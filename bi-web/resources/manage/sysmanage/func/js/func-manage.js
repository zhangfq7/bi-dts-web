define(["sabace","message"],function(y,k){var d=null;var v=null;var t="";var z="";var w="";var r="";var i="";var q="";var f="";var o="";var n="";function x(){jQuery("#funcTree").jqGrid({url:y.handleUrlParam("/manage/sysmanage/func/func-list"),styleUI:"Bootstrap",postData:"",datatype:"json",height:"auto",autowidth:true,treeGrid:true,ExpandColumn:"oname",treeGridModel:"adjacency",regional:"cn",mtype:"post",forceFit:true,gridComplete:function(){jQuery("input[type=checkbox]").on("click",c)},onSelectRow:function(E){jQuery("input[type=checkbox]").prop("checked",false);jQuery("tr[id="+E+"]>td>input").prop("checked",true)},loadComplete:function(){$(".tree-wrap").width(function(){return $(this).width()+14});$(".fileType").parents("td").find(".glyphicon-triangle-bottom ,.glyphicon-triangle-right").addClass("filepyte-class")},colModel:[{index:"oid",label:y.getMessage("label.func.choice"),formatter:function(F,G,I){var E=y.IsEmpty(I.oicon)?"":I.oicon;var H='<input type="checkbox" name="attrId" class="funcCheckBox" id="selectFuncId'+I.oid+'" value="'+I.oid+'" oname="'+I.oname+'" systemId="'+I.systemId+'" level="'+I.level+'" pid="'+I.parent+'" parentName="'+I.parentName+'" oicon="'+E+'" ourl="'+I.ourl+'" otype="'+I.otype+'" ftype="'+I.ftype+'" otarget="'+I.otarget+'" checkUrl="'+I.checkUrl+'"/>';H+='<div style="display:none">'+I.oname+"</div>";return H},cellattr:function(J,G,H,E,I){if(!H.oid){var F=jQuery(this).jqGrid("getGridParam","colModel");return"colspan="+F.length}},hlign:"center",align:"center",sortable:false,width:50},{name:"oid",key:true,hidden:true,sortable:false},{name:"oname",index:"oname",label:y.getMessage("label.func.funcName"),hlign:"center",sortable:false,width:300,formatter:function(E,F,G){if(G.otype=="2"&&G.isLeaf=="true"){G.isLeaf=false;return"<div class='fileType'>"+E+"</div>"}if(G.otype=="3"&&G.isLeaf=="true"){G.isLeaf=false;return"<div class='fileType'>"+E+"</div>"}else{return E}}},{name:"ourl",index:"ourl",label:y.getMessage("label.func.url"),hlign:"center",sortable:false,width:240},{name:"userName",index:"userName",label:y.getMessage("label.func.creater"),hlign:"center",sortable:false,width:100},{name:"adminTime",index:"adminTime",label:y.getMessage("label.func.createTime"),hlign:"center",sortable:false,width:130}]});jQuery("#searchButton").on("click",function(){D()});jQuery("#addFuncButton").on("click",function(){b()});jQuery("#modifyFuncButton").on("click",function(){h()});jQuery("#delFuncButton").on("click",function(){u()});jQuery(window).resize(function(){$("#funcTree").setGridWidth($("#funcListPanel").width()-5)});z=jQuery(".typeLine .typeselect");z.removeClass("hide");w=jQuery(".typeLine .text");w.removeClass("hide");jQuery(".typeLine .typeselect,.typeLine .text").remove();r=jQuery("#dimOurl");i=jQuery("#dimFunctype");q=jQuery("#dimTarget");f=jQuery("#dimfuncRightUrl");o=jQuery("#dimFuncRight");n=jQuery("#expandOperLi");t=jQuery("#funcInfoPanel").outerHTML();jQuery("#funcInfoPanel").remove();jQuery("#functype").chosen();jQuery("#target").chosen();jQuery("#otype").chosen();jQuery("body").on("blur",'input[name="operId"]',function(){$(this).val($(this).val().toUpperCase())})}function a(){jQuery("#funcId").on("blur",function(){var E=jQuery("#funcId").val();if(!y.IsEmpty(E)){var F={funcCode:E};C(F)}})}function C(E){var F=y.handleUrlParam("/manage/sysmanage/func/check-repeat");y.ajax({data:E,url:F,success:function(G){if("1"==G.code){jQuery("#funcId").val("");jQuery("#funcIdSpan").removeClass("green_t").addClass("red");jQuery("#funcIdSpan").html("编码重复")}else{jQuery("#funcIdSpan").removeClass("red").addClass("green_t");jQuery("#funcIdSpan").html("编码通过")}},error:function(G){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"提示",message:G.responseText||"查询出错"})}})}function D(){var E={};E.oname=$("#queryFuncName").val();jQuery("#funcTree").jqGrid("setGridParam",{postData:E}).trigger("reloadGrid")}function l(){jQuery("#otype").on("change",function(){var E=jQuery(this).val();s()})}function B(){var G=$("#funcTree input:checkbox:checked");var F=jQuery(G[0]).attr("value");if(F==-1){var E=jQuery(this).val();s()}}function s(){jQuery("#dimOurl,#dimIcon,#dimFunctype,#dimfuncRightUrl,#dimTarget,#dimFuncRight,#expandOperLi").toggle();jQuery(".open-dialog .modal-body").css("height","430px")}function b(){var H=$("#funcTree input:checkbox:checked");var J=$("#funcTree").jqGrid("getGridParam","selrow");if(y.IsEmpty(J)){bi.dialog.show({type:"type-warning",title:y.getMessage("label.func.prompt"),message:y.getMessage("label.func.msg.choice"),});return}var I=jQuery(H[0]).attr("otype");if(I==1){bi.dialog.show({type:"type-warning",title:y.getMessage("label.func.prompt"),message:y.getMessage("label.func.msg.add"),});return}var F=bi.dialog.show({title:y.getMessage("label.func.add"),message:t,nl2br:false,closable:false,cssClass:"open-dialog",closeByBackdrop:false,closeByKeyboard:false,onshown:function(){if(H.val()==-1){jQuery(".typeLine").append(w);jQuery("#dimOurl,#dimFunctype,#dimTarget,#dimfuncRightUrl,#dimFuncRight,#expandOperLi").remove()}else{jQuery(".typeLine").append(z);jQuery("#otype").chosen({disable_search:true})}l();a();m(jQuery(H[0]).attr("value"),"add",null);jQuery("#other-right-add").on("click",function(){e()});jQuery("#other-right-add").trigger("click");jQuery("#otype option:eq(0)").attr("selected",true)},buttons:[{label:y.getMessage("label.func.cancel"),action:function(K){jQuery("#otype").chosen("destroy");K.close()}},{label:y.getMessage("label.func.save"),cssClass:"btn-info",action:function(K){var L=K.getModalBody().find("#funcInfoPanel").validationEngine("validate");if(!L){return false}bi.dialog.confirm({title:y.getMessage("label.func.prompt"),message:y.getMessage("label.func.msg.save"),callback:function(M){if(!M){return}g(F,"add")}});jQuery("#otype").chosen("destroy")}}]});var G=jQuery(H[0]).attr("value");var E=jQuery(H[0]).attr("systemId");F.getModalBody().find("#pid").val(G);F.getModalBody().find("#systemId").val(E);F.getModalBody().find("#funcInfoPanel").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true})}function m(F,E,G){var H={pid:F};y.ajax({type:"post",cache:false,dataType:"json",url:y.handleUrlParam("/manage/sysmanage/func/junior-func"),data:H,success:function(L){var K="last";d=L.funcListBeanList;A(d,G);var I=0;for(var J=0;J<d.length;J++){if(G==d[J].oid){v=++J;I=J;break}}if(I==d.length){K="last"}else{if("modify"==E){K=d[I].oid}}jQuery("#funcOrder").chosen();jQuery("#funcOrder").val(K);jQuery("#funcOrder").trigger("chosen:updated");jQuery("#functype").chosen({disable_search:true});jQuery("#target").chosen({disable_search:true})},error:function(I){}})}function A(H,G){var F="";F+='<option value="last">'+y.getMessage("label.func.last")+"</option>";var I=null;for(var E=0;E<H.length;E++){I=H[E];if(!y.IsEmpty(G)){if(I.oid==G){continue}}F+='<option value="'+I.oid+'">';F+=I.oname;F+="</option>"}jQuery("#funcOrder").append(F)}function j(E){var G=$("#funcTree input:checkbox:checked");var F=jQuery(G[0]).attr("otype");jQuery(".typeselect").remove();if(F==2){jQuery("#dimOurl,#dimIcon,#dimFunctype,#dimfuncRightUrl,#dimTarget,#dimFuncRight,#expandOperLi").toggle();jQuery(".typeLine").append('<div class="input-class">功能模块文件夹<input type="hidden" id="otype" value="'+F+'"><div>')}if(F==3){jQuery("#dimOurl,#dimFunctype,#dimTarget,#dimfuncRightUrl,#dimFuncRight,#expandOperLi").toggle();jQuery(".typeLine").append('<div class="input-class">子系统<input type="hidden" id="otype" value="'+F+'"><div>')}if(F==1){jQuery(".typeLine").append('<div class="input-class">功能模块<input type="hidden" id="otype" value="'+F+'"><div>')}}function h(){var K=$("#funcTree input:checkbox:checked");var F=$("#funcTree").jqGrid("getGridParam","selrow");if(y.IsEmpty(F)){bi.dialog.show({type:"type-warning",title:y.getMessage("label.func.prompt"),message:y.getMessage("label.func.msg.choice"),});return}var P=jQuery(K[0]).attr("value");var L=jQuery(K[0]).attr("otype");if(P==-1){bi.dialog.show({type:"type-warning",title:y.getMessage("label.func.prompt"),message:y.getMessage("label.func.msg.modify"),});return}var R=bi.dialog.show({title:y.getMessage("label.func.modify"),message:t,nl2br:false,closable:false,cssClass:"open-dialog",closeByBackdrop:false,closeByKeyboard:false,onshown:function(){jQuery(".typeLine").append(z);j();m(jQuery(K[0]).attr("pid"),"modify",jQuery(K[0]).attr("value"));jQuery("#other-right-add").on("click",function(){e()});jQuery("#funcId").attr("disabled","disabled");y.ajax({type:"post",cache:false,dataType:"json",url:y.handleUrlParam("/manage/sysmanage/func/query-func-oper"),data:{oid:P,},success:function(X){var W=X.funcOper;if(W.length>0){jQuery("#expandOperLi").show();for(var V=0;V<W.length;V++){var U=W[V].operId;var T=W[V].operName;e(U,T)}}},error:function(T){}})},buttons:[{label:y.getMessage("label.func.cancel"),action:function(T){T.close()}},{label:y.getMessage("label.func.save"),cssClass:"btn-info",action:function(T){var U=T.getModalBody().find("#funcInfoPanel").validationEngine("validate");if(!U){return false}bi.dialog.confirm({title:y.getMessage("label.func.prompt"),message:y.getMessage("label.func.msg.save"),callback:function(V){if(!V){return}g(R,"modify")}})}}]});var I=jQuery(K[0]).attr("otype");var J=jQuery(K[0]).attr("oname");var E=jQuery(K[0]).attr("value");var O=jQuery(K[0]).attr("oicon");var H=jQuery(K[0]).attr("ourl");var S=jQuery(K[0]).attr("ftype");var Q=jQuery(K[0]).attr("otarget");var N=jQuery(K[0]).attr("checkUrl");var M=jQuery(K[0]).attr("systemid");var G=jQuery(K[0]).next().html();R.getModalBody().find("#otype").val(I);R.getModalBody().find("#funcName").val(J);R.getModalBody().find("#funcId").val(E);R.getModalBody().find("#pid").val(E);R.getModalBody().find("#icon").val(O);R.getModalBody().find("#ourl").val(H);R.getModalBody().find("#target").val(Q);R.getModalBody().find("#funcRightUr").val(N);R.getModalBody().find("#functype").val(S);R.getModalBody().find("#remark").val(G);R.getModalBody().find("#systemId").val(M);R.getModalBody().find("#funcInfoPanel").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true})}function u(){var H=$("#funcTree input:checkbox:checked");var L=$("#funcTree").jqGrid("getGridParam","selrow");if(y.IsEmpty(L)){bi.dialog.show({type:"type-warning",title:y.getMessage("label.func.prompt"),message:y.getMessage("label.func.msg.choice"),});return}var G=jQuery(H[0]).attr("value");var E=jQuery(H[0]).attr("otype");var F=jQuery(H[0]).attr("systemId");var J=jQuery(H[0]).attr("otype");var K=jQuery(H[0]).attr("pid");if(G==-1){bi.dialog.show({type:"type-warning",title:y.getMessage("label.func.prompt"),message:y.getMessage("label.func.msg.delete"),});return}var I="";if(J!=1){I=y.getMessage("func.msg.submit.confirm")}else{I=y.getMessage("func.msg.delete.confirm")}bi.dialog.confirm({title:y.getMessage("label.func.prompt"),message:I,callback:function(M){if(M){y.ajax({type:"post",cache:false,dataType:"json",url:y.handleUrlParam("/manage/sysmanage/func/delete-func-list/"),data:{oid:G,systemId:F,otype:J,pid:K},success:function(N){bi.dialog.show({title:y.getMessage("label.func.prompt"),message:y.getMessage("label.func.delete.success"),nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:y.getMessage("label.func.confirm"),cssClass:"btn-info",action:function(O){D();O.close()}}]})},error:function(N){}})}}})}function g(P,S){var H=null;var T={};var M=[];var R=null;var F=null;var O=false;T.oid=P.getModalBody().find("#funcId").val();T.pid=P.getModalBody().find("#pid").val();T.otype=P.getModalBody().find("#otype").val();if(y.IsEmpty(T.otype)){T.otype=P.getModalBody().find("#otype").attr("value")}T.oname=P.getModalBody().find("#funcName").val().trim();T.ourl=P.getModalBody().find("#ourl").val();T.checkUrl=P.getModalBody().find("#funcRightUr").val();T.remark=P.getModalBody().find("#remark").val();T.oicon=P.getModalBody().find("#icon").val();T.otarget=P.getModalBody().find("#target").val();T.ftype=P.getModalBody().find("#functype").val();T.orank=P.getModalBody().find("#funcOrder").val();for(var L=0;L<d.length;L++){R=d[L];if(R.oid==T.orank){H=R.orank;O=true}F={};if(O){F.oid=R.oid;F.otype=R.otype;F.orank=R.orank;M.push(F)}}if(M.length==0){var G;if(null!=d&&d.length>0){G=d[d.length-1].orank}else{G=0}if("modify"==S){T.orank=G}else{T.orank=G+1}}else{if("modify"==S){if(H>=v){T.orank=H-1}else{T.orank=H}}else{T.orank=H}}T.modifyOrank=v;if("modify"==S){var U=false;var J=[];var K=null;for(var L=0;L<d.length;L++){K=d[L];if(y.IsEmpty(H)){if(K.orank>v){K.orank=K.orank-1;J.push(K)}U=true}if(H>v&&!U){if(K.orank>v&&K.orank<H){K.orank=K.orank-1;J.push(K)}}if(H<v&&!U){if(K.orank<v&&K.orank>=H){K.orank=K.orank+1;J.push(K)}}}T.funcBeanList=J}else{T.funcBeanList=M}T.systemId=P.getModalBody().find("#systemId").val();T.operateType=S;var Q="";var N="";var E=jQuery(".operTr");$.each(E,function(Y,W){var X=jQuery(W).find("input[name='operId']").val();var V=jQuery(W).find("input[name='operName']").val();Q+=X;N+=V;if(Y!=E.size()-1){Q+=",";N+=","}});T.operIdArr=Q;T.operNameArr=N;log(T.operIdArr);log(T.operNameArr);log(T);var I="&returnStr="+JSON.stringify(T);y.ajax({type:"post",cache:false,dataType:"json",url:y.handleUrlParam("/manage/sysmanage/func/save-func"),data:I,success:function(V){if(V.saveFlag=="true"){bi.dialog.show({title:y.getMessage("label.func.prompt"),message:y.getMessage("label.func.success.save"),buttons:[{label:y.getMessage("label.func.save"),cssClass:"btn-info",action:function(W){D();W.close();P.close()}}]})}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:y.getMessage("label.func.prompt"),message:y.getMessage("label.func.failed.save"),})}},error:function(V){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:y.getMessage("label.func.prompt"),message:y.getMessage("label.func.exception"),})}})}function e(F,E){var G="";if(F!=null){G='<tr class="operTr"><td name="operOrder"></td><td name="operIdTd"><input name="operId" value="'+F+'" style="width:80%"/></td><td name="operNameTd" align="center"><input name="operName" value="'+E+'" style="width:80%"/></td><td><i name="other-right-delete" class="fa fa-minus-circle other-right-minus cursor-pointer"></i></td></tr>'}else{G='<tr class="operTr"><td name="operOrder"></td><td name="operIdTd"><input name="operId" style="width:80%"/></td><td name="operNameTd" align="center"><input name="operName" style="width:80%"/></td><td><i name="other-right-delete" class="fa fa-minus-circle other-right-minus cursor-pointer"></i></td></tr>'}jQuery("#expandOperGroup").append(G);jQuery("td[name='operOrder']").each(function(I,H){H.innerHTML=I+1});jQuery("i[name='other-right-delete']").on("click",function(){p(this)});jQuery("#expandOperGroup td").css("height","32px")}function p(E){E.parentNode.parentNode.parentNode.removeChild(E.parentNode.parentNode);jQuery("td[name='operOrder']").each(function(G,F){F.innerHTML=G+1})}function c(){jQuery("input[type=checkbox]").prop("checked",false);jQuery(this).prop("checked",true);jQuery("#funcTree").jqGrid("setSelection",$("#funcTree input[type='checkbox']:checked").parent().next().text())}return{init:x}});