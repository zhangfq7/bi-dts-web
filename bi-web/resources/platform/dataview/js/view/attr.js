define(["view/box","bace","view/component/dateFormatUtil","view/component/CalcUtil","view/component/PersonalizedChoose"],function(b,d,g,f,e){var a={};a.control={init:function(){log("初始化指标树");a.view.init();b.AttrTree.openAttrPanel=a.control.openAttrPanel;b.AttrTree.findAttrByParam=a.view.findAttrByParam;b.AttrTree.viewInit=a.view.init},openAttrPanel:function(h){jQuery(".closeAttr").removeClass("hide").siblings(".layout_title_panel").addClass("closeTag");setTimeout(function(){if(h==="open"){myLayout.open("west")}else{myLayout.toggle("west")}},0);d.autoScroll($("#layout_attr_panel .l-grid-body2"));setTimeout(function(){var i=$("#layout_attr_treeGrid_panel").ligerGetGridManager();if(!i){return}i.setColumnWidth("attrName",jQuery("#layout_attr_treeGrid_panelgrid").width())},100)}};var c;a.view={init:function(){a.view.initTreeGrid();for(var h in a.view.bindEvent){a.view.bindEvent[h]()}},initTreeGrid:function(h){if(c){a.view.findAttrByParam({attrName:"",dataId:h||b.main.dataId});return}c=$("#layout_attr_treeGrid_panel").ligerGrid({columns:[{name:"attrName",width:"100%",align:"left",render:function(j,l,t){var q=j.attrId;var w=j.attrName;var z=j.attrType;var p=j.attrClass;var i=j.fieldName;var r=j.columnScale;var m=j.filterType;var k=j.importType||"";var o=j.dimId||"";var s=j.filterContent;var u=j.attrPostfix;var y=j.attrFormat;var v=j.dataId;var x=j.diyRelation;var n=(p=="2"||p=="3")?"custom_dimAttr":"";return"<span class='"+n+"' data-attrId='"+q+"' data-attrName ='"+w+"' data-dimId='"+o+"' data-filterType='"+m+"' data-attrType='"+z+"' data-attrClass='"+p+"' data-fieldname='"+i+"' data-columnscale='"+r+"' data-importtype='"+k+"'data-filterContent='"+s+"'data-attrPostfix='"+u+"'data-attrFormat='"+y+"' data-dataId='"+v+"' data-diyRelation='"+x+"' title='"+w+"'>"+w+"</span>"}}],width:"101%",height:"100%",heightDiff:24,title:function(){return'<span class="filter-span">	<input id="filterInput" class="filter-text"  placeholder="输入指标关键字"/>	<span class="filter-icon"></span></span>'}(),url:d.handleUrlParam("/platform/dataview/initDataAttr"),parms:{dataId:h||b.main.dataId},alternatingRow:false,selectRow:false,usePager:false,tree:{columnName:"attrName"},onClickRow:function(l,j,k,i){if(l.__hasChildren){c.toggle(j)}d.stopBubble(i)},onAfterShowData:function(){a.view.installDrayAttr();d.autoScroll($("#layout_attr_panel .l-grid-body2"))}})},bindEvent:{serachAttrbyName:function(){jQuery("#layout_attr_treeGrid_panel").on("click",".filter-icon",function(h){a.view.findAttrByParam({attrName:$(this).prev().val(),dataId:b.main.dataId});d.stopBubble(h)});jQuery("body").on("keypress","#filterInput",function(h){if(h.keyCode=="13"){a.view.findAttrByParam({attrName:$(this).val(),dataId:b.main.dataId})}});jQuery(".calcPanel").unbind("click").on("click",function(){var h="0";e.show(h)})},dateFormat:function(){jQuery("#derive-dim").on("click",function(){var h="1";e.show(h)})}},findAttrByParam:function(j){var h=$("#layout_attr_treeGrid_panel").ligerGetGridManager();if(!h){return}var i=$.extend(true,{},h.options.parms,j);h.loadServerData(i,undefined,undefined,function(){h.setColumnWidth("attrName",jQuery("#layout_attr_treeGrid_panelgrid").width())})},installDrayAttr:function(){var h="#attrPanel,#dimPanel,#graphPanel,#rowsDimPanel,#colsDimPanel,#attrFuncPanel,#indicatorPanel,.filterarea,.conditionArea";if(discovery=="1"){h+=",div.filter-panel"}$("#layout_attr_treeGrid_panel span[file]").parents("td").draggable({delay:10,cursorAt:{top:1,left:56},addClasses:false,connectToSortable:h,helper:function(k){var q=jQuery(this).find("span[file] >span");var r=q.attr("data-attrId");var t=q.attr("data-attrName");var n=q.attr("data-attrType");var x=q.attr("data-attrClass");var v=q.attr("data-fieldName");var p=q.attr("data-columnScale");var j=q.attr("data-filterType");var u=q.attr("data-dimId");var m=q.attr("data-importtype");var s=q.attr("data-attrPostfix");var i=q.attr("data-filterContent");var w=q.attr("data-attrFormat");var o=q.attr("data-dataId");var l=q.attr("data-diyRelation");return jQuery("<div>",{style:"z-index:9999999","data-attrid":r,"data-attrtype":n,"data-attrclass":x,"data-fieldname":v,"data-columnscale":p,"data-attrname":t,"data-filterType":j,"data-dimId":u,"data-importType":m,"data-attrpostfix":s,"data-filtercontent":i,"data-attrformat":w,"data-dataId":o,"data-diyRelation":l,html:t}).addClass("attr-helper").appendTo("body")}})}};a.module={};return a.control});