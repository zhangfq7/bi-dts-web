define(["bace","view/box"],function(c,b){var a={};var d={};a.control={init:function(){a.view.init();b.Filter.dataStart=a.control.dataStart},openFilter:function(){a.view.openFilter()},closeFilter:function(){a.view.closeFilter()},dataStart:function(j){if(j==="collect"){var f=[];jQuery("#filterPanel .filter-attr").each(function(){var s=$(this);var u=s.data("filterAttrData");var r="";log(u);if(!c.IsEmpty(u.dimId)||["A","B","C"].indexOf(u.filterType)>-1){var m=s.find(".bi-input").data("code");u.filterValue=m?m.join(","):"";u.filterLabelValue=JSON.stringify([s.find(".bi-input").val(),""])}else{var n=s.find(".intervalInput.start").val();var p=s.find(".chooseType.start >select").val();var w=p.split("_");var i=w[0];if(i=="more"||i=="moreEq"){var q="";var v=s.find(".chooseType.end >select").val();n=encodeURIComponent(n);var t=encodeURIComponent(s.find(".intervalInput.end").val());var l=i=="more"?">":">=";var o=v=="less"?"<":"<=";if(n&&t){r=l+n+","+o+t;u.filterLabelValue=JSON.stringify([n,t])}else{if(n){r=l+n;u.filterLabelValue=JSON.stringify([n,""])}if(t){r=o+t;u.filterLabelValue=JSON.stringify(["",t])}if(n==""&&t==""){u.filterLabelValue=JSON.stringify(["",""])}}u.filterSelectValue=JSON.stringify([p,v])}else{if(i=="like"){r="%"+n+"%"}if(i=="leftLike"){r=n+"%"}if(i=="rightLike"){r="%"+n}if(i=="eq"){r=n}u.filterSelectValue=JSON.stringify([p,""]);u.filterLabelValue=JSON.stringify([n,""])}u.filterValue=r}f.push(u)});return f}else{for(var g=0,k=j.length;g<k;g++){var h=a.view._packFilter(j[g]);jQuery(".filter-panel").append(h);var e=$.evalJSON(j[g].filterLabelValue);(function(l,i){setTimeout(function(){i.find(".intervalInput.start").val(decodeURIComponent(l[0]));i.find(".intervalInput.end").val(decodeURIComponent(l[1]))},100)})(e,h)}}},getPluginByType:function(e){if(["pie","bar","line","radar","funnel","gauge","map","scatter","heatmap"].indexOf(e)>-1){return b.Widgets.plugins.echarts}else{return b.Widgets.plugins[e]}},setGlobalFilter:function(e){a.view.initFilter(e)},reomveGlobalFilter:function(e){a.view.reomveGlobalFilter(e)}};a.view={init:function(){a.view.installFilterSortable();var f=a.view.bindFilterEvent;for(var e in f){f[e]()}},installFilterSortable:function(){$("#filterPanel .filter-panel,.filterarea").sortable({items:"div.filter-attr",revert:false,scroll:false,delay:200,cancel:".bi-input,.intervalInput",placeholder:"filter-placeholder",containment:"parent",over:function(e,f){setTimeout(function(){myLayout.center.children.layout1.resizeAll()},0)},out:function(e,f){setTimeout(function(){myLayout.center.children.layout1.resizeAll()},0)},start:function(e,f){f.item.css({cursor:"move"})},stop:function(g,i){var e=i.item;if(!e.hasClass("filter-attr")){var h={attrId:e.attr("data-attrid"),attrName:e.attr("data-attrname"),attrType:e.attr("data-attrtype"),filterType:e.attr("data-filterType"),dimId:e.attr("data-dimId"),attrClass:e.attr("data-attrclass"),filterLabelValue:"",filterValue:""};var f=a.view._packFilter(h);e.replaceWith(f);var j=parseInt(jQuery(".filter-panel").height()/45);if(j>1&&j<4){jQuery(".search .fa-search").css({"font-size":15*j*0.6})}}}}).disableSelection().off("mousedown.ui-disableSelection")},_packFilter:function(f){f.filterId=f.attrId+"_"+new Date().getTime();var e="";e+='<div id="${filterId}" class="filter-attr cursor-pointer">';e+='   	<span class="label">';if(discovery=="1"){e+="   		<label>${attrName}</label><span>：</span>"}else{e+='   		<label class="label-global">${attrName}</label><span>：</span>'}e+='   		<input id="${filterId}_input" type="text" class="bi-input target" />';e+="   	</span>";if(discovery=="1"){e+='   	<span class="icon-filter-tools">';e+='   		<i class="fa fa-remove icon-filter-hover" style="margin-left:1px" title="删除"></i>';e+="   	</span>"}else{e+='   	<span class="icon-filter-tools icon-filter-tools-global">';e+='   		<i class="fa fa-cog icon-filter-hover" style="margin-left:2px" title="修改"></i>';e+='   		<i class="fa fa-remove icon-filter-hover" style="margin-left:2px" title="删除"></i>';e+="   	</span>"}e+="</div>";var g=$.tmpl(e,f).data("filterAttrData",f);setTimeout(function(){a.view.translate(f)},0);return g},translate:function(q,k){var f=$("#"+q.filterId);var m=f.find("input.target");f.find("select").chosen("destroy");f.find(".bi-filter").remove();var k=q.filterType;if([a.module.filterType.DIM,"A","B","C"].indexOf(k)>-1){var p=f.data("filterAttrData").dimId;var e=f.data("filterAttrData").filterType;function i(u,s,t){return t.RES_DATA}var o=q.filterLabelValue?$.evalJSON(q.filterLabelValue)[0]:"";f.find(".bi-input").bzTree({async:{label:o,code:q.filterValue,enable:true,autoParam:["id=clickCode","dimId=clickDimId"],url:c.handleUrlParam(a.module.ajaxURL),dataType:"json",otherParam:{dimId:p,filterType:e},dataFilter:i}})}else{var l=q.filterSelectValue?$.evalJSON(q.filterSelectValue):null;var h='<div class="intervalGroup {{if endType != "less" && endType != "lessEq" }} like {{/if}} bi-filter"><div class="chooseType start"><select>{{if attrType != 1 && attrType != 2 && filterType != 4 && filterType != 6 && filterType != 7}}<option {{if startType == "like_9" }} selected {{/if}}value="like_9" >全匹配</option><option {{if startType == "leftLike_9" }} selected {{/if}} value="leftLike_9" >左匹配</option><option {{if startType == "rightLike_9" }} selected {{/if}} value="rightLike_9" >右匹配</option>{{/if}}<option {{if startType == "eq_3" }} selected {{/if}}value="eq_3" >精确</option><option {{if startType == "more_2" }} selected {{/if}}value="more_2" >&gt;</option><option {{if startType == "moreEq_2" }} selected {{/if}} value="moreEq_2" >&gt;=</option></select></div><div><input class="intervalInput start"/></div><div class="chooseType end"  {{if endType != "less" && endType != "lessEq" }}  style="display:none" {{/if}} ><select><option {{if endType == "less" }} selected {{/if}} value="less" >&lt;</option><option {{if endType == "lessEq" }} selected {{/if}} value="lessEq" >&lt;=</option></select></div><div class="endInput" {{if endType != "less" && endType != "lessEq" }}  style="display:none" {{/if}}><input class="intervalInput end"/></div></div>';m.hide().after($.tmpl(h,{attrType:q.attrType,filterType:k,startType:l?l[0]:"",endType:l?l[1]:""}));f.find(".chooseType.start select").chosen({width:"54px",disable_search:true});f.find(".chooseType.end select").chosen({width:"32px",disable_search:true});if(q.filterType==a.module.filterType.MONTH||q.filterType==a.module.filterType.DAY||q.filterType==a.module.filterType.TIME){var n=f.find("input.start");var r=f.find("input.end");if(n.data("DateTimePicker")){n.data("DateTimePicker").destroy();r.data("DateTimePicker").destroy()}var g="";var j="";if(k==a.module.filterType.MONTH){g="YYYY-MM"}if(k==a.module.filterType.DAY){g="YYYY-MM-DD";j+="months,days"}if(k==a.module.filterType.TIME){g="YYYY-MM-DD HH:mm:ss";j+="months,days,times"}q.filterValueType=k;f.find("input.start,input.end").datetimepicker({format:g,showClear:true,showTodayButton:true,showChangeType:j,keepOpen:false,onhide:function(){jQuery(this).attr("title",$(this).val()).parents(".filter-attr").removeClass("hover")},onChangeType:function(u,s){var v=f.find("input.start").data("DateTimePicker");var t=f.find("input.end").data("DateTimePicker");v.viewMode(s);v.format(u);t.viewMode(s);t.format(u);switch(s){case"months":q.filterValueType=a.module.filterType.MONTH;break;case"times":q.filterValueType=a.module.filterType.TIME;break;case"days":q.filterValueType=a.module.filterType.DAY;break;default:break}}});f.find("input.startDate").on("dp.change",function(s){f.find("input.endDate").data("DateTimePicker").minDate(s.date)})}}setTimeout(function(){myLayout.center.children.layout1.resizeAll()},0)},bindFilterEvent:{changeFilterSelect:function(){jQuery("#filterPanel").on("change",".chooseType.start select",function(){var e=jQuery(this);var f=e.val();if(["moreEq_2","more_2","less","lessEq"].indexOf(f)>-1){e.parents(".filter-attr .intervalGroup").removeClass("like");e.parents(".filter-attr").find(".end,.endInput").show()}else{e.parents(".filter-attr .intervalGroup").addClass("like");e.parents(".filter-attr").find(".end,.endInput").hide()}setTimeout(function(){myLayout.center.children.layout1.resizeAll()},0)})},search:function(){jQuery("#filterPanel .search ").on("click",function(){jQuery("#tableChartPanel >.container[charttype]").each(function(){var e=$(this).data("option");if(e&&e.isInit){(function(f){if(f.config.build.dataParams){f.config.build.dataParams.filterJsonStr=$.toJSON(a.control.dataStart("collect"))}a.control.getPluginByType(f.chartType).apply(f,true)})(e)}else{$.dialog.alert("该图形未初始化！")}})})},removeFilter:function(){jQuery("#filterPanel").on("click ",".fa-remove",function(){jQuery(this).parents(".filter-attr").fadeOut(200,function(){this.remove()});setTimeout(function(){myLayout.resizeAll();jQuery("#tableChartPanel >.container[charttype]").each(function(){var e=$(this).data("option");if(e&&e.isInit){(function(f){if(f.config.build.dataParams){f.config.build.dataParams.filterJsonStr=$.toJSON(a.control.dataStart("collect"))}a.control.getPluginByType(f.chartType).apply(f,true)})(e)}})},300)})},modifyFilter:function(){jQuery("#filterPanel").on("click ",".fa-cog",function(){d.editFilterData=jQuery(this).parent().parent().data("filterAttrData");d.editFilterId=jQuery(this).parent().parent().attr("id");a.view.initFilter("edit");setTimeout(function(){myLayout.resizeAll()},300)})},settingFilter:function(){jQuery("#filterPanel").on("click","span.icon-filter-tools.cog",function(){var e=jQuery(this);if(jQuery(".fliterMenu").is(":visible")){}else{e.poshytip("show")}})},hoverAttr:function(){jQuery("#filterPanel").on("mouseover",".filter-attr",function(){$(this).addClass("hover")});jQuery("#filterPanel").on("mouseout",".filter-attr",function(e){var f=jQuery(this);var g=f.attr("id");if(jQuery(".fliterMenu[fid='"+g+"']").is(":visible")){}else{f.removeClass("hover")}});jQuery("#filterPanel").on("touchend",".filter-attr",function(){$(this).find(".bi-input").focus();$(this).addClass("hover")});jQuery("#filterPanel").on("touchmove",".filter-attr",function(e){var g=jQuery(this);var f=g.find("span.icon-filter-tools.cog");f.poshytip("show");setTimeout(function(){g.find(".bi-input").blur()},10)});jQuery("body").on("touchstart",function(e){jQuery("span.icon-filter-tools.cog").poshytip("hide")})}},initFilter:function(o){var g=b.Widgets.start("collect");var p=g.widgets;var f=p.length;if(f==0){$.dialog({lock:true,content:'<div style="color:#444;font-weight:bolder;margin-top:-10px">请先设置图表！</div>',icon:"warning",width:"200px",height:"70px",resize:false,ok:true});return}else{var n="";var l=[];var r=[];var k=null;var h=null;var e=null;var m=-1;for(var j=0;j<f;j++){k=p[j];if(typeof(k.option.config.build.dataParams)!="undefined"){h=k.option.config.build.dataParams.dataId;e=k.option.config.build.dataParams.dataName;m=jQuery.inArray(h,l);if(m==-1){if(j==0){n+=h}else{n+=","+h}l.push(h);r.push(e)}}}if(l.length>0){$("<div></div>",{id:"globalFilterPanel",style:"display:none"}).appendTo("body");var q=c.handleUrlParam("/platform/dataview/set-global-filter")+"?type="+o+"&_t="+(new Date()).getTime();jQuery("#globalFilterPanel").load(q,function(){a.view.setGlobalFilter(l,n,r,o)})}}},setGlobalFilter:function(f,h,g,e){d.type=e;d.dataIdArr=f;d.scount=f.length;d.dataIds=h;d.dataNames=g;d.width=930;if(d.scount==1){d.width=460}else{if(1<d.scount<=5){d.width=930-(5-d.scount)*100}}console.log(1);$.dialog({id:"globalFilterDialog",title:"设置筛选条件",padding:"0",width:d.width+"px",lock:true,resize:false,content:$("#globalFilterPanel")[0],init:function(){a.view.getDataInfo()},ok:function(){a.view.saveFilterColumn();return false},okVal:"保存",cancelVal:"关闭",cancel:function(){return true}})},initGlobalFilter:function(){a.view.addColumn("init");if(d.type=="edit"){var e=jQuery("#globalFilterPanel .init-class");e.find(".filter-input").val(d.editFilterData.attrName);var h=null;var i=null;var f=null;var j=null;var g=null;e.find(".filter-chosen-select").each(function(){if(d.scount==1){d.editFilterData.attrType=null;d.editFilterData.filterType=null;d.editFilterData.dimId=null;d.editFilterData.attrClass=null}jQuery(this).find("[value!='']option").remove();h=jQuery(this).parent().parent().attr("colIndex");f=d.dataIdArr[h];g=jQuery.inArray(f,d.editFilterData.dataArr);i=a.view.getAttrItems(h,d.editFilterData.attrType,d.editFilterData.filterType,d.editFilterData.dimId);jQuery(this).append(i);if(g>-1){j=d.editFilterData.attrArr[g];jQuery(this).find("[attrId='"+j+"']").prop("selected",true)}jQuery(this).trigger("chosen:updated");if(d.editFilterData.attrType==null||d.editFilterData.attrType==""){d.editFilterData.attrType=jQuery(this).find("option:selected").attr("attrType");d.editFilterData.filterType=jQuery(this).find("option:selected").attr("filterType");d.editFilterData.dimId=jQuery(this).find("option:selected").attr("dimId");d.editFilterData.attrClass=jQuery(this).find("option:selected").attr("attrClass")}})}jQuery("#globalFilterPanel .filter-add").hover(function(){jQuery("#globalFilterPanel .filter-add .filter-add-icon-white").addClass("hide");jQuery("#globalFilterPanel .filter-add .filter-add-icon-blue").removeClass("hide")},function(){jQuery("#globalFilterPanel .filter-add .filter-add-icon-blue").addClass("hide");jQuery("#globalFilterPanel .filter-add .filter-add-icon-white").removeClass("hide")});jQuery("#globalFilterPanel .filter-add").on("click",function(){a.view.addColumn("add")})},getDataInfo:function(){$.ajax({type:"POST",url:c.handleUrlParam("/platform/dataview/get-column-info"),dataType:"json",data:{dataIds:d.dataIds},success:function(e){if(e.resFlag=="success"){d.attrList=e.attrList;a.view.initGlobalFilter()}else{$.dialog({lock:true,content:'<div style="color:#444;font-weight:bolder;margin-top:-10px">获取数据源字段信息失败！</div>',icon:"warning",width:"200px",height:"70px",resize:false,ok:true});return false}},error:function(e){$.dialog({lock:true,content:'<div style="color:#444;font-weight:bolder;margin-top:-10px">获取数据源字段信息异常！</div>',icon:"warning",width:"200px",height:"70px",resize:false,ok:true});return false}})},addColumn:function(l){var j=120;if(d.scount==1){j=220}else{if(d.scount==2){j=180}else{if(d.scount==3){j=150}else{if(d.scount==4){j=140}}}}var k=d.width-220;if(d.scount>5){k=(k/5)-2}else{k=(k/d.scount)-2}if(d.scount>5){var h='<li class="init-class" style="width:'+d.width+'px;">';if(l=="add"){h='<li class="add-line" style="width:'+d.width+'px;">'}}else{var h='<li class="init-class filter-li">';if(l=="add"){h='<li class="add-line filter-li">'}}var f="";f+='<div class="filter-name">';if(l=="init"){f+='	<div class="filter-name-title">';f+=' 		<span class="f14">筛选名称</span>';f+="	</div>"}f+='	<div class="filter-name-input">';f+=' 		<input type="text" class="filter-input" placeholder="请输入名称"/>  ：';f+="	</div>";f+="</div>";f+='<div class="filter-column">';var e="";for(var g=1;g<=d.scount;g++){e+='<div class="filter-column-attr" style="width: '+k+'px;" colIndex='+(g-1)+">";if(l=="init"){e+='	<div class="filter-column-span" style="width: '+k+'px;" title="'+d.dataNames[g-1]+'对应字段"><span>'+d.dataNames[g-1]+"对应字段</span></div>"}e+='	<div class="filter-column-select">';e+='		<select class="filter-chosen-select" style="width: '+j+'px;" data-placeholder="请选择字段">';e+='			<option value="" selected></option>';e+=a.view.getAttrItems(g-1,null,null,null);e+="		</select>";e+="	</div>";e+="</div>"}f+=e;f+="</div>";h+=f;h+="</li>";jQuery("#filterColumn").append(h);jQuery(".filter-chosen-select").chosen({allow_single_deselect:true});jQuery("#globalFilterPanel").on("change",".filter-chosen-select",function(){var i=jQuery(this).val();var q=null;var p=null;var o=null;var r=null;jQuery(this).parent().parent().siblings().each(function(){q=jQuery(this).find("select [value!='']option:selected");if(q){p=q.attr("attrType");o=q.attr("filterType");r=q.attr("dimId");return false}});if(p==null){p=jQuery(this).find("option:selected").attr("attrType");o=jQuery(this).find("option:selected").attr("filterType");r=jQuery(this).find("option:selected").attr("dimId")}if(i==""){jQuery(this).find("[value!='']option").remove();var m=jQuery(this).parent().parent().attr("colIndex");var n=a.view.getAttrItems(m,p,o,r);jQuery(this).append(n);jQuery(this).trigger("chosen:updated");if(jQuery(this).parent().parent().siblings().length==1){p=null}}jQuery(this).parent().parent().siblings().each(function(){var u=jQuery(this).find(".filter-chosen-select option:selected").val();jQuery(this).find(".filter-chosen-select [value!='']option").remove();var s=jQuery(this).attr("colIndex");var t=a.view.getAttrItems(s,p,o,r);jQuery(this).find(".filter-chosen-select").append(t);if(u!=""){jQuery(this).find(".filter-chosen-select").val(u)}jQuery(this).find(".filter-chosen-select").trigger("chosen:updated")})})},getAttrItems:function(t,s,o,i){var n=d.attrList[t];var g=d.dataIdArr[t];var m="";var q=null;var l=null;var p=null;var k=null;var f=null;var e=null;var r=null;var u=null;for(var h=0;h<n.insertList.length;h++){q=n.insertList[h];l=q.attrId;p=q.attrName;k=q.fieldName;f=q.attrType;e=q.filterType;r=q.dimId;u=q.attrClass;if(s==null){m+="<option value="+k+" attrType="+f+" filterType="+e+" attrId="+l+" dataId = "+g+" attrClass = "+u+" dimId="+r+">"+p+"</option>"}else{if(s==f&&o==e&&i==r){m+="<option value="+k+" attrType="+f+" filterType="+e+" attrId="+l+" dataId = "+g+" attrClass = "+u+" dimId="+r+">"+p+"</option>"}}}return m},saveFilterColumn:function(){var k={};var l=[];var h=0;var j=null;var m=[];var f=null;var e=[];jQuery("#filterColumn .filter-li").each(function(){k={};h=0;j=null;m=[];f=null;e=[];k.filterName=jQuery.trim(jQuery(this).find(".filter-input").val());jQuery(this).find(".filter-chosen-select").each(function(){if(jQuery(this).val()!=""){if(h==0){k.attrType=jQuery(this).find("option:selected").attr("attrType");k.filterType=jQuery(this).find("option:selected").attr("filterType");k.dimId=jQuery(this).find("option:selected").attr("dimId");k.attrClass=jQuery(this).find("option:selected").attr("attrClass")}j=jQuery(this).find("option:selected").attr("attrId");f=jQuery(this).find("option:selected").attr("dataId");m.push(j);e.push(f);h++}});k.attrArr=m;k.dataArr=e;if((typeof(k.filterName)!="undefined"&&k.filterName!="")&&(typeof(k.attrArr)!="undefined"&&k.attrArr.length>0)){l.push(k)}});if(l.length>0){var g=null;var o=null;var n=null;$.dialog.confirm("您确定保存该设置吗？",function(){for(var p=0;p<l.length;p++){g=l[p];o={attrId:"attrId"+p,attrName:g.filterName,attrType:g.attrType,filterType:g.filterType,attrClass:g.attrClass,dimId:g.dimId,filterLabelValue:"",filterValue:"",attrArr:g.attrArr,dataArr:g.dataArr};n=a.view._packFilter(o);if(d.type=="edit"){jQuery("#filterPanel .filter-panel #"+d.editFilterId+"").replaceWith(n)}else{jQuery("#filterPanel .filter-panel").append(n)}}$.dialog.closeAll()})}else{$.dialog({lock:true,content:'<div style="color:#444;font-weight:bolder;margin-top:-10px">请检查设置的查询条件，筛选名称和关联字段都需要设置！</div>',icon:"warning",width:"200px",height:"70px",resize:false,ok:true});return false}},reomveGlobalFilter:function(e){var g=b.Widgets.start("collect");var i=g.widgets;var k=i.length;if(k==1){jQuery("#filterPanel .filter-attr").each(function(){jQuery(this).remove()})}else{var l=null;var h=null;var j=null;var f=null;jQuery("#filterPanel .filter-attr").each(function(){l=jQuery(this).data("filterAttrData");h=l.attrArr;f=l.dataArr.indexOf(e);if(f>-1){var n=null;var q=null;var p=[];var o=0;for(var m=0;m<k;m++){n=i[m];if(typeof(n.option.config.build.dataParams)!="undefined"){q=n.option.config.build.dataParams.dataId;if(e==q){o+=1}}}if(o==1){l.dataArr.splice(f,1);l.attrArr.splice(f,1)}}if(l.dataArr.length==0){jQuery(this).remove()}})}}};a.module={ajaxURL:"/platform/dataview/query-tree-data",attrType:{INT:"1",DATE:"2",STRING:"3"},filterType:{DIM:"1",INTERVAL:"2",EQUAL:"3",LIKE:"9",MONTH:"4",DAY:"6",TIME:"7"},};return a.control});