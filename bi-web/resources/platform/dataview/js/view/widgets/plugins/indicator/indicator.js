define(["bace","view/box","view/widgets/plugins/indicator/dimAttr","view/widgets/plugins/indicator/desgin","view/attr"],function(Bace,Box,DimAttr,Desgin,Attr){Box.Widgets.plugins.indicator={type:"indicator",flag:false,init:function(){function settingPanelEvent(){$("#tableChartPanel").on("click",".chart-icon.tpl",function(){var $container=$(this).parents(".container");Tpl.show($container)})}if(!Box.Widgets.plugins.indicator.flag){settingPanelEvent();Box.Widgets.plugins.indicator.flag=true}},initDataPanel:DimAttr.init,initDesginPanel:{config:Desgin.getConfig(),change:Desgin.change},contanier:{getTools:function(page){page=page||"main";var tools={move:'<div class="chart-icon move" title="按住我，拖动！"><i class="iconfont icon-move" ></i></div>',setting:'<div class="chart-icon setting" title="打开属性面板"><i class="iconfont icon-setting" ></i></div>',openSelfDimAttr:'<div class="chart-icon openSelfDimAttr" title="打开小面板"><i class="iconfont icon-dim" ></i></div>',tpl:'<div class="chart-icon tpl " title="模版"><i class="iconfont icon-tpl" style="top: -2px; left: 4px; font-size: 24px;" ></i></div>',removeSelfChart:'<div class="chart-icon removeSelfChart del" title="移除"><i class="iconfont icon-delete" ></i></div>',discovery:'<div class="chart-icon discovery" title="探索"><i class="iconfont icon-discovery" ></i></div>',viewdata:'<div class="chart-icon viewdata" title="预览工作表"><i class="iconfont icon-viewdata" ></i></div>'};switch(page){case"main":switch(discovery){case"1":default:return[tools.move,tools.setting,tools.viewdata,tools.removeSelfChart];break}break;case"container":return[tools.openSelfDimAttr,tools.discovery];break;case"preview":return[tools.openSelfDimAttr];break;default:return[]}},settingPanel:'<div class="fieldTitle indicatorTitle">指标</div><div class="indicatorPanel panel"></div>',renderSettingPanel:function($container){if(_.keys(dataPanel).length>0){var attrData=dataPanel.attrData;var html='<div class="dimAttrField ${order}" title="${attrName}"><div class="attrDimText {{if isChecked==true}} checked {{/if}}">${modifyName}</div></div>';for(var i=0;i<attrData.length;i++){$attrPanel.append($.tmpl(html,attrData[i]).data("data",attrData[i]))}}return $dimAttrSettingPanel},resize:{start:function(){},reisze:function(el){Box.Widgets.plugins.indicator.indicatorSizeChange(el)},stop:function(el){Box.Widgets.plugins.indicator.indicatorSizeChange(el)}}},propPanel:{data:{html:'<div propType="indicator"><div class="fieldTitle indicatorTitle"><div style="display: inline-block; vertical-align:top">指标</div></div><div class="indicatorPanel" id="indicatorPanel"></div></div>'},tabsChange:function(event,ui){},openRender:function(option){if(option.isInit){var currentDataId=option.config.build.dataParams.dataId;var currentDataName=option.config.build.dataParams.dataName;Box.main.dataName=currentDataName;Box.main.dataId=currentDataId;Attr.init();Attr.openAttrPanel("open")}DimAttr.render(option);Desgin.render(option)},close:function(){if(DimAttr.checkDiff()===false){Box.Property.hideTip("error");Box.Property.showTip({_id:"error",msg:"<br/>系统检测到关闭操作!<br/>但图形指标数据发生变化，<br/>是否应用该数据？",button:'<div class="btn changeChart" style="width: 196px;">应用</div><div class="btn cancelChange" style="width: 196px;">直接关闭</div>'});$("#error .changeChart").click(function(){Box.Property.apply();Box.Property.hideTip("error")});$("#error .cancelChange").click(function(){Box.Property.close(true);Box.Property.hideTip("error")});return false}else{Box.Property.close(true);return true}}},apply:function(option,isPass){if(isPass){Box.Widgets.plugins.indicator.indicatorApply(option.config.build,option);return}var dimAttrData=DimAttr.collect();var errorText=DimAttr.checkValidity(dimAttrData);if(errorText){Box.Property.showTip({_id:"error",msg:"<br/>"+errorText,button:'<div class="btn changeChart" style="width: 196px;">确定</div><div class="btn cancelChange" style="width: 196px;">取消</div>'});$("#error .changeChart").click(function(){jQuery("#propertyTabs").tabs("option","active",0);Box.Property.hideTip("error")});$("#error .cancelChange").click(function(){jQuery("#propertyTabs").tabs("option","active",0);Box.Property.hideTip("error")})}else{option.config.dataPanel=eval("("+$.toJSON(dimAttrData)+")");var checkDimAttr=DimAttr.getCheckedDimAttr(dimAttrData);var build={};build.dataParams={dataId:Box.main.dataId,dataName:Box.main.dataName,dataType:Box.main.dataType,chartType:option.chartType,dimAttrJsonStr:$.toJSON(checkDimAttr.data),filterJsonStr:$.toJSON(Box.Filter.dataStart("collect"))};Box.Widgets.plugins.indicator.indicatorApply(build,option);option.config.build=build;option.isInit=true}},indicatorApply:function(build,option){var chartChild=option.chartChild;var $el=$("#"+option.el);var $grid=$(".chart",$el);Box.Widgets.showLoading($el);setTimeout(function(){$(".dimAttrSettingPanel",$el).hide("slide")},0);build.ajaxURL=Bace.handleUrlParam("/platform/dataview/viewChartData");$.ajax({type:"POST",url:build.ajaxURL,dataType:"json",data:build.dataParams,success:function(response){if($grid[0]){$grid.replaceWith('<div class="indicator-display"></div>')}else{$el.find(".indicator-display").children().remove()}Box.Widgets.plugins.indicator.installIndicator($el,option,response);$el.find(".chart i").remove();Box.Widgets.hideLoading($el)},error:function(){Box.Widgets.showLoading($el)}})},installIndicator:function($el,option,response){if(response){var buildContent=response;var designPanel=option.config.designPanel;var chartChild=option.chartChild;var indicatorStyle=designPanel.indicator.style;var $appendHtml="";switch(chartChild){case"single":$appendHtml='<div class="indiSingle"><p class="indiSingle-val fontSizeChangeValue_1" style="font-size:'+indicatorStyle.value_1+'">'+buildContent[0].value+"<span>"+buildContent[0].attrPostfix+'</span></p><p class="indiSingle-content fontSizeChangeContent_1 attr-dot" title="'+buildContent[0].attrName+'" style="font-size:'+indicatorStyle.Content_1+'">'+buildContent[0].attrName+"</p></div>";break;case"two":$appendHtml='<div class="indiTwo">           <div class="indiTwo-top">               <div class="indiTwo-topname fontSizeChangeContent_1 attr-dot" title="'+buildContent[0].attrName+'" style="font-size:'+indicatorStyle.Content_1+'">'+buildContent[0].attrName+'</div>               <div class="indiTwo-topval fontSizeChangeValue_1" style="font-size:'+indicatorStyle.Value_1+'"><p>'+buildContent[0].value+buildContent[0].attrPostfix+'</p></div>           </div>           <ul class="indiTwo-bottom"><li><span class="attr-dot fontSizeChangeContent_2" title="'+buildContent[1].attrName+'" style="font-size:'+indicatorStyle.Content_2+'">'+buildContent[1].attrName+'</span><span class="fontSizeChangeValue_2" style="font-size:'+indicatorStyle.Value_2+'">'+buildContent[1].value+buildContent[1].attrPostfix+"</span></li></ul>         </div>";break;case"three":$appendHtml='<div class="indiThree">           <div class="indiThree-top">               <p class="indiThree-topname fontSizeChangeContent_1 attr-dot" title="'+buildContent[0].attrName+'" style="font-size:'+indicatorStyle.Content_1+'">'+buildContent[0].attrName+'</p>               <p class="indiThree-topval fontSizeChangeValue_1" style="font-size:'+indicatorStyle.Value_1+'">'+buildContent[0].value+buildContent[0].attrPostfix+'</p>           </div>           <div class="indiThree-middle"><p class="fontSizeChangeContent_2 attr-dot" title="'+buildContent[1].attrName+'" style="font-size:'+indicatorStyle.Content_2+'">'+buildContent[1].attrName+'</p><p class="fontSizeChangeValue_2" style="font-size:'+indicatorStyle.Value_2+'">'+buildContent[1].value+buildContent[1].attrPostfix+'</p></div>           <div class="indiThree-bottom"><p class="fontSizeChangeContent_3 attr-dot" title="'+buildContent[2].attrName+'" style="font-size:'+indicatorStyle.Content_3+'">'+buildContent[2].attrName+'</p><p class="fontSizeChangeValue_3" style="font-size:'+indicatorStyle.Value_3+'">'+buildContent[2].value+buildContent[2].attrPostfix+"</p></div>        </div>";break;case"four":$appendHtml='<div class="indiFour">           <div class="indiFour-top">               <div class="indiFour-topname"><p class="fontSizeChangeContent_1 attr-dot" title="'+buildContent[0].attrName+'" style="font-size:'+indicatorStyle.Content_1+'">'+buildContent[0].attrName+'</p></div>               <div class="indiFour-topval"><p class="fontSizeChangeValue_1" style="font-size:'+indicatorStyle.Value_1+'">'+buildContent[0].value+buildContent[0].attrPostfix+'</p><p><span class="fontSizeChangeContent_4 attr-dot" title="'+buildContent[3].attrName+'" style="font-size:'+indicatorStyle.Content_4+'">'+buildContent[3].attrName+'</span><span class="fontSizeChangeValue_4" style="font-size:'+indicatorStyle.Value_4+'">'+buildContent[3].value+buildContent[3].attrPostfix+'</span></p></div>           </div>           <div class="indiFour-middle"><p class="fontSizeChangeContent_2 attr-dot" title="'+buildContent[1].attrName+'" style="font-size:'+indicatorStyle.Content_2+'">'+buildContent[1].attrName+'</p><p class="fontSizeChangeValue_2" style="font-size:'+indicatorStyle.Value_2+'">'+buildContent[1].value+buildContent[1].attrPostfix+'</p></div>           <div class="indiFour-bottom"><p class="fontSizeChangeContent_3 attr-dot" title="'+buildContent[2].attrName+'" style="font-size:'+indicatorStyle.Content_3+'">'+buildContent[2].attrName+'</p><p class="fontSizeChangeValue_3" style="font-size:'+indicatorStyle.Value_3+'">'+buildContent[2].value+buildContent[2].attrPostfix+"</p></div>        </div>"}$el.css({background:designPanel.indicator.style.background}).find(".indicator-display").append($appendHtml).find(".attr-dot").dotdotdot()}},indicatorSizeChange:function(el){var $el=$("#"+el);var $elHeight=parseFloat($el.css("height"))-15+"px";$el.find("indicator-container").css("height",$elHeight)},destory:function(el){var $this=$("#"+el);$this.remove()}}});