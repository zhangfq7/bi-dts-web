define(["bace","view/box","underscore","view/widgets/plugins/indicator/indiFilter"],function(e,a,c,d){var b={};b.module={chartType:"",el:"",mapType:"",chartChild:""};b.control={init:function(f){b.view.initDimAttrPanel()},collect:function(){var g=[];$("#indicatorPanel .dimAttrField").each(function(){g.push($(this).data("dimAttrData"))});var f={attrData:g};return f},render:function(g){var h=g.config.dataPanel;b.module.chartType=g.chartType;b.module.el=g.el;b.module.chartChild=g.chartChild;$("#indicatorPanel .select").chosen("destroy");$("#indicatorPanel .dimAttrField").remove();var j=h.attrData||[];for(var f=0,k=j.length;f<k;f++){$("#indicatorPanel").append(b.view.packDimAttr("indicatorPanel",j[f]))}$("#indicatorPanel .funcSelect").chosen({width:"100%",disable_search:true});$("#indicatorPanel .formatSelect").chosen({width:"100%",disable_search:true})},getCheckedDimAttr:function(g){var f=[];var h=$.map(g.attrData,function(j,i){if(j.isChecked){f.push(i);return j}});return{data:{attrData:h},indexArray:f}},checkDiff:function(f){var g=$("#"+b.module.el).data("option");if(g.isInit===false&&f){return true}var i=b.control.collect();if(i.attrData.length==0){i={}}var h=g.config.dataPanel;if(!(c.isEqual(i,h))){return false}return true},checkValidity:function(f){var g=f.attrData;if($("#indicatorPanel .attrDimText.vr").length>0){return"请设置模板位指标！"}if($("#indicatorPanel .checked").length==0){return"请设置指标！"}else{if(b.module.chartChild==="single"&&$("#indicatorPanel .checked").length!=1){return"此类型指标卡只可以设定一个指标！"}else{if(b.module.chartChild==="two"&&$("#indicatorPanel .checked").length!=2){return"此类型指标卡需设定两个指标！"}else{if(b.module.chartChild==="three"&&$("#indicatorPanel .checked").length!=3){return"此类型指标卡需设定3个指标！"}else{if(b.module.chartChild==="four"&&$("#indicatorPanel .checked").length!=4){return"此类型指标卡需设定4个指标！"}}}}}}};b.view={initDimAttrPanel:function(){var f={connectWith:"#indicatorPanel",appendTo:"body",delay:200,handle:".attrDimText",containment:"#propertyPanel",cancel:".attrDimText.vr",placeholder:"dimAttr-placeholder",scroll:true,helper:function(k,l){var j=$(l);var i=j.data("dimAttrData");return $("<div>",{"data-attrid":i.attrId,"data-attrtype":i.attrType,"data-attrclass":i.attrClass,"data-fieldname":i.fieldName,"data-columnscale":i.columnScale,"data-filtertype":i.filterType,"data-attrname":i.attrName,"data-dimId":i.dimId,"data-modifyname":i.modifyName||i.attrName,"data-filtercontent":[]||"","data-attrpostfix":i.attrPostfix||"","data-attrformat":i.attrFormat||"",style:"z-index:9999999;height:30px",html:i.modifyName||i.attrName,"data-diyRelation":i.diyRelation}).addClass("attr-helper").appendTo("body")},over:function(i,j){},stop:function(m,o){var k=o.item;var j=k.parent().attr("id"),i={};if(k.attr("data-attrid")){var l=k.attr("data-attrname");i={attrId:k.attr("data-attrid"),attrName:l,modifyName:k.attr("data-modifyname")||k.attr("data-attrname"),attrType:k.attr("data-attrtype"),attrClass:k.attr("data-attrclass"),fieldName:k.attr("data-fieldname"),columnScale:k.attr("data-columnscale"),filterType:k.attr("data-filterType"),dimId:k.attr("data-dimId"),filterContent:[],attrPostfix:(k.attr("data-attrpostfix")==("undefined"||"null"||undefined||null||"NaN"||"")?"":k.attr("data-attrpostfix")),attrFormat:(k.attr("data-attrformat")==("undefined"||"null"||undefined||null||"NaN"||"")?"1":k.attr("data-attrformat")),diyRelation:k.attr("data-diyRelation"),isChecked:true,fanyi:true,order:""}}else{i=k.data("dimAttrData")}var n=b.view.packDimAttr(j,i,"isDray");o.item.replaceWith(n);setTimeout(function(){if(o.helper){o.helper.remove()}},0);$("#indicatorPanel .funcSelect").chosen({width:"100%",disable_search:true});$("#indicatorPanel .formatSelect").chosen({width:"100%",disable_search:true});b.view.checkAttrName();b.view.updateDesginAttr()}};$("#indicatorPanel").sortable(f).disableSelection();var h=b.view.bindDimAttrEvent;for(var g in h){h[g]()}e.autoScroll($("#indicatorPanel"))},checkAttrName:function(){var f=[];$("#indicatorPanel .dimAttrField").each(function(h){var j=$(this);var g=j.data("dimAttrData").modifyName;if(f.indexOf(g)>-1){g+=h;j.data("dimAttrData").modifyName=g;j.attr("title",g).find(".attrDimText").text(g)}f.push(g)})},updateDesginAttr:function(){var f=[];$("#indicatorPanel .dimAttrField").each(function(){f.push($(this).data("dimAttrData"))})},packDimAttr:function(g,j,l){var f=$.extend(true,{},j),i=$.extend(true,{},j);i.chartType=b.module.chartType;if(!f.id){f.id=f.attrId+(new Date()).getTime()}i.parentPanel=g;var h="";if(g=="indicatorPanel"){var k=i.funcName;if(!k){if(f.modifyName.indexOf("默认")>-1){f.funcName=i.funcName="";f.modifyName=f.attrName=i.modifyName}else{f.funcName=i.funcName="count";f.modifyName=f.attrName=i.modifyName="[ 计数 ] "+i.modifyName}}if(l){switch(b.module.chartChild){case"single":i.isChecked=f.isChecked=$("#indicatorPanel .checked").length>0?false:true;break;case"two":i.isChecked=f.isChecked=$("#indicatorPanel .checked").length>1?false:true;break;case"three":i.isChecked=f.isChecked=$("#indicatorPanel .checked").length>2?false:true;break;case"four":i.isChecked=f.isChecked=$("#indicatorPanel .checked").length>3?false:true;break}}h='<div class="dimAttrField ${order}" ><div class="attrDimPanel">	<div class="icon-checkbox {{if isChecked==true}} checked {{/if}}"></div>	<div class="attrDimText" title="${modifyName}">${modifyName}</div>   <div class="delAttrDim" deltag="attr" title="移除该指标"></div></div><div class="attrDimTools">      <div {{if attrClass=="0"}} style="width:40%;text-align:left;padding:0 3px;" {{else}} style="width:50%;text-align:left;padding:0 3px;" {{/if}}>			<select class="select funcSelect">			{{if attrType=="1"}}				<option  {{if funcName=="sum"}} selected {{/if}}value="sum">求和</option>				<option  {{if funcName=="avg"}} selected {{/if}}value="avg">平均值</option>			{{/if}}           {{if attrClass != "3"}}				<option  {{if funcName=="max"}} selected {{/if}}value="max">最大值</option>				<option  {{if funcName=="min"}} selected {{/if}}value="min">最小值</option>			{{/if}}				<option  {{if funcName=="count"}} selected {{/if}}value="count">计数</option>			</select>		</div>       {{if attrClass=="0"}}       <div class="indicator-filter">           <span>过滤</span>           <i>+</i>       </div>       {{/if}}		<div class="modifyName" {{if attrClass=="0"}} style="width:30%";{{else}}style="width:50%";{{/if}}>			<div >重命名</div>		</div>       <div class="displaySuffix"><div>后缀单位：</div><input class="bi-input postfix-input" style="width:60%;margin:3px 0;float:left;" value="${attrPostfix}"/></div>       <div class="figureFormat">           <div class="figureText">数字格式：</div>           <div class="figureSelect" style="">               <select class="select formatSelect">                   <option {{if attrFormat=="1"}} selected {{/if}} value="1">整数&nbsp;&nbsp;&nbsp;1234</option>                   <option {{if attrFormat=="2"}} selected {{/if}} value="2">千分数&nbsp;&nbsp;&nbsp;1,234</option>                   <option {{if attrFormat=="3"}} selected {{/if}} value="3">百分比&nbsp;&nbsp;&nbsp;1234%</option>                   <option {{if attrFormat=="4"}} selected {{/if}} value="4">百分比千分位&nbsp;&nbsp;&nbsp;1,234%</option>                   <option {{if attrFormat=="5"}} selected {{/if}} value="5">百分比小数&nbsp;&nbsp;&nbsp;1234.00%</option>                   <option {{if attrFormat=="6"}} selected {{/if}} value="6">百分比全部&nbsp;&nbsp;&nbsp;1,234.00%</option>               </select>           </div>       </div></div></div></div>'}return $.tmpl(h,i).data("dimAttrData",f)},bindDimAttrEvent:{bindDelAttrDim:function(){$("#propertyTabs").on("click","div[proptype='indicator'] div.delAttrDim",function(){var g=$(this);var f=g.attr("deltag");g.parents(".dimAttrField").fadeOut(200,function(){var h=$(this);if(f=="attr"){h.remove();b.view.updateDesginAttr()}else{h.remove()}})})},bindOpenDimAttrOpt:function(){$("#indicatorPanel").on("click",".attrDimText",function(){var h=$(this);if(h.hasClass("vr")){return}var g=h.parents(".dimAttrField");var f=g.data("dimAttrData");g.siblings().removeClass("open").animate({height:"30px"},200);(g.hasClass("open")?g.animate({height:"30px"},200):g.animate({height:(f.filterContent.length>0)?((122+f.filterContent.length*30)+"px"):"122px"},200)).toggleClass("open");$("#indicatorPanel input").blur();if(f.filterContent&&f.filterContent.length>0){$("#indicatorPanel .filter-attr").remove();a.IndiFilter.dataStart(f.filterContent,"isRender")}})},bindCheckBox:function(){$("#indicatorPanel").on("click",".dimAttrField .icon-checkbox",function(){var h=$(this);var g=h.parents(".dimAttrField");var f=g.data("dimAttrData");if(h.hasClass("checked")){if($("#indicatorPanel").find(".checked").length==1){return}h.removeClass("checked");f.isChecked=false}else{h.addClass("checked");f.isChecked=true}});$("#indicatorPanel").on("click",".modifyName",function(){var i=$(this);var g=i.parents(".dimAttrField");var f=g.data("dimAttrData");var h=g.find(".attrDimText");h.hide().after($("<input />",{value:f.modifyName,"class":"input"}).on("blur keypress",function(k){if(k.keyCode=="13"||k.type==="blur"){var j=$(this).val()||f.attrName;f.modifyName=j;h.text(j).show().next().remove();if(f.funcName){b.view.checkAttrName();b.view.updateDesginAttr()}}})).next().focus().select()});$("#indicatorPanel").on("change",".funcSelect",function(){var k=$(this);var g=k.parents(".dimAttrField");var f=g.data("dimAttrData");var j=k.val(),l="";switch(j){case"":l="默认";break;case"sum":l="求和";break;case"avg":l="平均值";break;case"max":l="最大值";break;case"min":l="最小值";break;default:l="计数";break}var i=f.modifyName.replace(/\求和|\平均值|\最大值|\最小值|\计数|\默认/g,l);f.attrName=f.attrName.replace(/\求和|\平均值|\最大值|\最小值|\计数|\默认/g,l);f.modifyName=i;f.funcName=j;var h=g.find(".attrDimText");h.text(i);b.view.updateDesginAttr()});$("#indicatorPanel").on("click",".indicator-filter",function(){var h=$(this);var g=h.parents(".dimAttrField");var f=g.data("dimAttrData");if(!$("#urlSettingsPanel")[0]){jQuery("body").append("<div id='indicatorFilterPanel' style='display:none;position: relative;'></div>")}jQuery("#indicatorFilterPanel").load(e.handleUrlParam("/platform/dataview/indicator-filter"),function(){$("#propertyPanel").css("display","none");$(".filterTop span").html(h.parentsUntil("#indicatorPanel").find(".attrDimText").html());d.init(g,b.module.el);if(f.filterContent&&f.filterContent.length>0){a.IndiFilter.dataStart(f.filterContent)}})});$("#indicatorPanel").on("change",".figureSelect .formatSelect",function(){var h=$(this);var g=h.parents(".dimAttrField");var f=g.data("dimAttrData");var i=h.val();f.attrFormat=i;b.view.updateDesginAttr()});$("#indicatorPanel").on("change",".postfix-input",function(){var h=$(this);var g=h.parents(".dimAttrField");var f=g.data("dimAttrData");f.attrPostfix=h.val();b.view.updateDesginAttr()});$("#indicatorPanel").on("click",".filter-attr .filter-attrDelete",function(){var k=$(this);var f=k.parents(".filter-attr");var h=k.parents(".dimAttrField");var g=h.data("dimAttrData");var j=g.filterContent;var i=f.attr("data-filterid");f.remove();c.each(j,function(m,l){if(m.filterId==i){j.splice(l,1)}});h.css({height:(122+j.length*30)+"px"})})}}};return b.control});