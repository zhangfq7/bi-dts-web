define(["bace","view/box","underscore","view/widgets/plugins/echarts/series","view/widgets/plugins/echarts/collect"],function(Bace,Box,_,series,Collect){var Desgin={isInit:false};Desgin.control={getConfig:function(){return $.extend(true,Desgin.module.config,series.seriesData)},render:function(option){var chartType=option.chartType;Desgin.module.chartType=chartType;Desgin.module.el=option.el;var attrData=option.config.dataPanel.attrData||[];Desgin.view.updateSeriesPanel(attrData);if(option.isInit||option.tplCount>0){var initOption=eval("("+$.toJSON(option.config.designPanel)+")");delete initOption.seriesPanel;Box.Property.dataStart(initOption);var seriesPanel=option.config.designPanel.seriesPanel;var seriesData=_.indexObj(seriesPanel.seriesData,0);Box.Property.dataStart(seriesData);var firstChartType=_.keys(seriesData)[0];firstChartType=firstChartType=="radar2"?"radar":firstChartType;$("#series-charts").val(firstChartType).trigger("chosen:updated");Desgin.view.showSeriesChartPanelByType(firstChartType);if(seriesPanel.seriesAuto){Desgin.view.setSeriseState(true)}else{Desgin.view.setSeriseState(false)}}else{Box.Property.dataStart(Collect.collectBaseTemplate("public"));var initBuild=Collect.collectSeriesTemplate(chartType);Box.Property.dataStart(initBuild);if(option.config.designPanel!==undefined){option.config.designPanel.seriesPanel.seriesData.single=initBuild}Desgin.view.showSeriesChartPanelByType(chartType)}if(["pie","funnel","map","radar","gauge","heatmap"].indexOf(chartType)>-1){$("#chart-property").find('div[proptype="xy"]').hide()}$("#bi-grid-yx").parents(".items")[chartType=="scatter"?"hide":"show"]();if(!Desgin.isInit){Box.Design.updateSeriesPanel=Desgin.view.updateSeriesPanel;for(var event in Desgin.view.bindEvent){Desgin.view.bindEvent[event]()}Desgin.isInit=true}},apply:function(option,isReal,map_convert){var build={type:[]};var seriesPanel=option.config.designPanel.seriesPanel;var collectSeriesData=Desgin.control.renderSeriesArray(seriesPanel.seriesData,option.mapType);var collectBaseType=[];var typeArray=_.pluck(collectSeriesData,"type");if(_.intersection(typeArray,["line","bar","scatter"]).length>0){collectBaseType.push("grid")}if(typeArray.indexOf("radar")>-1){collectBaseType.push("radar")}if(typeArray.indexOf("map")>-1){collectBaseType.push("map")}var baseOption=Desgin.control.collectBase(collectBaseType,"convert");var _option=baseOption.data;var _config=baseOption.config;_config.seriesPanel=seriesPanel;build.option=_option;build.seriesAuto=seriesPanel.seriesAuto;build.series=collectSeriesData;if(collectBaseType.indexOf("grid")>-1){build.yx=_option.bi.grid.yx}$("#"+option.el+" .dimAttrSettingPanel").hide("slide");if(isReal===false){var $el=$("#"+option.el);build.seriseIndex=$el.data("option").config.build.seriseIndex;build.ajaxURL=$el.data("option").config.build.ajaxURL;build.dataParams=$el.data("option").config.build.dataParams;var byDesgin=map_convert?true:false;$(".chart",$el).EBuilder(build,byDesgin);option.config.build=build;option.config.designPanel=_config;return}return{designPanel:_config,build:build}},change:function($el,id,val,prop){var type=id.split("-")[0];if(type=="series"){return}var echartsInstance=$(".chart",$el).EBuilder("getInstanceByDom");if(["pie","bar","line","scatter","funnel","map","gauge","heatmap"].indexOf(type)>-1||id=="radar2-fill"){Desgin.view.changeSeriesProp($el,id,val,prop,type,echartsInstance);return}var option=$el.data("option");$.extend(true,option.config.designPanel,prop);option.config.build.option=Collect.renderTemplate(["line","bar","grid"].indexOf(option.chartType)>-1?"grid":option.chartType,option.config.designPanel);if(echartsInstance){if(id=="bi-grid-xUnit"){prop={xAxis:[{axisLabel:{formatter:"{value}"+val}}]}}else{if(id=="bi-grid-yUnit"){prop={yAxis:[{axisLabel:{formatter:"{value}"+val}}]}}else{if(id=="radar-0-name-dataUnit"){prop={radar:[{name:{formatter:"{value}"+val}}]}}else{if(id=="radar-0-radius"){prop={radar:[{radius:val+"%"}]}}else{if(id=="bi-grid-yx"){var option=echartsInstance.getOption();var temp=option.xAxis;option.xAxis=option.yAxis;option.yAxis=temp;$el.data("option").config.build.yx=val;echartsInstance.setOption(option);return}else{if(id=="dataZoom-1-type"){var option=echartsInstance.getOption();if(val){option.dataZoom[1].type="inside"}else{delete option.dataZoom[1]}echartsInstance.setOption(option);return}else{if(id=="xAxis-0-position"){if(val=="top"){prop={xAxis:[{position:"top",axisLine:{onZero:false}}]}}else{prop={xAxis:[{position:"bottom",axisLine:{onZero:true}}]}}}else{if(id=="yAxis-0-max"){if(!val){prop={yAxis:[{max:null}]}}}else{if(id=="yAxis-0-min"){if(!val){prop={yAxis:[{min:null}]}}}else{if(id=="yAxis-0-type"){$("#yAxis-0-splitLine-show").prop("checked",true).change()}}}}}}}}}}echartsInstance.setOption(prop)}},collectBase:function(chartType,isConvert){var collectData=Collect.collectBaseTemplate(chartType);Box.Property.dataStart("collect",collectData);if(isConvert){return{data:Collect.renderTemplate(chartType,collectData),config:collectData}}return collectData},collectSeries:function(chartType,isConvert){var series_temp=Collect.collectSeriesTemplate(chartType);var chartChild=arguments[2];Box.Property.dataStart("collect",series_temp);if(isConvert){return{data:Collect.renderSeries(chartType,series_temp,chartChild),config:series_temp}}return series_temp},renderSeriesArray:function(seriesArray){var series=[];var chartChild=arguments[1];_.each(seriesArray,function(obj){var attrObj=_.indexObj(obj,0);series.push(Collect.renderSeries(attrObj.type,obj,chartChild))});return series}};Desgin.view={showSeriesChartPanelByType:function(chartType,config,isApply,map_convert){var $el=$("#"+Desgin.module.el);var $desginPanel=$("#chart-property");$(".seriesType",$desginPanel).hide();$('div[proptype="'+chartType+'"]',$desginPanel).show();$("#series-charts").val(chartType).trigger("chosen:updated");var $seriesAttrs=$("#series-attrs");var $selecedOption=$("option:selected",$seriesAttrs);$selecedOption.attr("chartType",chartType).text(Desgin.module.getNameByType(chartType)+" - "+$selecedOption.attr("modifyName"));$seriesAttrs.trigger("chosen:updated");var seriesPanel=$el.data("option").config.designPanel.seriesPanel;if(config){Box.Property.dataStart(config)}setTimeout(function(){var seriesNum=$seriesAttrs.find("option:selected").index();if($("#attrPanel .dimAttrField").length>0){$("#attrPanel .dimAttrField").eq(seriesNum).data("dimAttrData").seriesType=chartType;if($el.data("option").isInit){$el.data("option").config.dataPanel.attrData[seriesNum].seriesType=chartType}var seriesObj=Desgin.control.collectSeries(chartType,"isConvert",$el.data("option").mapType);var selectSeriesValue=$seriesAttrs.find("option:selected").val();if(seriesPanel.seriesData.single){seriesPanel.seriesData.single=seriesObj.config}else{seriesPanel.seriesData[selectSeriesValue]=seriesObj.config}}var $xyPanel=$desginPanel.find('div[proptype="xy"]:eq(0)');if(["line","bar","scatter"].indexOf(chartType)>-1){$xyPanel.show()}else{var typeArray=_.map(seriesPanel.seriesData,function(obj){return _.indexObj(obj,0).type});if(_.intersection(typeArray,["line","bar","scatter"]).length==0){$xyPanel.hide()}if(typeArray.indexOf("gauge")>-1){$desginPanel.find('div[proptype="legend"]:eq(0)').hide()}else{$desginPanel.find('div[proptype="legend"]:eq(0)').show()}}if(isApply){Desgin.control.apply($el.data("option"),false,map_convert)}},100)},updateSeriesPanel:function(_attrData){var attrData=eval("("+$.toJSON(_attrData)+")");var $desginPanel=$("#chart-property");var $seriesPanel=$('div[proptype="series"]',$desginPanel);var $seriesAttrs=$("#series-attrs");_.map(attrData,function(obj,n){obj.label=Desgin.module.getNameByType(obj.seriesType)+" - "+obj.modifyName});$seriesAttrs.html($.tmpl('<option  chartType=${seriesType} modifyName="${modifyName}" value="${seriesId}">${label}</option>',attrData)).trigger("chosen:updated");var $seriesCharts=$("#series-charts");if(Desgin.module.chartType=="gauge"){$seriesCharts.html('<option value= "gauge" selected>仪表盘</option>').trigger("chosen:updated")}else{if(Desgin.module.chartType=="radar"){$seriesCharts.html('<option value= "radar" selected>雷达图</option>').trigger("chosen:updated")}else{$seriesCharts.html("<option  value= 'pie'>饼图</option><option value='bar'>柱图</option><option value='line'>线图</option><option value='funnel'>漏斗图</option><option value='map'>地图</option><option value='heatmap'>热力图</option>").trigger("chosen:updated")}}$seriesCharts.val(Desgin.module.chartType).trigger("chosen:updated");var $el=$("#"+Desgin.module.el);var seriesPanel=$el.data("option").config.designPanel.seriesPanel;if(seriesPanel==undefined||seriesPanel.seriesAuto){Desgin.view.setSeriseState(true);if(Desgin.module.chartType=="pie"){$("#pie-centerX,#pie-centerY").parents(".items").hide()}else{if(Desgin.module.chartType=="funnel"){$("#funnel-left,#funnel-top").parents(".items").hide()}else{if(Desgin.module.chartType=="map"){$("#map-left,#map-top,#map-width").parents(".items").hide()}else{if(Desgin.module.chartType=="gauge"){$("#gauge-centerX,#gauge-centerY").parents(".items").hide()}}}}}if(_.keys(seriesPanel).length==0){var seriesProp=Desgin.control.collectSeries(Desgin.module.chartType);$el.data("option").config.designPanel.seriesPanel={seriesAuto:true,seriesData:{single:seriesProp}}}else{if(!seriesPanel.seriesAuto){var seriesData={};var keys=_.keys(seriesPanel.seriesData);_.each(_attrData,function(obj,index){var seriesId=obj.seriesId;var series=seriesPanel.seriesData[seriesId];if(series){seriesData[seriesId]=series}else{seriesData[seriesId]=Collect.collectSeriesTemplate($el.data("option").chartType)}if(index==0){var _temp=seriesData[seriesId];Desgin.view.showSeriesChartPanelByType(_.keys(_temp)[0],_temp)}});$el.data("option").config.designPanel.seriesPanel.seriesData=seriesData}}$seriesPanel[attrData.length==0||Desgin.module.chartType=="scatter"?"hide":"show"]();if(Desgin.module.chartType=="radar"){$seriesPanel.hide()}},changeSeriesProp:function($el,id,val,prop,type,echartsInstance){var $seriesAttrs=$("#series-attrs");var $selectSeries=$seriesAttrs.find("option:selected");var selectSeriesValue=$selectSeries.val();var seriesPanel=$("#"+Desgin.module.el).data("option").config.designPanel.seriesPanel;var seriesObj=Desgin.control.collectSeries(type,"isConvert",$el.data("option").mapType);var seriesConfig=seriesObj.config;var serie=seriesObj.data;if(seriesPanel.seriesAuto){if(type=="pie"){delete serie.center}else{if(type=="funnel"){delete serie.top;delete serie.left}else{if(type=="map"){delete serie.width;delete serie.left;delete serie.top}else{if(type=="gauge"){delete serie.center}}}}seriesPanel.seriesData={single:seriesConfig};$("#"+Desgin.module.el).data("option").config.build.series=[serie];Desgin.view.updateSeriesChart({updateNum:"all",updateObj:serie,echartsInstance:echartsInstance})}else{var seriesNum=$selectSeries.index();seriesPanel.seriesData[selectSeriesValue]=seriesConfig;var checkArray=[];$("#attrPanel .icon-checkbox.checked").each(function(){checkArray.push($(this).parents(".dimAttrField").data("dimAttrData").seriesId)});$("#"+Desgin.module.el).data("option").config.build.series[seriesNum]=serie;var index=checkArray.indexOf(selectSeriesValue);if(index>-1){Desgin.view.updateSeriesChart({updateNum:index,updateObj:serie,echartsInstance:echartsInstance})}}},setSeriseState:function(disabled){var $chartProperty=$("#chart-property");var $seriesAttr=$("#series-attrs");var $seriesCharts=$("#series-charts");if(disabled===true){$(".cs-button.update",$chartProperty).addClass("active");$(".cs-button.makeSure",$chartProperty).removeClass("active");$seriesCharts.setDisabled(true);$seriesAttr.setDisabled(true)}else{$(".cs-button.update",$chartProperty).removeClass("active");$(".cs-button.makeSure",$chartProperty).addClass("active");$seriesCharts.setDisabled(false);$seriesAttr.setDisabled(false)}},updateSeriesChart:function(config){var $el=$("#"+Desgin.module.el);if(config.echartsInstance){var option=config.echartsInstance.getOption();if(config.updateNum=="all"){var series=[];_.each(option.series,function(obj){series.push(config.updateObj)});$.extend(true,option.series,series)}else{$.extend(true,option.series[config.updateNum],config.updateObj)}config.echartsInstance.setOption(option)}},bindEvent:{changeAttr:function(){$("#series-attrs").change(function(event,obj){var $this=$(this);var chartType=$("option:selected",$this).attr("chartType");$("#series-charts").val(chartType).trigger("chosen:updated");var seriesId=obj.selected;var seriesConfig=$("#"+Desgin.module.el).data("option").config.designPanel.seriesPanel.seriesData[seriesId];Desgin.view.showSeriesChartPanelByType(chartType,seriesConfig)})},changeChartType:function(){$("#series-charts").change(function(event,obj){var $this=$(this);var isInit=$("#"+Desgin.module.el).data("option").isInit;if(!isInit){Desgin.view.showSeriesChartPanelByType(obj.selected);return}Box.Property.showTip({_id:"cseries",msg:"<br/>切换当前指标的系列图形将会丢失设计配置！您确定切换当前指标的系列吗？",button:'<div class="btn changeChart" style="width: 196px;">更换</div><div class="btn cancelChange" style="width: 196px;">取消</div>'});$("#cseries .changeChart").click(function(){Box.Property.hideTip("cseries");Desgin.view.showSeriesChartPanelByType(obj.selected,null,"isApply",obj.beforeSelected=="map"?"map_convert":null)});$("#cseries .cancelChange").click(function(){Box.Property.hideTip("cseries");$this.val(obj.beforeSelected).trigger("chosen:updated")})})},startChange:function(){$("#chart-property .cs-button.update").click(function(){if($(this).hasClass("active")){Desgin.view.setSeriseState(false);var config=$("#"+Desgin.module.el).data("option").config;var seriesPanel=config.designPanel.seriesPanel;seriesPanel.seriesAuto=false;var seriesData=_.indexObj(seriesPanel.seriesData,0);var newData={};var series=[];$("#series-attrs option").each(function(n,obj){newData[obj.value]=seriesData;series.push(Collect.renderSeries($(obj).attr("chartType"),seriesData,$(obj).attr("chartChild")))});seriesPanel.seriesData=newData;config.build.series=series;config.build.seriesAuto=false;$("#gauge-centerX,#gauge-centerY,#pie-centerX,#pie-centerY,#funnel-left,#funnel-top,#map-left,#map-top,#map-width").parents(".items").show()}})},startDefault:function(){$("#chart-property .cs-button.makeSure").click(function(){if($(this).hasClass("active")){Desgin.view.setSeriseState(true);var chartType=$("#series-charts").val();var $changeSeriesAttr=$("#series-attrs");var selectedPanelIndex=$changeSeriesAttr.find("option:selected").index();var $el=$("#"+Desgin.module.el);var seriesPanel=$el.data("option").config.designPanel.seriesPanel;var singleSeries=_.indexObj(seriesPanel.seriesData,selectedPanelIndex);seriesPanel.seriesAuto=true;seriesPanel.seriesData={single:singleSeries};$("#attrPanel .dimAttrField").each(function(){$(this).data("dimAttrData").seriesType=chartType});$("option",$changeSeriesAttr).each(function(){$(this).attr("chartType",chartType).text(Desgin.module.getNameByType(chartType)+" - "+$(this).attr("modifyName"))});$changeSeriesAttr.trigger("chosen:updated");var $gridPanel=$("#chart-property").find('div[proptype="xy"]:eq(0)');if(["line","bar","scatter"].indexOf(chartType)>-1){$gridPanel.show()}else{$gridPanel.hide()}if($el.data("option").isInit){Desgin.control.apply($el.data("option"),false)}$("#gauge-centerX,#gauge-centerY,#pie-centerX,#pie-centerY,#funnel-left,#funnel-top,#map-left,#map-top,#map-width").parents(".items").hide()}})}}};Desgin.module={el:"",chartType:"",config:{title:{title:"标题",state:"close",items:[{id:"title-text",lable:"主标题:",type:"input",value:""},{id:"title-subtext",lable:"副标题:",type:"input",value:""},{id:"title-textStyle-color",lable:"颜色:",type:"color",value:"rgba(0,0,0,1)",position:"bottom left-30"},{id:"title-left",lable:"水平:",type:"select",width:"70px",selectHTML:"<option value='left' >居左</option><option value='center' selected>居中</option><option value='right'>居右</option>",style:"position:absolute;top:60px;right:2px"},{id:"title-textStyle-fontSize",lable:"大小:",type:"spaceInput",value:22,width:"13px"},{id:"title-top",lable:"垂直:",type:"select",width:"70px",selectHTML:"<option value= 'top' selected>顶部</option><option value='middle' >中间</option><option value='bottom' >置底</option>",style:"position:absolute;top:90px;right:2px"},]},legend:{title:"图例",state:"close",items:[{id:"legend-show",lable:"标签:",type:"switchbutton",value:true},{id:"legend-orient",lable:"排版:",type:"select",width:"65px",selectHTML:"<option value='horizontal' selected>横排</option><option value='vertical' >竖排</option>"},{id:"legend-itemGap",lable:"间隔:",type:"spaceInput",value:"5",width:"30px",style:"position:absolute;top:30px;right:-7px"},{id:"legend-top",lable:"垂直:",type:"select",width:"65px",selectHTML:"<option value='top'  >顶部</option><option value='middle' >中间</option><option value='bottom' selected>置底</option>"},{id:"legend-left",lable:"水平:",type:"select",width:"63px",selectHTML:"<option value='left' >居左</option><option value='center' selected>居中</option><option value='right' >居右</option>",style:"position:absolute;top:60px;right:-8px"},]},colorSet:{title:"图例颜色",state:"close"},xy:{title:"X轴 <span class='circle'>●</span> Y轴",state:"close",items:[{id:"xAxis-0-show",lable:"<strong style='color:#508FC5'>X轴:</strong>",type:"switchbutton",value:true,style:"margin-left:1px"},{id:"xAxis-unit-switch",lable:"<strong id='xUnit-switch' style='color:#508FC5'>X轴单位换算:</strong>",type:"switchbutton",value:true,style:"margin-left:1px"},{id:"bi-grid-xUnit",lable:"X轴单位:",type:"input",width:"136px"},{id:"xAxis-0-name",lable:"X轴名称:",type:"input",width:"136px"},{id:"xAxis-0-axisLabel-interval",lable:"X值展示:",type:"select",width:"136px",selectHTML:"<option  value='auto'  selected>自适应展示</option><option value=0>全部展示</option>"},{id:"xAxis-0-position",lable:"X轴位置:",type:"select",width:"134px",selectHTML:"<option  value='top' >顶部</option><option value='bottom' selected>底部</option>"},{id:"xAxis-0-nameLocation",lable:"名称位置:",type:"select",width:"134px",selectHTML:"<option  value='start'  selected>起始位置</option><option value='selected'>中间</option><option value='end' selected>结束位置</option>"},{id:"xAxis-0-inverse",lable:"X轴反转:",type:"switchbutton",value:false},{id:"xAxis-0-axisLine-lineStyle-color",lable:"X轴颜色:",type:"color",value:"rgba(0,0,0,.8)",position:"bottom left-40"},{id:"xAxis-0-axisLabel-rotate",lable:"X轴值旋转角度：<span>0</span>度",value:0,type:"slider",width:"190px",min:0,max:90},{id:"xAxis-0-axisTick-show",lable:"X轴刻度:",type:"switchbutton",value:true},{id:"xAxis-0-splitArea-show",lable:"X分割色:",type:"switchbutton",value:false},{id:"xAxis-0-splitLine-show",lable:"X分割线:",type:"switchbutton",value:false},{id:"dataZoom-0-show",lable:"X轴数值缩放轴:",type:"switchbutton",value:false},{id:"dataZoom-1-type",lable:"使用滚轮缩放:",type:"switchbutton",value:true,style:"display:none"},{id:"yAxis-0-show",lable:"<strong style='color:#508FC5'>Y轴:</strong>",type:"switchbutton",value:true,style:"margin-left:1px;margin-top: 9px;padding-top: 9px;border-top:1px solid #ddd"},{id:"yAxis-unit-switch",lable:"<strong id='yUnit-switch' style='color:#508FC5'>Y轴单位换算:</strong>",type:"switchbutton",value:true,style:"margin-left:1px"},{id:"bi-grid-yUnit",lable:" Y轴单位:",type:"input",width:"136px"},{id:"yAxis-0-name",lable:" Y轴名称:",type:"input",width:"136px"},{id:"yAxis-0-type",lable:" Y轴类型:",type:"select",width:"136px",selectHTML:"<option  value='value' selected>数值</option><option value='time'>时间</option>"},{id:"yAxis-0-position",lable:"Y轴位置:",type:"select",width:"136px",selectHTML:"<option  value='right'>右侧</option><option value='left' selected>默认左侧</option>"},{id:"yAxis-0-max",lable:"最大刻度:",type:"spaceInput",width:"103px"},{id:"yAxis-0-min",lable:"最小刻度:",type:"spaceInput",width:"103px"},{id:"yAxis-0-inverse",lable:"Y轴反转:",type:"switchbutton",value:false},{id:"yAxis-0-axisLine-lineStyle-color",lable:"Y轴颜色:",type:"color",value:"rgba(0,0,0,.8)",position:"bottom left-40"},{id:"yAxis-0-axisTick-show",lable:"Y轴刻度:",type:"switchbutton",value:true},{id:"yAxis-0-splitArea-show",lable:"Y分割色:",type:"switchbutton",value:false},{id:"yAxis-0-splitLine-show",lable:"Y分割线:",type:"switchbutton",value:false},{id:"",lable:"图形与画布的间距",style:"height:26px;line-height:26px"},{id:"grid-top",lable:"上:",type:"spaceInput",value:48,width:"36px"},{id:"grid-bottom",lable:"下:",type:"spaceInput",value:35,width:"36px",style:"position:absolute;bottom:80px;right:2px"},{id:"grid-left",lable:"左:",type:"spaceInput",value:15,width:"36px"},{id:"grid-right",lable:"右:",type:"spaceInput",value:35,width:"36px",style:"position:absolute;bottom:50px;right:2px"},{id:"bi-grid-yx",lable:" X | Y轴互换:",type:"switchbutton",value:false,style:"margin-left:1px;margin-top: 9px;padding-top: 9px;border-top:1px solid #ddd"},]},help:{title:"辅助",state:"close",items:[{id:"tooltip-showContent",lable:"悬浮提示:",type:"switchbutton",value:true,},{id:"toolbox-show",lable:"辅助工具栏:",type:"switchbutton",value:true},]},penetrate:{}},getNameByType:function(chartType){switch(chartType){case"pie":return"饼图";break;case"bar":return"柱图";break;case"line":return"线图";break;case"scatter":return"散点图";break;case"funnel":return"漏斗图";break;case"radar":return"雷达图";break;case"gauge":return"仪表盘";break;case"map":return"地图";break;case"treemap":return"矩形树图";break;case"heatmap":return"热力图";break;default:return"图形";break}}};return Desgin.control});