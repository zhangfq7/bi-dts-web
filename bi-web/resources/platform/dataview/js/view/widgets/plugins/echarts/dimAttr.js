define(["bace","view/box","view/component/levelUtil","underscore"],function(d,a,e,c){var b={};b.module={chartType:"",el:"",mapType:""};b.control={init:function(f){b.view.initDimAttrPanel()},collect:function(){var g=[];$("#dimPanel .dimAttrField").each(function(){g.push($(this).data("dimAttrData"))});var i=[];$("#attrPanel .dimAttrField").each(function(){i.push($(this).data("dimAttrData"))});var h=[];$("#graphPanel .dimAttrField").each(function(){h.push($(this).data("dimAttrData"))});var f={dimData:g,attrData:i,graphData:h};return f},render:function(h){var j=h.config.dataPanel;b.module.chartType=h.chartType;b.module.el=h.el;b.module.mapType=h.mapType;$("#attrPanel .select").chosen("destroy");$("#dimPanel .dimAttrField").remove();$("#attrPanel .dimAttrField").remove();$("#graphPanel .dimAttrField").remove();var l=j.attrData||[];for(var g=0,m=l.length;g<m;g++){$("#attrPanel").append(b.view.packDimAttr("attrPanel",l[g]))}if(b.module.chartType=="gauge"){$("#data-property").addClass("gaguePanel")}else{$("#data-property").removeClass("gaguePanel");var f=j.dimData||[];for(var g=0,m=f.length;g<m;g++){$("#dimPanel").append(b.view.packDimAttr("dimPanel",f[g]))}}if(h.mapType==="twoDimension"){$("#data-property .graphTitle,#data-property .graphPanel").css("display","inline-block");$("#data-property").find("div.dimPanel:first").addClass("addDimPanel").parent().find(".attrTitle").addClass("addAttrTitle").parent().find(".attrPanel").addClass("addAttrPanel");d.autoScroll($("#graphPanel"));$("#attrPanel").off("click",".dimAttrField .icon-checkbox");$("#attrPanel").on("click",".dimAttrField .icon-checkbox",function(){var o=$(this);var p=o.parents("#attrPanel");p.find(".dimAttrField").each(function(){var q=$(this);q.data("dimAttrData").isChecked=false;q.find(".icon-checkbox").removeClass("checked")});var n=o.parents(".dimAttrField");var i=n.data("dimAttrData");if(o.hasClass("checked")){o.removeClass("checked");i.isChecked=false}else{o.addClass("checked");i.isChecked=true}});var k=j.graphData||[];for(var g=0,m=k.length;g<m;g++){$("#graphPanel").append(b.view.packDimAttr("graphPanel",k[g]))}}else{if(h.mapType!=="twoDimension"){$("#data-property .graphTitle,#data-property .graphPanel").css("display","none");$("#data-property").find("div.dimPanel:first").removeClass("addDimPanel").parent().find(".attrTitle").removeClass("addAttrTitle").parent().find(".attrPanel").removeClass("addAttrPanel");$("#attrPanel").off("click",".dimAttrField .icon-checkbox");$("#attrPanel").on("click",".dimAttrField .icon-checkbox",function(){var o=$(this);console.log(o);var n=$(this).parents(".dimAttrField");var i=n.data("dimAttrData");if(o.hasClass("checked")){if($("#attrPanel").find(".checked").length==1){return}o.removeClass("checked");i.isChecked=false}else{o.addClass("checked");i.isChecked=true}})}}$("#attrPanel .select").chosen({width:"100%",disable_search:true});b.view.updateTplAttrPanel()},getCheckedDimAttr:function(h){var f=$.map(h.dimData,function(k){if(k.isChecked){return k}});var j=$.map(h.graphData,function(k){if(k.isChecked){return k}});var g=[];var i=$.map(h.attrData,function(l,k){if(l.isChecked){g.push(k);return l}});return{data:{dimData:f,attrData:i,graphData:j},indexArray:g}},checkDiff:function(f){var g=$("#"+b.module.el).data("option");if(g.isInit===false&&f){return true}var i=b.control.collect();if(i.dimData.length==0&&i.attrData.length==0){i={}}var h=g.config.dataPanel;if(!(c.isEqual(i,h))){return false}return true},checkValidity:function(p){var m=p.dimData;var o=p.graphData;var f=p.attrData;if($("#attrPanel .attrDimText.vr").length>0){return"请设置模板位指标！"}if(b.module.chartType=="gauge"){if(f.length==0){return"仪表盘需要设置指标数据！"}}else{if(b.module.chartType=="scatter"){if(m.length==0){return"该图形需要设置维度数据！"}if(f.length<2){return"散点图最少需要设置2个指标数据！"}}else{if(b.module.chartType=="bar"){if(b.module.mapType==="twoDimension"){if(o.length===0){return"二维柱图需要设置图形维度数据!"}}}else{if(b.module.chartType=="heatmap"){var q=false;for(var j=0;j<m.length;j++){var k=m[j];var h=k.isChecked;var r=k.dimType;if(h&&"complex"==r){q=true;break}}if(!q){return"请设置并选择组合维度！"}if(f.length==0){return"请设置指标！"}var g=0;for(var j=0;j<f.length;j++){var n=f[j];var h=n.isChecked;if(h){g++}}if(g>1){return"此类型热力图只可以设定一个指标！"}}else{var l="";if(m.length==0){l+="该图形需要设置维度数据！<br/>"}if(f.length==0){l+="该图形需要设置指标数据！"}return l}}}}}};b.view={initDimAttrPanel:function(){var f={connectWith:"#attrPanel,#dimPanel,#graphPanel",appendTo:"body",delay:200,handle:".attrDimText",containment:"#propertyPanel",cancel:".attrDimText.vr",placeholder:"dimAttr-placeholder",scroll:true,helper:function(k,l){var j=$(l);var i=j.data("dimAttrData");return $("<div>",{"data-attrid":i.attrId,"data-attrtype":i.attrType,"data-attrclass":i.attrClass,"data-fieldname":i.fieldName,"data-columnscale":i.columnScale,"data-filtertype":i.filterType,"data-attrname":i.attrName,"data-dimId":i.dimId,"data-modifyname":i.modifyName||i.attrName,style:"z-index:9999999;height:30px",html:i.modifyName||i.attrName,"data-diyRelation":i.diyRelation}).addClass("attr-helper").appendTo("body")},over:function(i,j){},stop:function(m,o){var k=o.item;var j=k.parent().attr("id"),i={};if("attrPanel"===j&&k.find(".attrDimText").hasClass("complex")){return false}if(k.attr("data-attrid")){var l=k.attr("data-attrname");i={attrId:k.attr("data-attrid"),attrName:l,modifyName:k.attr("data-modifyname")||k.attr("data-attrname"),attrType:k.attr("data-attrtype"),attrClass:k.attr("data-attrclass"),fieldName:k.attr("data-fieldname"),columnScale:k.attr("data-columnscale"),filterType:k.attr("data-filterType"),dimId:k.attr("data-dimId"),diyRelation:k.attr("data-diyRelation"),isChecked:true,fanyi:true}}else{i=k.data("dimAttrData");if(i.fanyi===undefined){i.fanyi=true}}var n=b.view.packDimAttr(j,i,"isDray");o.item.replaceWith(n);setTimeout(function(){if(o.helper){o.helper.remove()}},0);if(j=="attrPanel"){$("#attrPanel .select").chosen({width:"100%",disable_search:true});b.view.checkAttrName();b.view.updateDesginAttr();b.view.updateTplAttrPanel(n)}else{if(j=="dimPanel"){b.view.updateDesginAttr()}}$("#dimPanel .checked").length==0&&$("#dimPanel .dimAttrField").eq(0).find(".icon-checkbox").click();$("#attrPanel .checked").length==0&&$("#attrPanel .dimAttrField").eq(0).find(".icon-checkbox").click();$("#graphPanel .checked").length==0&&$("#graphPanel .dimAttrField").eq(0).find(".icon-checkbox").click()}};$("#dimPanel").sortable(f).disableSelection();$("#attrPanel").sortable(f).disableSelection();$("#graphPanel").sortable(f).disableSelection();var h=b.view.bindDimAttrEvent;for(var g in h){h[g]()}d.autoScroll($("#dimPanel"));d.autoScroll($("#attrPanel"))},checkAttrName:function(){var f=[];$("#attrPanel .dimAttrField").each(function(h){var j=$(this);var g=j.data("dimAttrData").modifyName;if(f.indexOf(g)>-1){g+=h;j.data("dimAttrData").modifyName=g;j.attr("title",g).find(".attrDimText").text(g)}f.push(g)})},updateDesginAttr:function(){var f=[];$("#attrPanel .dimAttrField").each(function(){f.push($(this).data("dimAttrData"))});a.Design.updateSeriesPanel(f)},packDimAttr:function(l,k,f){var m,n;if(!(k.dimType&&"complex"==k.dimType)){m=$.extend(true,{},k);n=$.extend(true,{},k);n.chartType=b.module.chartType;n.mapType=b.module.mapType;if(!m.id){m.id=m.attrId+(new Date()).getTime()}switch(n.order){case"desc":n.orderText="降序";break;case"asc":n.orderText="升序";break;default:n.orderText="排序";break}n.fanyiText=n.fanyi?"取消翻译":"翻译"}else{m=JSON.parse(JSON.stringify(k));n={modifyName:c.pluck(m.dimList,"modifyName").join(" + "),attrId:c.pluck(m.dimList,"attrId").join("||"),attrName:c.pluck(m.dimList,"attrName").join("||"),attrType:c.pluck(m.dimList,"attrType").join("||"),attrClass:c.pluck(m.dimList,"attrClass").join("||"),fieldName:c.pluck(m.dimList,"fieldName").join("||"),columnScale:c.pluck(m.dimList,"columnScale").join("||"),filterType:c.pluck(m.dimList,"filterType").join("||"),dimId:c.pluck(m.dimList,"dimId").join("||"),isChecked:c.some(m.dimList,function(o){return !!o.isChecked}),fanyi:c.some(m.dimList,function(o){return !!o.fanyi}),order:m.dimList[0].order||""};console.log(m);m.dimList=c.map(m.dimList,function(o){return c.extend(o,{isChecked:n.isChecked,fanyi:n.fanyi})});c.extend(m,n);n.fanyiText=n.fanyi?"取消翻译":"翻译";n.chartType=b.module.chartType;switch(n.order){case"desc":n.orderText="降序";break;case"asc":n.orderText="升序";break;default:n.orderText="排序";break}}n.parentPanel=l;var g="";if(l=="attrPanel"){delete m.levelId;delete m.fanyi;delete n.levelId;delete n.fanyi;var i=n.funcName;if(!i){if(b.module.chartType=="scatter"&&m.attrType=="1"){m.funcName=n.funcName="";if(m.modifyName.indexOf("默认")==-1){m.modifyName=m.attrName=n.modifyName="[ 默认 ] "+n.modifyName}else{m.modifyName=m.attrName=n.modifyName}}else{if(m.modifyName.indexOf("默认")>-1){m.funcName=n.funcName="";m.modifyName=m.attrName=n.modifyName}else{m.funcName=n.funcName="count";m.modifyName=m.attrName=n.modifyName="[ 计数 ] "+n.modifyName}}}if(!m.seriesId){m.seriesId=m.attrId+(new Date()).getTime();m.seriesType=b.module.chartType}if(b.module.mapType==="twoDimension"){if(f){var h=$("#attrPanel .checked").eq(0);b.view.dimGraphIsChecked(h,n,m)}else{if($("#attrPanel .checked").length>0){n.isChecked=m.isChecked=false}}}else{if(f){n.isChecked=m.isChecked=true}}if(n.isTpl===true){g='<div class="dimAttrField ${order}" ><div class="attrDimPanel vr"><div class="icon-vr"></div><div class="attrDimText vr">${attrName}</div></div></div>'}else{g='<div class="dimAttrField ${order}" ><div class="attrDimPanel">	<div class="icon-checkbox {{if isChecked==true}} checked {{/if}}"></div>	<div class="attrDimText" title="${modifyName}">${modifyName}</div><div class="delAttrDim" deltag="attr" title="移除该指标"></div></div><div class="attrDimTools">		<div style="width:50%;text-align:left;padding:0 3px;">			<select class="select">			{{if chartType == "scatter"}}	<option  {{if funcName=="" }} selected {{/if}}value="">无</option>{{/if}}			{{if attrType=="1"}}				<option  {{if funcName=="sum"}} selected {{/if}}value="sum">求和</option>				<option  {{if funcName=="avg"}} selected {{/if}}value="avg">平均值</option>			{{/if}}           {{if attrClass != "3"}}				<option  {{if funcName=="max"}} selected {{/if}}value="max">最大值</option>				<option  {{if funcName=="min"}} selected {{/if}}value="min">最小值</option>			{{/if}}				<option  {{if funcName=="count"}} selected {{/if}}value="count">计数</option>			</select>		</div>		{{if ["map","funnel"].indexOf(chartType) == -1 }} <div class="order">			<div>${orderText}</div>		</div>{{/if}}		<div class="modifyName" {{if chartType == "funnel" ||  chartType=="map" }} style="width:50%" {{/if}} >			<div >重命名</div>		</div></div></div>'}}else{if(l=="dimPanel"||l=="graphPanel"){var j=/\[ 求和 \]|\[ 平均值 \]|\[ 最大值 \]|\[ 最小值 \]|\[ 计数 \]|\[ 默认 \]/g;if(k.dimType&&"complex"==k.dimType){c.each(m.dimList,function(o){delete o.funcName;o.modifyName&&(o.modifyName=o.modifyName.replace(j,""));o.attrName&&(o.modifyName=o.attrName.replace(j,""))});n.modifyName=n.modifyName.replace(j,"");n.attrName=n.attrName.replace(j,"");n.dimType="complex"}else{delete m.funcName;delete n.funcName;n.fendangText=n.levelId?"已分档":"分档";n.modifyName=m.modifyName=m.modifyName.replace(j,"");m.attrName=m.attrName.replace(j,"");n.dimType="single";if(l=="dimPanel"){if(f){var h=$("#dimPanel .checked").eq(0);b.view.dimGraphIsChecked(h,n,m)}else{if($("#dimPanel .checked").length>0){n.isChecked=m.isChecked=false}}}else{if(l=="graphPanel"){if(f){var h=$("#graphPanel .checked").eq(0);b.view.dimGraphIsChecked(h,n,m)}else{if($("#graphPanel .checked").length>0){n.isChecked=m.isChecked=false}}}}}g='<div class="dimAttrField ${order}"><div class="attrDimPanel">	<div class="icon-checkbox {{if isChecked==true}} checked {{/if}}"></div>	<div class={{if dimType=="complex"}}"attrDimText complex"{{else}}"attrDimText"{{/if}}  title="${modifyName}">${modifyName}</div> {{if dimType!="complex" && chartType!="map" && mapType!="twoDimension" && parentPanel=="dimPanel" }} <div class="complexDim" title="维度组合"></div> {{/if}} <div class="delAttrDim" deltag="dim" title="移除该维度"></div></div><div class="attrDimTools">		{{if chartType!="map" && dimType!="complex" && attrClass == "0"}}<div class="fendang"  {{if   dimId=="" && chartType=="funnel" || attrClass !="0"}} style="width:50%" {{/if}} >			<div >${fendangText}</div>		</div>{{/if}}		{{if dimId!="" && dimId!="||"}} <div class="fanyi"  {{if  chartType=="map" &&   dimId!="" &&  dimId!="||" || attrClass !="0" }} style="width:50%" {{/if}}>			<div >${fanyiText}</div>		</div>{{/if}}		{{if ["map","funnel"].indexOf(chartType) == -1  }}<div class="order" {{if  dimId=="||" || attrClass !="0" }} style="width:50%" {{/if}} >			<div >${orderText}</div>		</div>{{/if}}		<div class="modifyName" {{if  chartType=="map"  &&   dimId =="" }}  style="width:100%"  {{else  dimId=="" || (chartType=="map"  &&   dimId !="") || dimType=="complex" || attrClass !="0"}}  style="width:50%" {{/if}} >			<div>重命名</div>		</div></div></div>'}}return $.tmpl(g,n).data("dimAttrData",m)},dimGraphIsChecked:function(h,g,f){if(h.outerHTML()){if(h.parents(".dimAttrField").data("dimAttrData").id==f.id){g.isChecked=f.isChecked=true}else{g.isChecked=f.isChecked=false}}else{g.isChecked=f.isChecked=true}},updateTplAttrPanel:function(i){var j=$("#"+b.module.el).data("option");var g=j.tplCount;var l=$("#attrPanel");var h=$(".attrDimPanel.vr",l);if(i&&h.length>0){var f=h.eq(0).parent();var n=f.data("dimAttrData");var o=i.data("dimAttrData");if(j.config.designPanel.seriesPanel.seriesAuto===false){var m=j.config.designPanel.seriesPanel.seriesData[n.seriesId];j.config.designPanel.seriesPanel.seriesData[o.seriesId]=m;o.seriesType=n.seriesType;delete j.config.designPanel.seriesPanel.seriesData[n.seriesId]}h.eq(0).parent().remove();b.view.updateDesginAttr()}if(g>0){var k=$(".dimAttrField",l);k.each(function(q){var p=$(this);if(q<g){p.addClass("tplAttrBg")}else{p.removeClass("tplAttrBg")}})}},bindDimAttrEvent:{bindDelAttrDim:function(){$("#propertyTabs").on("click","div[proptype='echarts'] div.delAttrDim",function(){var g=$(this);var f=g.attr("deltag");g.parents(".dimAttrField").fadeOut(200,function(){var i=$(this);if(f=="attr"){if(i.hasClass("tplAttrBg")){var h=$("#"+b.module.el).data("option");h.tplCount--}i.remove();b.view.updateDesginAttr()}else{i.remove()}})})},bindComplexDim:function(){$("#propertyPanel").on("click","div.complexDim",function(){var g=$(this).closest(".attrDimPanel");var f=g.parent();if(g.hasClass("complexActive")){g.removeClass("complexActive");f.siblings().show();$("#dimPanel").sortable("enable");g.hasClass("ui-droppable")&&g.droppable("destroy")}else{g.addClass("complexActive");f.siblings().hide();f.hasClass("open")&&f.animate({height:"30px"},200).removeClass("open");$("#dimPanel").sortable("disable");g.droppable({hoverClass:"onDrop",drop:function(j,k){var l=$(this);var m=$(k.helper);var n={attrId:m.data("attrid"),attrName:m.data("attrname"),modifyName:m.data("modifyname")||m.data("attrname"),attrType:m.data("attrtype"),attrClass:m.data("attrclass"),fieldName:m.data("fieldname"),columnScale:m.data("columnscale"),filterType:m.data("filtertype"),dimId:m.data("dimid"),isChecked:false,fanyi:true};var i=l.parent(".dimAttrField").data("dimAttrData");if(i.attrId===n.attrId){return false}var h=b.view.packDimAttr("dimPanel",{dimList:[i,n],dimType:"complex"});l.parent(".dimAttrField").replaceWith(h);$(".dimAttrField","#dimPanel").show();$("#dimPanel").sortable("enable")}})}})},bindOpenDimAttrOpt:function(){$("#dimPanel,#attrPanel,#graphPanel").on("click",".attrDimText",function(){var g=$(this);if(g.hasClass("vr")){return}if(g.parent().hasClass("complexActive")){return}var f=g.parents(".dimAttrField");f.siblings().removeClass("open").animate({height:"30px"},200);(f.hasClass("open")?f.animate({height:"30px"},200):f.animate({height:"62px"},200)).toggleClass("open");$("#dimPanel input,#attrPanel input").blur()})},bindCheckBox:function(){$("#attrPanel").on("click",".dimAttrField .icon-checkbox",function(){var h=$(this);var g=$(this).parents(".dimAttrField");var f=g.data("dimAttrData");if(h.hasClass("checked")){if($("#attrPanel").find(".checked").length==1){return}h.removeClass("checked");f.isChecked=false}else{h.addClass("checked");f.isChecked=true}});$("#dimPanel,#graphPanel").on("click",".dimAttrField .icon-checkbox",function(){var j=$(this);var h=j.parents("#dimPanel");var g=j.parents("#graphPanel");h.find(".dimAttrField").each(function(){var l=$(this);var k=l.data("dimAttrData");k.isChecked=false;l.find(".icon-checkbox").removeClass("checked");if(k.dimType&&"complex"===k.dimType){c.each(k.dimList,function(n,m){c.extend(n,{isChecked:k.isChecked})})}});g.find(".dimAttrField").each(function(){var k=$(this);k.data("dimAttrData").isChecked=false;k.find(".icon-checkbox").removeClass("checked")});var i=j.parents(".dimAttrField");var f=i.data("dimAttrData");if(j.hasClass("checked")){j.removeClass("checked");f.isChecked=false}else{j.addClass("checked");f.isChecked=true}if(f.dimType&&"complex"===f.dimType){c.each(f.dimList,function(l,k){c.extend(l,{isChecked:f.isChecked})})}});$("#dimPanel,#attrPanel,#graphPanel").on("click",".modifyName",function(){var i=$(this);var g=i.parents(".dimAttrField");var f=g.data("dimAttrData");var h=g.find(".attrDimText");h.hide().after($("<input />",{value:f.modifyName,"class":"input"}).on("blur keypress",function(k){if(k.keyCode=="13"||k.type==="blur"){var j=$(this).val()||f.attrName;f.modifyName=j;h.text(j).show().next().remove();if(f.funcName){b.view.checkAttrName();b.view.updateDesginAttr()}}})).next().focus().select()});$("#dimPanel,#attrPanel,#graphPanel").on("click",".order",function(){var i=$(this);var h=i.parents(".dimAttrField");var g=h.data("dimAttrData");var f=g.order||"";if(f=="desc"){h.addClass("asc");g.order="asc";i.text("升序")}else{if(f=="asc"){h.removeClass("asc desc");g.order="";i.text("排序")}else{h.addClass("desc");g.order="desc";i.text("降序")}}if(g.dimType&&"complex"===g.dimType){c.each(g.dimList,function(k,j){c.extend(k,{order:g.order})})}});$("#dimPanel,#graphPanel").on("click",".fanyi",function(){var i=$(this);var g=i.parents(".dimAttrField");var f=g.data("dimAttrData");var h=f.fanyi||false;i.text(!h?"取消翻译":"翻译");f.fanyi=!h;if(f.dimType&&"complex"===f.dimType){c.each(f.dimList,function(k,j){c.extend(k,{fanyi:f.fanyi})})}});$("#dimPanel,#graphPanel").on("click",".fendang",function(){var m=$(this);var h=m.parents(".dimAttrField");var g=h.data("dimAttrData");var j=g.levelId||"";var l=g.attrId||"";var k=g.filterType||"";var i=g.attrName||"";var f="0";e.show(h,l,j,g.dimId,k,i,f)});$("#attrPanel").on("change",".select",function(){var k=$(this);var g=k.parents(".dimAttrField");var f=g.data("dimAttrData");var j=k.val(),l="";switch(j){case"":l="默认";break;case"sum":l="求和";break;case"avg":l="平均值";break;case"max":l="最大值";break;case"min":l="最小值";break;default:l="计数";break}var i=f.modifyName.replace(/\求和|\平均值|\最大值|\最小值|\计数|\默认/g,l);f.attrName=f.attrName.replace(/\求和|\平均值|\最大值|\最小值|\计数|\默认/g,l);f.modifyName=i;f.funcName=j;var h=g.find(".attrDimText");h.text(i);b.view.updateDesginAttr()})}}};return b.control});