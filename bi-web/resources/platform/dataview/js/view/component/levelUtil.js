define(["view/box","bace"],function(a,b){var c={};c.module={clickObj:null,enterType:"",isNew:false,attrId:"",attrName:"",dimId:"",filterType:"",levelId:"",data:null,temp:'<li class="levelRule">	<input value="${intervalName}" class="bi-input intervalName validate[required,len[1,30]]" placeholder="等级名称"/> <select {{if createId != "" && createId!=operaId}} disabled {{/if}} class="levelSelect beginType" ><option {{if beginType==1}} selected {{/if}} value="1">大于</option><option {{if beginType==2}} selected {{/if}} value="2">大于且等于</option><option {{if beginType==3}} selected {{/if}} value="3">等于</option></select>	 <input value="${beginValue}" {{if beginType==3}} style="width:56%" {{/if}}  class="bi-input beginValue"  placeholder="起始值"/> <span  {{if beginType==3}} style="display:none" {{/if}} class="endPanel"><select {{if createId != "" && createId!=operaId}} disabled {{/if}} class="levelSelect endType" ><option {{if endType==1}} selected {{/if}} value="1">小于</option><option {{if endType==2}} selected {{/if}} value="2">小于且等于</option></select>	 <input value="${endValue}" class="bi-input endValue" placeholder="结束值"/></span>	 <div class="removeRule" title="移除该规则">		<i {{if createId == "" || createId==operaId}}  class="fa fa-trash-o" {{/if}}></i>	</div></li>',dimTemp:'<li class="levelRule"><input value="${intervalName}"  class="bi-input intervalName validate[required,len[1,30]" placeholder="等级名称"/> <select class="levelSelect beginType" ><option selected  value="3">等于</option></select> <input  style="width:58%" value="${beginLabel}" data-code="${beginValue}"  class="bi-input beginValue" placeholder=""/> 	 <div class="removeRule" title="移除该规则">		<i  {{if createId == "" || createId==operaId}}  class="fa fa-trash-o" {{/if}}></i>	</div></li>',errMsg:'<div class="errMsgDiy form-validation-field-0formError parentFormaa formError" style="z-index:999;opacity: 0.9; position: absolute; top: 34px; left: 222px; margin-top: 0px;"><div class="formErrorContent"></div></div>'};c.control={show:function(l,f,i,j,d,g,k){c.module.clickObj=l;c.module.attrId=f;c.module.attrName=g;c.module.levelId=i;c.module.filterType=d;c.module.dimId=j;c.module.enterType=k;if(!jQuery("#saveLevelPanel").length){jQuery("<div></div>",{id:"saveLevelPanel",style:"display:none"}).appendTo("body");var h=b.handleUrlParam("/platform/dataview/saveLevelPage");jQuery("#saveLevelPanel").load(h,function(){c.view.show();if(k=="1"){c.view.installDropAttr();var m=jQuery("#saveLevelPanel");m.find(".listPanel").hide();jQuery("#importLevel").hide();jQuery("#removeLevel").hide()}else{c.view.rendLevel();jQuery("#importLevel").show();jQuery("#removeLevel").show()}setTimeout(function(){c.view.addRule()},100)})}else{c.view.show();if(k=="1"){c.view.installDropAttr();var e=jQuery("#saveLevelPanel");e.find(".listPanel").hide();jQuery("#importLevel").hide();jQuery("#removeLevel").hide()}else{var e=jQuery("#saveLevelPanel");e.find(".level-list.checked").attr("levelId","");c.view.rendLevel();jQuery("#importLevel").show();jQuery("#removeLevel").show()}setTimeout(function(){var n=jQuery("#saveLevelPanel");var m=n.find(".level-list.checked").attr("levelId");if(m==undefined||m==""){c.view.addRule()}},100)}},findLevelListByAttrId:function(){return $.ajax({type:"post",dataType:"json",url:b.handleUrlParam("/platform/dataview/findLevelListByAttrId"),data:{attrId:c.module.attrId}})},saveLevelInfo:function(){var d=c.view.collectData();return $.ajax({type:"POST",url:b.handleUrlParam("/platform/dataview/saveLevelInfo"),dataType:"json",data:d})},delRuleById:function(d){return $.ajax({type:"post",dataType:"json",url:b.handleUrlParam("/platform/dataview/delLevelInfo"),data:{levelId:d}})}};c.view={show:function(){if(c.module.enterType=="0"){jQuery(".bandTip").text("分档指标："+c.module.attrName)}else{jQuery(".bandTip").text("拖拽指标至此进行分档")}var d=jQuery("#saveLevelPanel").clone();$.dialog({title:"设置分档",padding:"0",width:"760px",height:"500px",lock:c.module.enterType=="1"?false:true,content:d[0],button:[{id:"importLevel",name:"引用该分档",title:"请在左侧选择一个有效的分档！",callback:function(){var g=jQuery("#saveLevelPanel");var e=jQuery("#levelName").val();var f=g.find(".level-list.checked").attr("levelId");if(!f){art.dialog.alert("请选择一个有效的分档！");return false}c.module.clickObj.data("dimAttrData").levelId=f;c.module.clickObj.find(".fendang >div").text("已分档");return true}},{id:"removeLevel",name:"取消分档",callback:function(){c.module.clickObj.data("dimAttrData").levelId="";c.module.clickObj.find(".fendang >div").text("分档");return true}},{id:"saveLevel",name:"保存",callback:function(){if(c.module.attrId==""){art.dialog.alert("请先拖拽指标");return false}var f=$("#saveLevelPanel .levelPanel").validationEngine("validate");var e=$(".levelRulePanel>ul").find("li").length;if(e<=0){f=false;art.dialog.alert("请添加规则");return f}var g=$("#levelList .datagrid-row:not('.datagrid-row-checked') .level-list");$.each(g,function(j,h){if($(h).html()==jQuery("#levelName").val()){f=false;art.dialog.alert("分档名称不能重复！")}});if(!f){return f}$.each($("#saveLevelPanel .levelRule"),function(j,h){if(!c.view.checkValue($(h))){f=false}});if(!f){return f}$.dialog.confirm("您确定保存该分档信息吗？",function(){var h=this;c.control.saveLevelInfo().then(function(i){if(i.result=="IS USERD"){h.showError("保存失败，该分档已被引用，不能修改");return}else{if(i.result=="ERROR"){h.showError("保存失败，系统异常，请您稍后重新提交或者咨询相关人员！");return}}jQuery("#levelId").val(i.levelId);c.module.isNew=false;h.showSucceed("保存成功，点击‘引用该分档’可以使用该分档进行分析！");$("#levelList .level-clone").datagrid("load",{attrId:c.module.attrId})},function(){h.showError("保存失败，请您稍后重新提交或者咨询相关人员！")});return false});return false},focus:true},{name:"关闭",callback:function(){jQuery("#levelName,#levelDesc").removeAttr("disabled")}}],init:function(){var e=$("#saveLevelPanel .levelPanel");e.validationEngine({promptPosition:"bottomLeft",scroll:false,autoHidePrompt:true,autoHideDelay:3000});e.on("blur",".beginValue , .endValue",function(){c.view.checkValue($(this).parents(".levelRule"))});e.on("click",".addRule",function(){var g=jQuery("#levelId").attr("createId");var f=jQuery("#levelId").val();if(f!=""&&g!=""&&g!=undefined&&operaId!=g){return}c.view.addRule()});e.on("click",".removeRule",function(){var g=jQuery("#levelId").attr("createId");var f=jQuery("#levelId").val();if(f!=""&&g!=""&&g!=undefined&&operaId!=g){return}c.view.removeRule($(this).parents(".levelRule"))});e.on("click",".deletelevel",function(g){var h=$(this);var f=$(this).attr("levelId");$.dialog.confirm("您确定要删除该分档信息吗？",function(){var i=this;c.control.delRuleById(f).then(function(k){i.showSucceed("删除该分档成功！");c.view.rendLevel();var j=jQuery("#saveLevelPanel");if(f==j.find(".infoPanel").attr("levelId")){c.view.restLevelInfo()}},function(){i.showError("删除该分档失败！")});return false});b.stopBubble(g)});c.view.bindEvent();$("#saveLevelPanel .infoPanel").niceScroll({cursorcolor:"#fff"})}})},installDropAttr:function(){$(".attrName").droppable({drop:function(e,i){var j=i.helper;var g=j.attr("data-attrId")||"";var h=j.attr("data-attrName")||"";var d=j.attr("data-filterType")||"";var l=j.attr("data-dimId")||"";if(!j.hasClass("attr-helper")){return}c.module.attrId=g;c.module.attrName=h;c.module.filterType=d;c.module.dimId=l;jQuery(".bandTip").text("分档指标："+h);c.view.rendLevel();setTimeout(function(){$(".aui_dialog .level-clone").datagrid("resize")},100);var f=jQuery("#saveLevelPanel");var k=f.find(".level-list.checked").attr("levelId");if(k==undefined){c.view.buildLevelPanel("")}}})},rendLevel:function(){$(".aui_dialog .level-clone").datagrid({url:b.handleUrlParam("/platform/dataview/findLevelListByAttrId"),queryParams:{attrId:c.module.attrId},width:"220px",height:"530px",fitColumns:true,showHeader:false,singleSelect:true,columns:[[{field:"levelName",title:"Code",width:85,align:"left",formatter:function(e,f){var d='<div  class="level-list';if(c.module.levelId==f.levelId){d+=" checked"}d+='"  levelId="'+f.levelId+'">'+f.levelName+"</div>";return d}},{field:"levelId",title:"Code",width:15,align:"center",formatter:function(d,e){if(e.createId===undefined||operaId==e.createId){return'<div levelId="'+e.levelId+'" class="deletelevel" title="删除该分档"><i class="fa fa-trash-o"></i></div>'}else{}}}]],onSelect:function(f,e){if(e==undefined){return}c.view.buildLevelPanel(e);jQuery("#levelId").val(e.levelId);var d=$("#levelList");d.find(".level-list").removeClass("checked");d.find(".level-list[levelId='"+e.levelId+"']").addClass("checked")},onUnselect:function(e,d){$("#levelList .level-clone").datagrid("selectRow",e)},onLoadSuccess:function(e){log(e.rows.length);var d=jQuery("#saveLevelPanel");if(!e||e.rows.length==0){c.view.restLevelInfo();d.find(".listPanel").hide()}else{d.find(".listPanel").show()}$(".datagrid-view").css("height","530px");$("#levelList .level-clone").datagrid("selectRow",0)}});c.module.isNew=false;b.autoScroll(jQuery("#saveLevelPanel .l-grid-body2"));return},removeRule:function(d){d.find(".levelSelect").chosen("destory");d.hide("fade",350,function(){jQuery(this).remove()})},addRule:function(l,f){if(!l){l=[{beginType:1,endType:1,beginLabel:"",beginValue:"",createId:""}]}else{if(f){for(var e=0;e<l.length;e++){l[e]=$.extend({},l[e],{createId:f})}}}var k;var d=c.module.dimId;var h=c.module.filterType;if(d||["A","B","C"].indexOf(h)>-1){k=$.tmpl(c.module.dimTemp,l);function g(n,i,m){return m.RES_DATA}var j="/platform/dataview/query-tree-data";k.each(function(){var i=$(this).find(".beginValue.bi-input");i.bzTree({async:{enable:true,autoParam:["id=clickCode","dimId=clickDimId"],url:b.handleUrlParam(j),dataType:"json",otherParam:{dimId:d,filterType:h},dataFilter:g},zIndex:"999999999999"})});k.find(".levelSelect").chosen({width:"80px",disable_search:true}).setDisabled(true)}else{if([4,6,7].indexOf(h)>-1){if(h=="4"){fmt="YYYY-MM"}if(h=="6"){fmt="YYYY-MM-DD"}if(h=="7"){fmt="YYYY-MM-DD HH:mm:ss"}k=$.tmpl(c.module.temp,l);k.find(".beginValue.bi-input,.endValue.bi-input").datetimepicker({format:fmt,showClear:true,showTodayButton:true,keepOpen:false,widgetPositioning:{horizontal:"right",vertical:"bottom"}});k.find(".levelSelect").chosen({width:"19%",disable_search:true})}else{k=$.tmpl(c.module.temp,l);k.find(".levelSelect").chosen({width:"19%",disable_search:true})}}jQuery("#saveLevelPanel .levelRulePanel>ul:eq(0)").append(k);k.find("input").placeholder()},collectData:function(){var f=jQuery("#saveLevelPanel");var e=jQuery("#levelId").val();var g={levelName:jQuery("#levelName").val(),levelDesc:jQuery("#levelDesc").val(),attrId:c.module.attrId,levelId:e,levelRule:""};var d=[];if(c.module.dimId||["A","B","C"].indexOf(c.module.filterType)>-1){f.find("li.levelRule").each(function(h){var j=$(this);d.push({intervalId:h,intervalName:j.find(".intervalName").val(),beginType:j.find(".beginType").val(),beginValue:(j.find(".beginValue").data("code")||[]).join(","),beginLabel:j.find(".beginValue").val(),})})}else{f.find("li.levelRule").each(function(h){var j=$(this);d.push({intervalId:h,intervalName:j.find(".intervalName").val(),beginType:j.find(".beginType").val(),beginValue:j.find(".beginValue").val(),endType:j.find(".endType").val(),endValue:j.find(".endValue").val()})})}g.levelRule=JSON.stringify({rule:d});return g},buildLevelPanel:function(d){c.view.restLevelInfo();if(d==undefined){return}jQuery("#levelId").val(d.levelId);jQuery("#levelId").attr("createId",d.createId);jQuery("#levelName").val(d.levelName);jQuery("#levelDesc").val(d.levelDesc);c.view.addRule(d.levelRule?$.evalJSON(d.levelRule).rule:"",d.createId);if(d.createId!=undefined&&operaId!=d.createId){jQuery("#levelName,#levelDesc").attr("disabled","disabled");setTimeout(function(){jQuery(".levelRule>input").prop("disabled","disabled");jQuery(".levelRule span>input").prop("disabled","disabled")},100);jQuery("#addRule").hide();jQuery("#saveLevel").hide()}else{jQuery("#levelName,#levelDesc").removeAttr("disabled");jQuery("#addRule").show();jQuery("#saveLevel").show()}},restLevelInfo:function(d){var f=jQuery("#saveLevelPanel");jQuery("#levelDesc").val("");jQuery("#levelName").val(d||"");var e=f.find(".levelRulePanel>ul");e.find(".levelSelect").chosen("destory");e.html("")},bindEvent:function(){var d=jQuery("#saveLevelPanel");d.on("click",".addlevel",function(){if(c.module.isNew===false){var f={levelName:"*未命名"};var g=$(".aui_dialog .level-clone");g.datagrid("appendRow",f);var e=g.datagrid("getRowIndex",f);g.datagrid("selectRow",e);c.module.isNew=true}});d.on("change",".beginType",function(){var h=$(this),e=$(this).parents(".levelRule"),g=e.find(".endPanel"),f=e.find(".beginValue");if(h.val()=="3"){g.hide();f.css({width:"56%"}).attr("placeholder","如需匹配多个值，用英文逗号分割。")}else{g.show();f.css({width:"18%"}).attr("placeholder","起始值")}});b.autoScroll(jQuery("#saveLevelPanel .infoPanel"))},checkValue:function(h){var e=h.find(".beginValue").val();var d=h.find(".endValue").val()==undefined?"":h.find(".endValue").val();h.find(".errMsgDiy").remove();var i=$(c.module.errMsg);setTimeout(function(){i.remove()},3000);if(e==""&&d==""){i.find(".formErrorContent").html("* 初始值跟结束值必须填写一个");h.append(i);return false}if(!isNaN(e)&&!isNaN(d)){if(parseInt(e)>parseInt(d)&&d!=""){i.find(".formErrorContent").html("* 初始值不能大于结束值");h.append(i);return false}}if([4,6,7].indexOf(c.module.filterType)>-1){var f=new Date(e).getTime();var g=new Date(d).getTime();if(f>g){i.find(".formErrorContent").html("* 初始值不能大于结束值");h.append(i);return false}}return true}};return c.control});