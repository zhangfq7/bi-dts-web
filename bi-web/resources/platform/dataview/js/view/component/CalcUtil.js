define(["view/box","bace","view/attr"],function(a,b,e){var d={};d.Consts={ATTR:1234567890,ATTR_2:"12345678901234567890",ATTRCLASS:{COMMON:0,CUSTOM:1,REPORT:2,FORMART:3},ATTRTYPE:{NUM:1,TIME:2,CHAR:3}};var c="";d.control={init:function(){jQuery(".calc-control").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true});d.control.getGroup();d.control.intialDroppable();d.control.intialInputDrag()},show:function(f){if(!jQuery("#calcPanel").length){jQuery("body").append("<div id='calcPanel' style='display:none;position: relative'></div>");jQuery("#calcPanel").load(b.handleUrlParam("/platform/dataview/format/calc-page"),function(){d.view.show(f);d.control.init();d.view.bindEvent();b.autoScroll(jQuery("#calcPanel .countarea"))})}else{d.view.show(f);d.control.refresh()}},refresh:function(){$("#calcName").val("");$("#calcGroup").val("");$(".inputlabel").empty().hide();$("#numInput").show().val("");$("#dotInput").val(0);$(".countarea .countdd").empty();var j=$.fn.zTree.getZTreeObj(c);if(j){var g=j.getCheckedNodes(true);for(var h=0,f=g.length;h<f;h++){j.checkNode(g[h],false,false)}}},getGroup:function(){$("#calcGroup").treeselect({zindex:"99999",height:200,searchAjaxParam:"groupName",chkStyle:"radio",width:(jQuery("#calcGroup").width()+21),url:b.handleUrlParam("/platform/resmanage/data/data-query-group"),onCheck:function(){c=this.id;$("#div"+this.id).fadeOut("fast")}})},intialDroppable:function(){$(".countarea").droppable({drop:function(h,o){var p=o.helper;var l=p.attr("data-attrId")||"";var n=p.attr("data-attrName")||"";var j=p.attr("data-attrType")||"";var t=p.attr("data-attrClass")||"";var s=p.attr("data-fieldName")||"";var f=p.attr("data-filterType")||"";var q=p.attr("data-dimId")||"";var k=p.attr("data-dataId")||"";var i=p.attr("data-diyRelation")||"";if(!p.hasClass("attr-helper")){return}if(j==d.Consts.ATTRTYPE.TIME||j==d.Consts.ATTRTYPE.CHAR){$.dialog({lock:true,content:'<div style="color:#444;font-weight:bolder;margin-top:-10px">日期或字符型指标不可做计算指标！</div>',icon:"warning",ok:true});return}if(t==d.Consts.ATTRCLASS.REPORT||t==d.Consts.ATTRCLASS.FORMART){$.dialog({lock:true,content:'<div style="color:#444;font-weight:bolder;margin-top:-10px">计算不可再做计算指标！</div>',icon:"warning",ok:true});return}var m=$(this).find(".countdd");var r=d.Consts.ATTR;if(l==0){r=0}var g="<div exp='"+r+"' data-attrId='"+l+"' data-fieldName='"+s+"' data-attrType='"+j+"' data-filterType='"+f+"' data-dimId='"+q+"' data-dataId='"+k+"' class='label'><div class ='text'><span class='name'>"+n+"</span></div><div class='close'><i class='fa fa-close'></i></div></div>";if(m.children().length>0){g="<i class='dashline'>--</i>"+g}m.append(g)}})},intialInputDrag:function(){$(".inputlabel").draggable({delay:10,cursorAt:{top:1,left:56},addClasses:false,helper:function(f){var g=$(this).text();return jQuery("<div>",{style:"z-index:9999999","data-attrid":g,"data-attrName":g,"data-fieldName":g,html:g}).addClass("attr-helper").appendTo("body")}})}};d.view={show:function(f){$.dialog({id:"calcDialog",title:"计算指标",padding:"0",width:"622px",height:"300px",lock:false,content:jQuery("#calcPanel")[0],ok:function(){if(!d.view.saveExpression(f)){return false}var m=$("#calcName").val();var h=$("#calcGroup").attr("truevalue");var l=$("#dotInput").val();var i="";var k="";var g="";$("#exparea *[exp]").each(function(){if($(this).attr("exp")==d.Consts.ATTR){k+=$(this).attr("data-attrId");i+=$(this).attr("data-fieldname");g+=$(this).attr("data-dataId")+"."+$(this).attr("data-fieldname")}else{k+=$(this).attr("exp");i+=$(this).attr("exp");g+=$(this).attr("exp")}});var j={attrRule:encodeURIComponent(k),dbConnectAttrRule:encodeURIComponent(i),viewAttrRule:encodeURIComponent(g),dataId:f,dataType:a.main.dataType,calcName:encodeURIComponent(m),groupId:h||"",attrType:1,attrClass:2,fieldName:"",columnScale:l,filterType:2};$.dialog.confirm("您确定保存该计算指标吗？",function(){$.ajax({url:b.handleUrlParam("/platform/dataview/format/save-calc-info"),data:j,success:function(n){if(n.resFlag=="success"){$.dialog.alert("新增计算指标成功");a.AttrTree.viewInit();$.dialog.closeAll("calcDialog")}else{$.dialog.alert("新增计算指标失败")}},error:function(n){$.dialog.alert("系统异常，新增计算指标失败，请稍后重试");return false}})});return false},okVal:"保存",cancelVal:"关闭",cancel:function(){return true}})},checkExpression:function(g){g=$.trim(g);if(""===g){return false}if(/[\+\-\*\/]{2,}/.test(g)){return false}if(g.indexOf("(")!=-1||g.indexOf(")")!=-1){var f=[];for(var h=0,j;h<g.length;h++){j=g.charAt(h);if("("===j){f.push("(")}else{if(")"===j){if(f.length>0){f.pop()}else{return false}}}}if(0!==f.length){return false}}if(/\([\+\-\*\/]/.test(g)){return false}if(/[\+\-\*\/]\)/.test(g)){return false}if(/[^\+\-\*\/]\(/.test(g)){return false}if(/\(\)/.test(g)){return false}if(g.indexOf(d.Consts.ATTR_2)!=-1||g.indexOf(d.Consts.ATTR+"0")!=-1){return false}if(g=="+"||g=="-"||g=="*"||g=="/"){return false}if(g.substring(0,1)=="+"||g.substring(0,1)=="-"||g.substring(0,1)=="*"||g.substring(0,1)=="/"){return false}if(g.substring(g.length-1)=="+"||g.substring(g.length-1)=="-"||g.substring(g.length-1)=="*"||g.substring(g.length-1)=="/"){return false}if(g.indexOf("/0")!=-1){return false}return true},bindHover:function(){jQuery("#exparea a").poshytip("destroy");jQuery("#exparea a").poshytip({content:function(){var g=$(this).attr("expid");var f="<div expid='"+g+"'class='downboxl'><ul><li>+</li><li>-</li><li>×</li><li>÷</li><li>(</li><li>)</li><li class='deleteicon'></li></ul></div>";return f},className:"tip-yellowsimple",alignTo:"target",alignY:"bottom",alignX:"center",offsetY:2,offsetX:80,showTimeout:200,keepInViewport:false,show:function(){d.view.bindExpClick()}})},bindEvent:function(){jQuery(".countinput .countdd").on("click","a",function(){var g=$(this);g.attr("expid","exp"+new Date().getTime());var f=g.outerHTML();if($(".countarea .countdd").children().length>0){$(".countarea .countdd").append("<i class='dashline'>--</i>"+f)}else{$(".countarea .countdd").append(f)}d.view.bindHover()});jQuery(".countarea .countdd").on("click",".close",function(g){var f=jQuery(this).parents(".label");var h=f.prev();f.remove();h.remove()});$("#numInput").on("blur keyup",function(){var h=$(this);var f=h.val();if((event.keyCode=="13"||event.type==="blur")&&f){var g=jQuery("#numInput").validationEngine("validate");if(g){return}h.hide();$(".inputlabel").show().text(f)}});jQuery(".inputlabel").on("dblclick",function(){var f=$(this);var g=f.text();f.hide();$("#numInput").show().val(g);b.stopBubble(event)})},bindExpClick:function(){$(".downboxl li").on("click",function(){var k=$(this);var h=k.parent().parent().attr("expid");var g=$("#exparea").find("a[expid='"+h+"']");var j=g.prev();if(k.hasClass("deleteicon")){g.remove();if(j.hasClass("dashline")){j.remove()}var f=$("#exparea>:first");if(f.hasClass("dashline")){f.remove()}}else{var i=k.html();g.attr("exp",i);g.html(i)}})},saveExpression:function(f){var h="";$("#exparea *[exp]").each(function(){h+=$(this).attr("exp")});var g=jQuery(".calc-control").validationEngine("validate");if(!g){return false}if(!d.view.checkExpression(h)){$.dialog({lock:true,content:'<div style="color:#444;font-weight:bolder;margin-top:-10px">计算表达式不符合运算规则！</div>',icon:"warning",ok:true});return false}return true}};return d.control});