define(["view/box","bace","view/attr","view/component/ConditionSet"],function(b,c,e,d){var a={};a.module={ATTRCLASS:{COMMON:0,CUSTOM:1,REPORT:2,FORMAT:3,PERSONAL:4},attrId:""};a.control={init:function(){jQuery(".personal-attr-sub").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true});a.control.getGroup();a.view.initTabs();$("#addTab").click()},componentInit:function(){a.control.installResultDrop();a.control.initInputDrag();a.control.initSymbolDrag();a.control.installConditionSort();a.view.bindEvent()},show:function(){if(!jQuery("#personalAttr")[0]){jQuery("body").append("<div id='personalAttr' style='display:none;position: relative'></div>")}jQuery("#personalAttr").load(c.handleUrlParam("/platform/dataview/format/personal-attr-page"),function(){a.view.show();a.control.init()})},getGroup:function(){$("#personalAttrGroup").treeselect({zindex:"99999",height:200,searchAjaxParam:"groupName",chkStyle:"radio",width:(jQuery("#personalAttrGroup").width()+21),url:c.handleUrlParam("/platform/resmanage/data/data-query-group"),onCheck:function(){$("#div"+this.id).fadeOut("fast")}})},installResultDrop:function(){$(".resultArea").droppable({drop:function(h,p){var q=p.helper;var l=q.attr("data-attrId")||"";var o=q.attr("data-attrName")||"";var j=q.attr("data-attrType")||"";var t=q.attr("data-attrClass")||"";var s=q.attr("data-fieldName")||"";var f=q.attr("data-filterType")||"";var r=q.attr("data-dimId")||"";var n=q.attr("type")||"";var k=q.attr("data-dataId")||"";var i=q.attr("data-diyRelation")||"";if(!q.hasClass("attr-helper")||q.attr("type")=="symbol"){return}if(a.module.ATTRCLASS.PERSONAL==t||a.module.ATTRCLASS.FORMAT==t){$.dialog.alert("自定义和时间格式化指标不能再次自定义");return}var m=$(this);if(m.html()!=""){$.dialog.alert("只允许设置一个结果字段");return}var g="<div data-attrId='"+l+"' data-fieldName='"+s+"' data-attrType='"+j+"' data-filterType='"+f+"' data-dimId='"+r+"' data-attrClass='"+t+"' data-type='"+n+"' data-dataId='"+k+"' class='label'><div class ='text'><span class='name'>"+o+"</span></div><div class='close'><i class='fa fa-close'></i></div></div>";m.append(g)}})},initInputDrag:function(){$(".constant-label").draggable({delay:10,cursorAt:{top:1,left:56},addClasses:false,helper:function(){var f=$(this).text();return jQuery("<div>",{style:"z-index:9999999","data-attrId":f,"data-attrName":f,"data-fieldName":f,type:"num",html:f}).addClass("attr-helper").appendTo("body")}})},initSymbolDrag:function(){$(".symbol a").draggable({delay:10,cursorAt:{top:1,left:26},addClasses:false,connectToSortable:".conditionArea",helper:function(){var f=$(this).text();return jQuery("<div>",{style:"z-index:9999999","data-attrid":$(this).attr("exp"),"data-attrName":f,"data-fieldName":f,type:"symbol",html:f}).addClass("attr-helper").appendTo("body")}}).disableSelection()},installConditionDrop:function(){$(".conditionArea").droppable({drop:function(h,n){var o=n.helper;var k=o.attr("data-attrId")||"";var m=o.attr("data-attrName")||"";var j=o.attr("data-attrType")||"";var r=o.attr("data-attrClass")||"";var q=o.attr("data-fieldName")||"";var f=o.attr("data-filterType")||"";var p=o.attr("data-dimId")||"";if(!o.hasClass("attr-helper")||o.attr("type")=="num"){return}var l=$(this);if(o.attr("type")!="symbol"){var i=false;$(".conditionArea div").each(function(){if(k==$(this).attr("data-attrId")){$.dialog.alert("该指标已存在");i=true}});if(i){return}}var g="";if(o.attr("type")=="symbol"){g+="<div data-attrId='"+k+"' data-fieldName='"+q+"' data-attrType='"+j+"' data-filterType='"+f+"' data-dimId='"+p+"' class='label'><div class ='text' style='color:#eb9800'><span class='name'>"+m+"</span></div><div class='close'><i class='fa fa-close'></i></div></div>"}else{g+="<div data-attrId='"+k+"' data-fieldName='"+q+"' data-attrType='"+j+"' data-filterType='"+f+"' data-dimId='"+p+"' class='label'><div class ='text'><span class='name'>"+m+"</span></div><div class='close'><i class='fa fa-close'></i></div></div>"}l.append(g)}})},installConditionSort:function(){$(".conditionArea").sortable({connectWith:".conditionArea,.symbol",appendTo:"body",delay:200,scroll:true,stop:function(s,o){var g=o.item;var n=g.attr("data-attrId")||"";var t=g.attr("data-attrName")||"";var w=g.attr("data-attrType")||"";var l=g.attr("data-attrClass")||"";var f=g.attr("data-fieldName")||"";var i=g.attr("data-filterType")||"";var k=g.attr("data-dimId")||"";var r=g.attr("data-dataId")||"";var u=g.attr("data-diyRelation")||"";if(!g.hasClass("attr-helper")||g.attr("type")=="num"){return}if(a.module.ATTRCLASS.CUSTOM!=l&&a.module.ATTRCLASS.COMMON!=l){$.dialog.alert("自定义指标不能再次自定义");o.item.replaceWith("");return}if(g.attr("type")==undefined){var p=$(".conditionArea");var j=null;p.each(function(){if($(this).is(":visible")){j=$(this)}});var q=0;j.children().each(function(){if(n==$(this).attr("data-attrId")){q+=1}});if(q==2){$.dialog.alert("该指标已存在");o.item.replaceWith("");return}}var h="";if(g.attr("type")=="symbol"){var m="text";if(n=="and"||n=="or"){m="text andOr"}var v="exp"+new Date().getTime();h+="<div exp='"+n+"' expId='"+v+"' data-attrId='"+n+"' data-fieldName='"+f+"' data-attrType='"+w+"' data-filterType='"+i+"' data-dimId='"+k+"' class='label'><div class ='"+m+"' style='color:#eb9800'><span class='name'>"+t+"</span></div><div class='close'><i class='fa fa-remove' style='color: #eb9800'></i></div></div>"}else{h+="<div exp='attr' data-attrId='"+n+"' data-fieldName='"+f+"' data-attrType='"+w+"' data-filterType='"+i+"' data-dimId='"+k+"' data-dataId='"+r+"' class='label'><div class ='text'><span class='name'>"+t+"</span></div><div class='set'><i class='fa fa-cog' style='color: #00b7ee'></i></div><div class='close'><i class='fa fa-close' style='color: #00b7ee'></i></div></div>"}o.item.replaceWith(h);a.view.bindHover()}}).disableSelection()}};a.view={show:function(){$.dialog({id:"personalAttrDialog",title:"设置自定义指标",padding:"0",width:"800px",height:"500px",lock:false,content:jQuery("#personalAttr")[0],ok:function(){var l=$(".personal-attr-sub").validationEngine("validate");if(!l){return false}var f=jQuery("#personalAttrName").val();var k=jQuery("#personalAttrGroup").attr("trueValue");var o=[];var m=true;var i=true;var n=true;var j=true;var g=jQuery("#personalAttrTabs").children("div").length;jQuery("#personalAttrTabs").children("div").each(function(){var s={resultType:"",resultName:"",resultAttrId:"",resultAttrType:"",resultAttrDimId:"",resultAttrClass:"",resultAttrFieldName:"",resultAttrDataId:"",conditionSql:"",conditionVal:""};var u=$(this);var v=u.find(".search-result-div .resultArea");var w=u.find(".search-condition-div .conditionArea");if(g>1&&v.html()==""){m=false;return false}if(w.html()==""){i=false;return false}var p=v.find(".label");if(g==1&&v.html()==""){s.resultType=2}else{if(p.data("type")=="num"){s.resultType=1;s.resultName=p.data("attrid")}else{s.resultType=0;s.resultName=p.text();s.resultAttrClass=p.data("attrclass");s.resultAttrFieldName=p.data("fieldname");s.resultAttrDataId=p.data("dataid")}s.resultAttrId=p.data("attrid");s.resultAttrDimId=p.data("dimid")?p.data("dimid"):""}s.resultAttrType=p.data("attrtype")?p.data("attrtype"):"";var x="";var q=[];var r="";var t="";w.children("div").each(function(){var A=$(this);var y={attrId:"",attrName:"",fieldName:"",attrType:"",conditionOptionValue:"",conditionLabelValue:"",attrDataId:"",conditionRealValue:""};var C=A.attr("exp");if(C=="attr"){x+=A.data("attrid")+" ";y.attrId=A.data("attrid");y.attrName=A.find(".text").text();y.fieldName=A.data("fieldname");y.attrType=A.data("attrtype");y.attrDataId=A.data("dataid");var z=A.find(".condition-val");if(!z.length){n=false;return false}if(A.data("dimid")){y.conditionOptionValue="dimId"}else{var B=z.data("filterselectvalue");y.conditionOptionValue=B?(B[0]+","+B[1]):""}y.conditionLabelValue=z.data("filterlabelvalue")[0]+","+z.data("filterlabelvalue")[1];y.conditionRealValue=z.data("filtervalue");q.push(y)}else{x+=C+" "}r+=C;t+=C+","});if(!a.view.checkRule(r,t.substring(0,t.length-1))){j=false}s.conditionSql=x;s.conditionVal=q;o.push(s)});if(!m){$.dialog.alert("请为每一个规则都设置查询结果");return false}if(!i){$.dialog.alert("请为每一个规则都设置筛选条件");return false}if(!n){$.dialog.alert("请为每个规则的筛选条件的每个指标都设置条件");return false}if(!j){$.dialog.alert("筛选条件表达式不符合规则，请检查所有规则的筛选条件");return false}var h={dataId:b.main.dataId,dataType:b.main.dataType,attrId:"",attrName:f,groupId:k,rule:JSON.stringify(o)};$.dialog.confirm("确定保存该自定义指标吗？",function(){$.ajax({url:c.handleUrlParam("/platform/dataview/format/save-personal-attr"),dataType:"json",type:"post",data:h,success:function(p){if(p.resFlag=="Success"){$.dialog.alert("新增自定义指标成功");b.AttrTree.viewInit();$.dialog.closeAll("personalAttrDialog")}else{$.dialog.alert("新增自定义指标失败，请联系管理员");return false}},error:function(){$.dialog.alert("新增自定义指标失败，请联系管理员")}})});return false},okVal:"保存",cancelVal:"关闭",cancel:function(){return true}})},initTabs:function(){var g=$("#personalAttrTabs").tabs();var h="<li><a shref='#{href}'>#{label}</a><span class='ui-icon ui-icon-close' style='cursor: pointer' role='presentation'></span></li>";var f=1;var j=0;function i(){if(j>8){$.dialog.alert("超出限制");return}var m="规则 "+(j+1),n="tab-"+f,k=$(h.replace(/#\{href\}/g,"#"+n).replace(/#\{label\}/g,m));g.find(".ui-tabs-nav").append(k);var l=a.view.buildTabContent();g.append("<div id='"+n+"' class='personal-attr-tab'>"+l+"</div>");g.tabs("refresh");g.tabs({active:j});j++;f++}$("#addTab").on("click",function(){i();a.control.componentInit()});g.on("click","span.ui-icon-close",function(){if(j==1){return}var l=$(this).closest("li").remove().attr("aria-controls");$("#"+l).remove();j--;if(j==0){f=1}else{var k=1;g.find(".ui-tabs-nav li>a").each(function(){$(this).html("规则"+k);k++})}g.tabs("refresh")})},buildTabContent:function(){return"<div class='search-result-div'><fieldset class='search-result'><legend style='margin-left: 10px'>设置查询结果</legend><div class='constant-label' style='display:none'> </div><input type='text' class='bi-input numInput validate[custom[number]]' placeholder='设置常量' style='width: 120px;height: 25px' id='numInput'/><div class='resultArea' id='resultArea'></div></fieldset></div><div class='search-condition-div'><fieldset class='search-condition'><legend style='margin-left: 10px'>设置筛选条件</legend><div class='symbol'><a exp='('>(</a><a exp=')'>)</a><a exp='and'>并且</a><a exp='or'>或者</a></div><div class='conditionArea' id='conditionArea'></div></fieldset></div>"},bindHover:function(){jQuery(".andOr").poshytip("destroy");jQuery(".andOr").poshytip({content:function(){var h=$(this).text();var f="";var g=$(this).parent().attr("expid");if(h=="并且"){f="<div expid='"+g+"'class='poshy-tip'><ul><li>或者</li></ul></div>"}else{f="<div expid='"+g+"'class='poshy-tip'><ul><li>并且</li></ul></div>"}return f},className:"tip-yellowsimple",alignTo:"target",alignY:"bottom",alignX:"center",offsetY:2,offsetX:80,showTimeout:200,keepInViewport:false,show:function(){a.view.bindClick()}})},bindClick:function(){$(".poshy-tip li").on("click",function(){var i=$(this);var g=i.parent().parent().attr("expid");var f=$(".conditionArea").find("div[expid='"+g+"']");var h=i.html();f.attr("exp",h=="并且"?"and":"or");f.attr("data-attrId",h=="并且"?"and":"or");f.attr("data-fieldName",h);f.children().find("span").html(h)})},bindEvent:function(){$(".numInput").on("blur keyup",function(){var g=$(".numInput");var f=null;g.each(function(){if($(this).is(":visible")){f=$(this);var h=f.val();if((event.keyCode=="13"||event.type==="blur")&&h){f.hide();f.siblings(".constant-label").show().text(h)}}})});jQuery(".constant-label").on("dblclick",function(){var g=$(".constant-label");var f=null;var h=null;g.each(function(){if($(this).is(":visible")){f=$(this);h=f.text();f.hide();f.siblings(".numInput").show().val(h)}});c.stopBubble(event)});jQuery(".resultArea,.conditionArea").on("click",".close",function(g){var f=jQuery(this).parents(".label");f.remove()});jQuery(".conditionArea").on("click",".set",function(g){var m=$(this).parent();var i=m.data("attrid");var n=m.find(".text").text();var h=m.data("attrtype");var f=m.data("filtertype");var o=m.data("dimid");var k=m.children(".condition-val").data("filterselectvalue")||"";var j=m.children(".condition-val").data("filterlabelvalue")||"";var l=m.children(".condition-val").data("filtervalue")||"";d.show(i,n,h,f,o,k,j,l,m,a.view.render)})},render:function(j,f){var i=f.css("width");var k=j.filterSelectValue;var h=j.filterLabelValue;var m=j.filterValue;var g=$.evalJSON(h);var l="<div class='condition-val' data-filterSelectValue = '"+k+"' data-filterLabelValue='"+h+"' data-filterValue='"+m+"' style='width: "+i+"'><span>条件值："+g+"</span></div>";if(f.children(".condition-val").length){if(g!=","){f.children(".condition-val").replaceWith(l)}else{f.find(".condition-val").remove()}}else{if(g!=","){f.append(l)}}},checkRule:function(f,n){var m=n.split(",");var p=0;for(var h=0;h<m.length;h++){if("attr"==m[h]){p++}}if(f!="attr"){var q=0;for(var g=0;g<m.length;g++){if("attr"==m[g]&&g!=m.length-1){q++;if(q==p&&")"!=m[g+1]){return false}else{if(")"!=m[g+1]&&"and"!=m[g+1]&&"or"!=m[g+1]){return false}}}else{if(("and"==m[g]||"or"==m[g])&&g!=m.length-1){if("attr"!=m[g+1]){return false}}}}}if("and"==m[0]||"or"==m[0]||"and"==m[m.length-1]||"or"==m[m.length-1]){return false}if(f.indexOf("andor")!=-1||f.indexOf("orand")!=-1||f.indexOf("or)")!=-1||f.indexOf("and)")!=-1||f.indexOf("(or")!=-1||f.indexOf("(and")!=-1||f.indexOf("oror")!=-1||f.indexOf("andand")!=-1){return false}if(f.indexOf("(")!=-1||f.indexOf(")")!=-1){var o=[];for(var l=0,r;l<f.length;l++){r=f.charAt(l);if("("===r){o.push("(")}else{if(")"===r){if(o.length>0){o.pop()}else{return false}}}}if(0!==o.length){return false}}if(/\(\)/.test(f)){return false}return true}};return a.control});