define(["bace"],function(a){var b={};var c=null;b.module={attrId:"",attrName:"",attrType:"",filterType:"",dimId:"",filterSelectValue:"",filterLabelValue:"",filterValue:"",clickObj:"",filterTypeArr:{DIM:"1",INTERVAL:"2",EQUAL:"3",LIKE:"9",MONTH:"4",DAY:"6",TIME:"7"},attrTypeArr:{INT:"1",DATE:"2",STRING:"3"}};b.control={show:function(g,k,f,d,l,i,h,j,m,e){b.module.attrId=g;b.module.attrName=k;b.module.attrType=f;b.module.filterType=d;b.module.dimId=l;b.module.filterSelectValue=i;b.module.filterLabelValue=h;b.module.filterValue=j;b.module.clickObj=m;c=e;if(!jQuery("#conditionSet")[0]){jQuery("body").append("<div id='conditionSet' style='display:none;position: relative'></div>")}jQuery("#conditionSet").load(a.handleUrlParam("/platform/dataview/format/condition-set-page"),function(){b.view.show();b.control.init()})},init:function(){var e={attrId:b.module.attrId,attrName:b.module.attrName,attrType:b.module.attrType,filterType:b.module.filterType,dimId:b.module.dimId,filterSelectValue:b.module.filterSelectValue,filterLabelValue:b.module.filterLabelValue,filterValue:b.module.filterValue};var d=b.view._packFilter(e);jQuery("#conditionSetPanel").append(d);b.view.bindEvent()}};b.view={show:function(){$.dialog({id:"conditionSetDialog",title:"设置自定义指标",padding:"0",width:"400px",height:"300px",lock:true,content:jQuery("#conditionSet")[0],ok:function(){var d=b.view.collect();c.call(this,d,b.module.clickObj)},okVal:"保存",cancelVal:"关闭",cancel:function(){return true}})},bindEvent:function(){jQuery("#conditionSetPanel").on("change",".chooseType.start select",function(){var d=jQuery(this);var e=d.val();if(["moreEq_2","more_2","less","lessEq"].indexOf(e)>-1){d.parents(".filter-attr .intervalGroup").removeClass("like");d.parents(".filter-attr .intervalGroup").css("width","390px");d.parent().siblings().children(".intervalInput").css("width","150px");d.parents(".filter-attr").find(".end,.endInput").show()}else{d.parents(".filter-attr .intervalGroup").addClass("like");d.parents(".filter-attr").find(".end,.endInput").hide()}})},_packFilter:function(e){e.filterId=e.attrId+"_"+new Date().getTime();var d="";d+='<div id="${filterId}" class="filter-attr cursor-pointer">';d+='   	<span class="label">';d+='   		<label style="width:auto">${attrName}</label><span>：</span>';d+='   		<input id="${filterId}_input" type="text" class="bi-input target" />';d+="   	</span>";d+="</div>";var f=$.tmpl(d,e).data("filterAttrData",e);setTimeout(function(){b.view.translate(e)},0);return f},translate:function(q){var e=$("#"+q.filterId);var n=e.find("input.target");e.find("select").chosen("destroy");e.find(".bi-filter").remove();var j=q.filterLabelValue?q.filterLabelValue:null;var f=q.filterValue?q.filterValue:null;var l=q.filterType;if([b.module.filterTypeArr.DIM,"A","B","C"].indexOf(l)>-1){var p=q.dimId;var d=q.filterType;function i(u,s,t){return t.RES_DATA}e.find(".bi-input").bzTree({async:{enable:true,autoParam:["id=clickCode","dimId=clickDimId"],url:a.handleUrlParam("/platform/dataview/query-tree-data"),dataType:"json",otherParam:{dimId:p,filterType:d},dataFilter:i,code:f,label:j}})}else{var m=q.filterSelectValue?q.filterSelectValue:null;var h='<div class="intervalGroup {{if endType != "less" && endType != "lessEq" }} like {{/if}} bi-filter"><div class="chooseType start"><select>{{if attrType != 1 && attrType != 2}}<option {{if startType == "like_9" }} selected {{/if}}value="like_9" >全匹配</option><option {{if startType == "leftLike_9" }} selected {{/if}} value="leftLike_9" >左匹配</option><option {{if startType == "rightLike_9" }} selected {{/if}} value="rightLike_9" >右匹配</option>{{/if}}<option {{if startType == "eq_3" }} selected {{/if}}value="eq_3" >精确</option>{{if attrType != 3}}<option {{if startType == "more_2" }} selected {{/if}}value="more_2" >&gt;</option><option {{if startType == "moreEq_2" }} selected {{/if}} value="moreEq_2" >&gt;=</option>{{/if}}</select></div><div><input class="intervalInput start"/></div><div class="chooseType end"  {{if endType != "less" && endType != "lessEq" }}  style="display:none" {{/if}} ><select><option {{if endType == "less" }} selected {{/if}} value="less" >&lt;</option><option {{if endType == "lessEq" }} selected {{/if}} value="lessEq" >&lt;=</option></select></div><div class="endInput" {{if endType != "less" && endType != "lessEq" }}  style="display:none" {{/if}}><input class="intervalInput end"/></div></div>';n.hide().after($.tmpl(h,{attrType:q.attrType,startType:m?m[0]:"",endType:m?m[1]:""}));e.find(".intervalInput.start").val(j?j[0]:"");e.find(".intervalInput.end").val(j?j[1]:"");e.find(".chooseType.start select").chosen({width:"54px",disable_search:true});e.find(".chooseType.end select").chosen({width:"32px",disable_search:true});if(q.attrType==b.module.attrTypeArr.DATE){var o=e.find("input.start");var r=e.find("input.end");if(o.data("DateTimePicker")){o.data("DateTimePicker").destroy();r.data("DateTimePicker").destroy()}var g="";var k="";if(l==b.module.filterTypeArr.MONTH){g="YYYY-MM"}if(l==b.module.filterTypeArr.DAY){g="YYYY-MM-DD";k+="months,days"}if(l==b.module.filterTypeArr.TIME){g="YYYY-MM-DD HH:mm:ss";k+="months,days,times"}q.filterValueType=l;e.find("input.start,input.end").datetimepicker({format:g,showClear:true,showTodayButton:true,keepOpen:false,onhide:function(){jQuery(this).attr("title",$(this).val()).parents(".filter-attr").removeClass("hover")},});e.find("input.startDate").on("dp.change",function(s){e.find("input.endDate").data("DateTimePicker").minDate(s.date)})}}},collect:function(){var k=$("#conditionSetPanel .filter-attr");var m=k.data("filterAttrData");var j="";if(m.dimId||["A","B","C"].indexOf(m.filterType)>-1){var f=k.find(".bi-input").data("code");m.filterValue=f?f.join(","):"";m.filterLabelValue=JSON.stringify([k.find(".bi-input").val(),""])}else{var g=k.find(".intervalInput.start").val();var i=k.find(".chooseType.start >select").val();var o=i.split("_");var d=o[0];if(d=="more"||d=="moreEq"){var n=k.find(".chooseType.end >select").val();var l=k.find(".intervalInput.end").val();var e=d=="more"?">":">=";var h=n=="less"?"<":"<=";if(g&&l){j=e+g+","+h+l;m.filterLabelValue=JSON.stringify([g,l])}else{if(g){j=e+g;m.filterLabelValue=JSON.stringify([g,""])}if(l){j=h+l;m.filterLabelValue=JSON.stringify(["",l])}if(g==""&&l==""){m.filterLabelValue=JSON.stringify(["",""])}}m.filterSelectValue=JSON.stringify([i,n])}else{if(d=="like"){j="%"+g+"%"}if(d=="leftLike"){j=g+"%"}if(d=="rightLike"){j="%"+g}if(d=="eq"){j=g}m.filterSelectValue=JSON.stringify([i,""]);m.filterLabelValue=JSON.stringify([g,""])}m.filterValue=j}return m}};return b.control});