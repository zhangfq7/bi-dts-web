define(["view/box","bace","validation"],function(a,b){var c={};var d;c.module={};c.control={init:function(){c.control.getGroup()},show:function(){if(!jQuery("#dateFormatPanel")[0]){jQuery("body").append("<div id='dateFormatPanel' style='display:none;position: relative'></div>")}jQuery("#dateFormatPanel").load(b.handleUrlParam("/platform/dataview/format/new-date-format")+"?dataId="+a.main.dataId+"&dataType="+a.main.dataType,function(){c.control.init();c.view.show();c.view.bindEvent()})},getGroup:function(){var e=jQuery("#attrGroup");e.treeselect({height:200,chkStyle:"radio",searchAjaxParam:"groupName",width:(e.width()+21),zindex:99999,url:b.handleUrlParam("/platform/resmanage/data/data-query-group"),onCheck:function(){$("#div"+this.id).fadeOut("fast")}})}};c.view={show:function(){$.dialog({id:"dateFormatDialog",title:"新增时间格式化",padding:"0",width:"400px",height:"260px",lock:true,content:jQuery("#dateFormatPanel")[0],cancelVal:"取消",okVal:"保存",ok:function(){var f=$(".formatBox").validationEngine("validate");if(!f){return false}if(""==d||null==d||undefined==d){$.dialog.alert("请选择时间格式");return false}var e=jQuery("#dateAttr").find("option:selected").attr("dataId");var g=jQuery("#dateAttr").find("option:selected").attr("fieldName");$.dialog.confirm("您确定保存该时间格式化指标吗？",function(){$.ajax({url:b.handleUrlParam("/platform/dataview/format/save-date-format-attr"),contentType:"charset=utf-8",data:{dataId:a.main.dataId,dataType:a.main.dataType,attrId:jQuery("#dateAttr option:selected").val(),viewAttrId:e+"."+g,attrDataId:e,dateFormatName:encodeURIComponent(jQuery("#formatName").val()),groupId:jQuery("#attrGroup").attr("trueValue"),formatRule:d},success:function(h){if(h.retFlag=="success"){$.dialog.alert("新增时间格式化成功");a.AttrTree.viewInit();$.dialog.closeAll("dateFormatDialog")}else{$.dialog.alert("新增时间格式化失败")}},error:function(h){$.dialog.alert("系统异常，新增时间格式化失败，请稍后重试");return false}})});return false},cancel:function(){return true}})},bindEvent:function(){jQuery("#dateAttr").on("change",function(){var e=jQuery("#dateAttr").find("option:selected").attr("filterType");if(e==7){jQuery("#formatRuleGroup").children().css("display","inline-block")}else{if(e==6){jQuery("#day").css("display","none").siblings().css("display","inline-block")}else{if(e==4){jQuery("#year").css("display","inline-block").siblings().css("display","none")}else{jQuery("#formatRuleGroup").children().css("display","none")}}}});jQuery("#formatRuleGroup").on("click",".formatRuleButton",function(f){$(this).addClass("active").siblings().removeClass("active");d=$(this).text()});jQuery(".formatBox").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true})}};return c.control});