define(["bace","view/box","view/layout","view/widgets/filter","view/widgets/property","view/widgets/urlPathPanel","view/widgets/plugins/table/table","view/widgets/plugins/echarts/echarts","view/widgets/plugins/text/text","view/widgets/plugins/indicator/indicator","view/widgets/plugins/echarts/tpl","view/widgets/plugins/default","view/component/DataInfoUtil","view/eventBinder"],function(c,j,n,d,l,m,g,b,f,e,k,o,h){var i={currentPlugin:""};i.module={};var a={lines:13,length:7,width:4,radius:10,corners:1,rotate:0,color:"#fff",speed:1,trail:60,shadow:false,hwaccel:false,className:"spinner",zIndex:2000000000};i.control={init:function(){log("初始化图表区域");i.view.init();d.init();j.Widgets.updateGridGraph=i.view.updateGridGraph;j.Widgets.showLoading=i.view.showLoading;j.Widgets.hideLoading=i.view.hideLoading;j.Widgets.showTip=i.view.showTip;j.Widgets.hideTip=i.view.hideTip;j.Widgets.start=i.control.start;j.Widgets.getThumbSingleURL=i.view.getThumbSingleURL;j.Widgets.getThumbURL=i.view.getThumbURL;j.Widgets.openUrlPanel=i.view.openUrlPanel},getPluginByType:function(p){if(["pie","bar","barMix","line","radar","funnel","gauge","map","treemap","scatter","heatmap","heatmap1","effectScatter"].indexOf(p)>-1){return j.Widgets.plugins.echarts}else{return j.Widgets.plugins[p]}},start:function(r){if(r=="collect"){var E=[];var t=i.view.getFirstLeft()-10;var q=i.view.getLastRight()-t;jQuery("#tableChartPanel .container").each(function(){var O=$(this);var M=O.data("option");var P=O.data("menuData");M.mapType=M.mapType||"";if($(".chart.text",this)[0]){var L=$(".text-editor.edui-body-container",this).html();M.config.build.textStr=L;$(".edui-toolbar",this).css("display","none")}if(M){var N=i.view.getLastTop();var Q={option:M,layout:{top:O.css("top"),left:O.css("left"),width:O.css("width"),height:O.css("height"),_left:(O.css("left").replace("px","")-t)/q*100+"%",_width:(M.chartType=="text")?O.css("width"):O.css("width").replace("px","")/q*100+"%","border-width":O.css("border-width"),"border-color":O.css("border-color"),background:O.css("background"),"box-shadow":O.css("box-shadow"),"border-radius":O.css("border-radius")}};if(P){Q.menuData=P}E.push(Q)}});var G=d.dataStart("collect");var I={widgets:E,filters:G,openDownload:jQuery("#openDownload").prop("checked"),tplId:j.main.tplId||"",};if(jQuery("#openSendEmail")[0]){I.openSendEmail=jQuery("#openSendEmail").prop("checked")}if(jQuery("#openWaterflag")[0]){I.openWaterflag=!jQuery("#openWaterflag").prop("checked")}if(discovery=="1"){I.filters=[];I.widgets[0].option.config.build.dataParams.filterJsonStr=""}return I}else{if(r=="render"){var I=arguments[1];var z=I.widgets;var v=I.filters;var D=I.openSendEmail;var H=I.openDownload;var y=!I.openWaterflag;var p=$.toJSON(v);d.dataStart(v);for(var C=0,A=z.length;C<A;C++){var s=z[C];var w=s.option;var F=s.layout;var x=s.chartId;var u=s.menuData;var B=i.view.packageContainer($("#tableChartPanel"),{top:F.top,left:F.left},w.chartType,w.el);B.css({width:F.width,height:F.height,"border-width":F["border-width"],"border-color":F["border-color"],background:F.background,"box-shadow":F["box-shadow"],"border-radius":F["border-radius"]}).data("option",w);if(u){B.data("__menuData",u)}(function(L){setTimeout(function(){i.control.getPluginByType(L.chartType).apply(L,true,true)},0)})(w)}setTimeout(function(){i.view.installWidgetsDraggableAndResize();i.view.updateGridGraph($("#tableChartPanel"));if(v){jQuery("#openFilter").prop("checked",true).change()}if(D){jQuery("#openSendEmail").prop("checked",true).change()}if(H){jQuery("#openDownload").prop("checked",true).change()}jQuery("#openWaterflag").prop("checked",y).change()},10)}else{if(r=="renderTpl"){var J=arguments[1];for(var C=0,A=J.length;C<A;C++){var K=J[C];var F=K.layout;var I=K.config;var B=i.view.packageContainer($("#tableChartPanel"),{top:F.top,left:F.left},I.chartType);B.css({width:F.width,height:F.height,});k.rendTpl(B,I);setTimeout(function(){i.view.installWidgetsDraggableAndResize();i.view.updateGridGraph($("#tableChartPanel"))},10)}}}}if(!!sessionStorage.imgSrc){$(".container").css({"background-image":"url("+sessionStorage.imgSrc+")","background-size":"100% 100%","background-repeat":"no-repeat"})}}};i.view={init:function(){i.view.initDroppable();for(var p in i.view.bindEvent){i.view.bindEvent[p]()}},initDroppable:function(){jQuery("#tableChartPanel").droppable({drop:function(p,x){var r=x.helper;var v=$(this);if(!r.hasClass("hp-container")){i.view.updateGridGraph();return}var s=i.view.autoPositionGrid(p,v);var u=r.attr("chartType");r.remove();var t=i.view.packageContainer(v,s,u);var y=o[u];if(_.keys(y).length>0){k.rendTpl(t,y)}i.view.checkContainerOverlap(t);var q=t.siblings("div[id!='gridBg']");if(q.hasClass("container-error")){var w=i.view.getLastBottom(t);t.animate({top:w},500,function(){i.view.updateGridGraph()});setTimeout(function(){q.removeClass("container-error")},500);v.animate({scrollTop:w-21},500)}i.view.updateGridGraph();i.view.installWidgetsDraggableAndResize()}})},packageContainer:function(y,w,x,u){var p=u||"container_"+(new Date()).getTime();var z=x.split("-")[0];var v=x.split("-")[1]||"";var r=x.split("-")[2]||"";y.append($("<div></div>",{id:p,chartType:x,"class":A(z),css:{position:"absolute",left:w.left,top:w.top},html:q(z),}));function A(C){switch(C){case"text":return"container allow editor-container";break;case"indicator":return"container allow indicator-container";break;default:return"container allow"}}function q(C){switch(C){case"text":return'<div class="tools"></div><div class="chart '+C+'"><i class="iconfont icon-'+C+' exp"></i></div>';break;case"indicator":return'<div class="tools"></div><div class="dimAttrSettingPanel" style="display:none"></div><div class="chart"><i class="iconfont icon-'+C+' exp"></i></div>';break;default:return'<div class="tools"></div><div class="breadcrumbs"></div><div class="chainInfo"></div><div class="dimAttrSettingPanel" style="display:none"></div><div class="chart"><i class="iconfont icon-'+C+' exp"></i></div>'}}var B=$("#"+p);i.currentPlugin=i.control.getPluginByType(z);if(!i.currentPlugin){log("没有找到 "+z+" 对应的组件,请检查是否注册组件！")}else{i.currentPlugin.init();var t=B.attr("charttype");if("table-detail"==t){t=0}else{if("table-pivot"==t){t=1}else{t=0}}$(".tools",B).append(i.currentPlugin.contanier.getTools("main",t));B.find(".tools .chart-icon").poshytip({className:"tip-twitter",showTimeout:100,alignTo:"target",offsetY:-28,offsetX:12,alignX:"left"});var s=$(i.currentPlugin.contanier.settingPanel);$(".dimAttrSettingPanel",B).append(s);if(z=="indicator"){B.css({width:"259px",height:"179px"})}c.autoScroll($("#"+p+" .panel"),{cursorcolor:"#5489A9"})}setTimeout(function(){i.view.resizeTempCharts(B)},100);B.data("option",{el:p,isInit:false,chartType:z,chartChild:v,mapType:r||"",config:{plugins:i.currentPlugin.type,build:{},designPanel:{},dataPanel:{}}});return B},installWidgetsDraggableAndResize:function(){jQuery("div.container").draggable({containment:"parent",handle:".move",scroll:true,scrollSensitivity:20,delay:1,scrollSpeed:20,grid:[20,20],drag:function(p,q){i.view.checkContainerOverlap($(this))},start:function(p,q){q.helper.addClass("ui-start-active-zindex");$(this).find(".tools .chart-icon").poshytip("disable")},stop:function(q,r){var u=$(this),p=u.siblings("div[id!='gridBg']");if(p.hasClass("container-error")){u.animate(r.originalPosition,300);p.removeClass("container-error")}r.helper.removeClass("ui-start-active-zindex");var t=Math.round(parseInt(u.css("left").replace("px",""))/20)*20-10;var s=Math.round(parseInt(u.css("top").replace("px",""))/20)*20-10;u.css({left:t,top:s});u.find(".tools .chart-icon").poshytip("enable")}}).resizable({grid:[20,20],autoHide:true,containment:"parent",minWidth:319,minHeight:239,handles:"all",start:function(q,r){var s=jQuery(r.helper);var p=s.data("option");var t=p.isInit;if(t){i.control.getPluginByType(p.chartType).contanier.resize.start(p.el)}r.helper.addClass("ui-start-active-zindex").removeClass("allow")},resize:function(q,r){var s=jQuery(r.helper);var p=s.data("option");var t=p.isInit;if(t){i.view.resizeContainer(p)}else{i.view.resizeTempCharts(s)}i.view.checkContainerOverlap($(this));if(p.chartType=="indicator"){$(this).resizable({minWidth:259,minHeight:139,})}},stop:function(r,s){var t=$(this),q=t.siblings("div[id!='gridBg']");var u=jQuery(s.helper);var p=u.data("option");var v=p.isInit;if(q.hasClass("container-error")){t.animate(s.originalSize,50,function(){t.animate(s.originalPosition,50);if(v){i.view.resizeContainer(p)}else{i.view.resizeTempCharts(u)}});q.removeClass("container-error")}if(v){i.control.getPluginByType(p.chartType).contanier.resize.stop(p.el)}u.removeClass("ui-start-active-zindex").addClass("allow");i.view.updateGridGraph()}});if($("div.container").find("div.chart").hasClass("text")){$("div.chart.text").parent().resizable({minWidth:420,minHeight:75})}},autoPositionGrid:function(p,s){var r=p.pageX+s.scrollLeft()-s.offset().left-76;var q=p.pageY+s.scrollTop()-s.offset().top-76;r=r<10?10:r;q=q<10?10:q;return{left:Math.round(r/20)*20-10,top:Math.round(q/20)*20-10}},updateGridGraph:function(){var u=jQuery("#tableChartPanel");var q=u.get(0).scrollWidth;var r=u.get(0).scrollHeight;var t=u.data("scrollWidth")||u.width();var p=u.data("scrollHeight")||u.height();var s=u.find("#gridBg");if(q>t){q=q+20;s.width(q);u.data("scrollWidth",q)}if(r>p){r=r+20;s.height(r);u.data("scrollHeight",r)}},resizeTempCharts:function(u){var r=u.find(".iconfont.exp"),t=u.width(),p=u.height(),s=r.width(),q=r.height();r.css({transform:"scale("+Math.min((p/200),(t/200))+")",top:function(){return(p-q)/2},left:function(){return(t-s)/2}})},resizeContainer:function(p){i.control.getPluginByType(p.chartType).contanier.resize.reisze(p.el)},checkContainerOverlap:function(t){var q=t.siblings("div[id!='gridBg']");var p=t.position();var s=p.left,v=p.top,r=s+t.width(),u=v+t.height();q.each(function(){var w=$(this);var B=w.position();var y=B.left,A=B.top,x=y+w.width(),z=A+w.height();if(((s>y&&s<x)||(r>y&&r<x))&&((v>A&&v<z)||(u>A&&u<z))||(((y>s&&y<r)||(x>s&&x<r))&&((A>v&&A<u)||(z>v&&z<u)))){w.addClass("container-error")}else{w.removeClass("container-error")}})},getLastBottom:function(q){var p=0;jQuery("#tableChartPanel .container").not("#"+q.attr("id")).each(function(){var r=$(this).position().top+$(this).parent().scrollTop()+$(this).height()+20;if(p<r){p=r}});return Math.round(p/20)*20+10},getLastTop:function(r){var p=[];var q=r?jQuery("#tableChartPanel .container").not("#"+r.attr("id")):jQuery("#tableChartPanel .container");q.each(function(){var s=$(this).position().top+$(this).parent().scrollTop()+20;p.push(s)});return Math.min.apply(null,p)},getFirstLeft:function(){var p=[];var q=jQuery("#tableChartPanel .container");q.each(function(){p.push($(this).position().left+$(this).parent().scrollLeft())});return Math.min.apply({},p)},getLastRight:function(r){var q=0;var p=r?jQuery("#tableChartPanel .container").not("#"+r.attr("id")):jQuery("#tableChartPanel .container");p.each(function(){var s=$(this).position().left+$(this).parent().scrollLeft()+$(this).width()+20;if(q<s){q=s}});return Math.round(q/20)*20+10},bindEvent:{togglePanel:function(){jQuery("#layout_body_title_panel .closeAttr").on("click",function(){myLayout.toggle("west");jQuery(this).find("div:eq(0)").toggleClass("fa-caret-left").toggleClass("fa-caret-right")});jQuery("#layout_body_title_panel .fullScreen").on("click",function(){var p=jQuery(this).find("div:eq(0)");if(p.hasClass("fa-caret-down")){n.toggleAllPanel("open")}else{n.toggleAllPanel("close")}p.toggleClass("fa-caret-down").toggleClass("fa-caret-up")});$("#tableChartPanel").bind("scroll",function(){});jQuery("#layout_body_title_panel  .closeFilter").on("click",function(){myLayout.center.children.layout1.center.children.layout1.toggle("north");jQuery(this).find("div:eq(0)").toggleClass("fa-caret-up").toggleClass("fa-caret-down")});jQuery("#layout_body_title_panel #setGlobalFilter").on("click",function(){d.setGlobalFilter("add")})},contanierTools:function(){jQuery("#tableChartPanel").on("click",".container .chart,.container .panel.datagrid",function(){var p=jQuery(this);var q=p.parents(".container");var r=q.find(".dimAttrSettingPanel");if(r.is(":visible")){r.hide("slide")}});jQuery("#gridBg").click(function(){l.close()});jQuery("#tableChartPanel").on("click",".chart-icon.setting",function(){var p=jQuery(this).parents(".container").data("option");l.toggle(p)});jQuery("#tableChartPanel").on("click",".chart-icon.openSelfDimAttr",function(){var q=jQuery(this).parents(".container");var p=q.data("option").chartType;var r=i.control.getPluginByType(p).contanier.renderSettingPanel(q);if(r.is(":hidden")){r.show("slide")}else{r.hide("slide")}});jQuery("#tableChartPanel").on("click",".chart-icon.removeSelfChart",function(){var p=$(this);var q=p.parents(".container");i.view.showTip({_id:"delPanel",titleShow:"false",msg:"确定删除？",button:'<div class="btn delChartTrue">确定</div><div class="btn delChartCanel">取消</div>'},q);$("#delPanel .delChartCanel").click(function(){i.view.hideTip("delPanel")});$("#delPanel .delChartTrue").click(function(){var u=jQuery(this);var v=u.parents(".container");var w=v.attr("id");var t=v.data("option").chartType;var r=v.data("option").config.build.dataParams;var s=r&&r.dataId;i.control.getPluginByType(t).destory(w);s&&d.reomveGlobalFilter(s);v.hide("fade",500,function(){jQuery(this).remove()});if(j.Property.isMyProperty&&j.Property.isMyProperty(w)){l.close(true)}})});jQuery("#tableChartPanel").on("click",".chart-icon.viewdata",function(){var s=jQuery(this);var t=s.parents(".container");var p=t.data("option").config.build.dataParams;var q=p&&p.dataId;var r=p&&p.dataType;q=q||j.main.dataId;r=r||j.main.dataType;if(!q){return}h.show(q)});jQuery("#tableChartPanel").on("click",".chart-icon.tabledownload",function(){var q=jQuery(this).parents(".container").data("option");if(!q.isInit){return}var p=c.handleUrlParam("/platform/dataview/down-table-data");p=p+"?"+$.param(q.config.build.dataParams);c.downloadbyfloor(p)});jQuery("#tableChartPanel").on("click",".chart-icon.xy2yx",function(){var q=jQuery(this).parents(".container").data("option");if(q.isInit){var p=JSON.parse(q.config.build.dataParams.dimAttrJsonStr);var r=p.rowsData;p.rowsData=p.colsData;p.colsData=r;r=null;q.config.build.dataParams.dimAttrJsonStr=JSON.stringify(p);i.control.getPluginByType(q.chartType).apply(q,true);$(this).toggleClass("checked")}});jQuery("#tableChartPanel").on("click",".breadcrumbs>a",function(){var r=jQuery(this).parent(".breadcrumbs").find("a").index(this);var p=jQuery(this).parents(".container");var q=p.find(".chart")[0];jQuery(q).EBuilder("undrill",r)});jQuery("#tableChartPanel").on("click",".chainInfo .j_unchainChart",function(){var p=jQuery(this).parents(".container");if(p.find(".chart:visible").length){var q=p.find(".chart")[0];jQuery(q).EBuilder("unchainChart")}else{j.Widgets.plugins.table.unchainChart(p)}})}},redirecPage:function(r,t){var s="";for(var q in t){s+="<input name='"+q+"' value='"+t[q]+"'/>"}var p=jQuery("<form></form>",{method:"post",action:r,target:"_blank",html:s});jQuery("body").append(p);p.submit();jQuery(p).remove()},showLoading:function(q){if(typeof(Spinner2)!=="undefined"){var p=jQuery("<div></div>",{"class":"bi-confirm loadingBg"});q.spin(a);q.append(p)}q.data("isLoading",true)},hideLoading:function(q){var p=q.find(".loadingBg");if(p.length==0){return}if(typeof(Spinner2)!=="undefined"){q.spin("close");p.remove()}q.data("isLoading",false)},showTip:function(r,q){r.titleShow=r.titleShow||true;var p='<div id="${_id}" failType="${failType}" class="bi-confirm ${className}">	<div class="confrim-text" style="letter-spacing: 1px;text-align:center">  {{if titleShow==true}} <span style="font-size: 26px;">提示 </span>{{/if}}{{html msg}}	</div>	<div class="btn-group">{{html button}}	</div></div>';$.tmpl(p,r).appendTo(q)},hideTip:function(p){jQuery("#"+p).remove()},getThumbSingleURL:function(p){return $(".chart",p).EBuilder("getInstanceByDom").getDataURL({backgroundColor:p.css("backgroundColor")})},getThumbURL:function(q){jQuery("#gridBg,#tableChartPanel").removeClass("grid-bg");var w=jQuery("#tableChartPanel");w.animate({scrollTop:0},0);jQuery("#thumb_canvas").remove();var t=[];var x=[];var u=[];var s=[];jQuery("#tableChartPanel .container").each(function(){var z=$(this);t.push(z.position().top);x.push(z.position().top+z.parent().scrollTop()+z.height()+20);u.push(z.position().left+z.parent().scrollLeft());s.push(z.position().left+z.parent().scrollLeft()+z.width())});var r=Math.min.apply({},t)-20;r=r<0?0:r;var v=Math.max.apply({},x)+20;var p=Math.min.apply({},u)-20;var y=Math.max.apply({},s)+20;html2canvas(document.getElementById("tableChartPanel"),{onrendered:function(B){var D=0;var A=0;var z=y+400;var E=v+400;var I=z;var C=E;var H=-p;var G=-r;var F=new Image();F.src=B.toDataURL("image/png");F.onload=function(){var L=y-p;var J=v-r;var N=document.createElement("canvas");N.setAttribute("id","thumb_canvas");N.style.display="none";N.width=L;N.height=J;document.body.appendChild(N);var M=document.getElementById("thumb_canvas");var K=M.getContext("2d");K.drawImage(F,D,A,z,E,H,G,I,C);document.body.appendChild(M);log("图形生成完毕");jQuery("#gridBg,#tableChartPanel").addClass("grid-bg");q.resolve(M.toDataURL("image/png"))}},width:y+500,height:v+500});return q},openUrlPanel:function(p){m.init();if(p==="close"){$("#layout_body_url_panel").css("display","none")}else{if(p==="open"){$("#layout_body_url_panel").css("display","block");$("#setUrlPath").click(m.show)}}}};return i.control});