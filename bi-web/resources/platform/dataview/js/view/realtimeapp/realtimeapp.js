define(["bace","view/box","view/realtimeapp/realtimeapp_layout","view/realtimeapp/realtimeapp_datagrid","view/realtimeapp/realtimeapp_filters","view/component/OpenApiGridUtil","view/component/reportUtil","underscore","layout","grid","validation","dialog"],function(c,l,p,d,e,b,g,q){var j={};j.module={};var a={lines:13,length:7,width:4,radius:10,corners:1,rotate:0,color:"#fff",speed:1,trail:60,shadow:false,hwaccel:false,className:"spinner",zIndex:2000000000};var i=false;var m=null;var n=null;j.control={init:function(){l.flags.isRealtimeapp=true;l.main.reportId=_RSDFGHJJKK;l.main.appType=appType;if(l.main.reportId){$.ajax({type:"POST",url:c.handleUrlParam("/platform/dataview/queryViewInfo"),dataType:"json",data:{reportId:l.main.reportId,appType:l.main.appType},success:function(r){l.main.reportName=r.reportName;console.log(r);l.main.reportDesc=r.reportDesc;l.main.labelId=$.evalJSON(r.labelId);var t=JSON.parse(r.resportConfig);j.view.init();j.view.bindEvents();var s=t.properties;if("1"==isView){s=q.filter(s,function(v,u){return v.checked})}j.view.rander(t.apiBaseInfo,t.paramInfoStr,s);f("exec");setTimeout(function(){jQuery("body").removeClass("invisible")},850)}})}else{j.view.init();j.view.bindEvents();setTimeout(function(){jQuery("body").removeClass("invisible")},850)}}};j.view={init:function(){p.init();jQuery("#tabs").tabs({active:function(r,s){},beforeActivate:function(r,s){}}).disableSelection();if("1"==isView){window.myLayout.sizePane("north",33);$("#tabs_data").empty()}jQuery("#tabs").append($("<div></div>",{"class":"tabs-logo",html:"<div class='icon-logo'></div>"}).on("click",function(){}))},bindEvents:function(){$(window).resize(function(r){if(!$("#table_container").is(":empty")){setTimeout(function(){$("#table_container").datagrid("resize")},400)}});jQuery("#existData").click(function(){b.show(j.view.rander)});$(".j_exec").click(function(r){r.stopPropagation();f("query")});$(".search .fa-search").click(function(r){r.stopPropagation();f("query")});$("#saveReport").click(function(r){r.stopPropagation();if(!i){$.dialog({lock:true,content:'<div style="color:#444;font-weight:bolder;margin-top:-10px">请加载数据源</div>',icon:"warning",ok:true});return false}else{if(!$("#table_container").hasClass("datagrid-f")){$.dialog({lock:true,content:'<div style="color:#444;font-weight:bolder;margin-top:-10px">请先初始化表格</div>',icon:"warning",ok:true});return false}else{l.main.realTimeappConfig={properties:k.view.collect("save"),apiBaseInfo:m,paramInfoStr:n};g.show()}}})},rander:function(r,u,s){console.log(u,r);m=r;n=u;i=true;var v=["","icon-attr-str","icon-attr-num","icon-attr-num","icon-attr-date"];s=s||JSON.parse(r.resultInfoStr);s=$.map(s,function(x,w){x.iconClass=v[x.resultType];x.spin=!!x.spin;x.spinClass=!x.spin?"":"spin";x.checked=!!x.checked;x.checkClass=!x.checked?"":"checked";return x});k.view.init(s);k.view.bindEvents();var t=JSON.parse(u);e.init(t,r)},showLoading:function(s){if(typeof(Spinner2)!=="undefined"){var r=jQuery("<div></div>",{"class":"bi-confirm loadingBg"});s.spin(a);s.append(r)}s.data("isLoading",true)},hideLoading:function(s){var r=s.find(".loadingBg");if(r.length==0){return}if(typeof(Spinner2)!=="undefined"){s.spin("close");r.remove()}s.data("isLoading",false)}};function f(s){if(!i){$.dialog({lock:true,content:'<div style="color:#444;font-weight:bolder;margin-top:-10px">请加载数据源！</div>',icon:"warning",ok:true});return false}var t=k.view.collect("colum");if(t.columns[0].length+t.frozenColumns[0].length==0){$.dialog({lock:true,content:'<div style="color:#444;font-weight:bolder;margin-top:-10px">请选择展示指标！</div>',icon:"warning",ok:true});return false}var r=$.extend(true,{},m);r.resultInfoStr=k.view.collect("query");r.paramInfoStr=e.collect(s);t.queryParams=r;d.init(t)}var o=null;var h;var k={view:{init:function(t,s){if(o){var r=$("#layout_attr_panel").ligerGetGridManager();if(!r){return}r.loadData({Rows:t})}o=$("#layout_attr_panel").ligerGrid({columns:[{name:"attrClass",width:"100%",align:"left",render:function(y,v,w){var x=y.resultName;var u="<span class='attrname' title='{{resultName}}' data-result_name='{{resultName}}' data-result_code='{{resultCode}}' data-result_lenght='{{resultLength}}' data-result_type='{{resultType}}' data-spin='{{spin}}' data-checked='{{checked}}'>{{resultName}}</span><span class='spin-icon {{spinClass}}' title='固定列'></span><span class='check-icon {{checkClass}}' title='选择列'></span>";return c.buildString(u,y)}}],width:"100%",height:"100%",heightDiff:25,title:function(){return'<span class="filter-span">	<input id="filterInput" class="filter-text"  placeholder="输入指标关键字"/>	<span class="filter-icon"></span></span>'}(),data:{Rows:t},alternatingRow:false,selectRow:false,usePager:false,tree:{columnName:"attrClass",isParent:$.noop},onClickRow:function(x,v,w,u){},onAfterShowData:function(){$(".filter-span .filter-icon").off("click");$(".filter-span .filter-icon").click(function(){var w=$("#filterInput").val().trim();var u=$("#layout_attr_panel .l-grid-row");u.show();if(!w){return}var v=w.split(" ");$.each(v,function(x,y){u=u.filter(function(){return !$(this).is(":contains('"+y+"')")})});u.hide()});$("#filterInput").off("keydown");$("#filterInput").keydown(function(u){if(u.keyCode=="13"){$(".filter-span .filter-icon").click()}else{clearTimeout(h);h=setTimeout(function(){$(".filter-span .filter-icon").click()},400)}});c.autoScroll($("#layout_attr_panel .l-grid-body2"))}})},collect:function(v){var t=q.map($("#layout_attr_panel .attrname"),function(z,w){var y=$(z);var x=y.data();x=c.coverObj2Camel(x);return x});switch(v){case"colum":var s=q.map(q.filter(t,function(x,w){return x.checked&&!x.spin}),function(x,w){return{field:x.resultCode,title:x.resultName,width:100}});var u=q.map(q.filter(t,function(x,w){return x.checked&&x.spin}),function(x,w){return{field:x.resultCode,title:x.resultName,width:100}});var r=(s.length+u.length)<=15;return{columns:[s],frozenColumns:[u],fitColumns:false};break;case"save":return t;break;case"query":return q.map(t,function(x,w){if(x.checked){return x.resultCode}}).join(",");break;default:break}},bindEvents:function(){$("#layout_attr_panel").off("click");$("#layout_attr_panel").on("click",".l-grid-row-cell-inner",function(s){var t=k.control.isChecked(this);var r=k.control.isSpin(this);if(!t){k.control.checkProperties(this)}else{if(t&&!r){k.control.spinProperties(this)}else{k.control.unCheckProperties(this);k.control.unSpinProperties(this)}}});$("#layout_attr_panel").on("click",".spin-icon",function(s){var r=$(this).parents(".l-grid-row-cell-inner")[0];var t=k.control.isChecked(r);if(!t){k.control.checkProperties(r);k.control.spinProperties(r)}else{k.control.toggleSpin(r)}s.stopPropagation()});$("#layout_attr_panel").on("click",".check-icon",function(t){var s=$(this).parents(".l-grid-row-cell-inner")[0];var r=k.control.isSpin(s);if(r){k.control.unSpinProperties(s);k.control.unCheckProperties(s)}else{k.control.toggleCheck(s)}t.stopPropagation()})}},control:{toggleCheck:function(r){if(k.control.isChecked(r)){k.control.unCheckProperties(r)}else{k.control.checkProperties(r)}},checkProperties:function(t){var r=$(t).find(".check-icon");var s=$(t).find(".attrname");s.data("checked",true);r.addClass("checked")},unCheckProperties:function(t){var r=$(t).find(".check-icon");var s=$(t).find(".attrname");s.data("checked",false);r.removeClass("checked")},isChecked:function(s){var r=$(s).find(".check-icon");return r.hasClass("checked")},toggleSpin:function(r){if(k.control.isSpin(r)){k.control.unSpinProperties(r)}else{k.control.spinProperties(r)}},spinProperties:function(s){var t=$(s).find(".spin-icon");var r=$(s).find(".attrname");r.data("spin",true);t.addClass("spin")},unSpinProperties:function(s){var t=$(s).find(".spin-icon");var r=$(s).find(".attrname");r.data("spin",false);t.removeClass("spin")},isSpin:function(r){var s=$(r).find(".spin-icon");return s.hasClass("spin")}}};return j.control});