UM.commands.inserthtml={execCommand:function(b,h,o){var u=this,j,k;if(!h){return}if(u.fireEvent("beforeinserthtml",h)===true){return}j=u.selection.getRange();k=j.document.createElement("div");k.style.display="inline";if(!o){var q=UM.htmlparser(h);if(u.options.filterRules){UM.filterNode(q,u.options.filterRules)}u.filterInputRule(q);h=q.toHtml()}k.innerHTML=utils.trim(h);if(!j.collapsed){var t=j.startContainer;if(domUtils.isFillChar(t)){j.setStartBefore(t)}t=j.endContainer;if(domUtils.isFillChar(t)){j.setEndAfter(t)}j.txtToElmBoundary();if(j.endContainer&&j.endContainer.nodeType==1){t=j.endContainer.childNodes[j.endOffset];if(t&&domUtils.isBr(t)){j.setEndAfter(t)}}if(j.startOffset==0){t=j.startContainer;if(domUtils.isBoundaryNode(t,"firstChild")){t=j.endContainer;if(j.endOffset==(t.nodeType==3?t.nodeValue.length:t.childNodes.length)&&domUtils.isBoundaryNode(t,"lastChild")){u.body.innerHTML="<p>"+(browser.ie?"":"<br/>")+"</p>";j.setStart(u.body.firstChild,0).collapse(true)}}}!j.collapsed&&j.deleteContents();if(j.startContainer.nodeType==1){var f=j.startContainer.childNodes[j.startOffset],l;if(f&&domUtils.isBlockElm(f)&&(l=f.previousSibling)&&domUtils.isBlockElm(l)){j.setEnd(l,l.childNodes.length).collapse();while(f.firstChild){l.appendChild(f.firstChild)}domUtils.remove(f)}}}var f,g,l,s,d=0,a;if(j.inFillChar()){f=j.startContainer;if(domUtils.isFillChar(f)){j.setStartBefore(f).collapse(true);domUtils.remove(f)}else{if(domUtils.isFillChar(f,true)){f.nodeValue=f.nodeValue.replace(fillCharReg,"");j.startOffset--;j.collapsed&&j.collapse(true)}}}while(f=k.firstChild){if(d){var m=u.document.createElement("p");while(f&&(f.nodeType==3||!dtd.$block[f.tagName])){a=f.nextSibling;m.appendChild(f);f=a}if(m.firstChild){f=m}}j.insertNode(f);a=f.nextSibling;if(!d&&f.nodeType==domUtils.NODE_ELEMENT&&domUtils.isBlockElm(f)){g=domUtils.findParent(f,function(e){return domUtils.isBlockElm(e)});if(g&&g.tagName.toLowerCase()!="body"&&!(dtd[g.tagName][f.nodeName]&&f.parentNode===g)){if(!dtd[g.tagName][f.nodeName]){l=g}else{s=f.parentNode;while(s!==g){l=s;s=s.parentNode}}domUtils.breakParent(f,l||s);var l=f.previousSibling;domUtils.trimWhiteTextNode(l);if(!l.childNodes.length){domUtils.remove(l)}if(!browser.ie&&(n=f.nextSibling)&&domUtils.isBlockElm(n)&&n.lastChild&&!domUtils.isBr(n.lastChild)){n.appendChild(u.document.createElement("br"))}d=1}}var n=f.nextSibling;if(!k.firstChild&&n&&domUtils.isBlockElm(n)){j.setStart(n,0).collapse(true);break}j.setEndAfter(f).collapse()}f=j.startContainer;if(a&&domUtils.isBr(a)){domUtils.remove(a)}if(domUtils.isBlockElm(f)&&domUtils.isEmptyNode(f)){if(a=f.nextSibling){domUtils.remove(f);if(a.nodeType==1&&dtd.$block[a.tagName]){j.setStart(a,0).collapse(true).shrinkBoundary()}}else{try{f.innerHTML=browser.ie?domUtils.fillChar:"<br/>"}catch(r){j.setStartBefore(f);domUtils.remove(f)}}}try{if(browser.ie9below&&j.startContainer.nodeType==1&&!j.startContainer.childNodes[j.startOffset]){var c=j.startContainer,l=c.childNodes[j.startOffset-1];if(l&&l.nodeType==1&&dtd.$empty[l.tagName]){var i=this.document.createTextNode(domUtils.fillChar);j.insertNode(i).setStart(i,0).collapse(true)}}setTimeout(function(){j.select(true)})}catch(r){}setTimeout(function(){j=u.selection.getRange();j.scrollIntoView();u.fireEvent("afterinserthtml")},200)}};UM.commands.insertimage={execCommand:function(f,d){d=utils.isArray(d)?d:[d];if(!d.length){return}var e=this;var c=[],g="",b;b=d[0];if(d.length==1){g='<img src="'+b.src+'" '+(b._src?' _src="'+b._src+'" ':"")+(b.width?'width="'+b.width+'" ':"")+(b.height?' height="'+b.height+'" ':"")+(b.floatStyle=="left"||b.floatStyle=="right"?' style="float:'+b.floatStyle+';"':"")+(b.title&&b.title!=""?' title="'+b.title+'"':"")+(b.border&&b.border!="0"?' border="'+b.border+'"':"")+(b.alt&&b.alt!=""?' alt="'+b.alt+'"':"")+(b.hspace&&b.hspace!="0"?' hspace = "'+b.hspace+'"':"")+(b.vspace&&b.vspace!="0"?' vspace = "'+b.vspace+'"':"")+"/>";if(b.floatStyle=="center"){g='<p style="text-align: center">'+g+"</p>"}c.push(g)}else{for(var a=0;b=d[a++];){g="<p "+(b.floatStyle=="center"?'style="text-align: center" ':"")+'><img src="'+b.src+'" '+(b.width?'width="'+b.width+'" ':"")+(b._src?' _src="'+b._src+'" ':"")+(b.height?' height="'+b.height+'" ':"")+' style="'+(b.floatStyle&&b.floatStyle!="center"?"float:"+b.floatStyle+";":"")+(b.border||"")+'" '+(b.title?' title="'+b.title+'"':"")+" /></p>";c.push(g)}}e.execCommand("insertHtml",c.join(""),true)}};UM.plugins.justify=function(){var a=this;$.each("justifyleft justifyright justifycenter justifyfull".split(" "),function(c,b){a.commands[b]={execCommand:function(d){return this.document.execCommand(d)},queryCommandValue:function(d){var e=this.document.queryCommandValue(d);return e===true||e==="true"?d.replace(/justify/,""):""},queryCommandState:function(d){return this.document.queryCommandState(d)?1:0}}})};UM.plugins.font=function(){var c=this,e={forecolor:"forecolor",backcolor:"backcolor",fontsize:"fontsize",fontfamily:"fontname"},a={forecolor:"color",backcolor:"background-color",fontsize:"font-size",fontfamily:"font-family"},b={forecolor:"color",fontsize:"size",fontfamily:"face"};c.setOpt({fontfamily:[{name:"songti",val:"宋体,SimSun"},{name:"yahei",val:"微软雅黑,Microsoft YaHei"},{name:"kaiti",val:"楷体,楷体_GB2312, SimKai"},{name:"heiti",val:"黑体, SimHei"},{name:"lishu",val:"隶书, SimLi"},{name:"andaleMono",val:"andale mono"},{name:"arial",val:"arial, helvetica,sans-serif"},{name:"arialBlack",val:"arial black,avant garde"},{name:"comicSansMs",val:"comic sans ms"},{name:"impact",val:"impact,chicago"},{name:"timesNewRoman",val:"times new roman"},{name:"sans-serif",val:"sans-serif"}],fontsize:[12,16,18,24,32,48]});c.addOutputRule(function(f){utils.each(f.getNodesByTagName("font"),function(g){if(g.tagName=="font"){var j=[];for(var h in g.attrs){switch(h){case"size":var i=g.attrs[h];$.each({"10":"1","12":"2","16":"3","18":"4","24":"5","32":"6","48":"7"},function(m,l){if(l==i){i=m;return false}});j.push("font-size:"+i+"px");break;case"color":j.push("color:"+g.attrs[h]);break;case"face":j.push("font-family:"+g.attrs[h]);break;case"style":j.push(g.attrs[h])}}g.attrs={style:j.join(";")}}g.tagName="span";if(g.parentNode.tagName=="span"&&g.parentNode.children.length==1){$.each(g.attrs,function(m,l){g.parentNode.attrs[m]=m=="style"?g.parentNode.attrs[m]+l:l});g.parentNode.removeChild(g,true)}})});for(var d in e){(function(f){c.commands[f]={execCommand:function(i,m){if(m=="transparent"){return}var h=this.selection.getRange();if(h.collapsed){var k=$("<span></span>").css(a[i],m)[0];h.insertNode(k).setStart(k,0).setCursor()}else{if(i=="fontsize"){m={"10":"1","12":"2","16":"3","18":"4","24":"5","32":"6","48":"7"}[(m+"").replace(/px/,"")]}this.document.execCommand(e[i],false,m);if(browser.gecko){$.each(this.$body.find("a"),function(p,n){var q=n.parentNode;if(q.lastChild===q.firstChild&&/FONT|SPAN/.test(q.tagName)){var o=q.cloneNode(false);o.innerHTML=n.innerHTML;$(n).html("").append(o).insertBefore(q);$(q).remove()}})}if(!browser.ie){var l=this.selection.getNative().getRangeAt(0);var j=l.commonAncestorContainer;var h=this.selection.getRange(),g=h.createBookmark(true);$(j).find("a").each(function(p,r){var q=r.parentNode;if(q.nodeName=="FONT"){var o=q.cloneNode(false);o.innerHTML=r.innerHTML;$(r).html("").append(o)}});h.moveToBookmark(g).select()}return true}},queryCommandValue:function(g){var i=c.selection.getStart();var h=$(i).css(a[g]);if(h===undefined){h=$(i).attr(b[g])}return h?utils.fixColor(g,h).replace(/px/,""):""},queryCommandState:function(g){return this.queryCommandValue(g)}}})(d)}};UM.plugins.link=function(){var a=this;a.setOpt("autourldetectinie",false);if(browser.ie&&this.options.autourldetectinie===false){this.addListener("keyup",function(e,c){var d=this,g=c.keyCode;if(g==13||g==32){var b=d.selection.getRange();var h=b.startContainer;if(g==13){if(h.nodeName=="P"){var f=h.previousSibling;if(f&&f.nodeType==1){var f=f.lastChild;if(f&&f.nodeName=="A"&&!f.getAttribute("_href")){domUtils.remove(f,true)}}}}else{if(g==32){if(h.nodeType==3&&/^\s$/.test(h.nodeValue)){h=h.previousSibling;if(h&&h.nodeName=="A"&&!h.getAttribute("_href")){domUtils.remove(h,true)}}}}}})}this.addOutputRule(function(b){$.each(b.getNodesByTagName("a"),function(e,d){var c=utils.html(d.getAttr("_href"));if(!/^(ftp|https?|\/|file)/.test(c)){c="http://"+c}d.setAttr("href",c);d.setAttr("_href");if(d.getAttr("title")==""){d.setAttr("title")}})});this.addInputRule(function(b){$.each(b.getNodesByTagName("a"),function(d,c){c.setAttr("_href",utils.html(c.getAttr("href")))})});a.commands.link={execCommand:function(c,d){var e=this;var b=e.selection.getRange();if(b.collapsed){var f=b.startContainer;if(f=domUtils.findParentByTagName(f,"a",true)){$(f).attr(d);b.selectNode(f).select()}else{b.insertNode($("<a>"+d.href+"</a>").attr(d)[0]).select()}}else{e.document.execCommand("createlink",false,"_umeditor_link");utils.each(domUtils.getElementsByTagName(e.body,"a",function(g){return g.getAttribute("href")=="_umeditor_link"}),function(g){if($(g).text()=="_umeditor_link"){$(g).text(d.href)}domUtils.setAttributes(g,d);b.selectNode(g).select()})}},queryCommandState:function(){return this.queryCommandValue("link")?1:0},queryCommandValue:function(){var c=this.selection.getStartElementPath();var b;$.each(c,function(d,e){if(e.nodeName=="A"){b=e;return false}});return b}};a.commands.unlink={execCommand:function(){this.document.execCommand("unlink")}}};UM.commands.print={execCommand:function(){var b=this,e="editor_print_"+ +new Date();$('<iframe src="" id="'+e+'" name="'+e+'" frameborder="0"></iframe>').attr("id",e).css({width:"0px",height:"0px",overflow:"hidden","float":"left",position:"absolute",top:"-10000px",left:"-10000px"}).appendTo(b.$container.find(".edui-dialog-container"));var a=window.open("",e,""),c=a.document;c.open();c.write("<html><head></head><body><div>"+this.getContent(null,null,true)+"</div><script>setTimeout(function(){window.print();setTimeout(function(){window.parent.$('#"+e+"').remove();},100);},200);<\/script></body></html>");c.close()},notNeedUndo:1};UM.plugins.paragraph=function(){var a=this;a.setOpt("paragraph",{p:"",h1:"",h2:"",h3:"",h4:"",h5:"",h6:""});a.commands.paragraph={execCommand:function(b,c){return this.document.execCommand("formatBlock",false,"<"+c+">")},queryCommandValue:function(){try{var c=this.document.queryCommandValue("formatBlock")}catch(b){}return c}}};UM.plugins.horizontal=function(){var a=this;a.commands.horizontal={execCommand:function(){this.document.execCommand("insertHorizontalRule");var b=a.selection.getRange().txtToElmBoundary(true),g=b.startContainer;if(domUtils.isBody(b.startContainer)){var e=b.startContainer.childNodes[b.startOffset];if(!e){e=$("<p></p>").appendTo(b.startContainer).html(browser.ie?"&nbsp;":"<br/>")[0]}b.setStart(e,0).setCursor()}else{while(dtd.$inline[g.tagName]&&g.lastChild===g.firstChild){var d=g.parentNode;d.appendChild(g.firstChild);d.removeChild(g);g=d}while(dtd.$inline[g.tagName]){g=g.parentNode}if(g.childNodes.length==1&&g.lastChild.nodeName=="HR"){var c=g.lastChild;$(c).insertBefore(g);b.setStart(g,0).setCursor()}else{c=$("hr",g)[0];domUtils.breakParent(c,g);var f=c.previousSibling;if(f&&domUtils.isEmptyBlock(f)){$(f).remove()}b.setStart(c.nextSibling,0).setCursor()}}}}};UM.commands.cleardoc={execCommand:function(){var b=this,a=b.selection.getRange();b.body.innerHTML="<p>"+(ie?"":"<br/>")+"</p>";a.setStart(b.body.firstChild,0).setCursor(false,true);setTimeout(function(){b.fireEvent("clearDoc")},0)}};UM.plugins.undo=function(){var d;var m=this,p=m.options.maxUndoCount||20,l=m.options.maxInputCount||20,g=new RegExp(domUtils.fillChar+"|</hr>","gi");var i={ol:1,ul:1,table:1,tbody:1,tr:1,body:1};var e=m.options.autoClearEmptyNode;function j(t,s){if(t.length!=s.length){return 0}for(var r=0,q=t.length;r<q;r++){if(t[r]!=s[r]){return 0}}return 1}function n(r,q){if(r.collapsed!=q.collapsed){return 0}if(!j(r.startAddress,q.startAddress)||!j(r.endAddress,q.endAddress)){return 0}return 1}function b(){this.list=[];this.index=0;this.hasUndo=false;this.hasRedo=false;this.undo=function(){if(this.hasUndo){if(!this.list[this.index-1]&&this.list.length==1){this.reset();return}while(this.list[this.index].content==this.list[this.index-1].content){this.index--;if(this.index==0){return this.restore(0)}}this.restore(--this.index)}};this.redo=function(){if(this.hasRedo){while(this.list[this.index].content==this.list[this.index+1].content){this.index++;if(this.index==this.list.length-1){return this.restore(this.index)}}this.restore(++this.index)}};this.restore=function(){var t=this.editor;var v=this.list[this.index];var r=UM.htmlparser(v.content.replace(g,""));t.options.autoClearEmptyNode=false;t.filterInputRule(r,true);t.options.autoClearEmptyNode=e;t.body.innerHTML=r.toHtml();t.fireEvent("afterscencerestore");if(browser.ie){utils.each(domUtils.getElementsByTagName(t.document,"td th caption p"),function(w){if(domUtils.isEmptyNode(w)){domUtils.fillNode(t.document,w)}})}try{var q=new dom.Range(t.document,t.body).moveToAddress(v.address);if(browser.ie&&q.collapsed&&q.startContainer.nodeType==1){var s=q.startContainer.childNodes[q.startOffset];if(!s||s.nodeType==1&&dtd.$empty[s]){q.insertNode(t.document.createTextNode(" ")).collapse(true)}}q.select(i[q.startContainer.nodeName.toLowerCase()])}catch(u){}this.update();this.clearKey();t.fireEvent("reset",true)};this.getScene=function(){var t=this.editor;var s=t.selection.getRange(),u=s.createAddress(false,true);t.fireEvent("beforegetscene");var r=UM.htmlparser(t.body.innerHTML,true);t.options.autoClearEmptyNode=false;t.filterOutputRule(r,true);t.options.autoClearEmptyNode=e;var q=r.toHtml();browser.ie&&(q=q.replace(/>&nbsp;</g,"><").replace(/\s*</g,"<").replace(/>\s*/g,">"));t.fireEvent("aftergetscene");return{address:u,content:q}};this.save=function(t,q){clearTimeout(d);var s=this.getScene(q),r=this.list[this.index];if(r&&r.content==s.content&&(t?1:n(r.address,s.address))){return}this.list=this.list.slice(0,this.index+1);this.list.push(s);if(this.list.length>p){this.list.shift()}this.index=this.list.length-1;this.clearKey();this.update()};this.update=function(){this.hasRedo=!!this.list[this.index+1];this.hasUndo=!!this.list[this.index-1]};this.reset=function(){this.list=[];this.index=0;this.hasUndo=false;this.hasRedo=false;this.clearKey()};this.clearKey=function(){h=0;a=null}}m.undoManger=new b();m.undoManger.editor=m;function k(){this.undoManger.save()}m.addListener("saveScene",function(){var q=Array.prototype.splice.call(arguments,1);this.undoManger.save.apply(this.undoManger,q)});m.addListener("beforeexeccommand",k);m.addListener("afterexeccommand",k);m.addListener("reset",function(r,q){if(!q){this.undoManger.reset()}});m.commands.redo=m.commands.undo={execCommand:function(q){this.undoManger[q]()},queryCommandState:function(q){return this.undoManger["has"+(q.toLowerCase()=="undo"?"Undo":"Redo")]?0:-1},notNeedUndo:1};var o={16:1,17:1,18:1,37:1,38:1,39:1,40:1},h=0,a;var c=false;m.addListener("ready",function(){$(this.body).on("compositionstart",function(){c=true}).on("compositionend",function(){c=false})});m.addshortcutkey({Undo:"ctrl+90",Redo:"ctrl+89,shift+ctrl+z"});var f=true;m.addListener("keydown",function(r,q){var t=this;var u=q.keyCode||q.which;if(!o[u]&&!q.ctrlKey&&!q.metaKey&&!q.shiftKey&&!q.altKey){if(c){return}if(!t.selection.getRange().collapsed){t.undoManger.save(false,true);f=false;return}if(t.undoManger.list.length==0){t.undoManger.save(true)}clearTimeout(d);function s(v){if(v.selection.getRange().collapsed){v.fireEvent("contentchange")}v.undoManger.save(false,true);v.fireEvent("selectionchange")}d=setTimeout(function(){if(c){var v=setInterval(function(){if(!c){s(t);clearInterval(v)}},300);return}s(t)},200);a=u;h++;if(h>=l){s(t)}}});m.addListener("keyup",function(r,q){var s=q.keyCode||q.which;if(!o[s]&&!q.ctrlKey&&!q.metaKey&&!q.shiftKey&&!q.altKey){if(c){return}if(!f){this.undoManger.save(false,true);f=true}}})};UM.plugins.paste=function(){function b(h){var f=this.document;if(f.getElementById("baidu_pastebin")){return}var e=this.selection.getRange(),d=e.createBookmark(),g=f.createElement("div");g.id="baidu_pastebin";browser.webkit&&g.appendChild(f.createTextNode(domUtils.fillChar+domUtils.fillChar));this.body.appendChild(g);d.start.style.display="";g.style.cssText="position:absolute;width:1px;height:1px;overflow:hidden;left:-1000px;white-space:nowrap;top:"+$(d.start).position().top+"px";e.selectNodeContents(g).select(true);setTimeout(function(){if(browser.webkit){for(var j=0,k=f.querySelectorAll("#baidu_pastebin"),m;m=k[j++];){if(domUtils.isEmptyNode(m)){domUtils.remove(m)}else{g=m;break}}}try{g.parentNode.removeChild(g)}catch(l){}e.moveToBookmark(d).select(true);h(g)},0)}var c=this;function a(d){var j;if(d.firstChild){var e=domUtils.getElementsByTagName(d,"span");for(var h=0,f;f=e[h++];){if(f.id=="_baidu_cut_start"||f.id=="_baidu_cut_end"){domUtils.remove(f)}}if(browser.webkit){var n=d.querySelectorAll("div br");for(var h=0,g;g=n[h++];){var o=g.parentNode;if(o.tagName=="DIV"&&o.childNodes.length==1){o.innerHTML="<p><br/></p>";domUtils.remove(o)}}var p=d.querySelectorAll("#baidu_pastebin");for(var h=0,m;m=p[h++];){var u=c.document.createElement("p");m.parentNode.insertBefore(u,m);while(m.firstChild){u.appendChild(m.firstChild)}domUtils.remove(m)}var l=d.querySelectorAll("meta");for(var h=0,t;t=l[h++];){domUtils.remove(t)}var n=d.querySelectorAll("br");for(h=0;t=n[h++];){if(/^apple-/i.test(t.className)){domUtils.remove(t)}}}if(browser.gecko){var s=d.querySelectorAll("[_moz_dirty]");for(h=0;t=s[h++];){t.removeAttribute("_moz_dirty")}}if(!browser.ie){var k=d.querySelectorAll("span.Apple-style-span");for(var h=0,t;t=k[h++];){domUtils.remove(t,true)}}j=d.innerHTML;j=UM.filterWord(j);var q=UM.htmlparser(j);if(c.options.filterRules){UM.filterNode(q,c.options.filterRules)}c.filterInputRule(q);if(browser.webkit){var r=q.lastChild();if(r&&r.type=="element"&&r.tagName=="br"){q.removeChild(r)}utils.each(c.body.querySelectorAll("div"),function(i){if(domUtils.isEmptyBlock(i)){domUtils.remove(i)}})}j={html:q.toHtml()};c.fireEvent("beforepaste",j,q);if(!j.html){return}c.execCommand("insertHtml",j.html,true);c.fireEvent("afterpaste",j)}}c.addListener("ready",function(){$(c.body).on("cut",function(){var d=c.selection.getRange();if(!d.collapsed&&c.undoManger){c.undoManger.save()}}).on(browser.ie||browser.opera?"keydown":"paste",function(d){if((browser.ie||browser.opera)&&((!d.ctrlKey&&!d.metaKey)||d.keyCode!="86")){return}b.call(c,function(e){a(e)})})})};UM.plugins.list=function(){var a=this;a.setOpt({insertorderedlist:{decimal:"","lower-alpha":"","lower-roman":"","upper-alpha":"","upper-roman":""},insertunorderedlist:{circle:"",disc:"",square:""}});this.addInputRule(function(b){utils.each(b.getNodesByTagName("li"),function(c){if(c.children.length==0){c.parentNode.removeChild(c)}})});a.commands.insertorderedlist=a.commands.insertunorderedlist={execCommand:function(d){this.document.execCommand(d);var c=this.selection.getRange(),b=c.createBookmark(true);this.$body.find("ol,ul").each(function(e,g){var f=g.parentNode;if(f.tagName=="P"&&f.lastChild===f.firstChild){$(g).children().each(function(i,h){var k=f.cloneNode(false);$(k).append(h.innerHTML);$(h).html("").append(k)});$(g).insertBefore(f);$(f).remove()}if(dtd.$inline[f.tagName]){if(f.tagName=="SPAN"){$(g).children().each(function(i,h){var j=f.cloneNode(false);if(h.firstChild.nodeName!="P"){while(h.firstChild){j.appendChild(h.firstChild)}$("<p></p>").appendTo(h).append(j)}else{while(h.firstChild){j.appendChild(h.firstChild)}$(h.firstChild).append(j)}})}domUtils.remove(f,true)}});c.moveToBookmark(b).select();return true},queryCommandState:function(b){return this.document.queryCommandState(b)}}};(function(){var a={textarea:function(d,c){var b=c.ownerDocument.createElement("textarea");b.style.cssText="resize:none;border:0;padding:0;margin:0;overflow-y:auto;outline:0";if(browser.ie&&browser.version<8){b.style.width=c.offsetWidth+"px";b.style.height=c.offsetHeight+"px";c.onresize=function(){b.style.width=c.offsetWidth+"px";b.style.height=c.offsetHeight+"px"}}c.appendChild(b);return{container:b,setContent:function(e){b.value=e},getContent:function(){return b.value},select:function(){var e;if(browser.ie){e=b.createTextRange();e.collapse(true);e.select()}else{b.setSelectionRange(0,0);b.focus()}},dispose:function(){c.removeChild(b);c.onresize=null;b=null;c=null}}}};UM.plugins.source=function(){var g=this;var b=this.options;var f=false;var i;b.sourceEditor="textarea";g.setOpt({sourceEditorFirst:false});function c(k){return a.textarea(g,k)}var j;var h=g.getContent,e;g.commands.source={execCommand:function(){f=!f;if(f){e=g.selection.getRange().createAddress(false,true);g.undoManger&&g.undoManger.save(true);if(browser.gecko){g.body.contentEditable=false}g.body.style.cssText+=";position:absolute;left:-32768px;top:-32768px;";g.fireEvent("beforegetcontent");var l=UM.htmlparser(g.body.innerHTML);g.filterOutputRule(l);l.traversal(function(q){if(q.type=="element"){switch(q.tagName){case"td":case"th":case"caption":if(q.children&&q.children.length==1){if(q.firstChild().tagName=="br"){q.removeChild(q.firstChild())}}break;case"pre":q.innerText(q.innerText().replace(/&nbsp;/g," "))}}});g.fireEvent("aftergetcontent");var n=l.toHtml(true);i=c(g.body.parentNode);i.setContent(n);var m=function(q){return parseInt($(g.body).css(q))};$(i.container).width($(g.body).width()+m("padding-left")+m("padding-right")).height($(g.body).height());setTimeout(function(){i.select()});g.getContent=function(){return i.getContent()||"<p>"+(browser.ie?"":"<br/>")+"</p>"}}else{g.$body.css({position:"",left:"",top:""});var k=i.getContent()||"<p>"+(browser.ie?"":"<br/>")+"</p>";k=k.replace(new RegExp("[\\r\\t\\n ]*</?(\\w+)\\s*(?:[^>]*)>","g"),function(r,q){if(q&&!dtd.$inlineWithA[q.toLowerCase()]){return r.replace(/(^[\n\r\t ]*)|([\n\r\t ]*$)/g,"")}return r.replace(/(^[\n\r\t]*)|([\n\r\t]*$)/g,"")});g.setContent(k);i.dispose();i=null;g.getContent=h;var p=g.body.firstChild;if(!p){g.body.innerHTML="<p>"+(browser.ie?"":"<br/>")+"</p>"}g.undoManger&&g.undoManger.save(true);if(browser.gecko){g.body.contentEditable=true}try{g.selection.getRange().moveToAddress(e).select()}catch(o){}}this.fireEvent("sourcemodechanged",f)},queryCommandState:function(){return f|0},notNeedUndo:1};var d=g.queryCommandState;g.queryCommandState=function(k){k=k.toLowerCase();if(f){return k in {source:1,fullscreen:1}?d.apply(this,arguments):-1}return d.apply(this,arguments)}}})();UM.plugins.enterkey=function(){var b,c=this,a=c.options.enterTag;c.addListener("keyup",function(l,m){var n=m.keyCode||m.which;if(n==13){var k=c.selection.getRange(),g=k.startContainer,d;if(!browser.ie){if(/h\d/i.test(b)){if(browser.gecko){var j=domUtils.findParentByTagName(g,["h1","h2","h3","h4","h5","h6","blockquote","caption","table"],true);if(!j){c.document.execCommand("formatBlock",false,"<p>");d=1}}else{if(g.nodeType==1){var i=c.document.createTextNode(""),e;k.insertNode(i);e=domUtils.findParentByTagName(i,"div",true);if(e){var f=c.document.createElement("p");while(e.firstChild){f.appendChild(e.firstChild)}e.parentNode.insertBefore(f,e);domUtils.remove(e);k.setStartBefore(i).setCursor();d=1}domUtils.remove(i)}}if(c.undoManger&&d){c.undoManger.save()}}browser.opera&&k.select()}else{c.fireEvent("saveScene",true,true)}}});c.addListener("keydown",function(h,f){var i=f.keyCode||f.which;if(i==13){if(c.fireEvent("beforeenterkeydown")){domUtils.preventDefault(f);return}c.fireEvent("saveScene",true,true);b="";var g=c.selection.getRange();if(!g.collapsed){var k=g.startContainer,e=g.endContainer,d=domUtils.findParentByTagName(k,"td",true),j=domUtils.findParentByTagName(e,"td",true);if(d&&j&&d!==j||!d&&j||d&&!j){f.preventDefault?f.preventDefault():(f.returnValue=false);return}}if(a=="p"){if(!browser.ie){k=domUtils.findParentByTagName(g.startContainer,["ol","ul","p","h1","h2","h3","h4","h5","h6","blockquote","caption"],true);if(!k&&!browser.opera){c.document.execCommand("formatBlock",false,"<p>");if(browser.gecko){g=c.selection.getRange();k=domUtils.findParentByTagName(g.startContainer,"p",true);k&&domUtils.removeDirtyAttr(k)}}else{b=k.tagName;k.tagName.toLowerCase()=="p"&&browser.gecko&&domUtils.removeDirtyAttr(k)}}}}});browser.ie&&c.addListener("setDisabled",function(){$(c.body).find("p").each(function(d,e){if(domUtils.isEmptyBlock(e)){e.innerHTML="&nbsp;"}})})};UM.commands.preview={execCommand:function(){var a=window.open("","_blank",""),e=a.document,g=this.getContent(null,null,true),b=this.getOpt("UMEDITOR_HOME_URL"),f=g.indexOf("mathquill-embedded-latex")!=-1?'<link rel="stylesheet" href="'+b+'third-party/mathquill/mathquill.css"/><script src="'+b+'third-party/jquery.min.js"><\/script><script src="'+b+'third-party/mathquill/mathquill.min.js"><\/script>':"";e.open();e.write("<html><head>"+f+"</head><body><div>"+g+"</div></body></html>");e.close()},notNeedUndo:1};UM.plugins.basestyle=function(){var b=["bold","underline","superscript","subscript","italic","strikethrough"],a=this;a.addshortcutkey({Bold:"ctrl+66",Italic:"ctrl+73",Underline:"ctrl+shift+85",strikeThrough:"ctrl+shift+83"});a.addOutputRule(function(c){$.each(c.getNodesByTagName("b i u strike s"),function(d,e){switch(e.tagName){case"b":e.tagName="strong";break;case"i":e.tagName="em";break;case"u":e.tagName="span";e.setStyle("text-decoration","underline");break;case"s":case"strike":e.tagName="span";e.setStyle("text-decoration","line-through")}})});$.each(b,function(c,d){a.commands[d]={execCommand:function(f){var e=this.selection.getRange();if(e.collapsed&&this.queryCommandState(f)!=1){var g=this.document.createElement({bold:"strong",underline:"u",superscript:"sup",subscript:"sub",italic:"em",strikethrough:"strike"}[f]);e.insertNode(g).setStart(g,0).setCursor(false);return true}else{return this.document.execCommand(f)}},queryCommandState:function(f){if(browser.gecko){return this.document.queryCommandState(f)}var g=this.selection.getStartElementPath(),e=false;$.each(g,function(h,j){switch(f){case"bold":if(j.nodeName=="STRONG"||j.nodeName=="B"){e=1;return false}break;case"underline":if(j.nodeName=="U"||j.nodeName=="SPAN"&&$(j).css("text-decoration")=="underline"){e=1;return false}break;case"superscript":if(j.nodeName=="SUP"){e=1;return false}break;case"subscript":if(j.nodeName=="SUB"){e=1;return false}break;case"italic":if(j.nodeName=="EM"||j.nodeName=="I"){e=1;return false}break;case"strikethrough":if(j.nodeName=="S"||j.nodeName=="STRIKE"||j.nodeName=="SPAN"&&$(j).css("text-decoration")=="line-through"){e=1;return false}break}});return e}}})};UM.plugins.video=function(){var c=this,d;function b(f,h,e,j,i,g){return !g?"<img "+(j?'id="'+j+'"':"")+' width="'+h+'" height="'+e+'" _url="'+f+'" class="edui-faked-video" src="'+c.options.UMEDITOR_HOME_URL+'themes/default/images/spacer.gif" style="background:url('+c.options.UMEDITOR_HOME_URL+"themes/default/images/videologo.gif) no-repeat center center; border:1px solid gray;"+(i?"float:"+i+";":"")+'" />':'<embed type="application/x-shockwave-flash" class="edui-faked-video" pluginspage="http://www.macromedia.com/go/getflashplayer" src="'+f+'" width="'+h+'" height="'+e+'"'+(i?' style="float:'+i+'"':"")+' wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" allowfullscreen="true" >'}function a(e,f){utils.each(e.getNodesByTagName(f?"img":"embed"),function(h){if(h.getAttr("class")=="edui-faked-video"){var g=b(f?h.getAttr("_url"):h.getAttr("src"),h.getAttr("width"),h.getAttr("height"),null,h.getStyle("float")||"",f);h.parentNode.replaceChild(UM.uNode.createElement(g),h)}})}c.addOutputRule(function(e){a(e,true)});c.addInputRule(function(e){a(e)});c.commands.insertvideo={execCommand:function(h,k){k=utils.isArray(k)?k:[k];var g=[],l="tmpVedio";for(var f=0,j,e=k.length;f<e;f++){j=k[f];g.push(b(j.url,j.width||420,j.height||280,l+f,j.align,false))}c.execCommand("inserthtml",g.join(""),true)},queryCommandState:function(){var f=c.selection.getRange().getClosedNode(),e=f&&(f.className=="edui-faked-video");return e?1:0}}};UM.plugins.selectall=function(){var a=this;a.commands.selectall={execCommand:function(){var d=this,b=d.body,c=d.selection.getRange();c.selectNodeContents(b);if(domUtils.isEmptyBlock(b)){if(browser.opera&&b.firstChild&&b.firstChild.nodeType==1){c.setStartAtFirst(b.firstChild)}c.collapse(true)}c.select(true)},notNeedUndo:1};a.addshortcutkey({selectAll:"ctrl+65"})};UM.plugins.removeformat=function(){var a=this;a.setOpt({removeFormatTags:"b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var",removeFormatAttributes:"class,style,lang,width,height,align,hspace,valign"});a.commands.removeformat={execCommand:function(m,o,b,k,l){var g=new RegExp("^(?:"+(o||this.options.removeFormatTags).replace(/,/g,"|")+")$","i"),f=b?[]:(k||this.options.removeFormatAttributes).split(","),h=new dom.Range(this.document),i,e,j,c=function(p){return p.nodeType==1};function d(s){if(s.nodeType==3||s.tagName.toLowerCase()!="span"){return 0}if(browser.ie){var q=s.attributes;if(q.length){for(var r=0,p=q.length;r<p;r++){if(q[r].specified){return 0}}return 1}}return !s.attributes.length}function n(v){var p=v.createBookmark();if(v.collapsed){v.enlarge(true)}if(!l){var q=domUtils.findParentByTagName(v.startContainer,"a",true);if(q){v.setStartBefore(q)}q=domUtils.findParentByTagName(v.endContainer,"a",true);if(q){v.setEndAfter(q)}}i=v.createBookmark();r=i.start;while((j=r.parentNode)&&!domUtils.isBlockElm(j)){domUtils.breakParent(r,j);domUtils.clearEmptySibling(r)}if(i.end){r=i.end;while((j=r.parentNode)&&!domUtils.isBlockElm(j)){domUtils.breakParent(r,j);domUtils.clearEmptySibling(r)}var w=domUtils.getNextDomNode(i.start,false,c),u;while(w){if(w==i.end){break}u=domUtils.getNextDomNode(w,true,c);if(!dtd.$empty[w.tagName.toLowerCase()]&&!domUtils.isBookmarkNode(w)){if(g.test(w.tagName)){if(b){domUtils.removeStyle(w,b);if(d(w)&&b!="text-decoration"){domUtils.remove(w,true)}}else{domUtils.remove(w,true)}}else{if(!dtd.$tableContent[w.tagName]&&!dtd.$list[w.tagName]){domUtils.removeAttributes(w,f);if(d(w)){domUtils.remove(w,true)}}}}w=u}}var x=i.start.parentNode;if(domUtils.isBlockElm(x)&&!dtd.$tableContent[x.tagName]&&!dtd.$list[x.tagName]){domUtils.removeAttributes(x,f)}x=i.end.parentNode;if(i.end&&domUtils.isBlockElm(x)&&!dtd.$tableContent[x.tagName]&&!dtd.$list[x.tagName]){domUtils.removeAttributes(x,f)}v.moveToBookmark(i).moveToBookmark(p);var r=v.startContainer,t,s=v.collapsed;while(r.nodeType==1&&domUtils.isEmptyNode(r)&&dtd.$removeEmpty[r.tagName]){t=r.parentNode;v.setStartBefore(r);if(v.startContainer===v.endContainer){v.endOffset--}domUtils.remove(r);r=t}if(!s){r=v.endContainer;while(r.nodeType==1&&domUtils.isEmptyNode(r)&&dtd.$removeEmpty[r.tagName]){t=r.parentNode;v.setEndBefore(r);domUtils.remove(r);r=t}}}h=this.selection.getRange();if(!h.collapsed){n(h);h.select()}}}};UM.plugins.keystrokes=function(){var a=this;var b=true;a.addListener("keydown",function(j,l){var m=l.keyCode||l.which,c=a.selection.getRange();if(!c.collapsed&&!(l.ctrlKey||l.shiftKey||l.altKey||l.metaKey)&&(m>=65&&m<=90||m>=48&&m<=57||m>=96&&m<=111||{13:1,8:1,46:1}[m])){var f=c.startContainer;if(domUtils.isFillChar(f)){c.setStartBefore(f)}f=c.endContainer;if(domUtils.isFillChar(f)){c.setEndAfter(f)}c.txtToElmBoundary();if(c.endContainer&&c.endContainer.nodeType==1){f=c.endContainer.childNodes[c.endOffset];if(f&&domUtils.isBr(f)){c.setEndAfter(f)}}if(c.startOffset==0){f=c.startContainer;if(domUtils.isBoundaryNode(f,"firstChild")){f=c.endContainer;if(c.endOffset==(f.nodeType==3?f.nodeValue.length:f.childNodes.length)&&domUtils.isBoundaryNode(f,"lastChild")){a.fireEvent("saveScene");a.body.innerHTML="<p>"+(browser.ie?"":"<br/>")+"</p>";c.setStart(a.body.firstChild,0).setCursor(false,true);a._selectionChange();return}}}}if(m==8){c=a.selection.getRange();b=c.collapsed;if(a.fireEvent("delkeydown",l)){return}var d,h;if(c.collapsed&&c.inFillChar()){d=c.startContainer;if(domUtils.isFillChar(d)){c.setStartBefore(d).shrinkBoundary(true).collapse(true);domUtils.remove(d)}else{d.nodeValue=d.nodeValue.replace(new RegExp("^"+domUtils.fillChar),"");c.startOffset--;c.collapse(true).select(true)}}if(d=c.getClosedNode()){a.fireEvent("saveScene");c.setStartBefore(d);domUtils.remove(d);c.setCursor();a.fireEvent("saveScene");domUtils.preventDefault(l);return}if(!browser.ie){d=domUtils.findParentByTagName(c.startContainer,"table",true);h=domUtils.findParentByTagName(c.endContainer,"table",true);if(d&&!h||!d&&h||d!==h){l.preventDefault();return}}d=c.startContainer;if(c.collapsed&&d.nodeType==1){var e=d.childNodes[c.startOffset-1];if(e&&e.nodeType==1&&e.tagName=="BR"){a.fireEvent("saveScene");c.setStartBefore(e).collapse(true);domUtils.remove(e);c.select();a.fireEvent("saveScene")}}if(browser.chrome){if(c.collapsed){while(c.startOffset==0&&!domUtils.isEmptyBlock(c.startContainer)){c.setStartBefore(c.startContainer)}var g=c.startContainer.childNodes[c.startOffset-1];if(g&&g.nodeName=="BR"){c.setStartBefore(g);a.fireEvent("saveScene");$(g).remove();c.setCursor();a.fireEvent("saveScene")}}}}if(browser.gecko&&m==46){var i=a.selection.getRange();if(i.collapsed){d=i.startContainer;if(domUtils.isEmptyBlock(d)){var k=d.parentNode;while(domUtils.getChildCount(k)==1&&!domUtils.isBody(k)){d=k;k=k.parentNode}if(d===k.lastChild){l.preventDefault()}return}}}});a.addListener("keyup",function(h,j){var l=j.keyCode||j.which,c,g=this;if(l==8){if(g.fireEvent("delkeyup")){return}c=g.selection.getRange();if(c.collapsed){var d,k=["h1","h2","h3","h4","h5","h6"];if(d=domUtils.findParentByTagName(c.startContainer,k,true)){if(domUtils.isEmptyBlock(d)){var e=d.previousSibling;if(e&&e.nodeName!="TABLE"){domUtils.remove(d);c.setStartAtLast(e).setCursor(false,true);return}else{var f=d.nextSibling;if(f&&f.nodeName!="TABLE"){domUtils.remove(d);c.setStartAtFirst(f).setCursor(false,true);return}}}}if(domUtils.isBody(c.startContainer)){var d=domUtils.createElement(g.document,"p",{innerHTML:browser.ie?domUtils.fillChar:"<br/>"});c.insertNode(d).setStart(d,0).setCursor(false,true)}}if(!b&&(c.startContainer.nodeType==3||c.startContainer.nodeType==1&&domUtils.isEmptyBlock(c.startContainer))){if(browser.ie){var i=c.document.createElement("span");c.insertNode(i).setStartBefore(i).collapse(true);c.select();domUtils.remove(i)}else{c.select()}}}})};UM.plugins.autosave=function(){var e=this,c=new Date(),a=20,f=null;e.setOpt("saveInterval",500);var b=UM.LocalStorage=(function(){var i=window.localStorage||g()||null,h="localStorage";return{saveLocalData:function(j,k){if(i&&k){i.setItem(j,k);return true}return false},getLocalData:function(j){if(i){return i.getItem(j)}return null},removeItem:function(j){i&&i.removeItem(j)}};function g(){var j=document.createElement("div");j.style.display="none";if(!j.addBehavior){return null}j.addBehavior("#default#userdata");return{getItem:function(l){var k=null;try{document.body.appendChild(j);j.load(h);k=j.getAttribute(l);document.body.removeChild(j)}catch(m){}return k},setItem:function(k,l){document.body.appendChild(j);j.setAttribute(k,l);j.save(h);document.body.removeChild(j)},removeItem:function(k){document.body.appendChild(j);j.removeAttribute(k);j.save(h);document.body.removeChild(j)}}}})();function d(h){var g=null;if(new Date()-c<a){return}if(!h.hasContents()){f&&b.removeItem(f);return}c=new Date();h._saveFlag=null;g=e.body.innerHTML;if(h.fireEvent("beforeautosave",{content:g})===false){return}b.saveLocalData(f,g);h.fireEvent("afterautosave",{content:g})}e.addListener("ready",function(){var g="-drafts-data",h=null;if(e.key){h=e.key+g}else{h=(e.container.parentNode.id||"ue-common")+g}f=(location.protocol+location.host+location.pathname).replace(/[.:\/]/g,"_")+h});e.addListener("contentchange",function(){if(!f){return}if(e._saveFlag){window.clearTimeout(e._saveFlag)}if(e.options.saveInterval>0){e._saveFlag=window.setTimeout(function(){d(e)},e.options.saveInterval)}else{d(e)}});e.commands.clearlocaldata={execCommand:function(h,g){if(f&&b.getLocalData(f)){b.removeItem(f)}},notNeedUndo:true,ignoreContentChange:true};e.commands.getlocaldata={execCommand:function(h,g){return f?b.getLocalData(f)||"":""},notNeedUndo:true,ignoreContentChange:true};e.commands.drafts={execCommand:function(h,g){if(f){e.body.innerHTML=b.getLocalData(f)||"<p>"+(browser.ie?"&nbsp;":"<br/>")+"</p>";e.focus(true)}},queryCommandState:function(){return f?(b.getLocalData(f)===null?-1:0):-1},notNeedUndo:true,ignoreContentChange:true}};UM.plugins.autoupload=function(){var me=this;me.setOpt("pasteImageEnabled",true);me.setOpt("dropFileEnabled",true);var sendAndInsertImage=function(file,editor){var fd=new FormData();fd.append(editor.options.imageFieldName||"upfile",file,file.name||("blob."+file.type.substr("image/".length)));fd.append("type","ajax");var xhr=new XMLHttpRequest();xhr.open("post",me.options.imageUrl,true);xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.addEventListener("load",function(e){try{var json=eval("("+e.target.response+")"),link=json.url,picLink=me.options.imagePath+link;editor.execCommand("insertimage",{src:picLink,_src:picLink})}catch(er){}});xhr.send(fd)};function getPasteImage(e){return e.clipboardData&&e.clipboardData.items&&e.clipboardData.items.length==1&&/^image\//.test(e.clipboardData.items[0].type)?e.clipboardData.items:null}function getDropImage(e){return e.dataTransfer&&e.dataTransfer.files?e.dataTransfer.files:null}me.addListener("ready",function(){if(window.FormData&&window.FileReader){var autoUploadHandler=function(e){var hasImg=false,items;items=e.type=="paste"?getPasteImage(e.originalEvent):getDropImage(e.originalEvent);if(items){var len=items.length,file;while(len--){file=items[len];if(file.getAsFile){file=file.getAsFile()}if(file&&file.size>0&&/image\/\w+/i.test(file.type)){sendAndInsertImage(file,me);hasImg=true}}if(hasImg){return false}}};me.getOpt("pasteImageEnabled")&&me.$body.on("paste",autoUploadHandler);me.getOpt("dropFileEnabled")&&me.$body.on("drop",autoUploadHandler);me.$body.on("dragover",function(e){if(e.originalEvent.dataTransfer.types[0]=="Files"){return false}})}})};UM.plugins.formula=function(){var b=this;function a(){return b.$body.find("iframe.edui-formula-active")[0]||null}function c(){var d=a();d&&d.contentWindow.formula.blur()}b.addInputRule(function(d){$.each(d.getNodesByTagName("span"),function(e,f){if(f.hasClass("mathquill-embedded-latex")){var h,g="";while(h=f.firstChild()){g+=h.data;f.removeChild(h)}f.tagName="iframe";f.setAttr({frameborder:"0",src:b.getOpt("UMEDITOR_HOME_URL")+"dialogs/formula/formula.html","data-latex":utils.unhtml(g)})}})});b.addOutputRule(function(d){$.each(d.getNodesByTagName("iframe"),function(e,f){if(f.hasClass("mathquill-embedded-latex")){f.tagName="span";f.appendChild(UM.uNode.createText(f.getAttr("data-latex")));f.setAttr({frameborder:"",src:"","data-latex":""})}})});b.addListener("click",function(){c()});b.addListener("afterexeccommand",function(d,e){if(e!="formula"){c()}});b.commands.formula={execCommand:function(f,e){var d=a();if(d){d.contentWindow.formula.insertLatex(e)}else{b.execCommand("inserthtml",'<span class="mathquill-embedded-latex">'+e+"</span>");browser.ie&&browser.ie9below&&setTimeout(function(){var g=b.selection.getRange(),h=g.startContainer;if(h.nodeType==1&&!h.childNodes[g.startOffset]){g.insertNode(b.document.createTextNode(" "));g.setCursor()}},100)}},queryCommandState:function(d){return 0},queryCommandValue:function(e){var d=a();return d&&d.contentWindow.formula.getLatex()}}};