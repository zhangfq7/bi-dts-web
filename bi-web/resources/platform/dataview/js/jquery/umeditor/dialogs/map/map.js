(function(){var a="map";UM.registerWidget(a,{tpl:'<style type="text/css">.edui-dialog-map .edui-map-content{width:530px; height: 350px;margin: 10px auto;}.edui-dialog-map .edui-map-content table{width: 100%}.edui-dialog-map .edui-map-content table td{vertical-align: middle;}.edui-dialog-map .edui-map-button { border: 1px solid #ccc; float: left; cursor: default; height: 23px; width: 70px; cursor: pointer; margin: 0; font-size: 12px; line-height: 24px; text-align: center; }.edui-dialog-map .edui-map-button:hover {background:#eee;}.edui-dialog-map .edui-map-city,.edui-dialog-map .edui-map-address{height:21px;background: #FFF;border:1px solid #d7d7d7; line-height: 21px;}.edui-dialog-map .edui-map-city{width:90px}.edui-dialog-map .edui-map-address{width:150px}.edui-dialog-map .edui-map-dynamic-label span{vertical-align:middle;margin: 3px 0px 3px 3px;}.edui-dialog-map .edui-map-dynamic-label input{vertical-align:middle;margin: 3px;}</style><div class="edui-map-content"><table><tr><td><%=lang_city%>:</td><td><input class="edui-map-city" type="text" value="<%=city.value%>"/></td><td><%=lang_address%>:</td><td><input class="edui-map-address" type="text" value="" /></td><td><a class="edui-map-button"><%=lang_search%></a></td><td><label class="edui-map-dynamic-label"><input class="edui-map-dynamic" type="checkbox" name="edui-map-dynamic" /><span><%=lang_dynamicmap%></span></label></td></tr></table><div style="width:100%;height:340px;margin:5px auto;border:1px solid gray" class="edui-map-container"></div></div><script class="edui-tpl-container" type="text/plain"><!DOCTYPE html><html><head><title></title></head><body><scr_ipt>window.onload = function(){var scripts = document.scripts || document.getElementsByTagName("script"),src = [];for( var i = 1, len = scripts.length; i<len; i++ ) {src.push( scripts[i].src );}parent.UM.getEditor(<<id>>).getWidgetData(\'map\').requestMapApi( src );};function mapReadyStateChange ( state ) {  if ( state === \'complete\' || state === \'loaded\' ) { document.close();  } }</scr_ipt><scr_ipt onreadystatechange=\'mapReadyStateChange(this.readyState);\' onload=\'mapReadyStateChange("loaded");\' src="http://api.map.baidu.com/api?v=2.0&ak=6b6c1a67eaa7db1ca6d6da28e590e343&services=true"></scr_ipt></body></html><\/script>',initContent:function(c,f){var d=this,e=c.getLang(a),b=c.options.themePath+c.options.theme;if(d.inited){d.preventDefault();return false}d.inited=true;d.lang=e;d.editor=c;d.root().html($.parseTmpl(d.tpl,$.extend({},e["static"],{theme_url:b})));d.initRequestApi()},initRequestApi:function(){var b=null;if(window.BMap&&window.BMap.Map){this.initBaiduMap()}else{b=$('<iframe style="display: none;"></iframe>');b.appendTo(this.root());b=b[0].contentWindow.document;b.open();b.write(this.root().find(".edui-tpl-container").html().replace(/scr_ipt/g,"script").replace("<<id>>","'"+this.editor.id+"'"))}},requestMapApi:function(c){var b=this;if(c.length){var d=c[0];c=c.slice(1);if(d){$.getScript(d,function(){b.requestMapApi(c)})}else{b.requestMapApi(c)}}else{b.initBaiduMap()}},initBaiduMap:function(){var h=this.root(),b=new BMap.Map(h.find(".edui-map-container")[0]),j=this,g,k,e,f=$(j.editor.selection.getRange().getClosedNode());b.enableInertialDragging();b.enableScrollWheelZoom();b.enableContinuousZoom();if(f.length&&/api[.]map[.]baidu[.]com/ig.test(f.attr("src"))){var c=f.attr("src"),d=j.getPars(c,"center").split(","),i=j.getPars(c,"markers").split(",");k=new BMap.Point(Number(d[0]),Number(d[1]));g=new BMap.Marker(new BMap.Point(Number(i[0]),Number(i[1])));b.addControl(new BMap.NavigationControl());b.centerAndZoom(k,Number(j.getPars(c,"zoom")));e=f.attr("style")}else{k=new BMap.Point(116.404,39.915);g=new BMap.Marker(k);b.addControl(new BMap.NavigationControl());b.centerAndZoom(k,10)}g.enableDragging();b.addOverlay(g);j.map=b;j.marker=g;j.imgcss=e},doSearch:function(){var d=this,e=d.root().find(".edui-map-city").val(),b=d.root().find(".edui-map-address").val();if(!e){alert(d.lang.cityMsg);return}var c=new BMap.LocalSearch(e,{onSearchComplete:function(g){if(g&&g.getNumPois()){var h=[];for(var f=0;f<g.getCurrentNumPois();f++){h.push(g.getPoi(f).point)}if(h.length>1){d.map.setViewport(h)}else{d.map.centerAndZoom(h[0],13)}point=d.map.getCenter();d.marker.setPoint(point)}else{alert(d.lang.errorMsg)}}});c.search(b||e)},getPars:function(d,c){var b=new RegExp(c+"=((\\d+|[.,])*)","g");return b.exec(d)[1]},reset:function(){this.map&&this.map.reset()},initEvent:function(){var b=this,c=b.root();c.find(".edui-map-address").on("keydown",function(d){d=d||event;if(d.keyCode==13){b.doSearch();return false}});c.find(".edui-map-button").on("click",function(d){b.doSearch()});c.find(".edui-map-address").focus();c.on("mousewheel DOMMouseScroll",function(d){return false})},width:580,height:408,buttons:{ok:{exec:function(g){var i=g.getWidgetData(a),d=i.map.getCenter(),h=i.map.getZoom(),f=i.map.getSize(),c=i.marker.P;if(i.root().find(".edui-map-dynamic")[0].checked){var b=g.getOpt("UMEDITOR_HOME_URL"),e=[b+(/\/$/.test(b)?"":"/")+"dialogs/map/map.html#center="+d.lng+","+d.lat,"&zoom="+h,"&width="+f.width,"&height="+f.height,"&markers="+c.lng+","+c.lat].join("");g.execCommand("inserthtml",'<iframe class="ueditor_baidumap" src="'+e+'" frameborder="0" width="'+(f.width+4)+'" height="'+(f.height+4)+'"></iframe>')}else{e="http://api.map.baidu.com/staticimage?center="+d.lng+","+d.lat+"&zoom="+h+"&width="+f.width+"&height="+f.height+"&markers="+c.lng+","+c.lat;g.execCommand("inserthtml",'<img width="'+f.width+'"height="'+f.height+'" src="'+e+'"'+(i.imgcss?' style="'+i.imgcss+'"':"")+"/>",true)}i.reset()}},cancel:{exec:function(b){b.getWidgetData(a).reset()}}}})})();