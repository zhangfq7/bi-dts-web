define(["sabace"],function(c,e){var b={};var a=null;g();var f=jQuery("#dialogContent").html();jQuery("#dialogContent").html("");function g(){jQuery("#openApiList").jqGrid({url:c.handleUrlParam("/platform/openapi/query-openapi-list")+"?ApiCode="+ApiCode,styleUI:"Bootstrap",datatype:"json",colModel:[{label:"接口名称",name:"apiName",width:50,align:"left",sortable:false},{label:"方法名称",name:"apiCode",width:50,align:"left",sortable:false},{label:"请求地址",name:"apiUrl",width:50,align:"left",sortable:false},{label:"请求字段",name:"paramInfoStr",width:50,align:"left",sortable:false},{label:"结果字段",name:"resultInfoStr",width:50,align:"left",sortable:false},{label:"操作",name:"serviceApiId",width:20,align:"center",sortable:false,formatter:function(i,j,k){if(i==null||i==""){return'<a href="javascript:void(0)" id="'+j.rowId+'" class="use-openapi use">引用</a>'}else{return'<a href="javascript:void(0)" id="'+j.rowId+'" class="use-openapi">失效</a>'}}}],autowidth:true,height:"auto",rowNum:100000,regional:"cn",loadComplete:function(i){jQuery(".use-openapi").on("click",function(){if(jQuery(this).hasClass("use")){var j=this.id-1;var l=i[j].paramInfoStr;b.apiName=i[j].apiName;b.apiCode=i[j].apiCode;b.apiUrl=i[j].apiUrl;b.clientId=i[j].clientId;b.passWord=i[j].passWord;b.resultInfoStr=i[j].resultInfoStr;b.sysId=i[j].sysId;b.isDes=i[j].isDes;b.accessKey=i[j].accessKey;bi.dialog.show({id:"createOpenApi",title:"引用",nl2br:false,cssClass:"use-openapi-dialog",message:f,closable:true,closeByBackdrop:false,closeByKeyboard:false,onshown:function(){jQuery(".chosen-select").chosen();jQuery("#businessType").ajaxChosen({fields:["classifyId","classifyName"],findPage:true,disabled:false,url:c.handleUrlParam("/platform/openapi/query-business-type-info")});jQuery("#firstUpdateTime").datetimepicker({format:"YYYY-MM-DD HH:mm:ss",sideBySide:true,minDate:moment().format("YYYY-MM-DD"),});jQuery("#updateType").on("change",function(){if(jQuery(this).val()=="I"){jQuery(".first-update-time").fadeOut()}else{jQuery(".first-update-time").fadeIn()}if(jQuery(this).val()=="I"||jQuery(this).val()=="S"){jQuery(".storage-type").fadeOut()}else{jQuery(".storage-type").fadeIn()}});jQuery("#apiName").html(b.apiName);a=JSON.parse(l);var A=a.length;var o=null;var t=null;var v=null;var w=null;var s=null;var y=0;for(var u=0;u<A;u++){o=a[u];v=o.paramName;w=o.paramCode;t=o.paramRuleType;s=o.paramRuleData;var z="";z+="<tr>";z+='	<td class="table-param-label">';z+=v;z+='  	<label class="control-label f14">';z+="  		("+w+")";z+="  	</label>";z+="  </td>";z+="  <td>";if(t=="1"){z+='  	<input type="text" name="'+v+'" id="'+w+'" value='+s+' class="form-control" disabled/>'}else{if(t=="2"){y+=1;z+='     <select style="width:100%" multiple name="'+v+'"  id="'+w+'" class="dim-select'+y+'" data-placeholder="请选择维度"></select>'}else{z+='     <input type="text"  name="'+v+'"  id="'+w+'" class="form-control"/>'}}z+="  </td>";z+="</tr>";jQuery("#param-table").append(z)}if(y>0){for(var q=1;q<=y;q++){jQuery(".dim-select"+q+"").chosen({disable_search:false});var w=jQuery(".dim-select"+q+"").attr("id");jQuery(".dim-select"+q+"").ajaxChosen({fields:["code","value"],findPage:true,disabled:false,url:c.handleUrlParam("/platform/openapi/query-dim-info")+"?paramCode="+w+"&paramInfoStr="+JSON.stringify(a)+"&apiBaseInfoStr="+JSON.stringify(b)+"&_t="+(new Date()).getTime()})}}var p=JSON.parse(b.resultInfoStr);var m=p.length;var x="";var r=null;for(var u=0;u<m;u++){r=p[u];x+='<div class="resultItem">';x+=' <label class="control-label f14">';x+=r.resultName+"("+r.resultCode+")";if(u!=m-1){x+="&nbsp;&nbsp;|"}x+="	</label>";x+="</div>"}x+='<div style="clear:both"></div>';jQuery("#resultDiv").html(x)},buttons:[{label:"取消",cssClass:"btn-default",action:function(m){m.close()}},{label:"保存",cssClass:"btn-info",action:function(m){h()}}]})}else{var j=this.id-1;var k=i[j].serviceApiId;bi.dialog.confirm({title:"提示",message:"OpenApi设置失效后该OpenApi所有的配置信息将删除！您确定需要将该OpenApi设置失效吗？",callback:function(m){if(m){c.ajax({type:"post",cache:false,dataType:"json",url:c.handleUrlParam("/platform/openapi/set-openapi-invalid"),data:{serviceApiId:k},loading:{title:"请稍后...",text:"正在设置OpenApi失效，请稍候..."},success:function(n){if(n.resFlag=="success"){jQuery("#openApiList").jqGrid().trigger("reloadGrid");bi.dialog.show({type:bi.dialog.TYPE_INFO,title:"提示",message:"设置OpenApi失效成功!"})}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"提示",message:"设置OpenApi失效失败!"})}},error:function(n){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"提示",message:n.responseText||"设置OpenApi失效异常!"})}})}}})}})}});d();$(window).resize(function(){d()})}function d(){jQuery("#openApiList").setGridWidth(jQuery(".data-grid-info").width()-5)}function h(){var k={};k=jQuery.extend(k,b);jQuery("#tip").html("");jQuery("#tip").hide();var v=a.length;for(var n=0;n<v;n++){var r=a[n].paramCode;var o=a[n].paramName;var m=jQuery("#"+r);var l=jQuery.trim(m.val());if(m.is("select")){l=l.split(",").join("||")}if(c.IsEmpty(l)){jQuery("#tip").html("请设置参数 ["+o+"] 的值");jQuery("#tip").show();return}else{a[n].paramRuleData=l}}k.paramInfoStr=JSON.stringify(a);var s=jQuery.trim(jQuery("#tableName").val());if(c.IsEmpty(s)){jQuery("#tip").html("表名称不能为空");jQuery("#tip").show();return}k.tableName=s;var u=jQuery("#updateType").val();k.updateType=u;var q=jQuery("#firstUpdateTime").val();if(u!="I"&&c.IsEmpty(firstUpdateTime)){jQuery("#tip").html("请设置下次更新时间");jQuery("#tip").show();return}if(u!="I"){k.updateTime=q}var p=jQuery("#storageType").val();if(u=="D"||u=="W"||u=="M"){if(c.IsEmpty(p)){jQuery("#tip").html("请设置存储方式");jQuery("#tip").show();return}else{k.storageType=p}}var j=jQuery("#businessType").val();k.businessType=j;var t=jQuery("#description").val();k.description=t;bi.dialog.confirm({title:"提示",message:"您确定需要保存OpenApi配置信息吗？",callback:function(i){if(i){c.ajax({type:"post",cache:false,dataType:"json",url:c.handleUrlParam("/platform/openapi/save-openapi-table"),data:k,loading:{title:"请稍后...",text:"正在保存数据，请稍候..."},success:function(w){if(w.resFlag=="success"){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:"提示",message:"OpenApi配置成功!",closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(x){jQuery("#openApiList").jqGrid().trigger("reloadGrid");window.parent.bi.dialog.closeAll()}}]})}},error:function(w){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"提示",message:w.responseText||"OpenApi配置失败!"})}})}}})}});