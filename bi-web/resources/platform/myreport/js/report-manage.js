define(["sabace","share","mymessage"],function(f,j,c){var g=20;var b=0;var e="";var k=0;jQuery(function(){var o="";jQuery(".btn-group button").bind("click",function(){jQuery(this).removeClass("normalButton").addClass("clickedButton theme-background").siblings().addClass("normalButton").removeClass("clickedButton theme-background")});jQuery(".btn-group").on("mouseover",".normalButton",function(){jQuery(".normalButton").removeClass("theme-background");jQuery(this).addClass("theme-background")}).on("mouseleave",".normalButton",function(){jQuery(this).removeClass("theme-background")});var n="all";jQuery(".top").on("click",".more",function(){jQuery(".moreLabel").toggle();var p=f.getMessage("report.label.more");if(jQuery(this).find("strong").html()==p){p=f.getMessage("report.label.back")}jQuery(this).find("strong").html(p)});var m="";jQuery(".search-btn-group button").bind("click",function(){n=jQuery(this).val();l(0,n,m,o)});jQuery("#firstbutton").click();f.ajax({url:f.handleUrlParam("/platform/myreport/manage/query-label"),success:function(p){if(p.length>0){jQuery(".report-panel .top>div,.report-panel .top>hr").show()}jQuery.each(p,function(u,s){var t=jQuery("<label>",{"class":"checkbox-diy col-xs-1",value:s.labelId});var r=jQuery("<input>",{type:"checkbox","data-toggle":"checkbox"});var q=jQuery("<label>",{html:s.labelName});t.append(r).append(q);if(u>4){t.addClass("moreLabel");jQuery(".more").show()}jQuery(".more").before(t)});jQuery('[data-toggle="checkbox"]').iCheck({checkboxClass:"icheckbox_minimal",radioClass:"iradio_minimal"});$("input").on("ifChanged",function(q){var r=jQuery(".top").find(":checked").parents(".checkbox-diy");m="";jQuery.each(r,function(t,s){if(t==0){m+=jQuery(s).attr("value")}else{m=m+","+jQuery(s).attr("value")}});l(0,n,m,o)})},error:function(p){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:f.getMessage("top.label.fail"),message:p.responseText})}});if(navyMenuShow!="0"){h()}jQuery("#search").bind("click",function(){l(0,n,m,o)});jQuery("#searchInput").keydown(function(p){if(p.keyCode==13){jQuery("#search").trigger("click")}});jQuery(".tool button").bind("click",function(){f.ajax({async:false,url:f.handleUrlParam("/platform/myreport/view/get-all-Data"),success:function(p){if((p.importList==null||p.importList.length==0)&&(p.dbList==null||p.dbList.length==0)&&(p.linkList=null||p.linkList.length==0)){bi.dialog.show({title:"页面跳转提醒",message:'您好，您还没有上传数据源，无法制作报表！<span class="timeSpan">5</span> 秒钟将自动跳转到上传数据源页面！<br><a href="'+f.handleUrlParam("/platform/resmanage/data/data-file-import")+'">立即跳转</a>',cssClass:"timeout-dialog",onshown:function(){f.interval(function(){jQuery(".timeSpan").html(jQuery(".timeSpan").html()-1)},1000);f.timeout(function(){top.document.location.href=f.handleUrlParam("/platform/resmanage/data/data-file-import")},5000)}})}else{window.open(f.handleUrlParam("/platform/dataview/create"))}},error:function(p){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:f.getMessage("top.label.fail"),message:p.responseText})}})});jQuery("#content").on("click",".eidtbtn",function(){var r=jQuery(this);var q=r.parents(".thumbnail").attr("reportId");var p=r.parents(".thumbnail").attr("appType");window.open(f.handleUrlParam("/platform/dataview/edit")+"?reportId="+q+"&appType="+p)});jQuery("#content").on("click",".delbtn",function(){var q=jQuery(this);var p=q.parents(".thumbnail").attr("reportId");bi.dialog.confirm({type:bi.dialog.TYPE_DANGER,title:f.getMessage("home.label.confirmBox"),message:f.getMessage("report.msg.delete"),callback:function(r){if(r){f.ajax({loading:{title:f.getMessage("report.button.delete"),text:f.getMessage("report.button.deleteing"),},url:f.handleUrlParam("/platform/myreport/manage/del-rep/"),data:{reportId:p},success:function(s){bi.dialog.show({title:f.getMessage("home.label.TipBox"),message:f.getMessage("report.button.deleteSuccess"),cssClass:"register-dialog",nl2br:false,closable:true});l(b,n,m,o)},error:function(s){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:f.getMessage("top.label.fail"),message:s.responseText})}})}}})});jQuery("#content").on("click",".sharebtn",function(){if(jQuery("#companyFlag").val()==0){bi.dialog.show({title:f.getMessage("home.label.TipBox"),message:f.getMessage("report.share.noCompanyMsg"),cssClass:"register-dialog",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:f.getMessage("home.button.sure"),action:function(s){s.close();dialog.close()}}]});return}k=1;var r=jQuery(this);var p=r.parents(".thumbnail").attr("reportId");var q;if(publishType==0){q=f.handleUrlParam("/platform/myreport/manage/share-rep")+"?reportId="+p}else{if(publishType==1){q=f.handleUrlParam("/third-party/publish-rep")+"?reportId="+p;bi.dialog.show({title:f.getMessage("report.publish.title"),message:$('<div id="dd"></div>').load(q),spinicon:"glyphicon glyphicon-refresh",cssClass:"share-dialog",closable:true,closeByBackdrop:false,closeByKeyboard:false,onshown:function(s){j.init()},buttons:[{label:f.getMessage("home.button.cancel"),cssClass:"btn-default btn-sm",action:function(s){s.close();k=0}},{label:f.getMessage("home.button.sure"),cssClass:"btn-primary btn-sm",action:function(s){j.publish(s);k=0}}]});return}}bi.dialog.show({title:f.getMessage("report.share.title"),message:$('<div id="dd"></div>').load(q),spinicon:"glyphicon glyphicon-refresh",cssClass:"share-dialog",closable:true,closeByBackdrop:false,closeByKeyboard:false,onshown:function(s){j.init()},buttons:[{label:f.getMessage("home.button.cancel"),cssClass:"btn-default btn-sm",action:function(s){s.close();k=0}},{label:f.getMessage("home.button.sure"),cssClass:"btn-primary btn-sm",action:function(s){j.sure(s);k=0}}]})});jQuery("#content").on("click",".repImg,.txt",function(){var q=jQuery(this).parents(".thumbnail").attr("reportId");var p=jQuery(this).parents(".thumbnail").attr("appType");window.open(f.handleUrlParam("/platform/dataview/view")+"?reportId="+q+"&appType="+p)});jQuery(window).scroll(function(){if(jQuery(window).scrollTop()>=100){jQuery(".actGotop").fadeIn(300);jQuery(".report-panel").addClass("suspension")}else{if(jQuery(window).scrollTop()<90){jQuery(".actGotop").fadeOut(300);jQuery(".report-panel").removeClass("suspension")}}});jQuery(".actGotop").click(function(){jQuery("html,body").animate({scrollTop:"0px"},800)});$(".tree-nav .nav-info .nav-arrow").on("click",function(){var q=$(this);var p=q.attr("status");if(p=="up"){q.attr("status","flowing");$(".tree-nav").stop().animate({left:"-1px"},"fast",function(){q.removeClass("fa-angle-double-left");q.removeClass("fa-angle-double-right");q.addClass("fa-angle-double-left");q.attr("status","down")})}else{if(p=="down"){q.attr("status","flowing");$(".tree-nav").stop().animate({left:"-225px"},"fast",function(){q.removeClass("fa-angle-double-left");q.removeClass("fa-angle-double-right");q.addClass("fa-angle-double-right");q.attr("status","up")})}}})});function d(o,m,n,p){jQuery(".loadingbar.waiting.reportLoading").remove();jQuery("<div>",{id:"loadingbar2","class":"loadingbar waiting reportLoading",html:"<dt/><dd/>"}).appendTo(".report-panel .butRow");jQuery("#loadingbar2").width((50+Math.random()*30)+"%");var q=jQuery("#searchInput").val();f.ajax({url:f.handleUrlParam("/platform/myreport/manage/query-reps/"),data:{page:o,rows:g,type:m,labelIds:n,searchText:e,navi:p},success:function(t){jQuery("#content").html("");$("body,html").animate({scrollTop:0},100);if(t.reportList.rows.length==0){var r=[];var u=n.split(",");if(u!=""){jQuery(u).each(function(z,x){var y=jQuery("label[value='"+x+"']").find("strong").html();if(z==0){y=f.getMessage("report.label.noReportLabel")+y}r.push(y)})}if(q!=""){r.push(f.getMessage("report.label.noReportTxt")+q)}if(!jQuery("#firstbutton").hasClass("clickedButton")){var s=r.length==0?"":f.getMessage("report.label.noReportAnd");r.push(s+jQuery(".report-panel .search-btn-group .clickedButton").html().replace(/&nbsp;/g,""))}var w="";if(r.length==0){w="<div>!</div><div>"+f.getMessage("report.label.noReport3")+"</div>"}else{w="<div>!</div><div>"+f.getMessage("report.label.noReport1")+'<span style="font-weight:bold;">“'+r+"”</span>"+f.getMessage("report.label.noReport2")+"</div>"}var v=jQuery("<div>",{"class":"noreport-msg",html:w});jQuery("#content").html(v)}else{jQuery.each(t.reportList.rows,function(y,x){a(x)})}jQuery("#loadingbar2").css("width","99.5%").delay(200).fadeOut(400,function(){$(this).remove()})},error:function(r){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"异常",message:"查询报表异常，请稍后再试 ！"})}})}function l(o,m,n,p){jQuery(".loadingbar.waiting.reportLoading").remove();jQuery("<div>",{id:"loadingbar2","class":"loadingbar waiting reportLoading",html:"<dt/><dd/>"}).appendTo(".report-panel .butRow");jQuery("#loadingbar2").width((50+Math.random()*30)+"%");var q=jQuery("#searchInput").val();f.ajax({url:f.handleUrlParam("/platform/myreport/manage/query-reps/"),data:{page:o,rows:g,type:m,labelIds:n,searchText:q,navi:p},success:function(v){b=0;e=q;jQuery("#content").html("");$("body,html").animate({scrollTop:0},100);if(v.reportList.rows.length==0){var s=[];var w=n.split(",");if(w!=""){jQuery(w).each(function(B,z){var A=jQuery("label[value='"+z+"']").find("strong").html();if(B==0){A=f.getMessage("report.label.noReportLabel")+A}s.push(A)})}if(q!=""){s.push(f.getMessage("report.label.noReportTxt")+q)}if(!jQuery("#firstbutton").hasClass("clickedButton")){var u=s.length==0?"":f.getMessage("report.label.noReportAnd");s.push(u+jQuery(".report-panel .search-btn-group .clickedButton").html().replace(/&nbsp;/g,""))}var y="";if(s.length==0){y="<div>!</div><div>"+f.getMessage("report.label.noReport3")+"</div>"}else{y="<div>!</div><div>"+f.getMessage("report.label.noReport1")+'<span style="font-weight:bold;">“'+s+"”</span>"+f.getMessage("report.label.noReport2")+"</div>"}var x=jQuery("<div>",{"class":"noreport-msg",html:y});jQuery("#content").html(x)}jQuery.each(v.reportList.rows,function(A,z){a(z)});jQuery("#page").page("destroy");jQuery("#page").page({total:v.reportList.total,pageSize:g,showJump:true,firstBtnText:"首页",lastBtnText:"尾页",jumpBtnText:"跳转"}).on("pageClicked",function(A,z){b=z;d(z,m,n,p)}).on("jumpClicked",function(A,z){b=z;d(z,m,n,p)});var r=jQuery(".page").width();var t=Number(jQuery(".m-pagination-page").width())+Number(jQuery(".m-pagination-jump").width());jQuery(".m-pagination-page").css("margin-left",(r-t)/2+"px");jQuery("#loadingbar2").css("width","99.5%").delay(200).fadeOut(400,function(){$(this).remove()})},error:function(r){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"异常",message:"查询报表异常，请稍后再试 ！"})}})}var i=(window.screen.width*0.21-30)/2;function a(o){var G=jQuery("<div>",{"class":"thumbnail effect",reportId:o.reportId,appType:o.appType});var F=jQuery("<div>",{css:{height:i+"px",background:"url("+o.imgByte+") no-repeat","background-size":"100% auto"},"class":"repImg"});var p=jQuery("<div>",{"class":"txt"});var E=jQuery("<strong>",{html:o.reportName,style:"margin-left:2%",title:o.reportName});var z=jQuery("<div>",{"class":"help-block",html:'<div class="comment">'+f.getMessage("home.label.comment")+"<strong> "+(o.commentCount==null?0:o.commentCount)+" </strong></div>"});var x=o.score;var v=jQuery("<i>",{"class":"fa fa-star-o",});var u=jQuery("<i>",{"class":"fa fa-star-o",});var t=jQuery("<i>",{"class":"fa fa-star-o",});var s=jQuery("<i>",{"class":"fa fa-star-o",});var r=jQuery("<i>",{"class":"fa fa-star-o",});var D=[];D.push(v);D.push(u);D.push(t);D.push(s);D.push(r);if(x.length==1){for(var w=1;w<=x;w++){D[w-1].attr("class","fa fa-star")}}else{for(var w=1;w<=x.substring(0,1);w++){D[w-1].attr("class","fa fa-star")}D[x.substring(0,1)].attr("class","fa fa-star-half-o")}var n=jQuery("<div>",{"class":"stars"});var A='<div class="visit">'+f.getMessage("home.label.visit")+'<strong class="times"> '+o.visitCount+" </strong></div>";var C=jQuery("<hr>",{});var q=jQuery("<div>",{"class":"but"});var m=jQuery("<div>",{"class":"eidtbtn",html:'<i class="fa fa-pencil butFa"></i><span>'+f.getMessage("report.button.edit")+"</span>"});var B=jQuery("<div>",{"class":"delbtn",html:'<i class="fa fa-trash-o butFa"></i><span>'+f.getMessage("report.button.delete")+"</span>"});var y=jQuery("<div>",{"class":"sharebtn",html:'<i class="fa fa-share butFa"></i><span>'+f.getMessage("report.button.share")+"</span>"});if(jobIds.indexOf("A")>-1){q.append(m).append(B).append(y)}else{if(o.createId==sessionUserId){q.append(m).append(B).append(y)}}n.append(D);z.append(n).append(A);if("1"==o.appType){p.append(E).append("<div class='help-block'>").find(".help-block").append(A).find(".visit").css("textAlign","left")}else{p.append(E).append(z)}G.append(F).append(p).append(C).append(q);jQuery("#content").append(G)}function h(){var m=$("html body div.container-fluid div#pjax-container.main div.panel.report-panel").outerHeight();var n=$(document).height();$("#nav").css("height",(n-m-20)+"px");f.ajax({data:{},url:f.handleUrlParam("/platform/myreport/manage/navi-tree/"),success:function(q){if(q==null||q.length==0){return}var o={view:{showLine:true},data:{simpleData:{enable:true,idKey:"id",pidKey:"pId"}},callback:{beforeClick:function(v,u){if(u.naviLevel==1){var r=u.children;if(r&&r.length>0){for(var t=0;t<r.length;t++){var s=r[t].children;if(s&&s.length>0){return true}}}return false}if(u.naviLevel==2){var r=u.children;if(!r&&r.length==0){return false}}return true},onClick:function(r,v,x){navi="";if(x.level==null||x.level==""){l(0,type,labelArry,navi)}if(x.naviLevel==1){var z=x.children;if(z&&z.length>0){navi+="('";for(var u=0;u<z.length;u++){var y=z[u].children;if(y&&y.length>0){for(var t=0;t<y.length;t++){navi+=y[t].id+"','"}}}navi=navi.substring(0,navi.length-2)+")"}l(0,type,labelArry,navi)}else{if(x.level==2){var z=x.children;if(z&&z.length>0){navi+="('";for(var u=0;u<z.length;u++){navi+=z[u].id+"','"}navi=navi.substring(0,navi.length-2)+")"}l(0,type,labelArry,navi)}else{if(x.level==3){var w=x.id;var s=jQuery(this).parents(".thumbnail").attr("appType");window.open(f.handleUrlParam("/platform/dataview/view")+"?reportId="+w+"&appType=0")}}}}}};var p=$.fn.zTree.init($("#tree"),o,q);p.expandAll(true)},error:function(o){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:f.getMessage("report.reportlist.label.tip"),message:o.responseText||f.getMessage("report.navi.get.error")})}})}});