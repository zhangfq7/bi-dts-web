define(["sabace","share","mymessage"],function(f,i,c){var g=20;var b=0;var e="";var j=0;jQuery(function(){var n="";jQuery(".btn-group button").bind("click",function(){jQuery(this).removeClass("normalButton").addClass("clickedButton theme-background").siblings().addClass("normalButton").removeClass("clickedButton theme-background")});jQuery(".btn-group").on("mouseover",".normalButton",function(){jQuery(".normalButton").removeClass("theme-background");jQuery(this).addClass("theme-background")}).on("mouseleave",".normalButton",function(){jQuery(this).removeClass("theme-background")});var m="all";jQuery(".top").on("click",".more",function(){jQuery(".moreLabel").toggle();var p=f.getMessage("report.label.more");if(jQuery(this).find("strong").html()==p){p=f.getMessage("report.label.back")}jQuery(this).find("strong").html(p)});var l="";jQuery(".search-btn-group button").bind("click",function(){m=jQuery(this).val();k(0,m,l,n)});jQuery("#firstbutton").click();f.ajax({url:f.handleUrlParam("/platform/myreport/manage/query-label"),success:function(p){if(p.length>0){jQuery(".report-panel .top>div,.report-panel .top>hr").show()}jQuery.each(p,function(u,s){var t=jQuery("<label>",{"class":"checkbox-diy col-xs-1",value:s.labelId});var r=jQuery("<input>",{type:"checkbox","data-toggle":"checkbox"});var q=jQuery("<label>",{html:s.labelName});t.append(r).append(q);if(u>4){t.addClass("moreLabel");jQuery(".more").show()}jQuery(".more").before(t)});jQuery('[data-toggle="checkbox"]').iCheck({checkboxClass:"icheckbox_minimal",radioClass:"iradio_minimal"});$("input").on("ifChanged",function(q){var r=jQuery(".top").find(":checked").parents(".checkbox-diy");l="";jQuery.each(r,function(t,s){if(t==0){l+=jQuery(s).attr("value")}else{l=l+","+jQuery(s).attr("value")}});k(0,m,l,n)})},error:function(p){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:f.getMessage("top.label.fail"),message:p.responseText})}});jQuery("#search").bind("click",function(){k(0,m,l,n)});jQuery("#searchInput").keydown(function(p){if(p.keyCode==13){jQuery("#search").trigger("click")}});jQuery(".tool button").bind("click",function(){f.ajax({async:false,url:f.handleUrlParam("/platform/myreport/view/get-all-Data"),success:function(p){if((p.importList==null||p.importList.length==0)&&(p.dbList==null||p.dbList.length==0)&&(p.linkList=null||p.linkList.length==0)){bi.dialog.show({title:"页面跳转提醒",message:'您好，您还没有上传数据源，无法制作报表！<span class="timeSpan">5</span> 秒钟将自动跳转到上传数据源页面！<br><a href="'+f.handleUrlParam("/platform/resmanage/data/data-file-import")+'">立即跳转</a>',cssClass:"timeout-dialog",onshown:function(){f.interval(function(){jQuery(".timeSpan").html(jQuery(".timeSpan").html()-1)},1000);f.timeout(function(){top.document.location.href=f.handleUrlParam("/platform/resmanage/data/data-file-import")},5000)}})}else{window.open(f.handleUrlParam("/platform/dataview/create"))}},error:function(p){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:f.getMessage("top.label.fail"),message:p.responseText})}})});jQuery("#content").on("click",".eidtbtn",function(){var r=jQuery(this);var q=r.parents(".thumbnail").attr("reportId");var p=r.parents(".thumbnail").attr("appType");window.open(f.handleUrlParam("/platform/dataview/edit")+"?reportId="+q+"&appType="+p)});jQuery("#content").on("click",".delbtn",function(){var q=jQuery(this);var p=q.parents(".thumbnail").attr("reportId");bi.dialog.confirm({type:bi.dialog.TYPE_DANGER,title:f.getMessage("home.label.confirmBox"),message:f.getMessage("report.msg.delete"),callback:function(r){if(r){f.ajax({loading:{title:f.getMessage("report.button.delete"),text:f.getMessage("report.button.deleteing"),},url:f.handleUrlParam("/platform/myreport/manage/del-rep/"),data:{reportId:p},success:function(s){bi.dialog.show({title:f.getMessage("home.label.TipBox"),message:f.getMessage("report.button.deleteSuccess"),cssClass:"register-dialog",nl2br:false,closable:true});k(b,m,l,n)},error:function(s){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:f.getMessage("top.label.fail"),message:s.responseText})}})}}})});jQuery("#content").on("click",".sharebtn",function(){if(jQuery("#companyFlag").val()==0){bi.dialog.show({title:f.getMessage("home.label.TipBox"),message:f.getMessage("report.share.noCompanyMsg"),cssClass:"register-dialog",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:f.getMessage("home.button.sure"),action:function(s){s.close();dialog.close()}}]});return}j=1;var r=jQuery(this);var p=r.parents(".thumbnail").attr("reportId");var q;if(publishType==0){q=f.handleUrlParam("/platform/myreport/manage/share-rep")+"?reportId="+p}else{if(publishType==1){q=f.handleUrlParam("/third-party/publish-rep")+"?reportId="+p;bi.dialog.show({title:f.getMessage("report.publish.title"),message:$('<div id="dd"></div>').load(q),spinicon:"glyphicon glyphicon-refresh",cssClass:"share-dialog",closable:true,closeByBackdrop:false,closeByKeyboard:false,onshown:function(s){i.init()},buttons:[{label:f.getMessage("home.button.cancel"),cssClass:"btn-default btn-sm",action:function(s){s.close();j=0}},{label:f.getMessage("home.button.sure"),cssClass:"btn-primary btn-sm",action:function(s){i.publish(s);j=0}}]});return}}bi.dialog.show({title:f.getMessage("report.share.title"),message:$('<div id="dd"></div>').load(q),spinicon:"glyphicon glyphicon-refresh",cssClass:"share-dialog",closable:true,closeByBackdrop:false,closeByKeyboard:false,onshown:function(s){i.init()},buttons:[{label:f.getMessage("home.button.cancel"),cssClass:"btn-default btn-sm",action:function(s){s.close();j=0}},{label:f.getMessage("home.button.sure"),cssClass:"btn-primary btn-sm",action:function(s){i.sure(s);j=0}}]})});jQuery("#content").on("click",".repImg,.txt",function(){var q=jQuery(this).parents(".thumbnail").attr("reportId");var p=jQuery(this).parents(".thumbnail").attr("appType");window.open(f.handleUrlParam("/platform/dataview/view")+"?reportId="+q+"&appType="+p)});jQuery(window).scroll(function(){if(jQuery(window).scrollTop()>=100){jQuery(".actGotop").fadeIn(300);jQuery(".report-panel").addClass("suspension")}else{if(jQuery(window).scrollTop()<90){jQuery(".actGotop").fadeOut(300);jQuery(".report-panel").removeClass("suspension")}}});jQuery(".actGotop").click(function(){jQuery("html,body").animate({scrollTop:"0px"},800)});$(".tree-nav .nav-info .nav-arrow").on("click",function(){var q=$(this);var p=q.attr("status");if(p=="up"){q.attr("status","flowing");$(".tree-nav").stop().animate({left:"-1px"},"fast",function(){q.removeClass("fa-angle-double-left");q.removeClass("fa-angle-double-right");q.addClass("fa-angle-double-left");q.attr("status","down")})}else{if(p=="down"){q.attr("status","flowing");$(".tree-nav").stop().animate({left:"-225px"},"fast",function(){q.removeClass("fa-angle-double-left");q.removeClass("fa-angle-double-right");q.addClass("fa-angle-double-right");q.attr("status","up")})}}});var o=function(){f.ajax({data:{},url:f.handleUrlParam("/platform/myreport/manage/navi-tree/"),success:function(r){if(r==null||r.length==0){return}var p={view:{showLine:true},data:{simpleData:{enable:true,idKey:"id",pidKey:"pId"}},callback:{beforeClick:function(w,v){if(v.naviLevel==1){var s=v.children;if(s&&s.length>0){for(var u=0;u<s.length;u++){var t=s[u].children;if(t&&t.length>0){return true}}}return false}if(v.naviLevel==2){var s=v.children;if(!s&&s.length==0){return false}}return true},onClick:function(s,w,y){n="";if(y.level==null||y.level==""){k(0,m,l,n)}if(y.naviLevel==1){var A=y.children;if(A&&A.length>0){n+="('";for(var v=0;v<A.length;v++){var z=A[v].children;if(z&&z.length>0){for(var u=0;u<z.length;u++){n+=z[u].id+"','"}}}n=n.substring(0,n.length-2)+")"}k(0,m,l,n)}else{if(y.level==2){var A=y.children;if(A&&A.length>0){n+="('";for(var v=0;v<A.length;v++){n+=A[v].id+"','"}n=n.substring(0,n.length-2)+")"}k(0,m,l,n)}else{if(y.level==3){var x=y.id;var t=jQuery(this).parents(".thumbnail").attr("appType");window.open(f.handleUrlParam("/platform/dataview/view")+"?reportId="+x+"&appType=0")}}}}}};var q=$.fn.zTree.init($("#tree"),p,r);q.expandAll(true)},error:function(p){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:f.getMessage("report.reportlist.label.tip"),message:p.responseText||f.getMessage("report.navi.get.error")})}})};o()});function d(n,l,m,o){jQuery(".loadingbar.waiting.reportLoading").remove();jQuery("<div>",{id:"loadingbar2","class":"loadingbar waiting reportLoading",html:"<dt/><dd/>"}).appendTo(".report-panel .butRow");jQuery("#loadingbar2").width((50+Math.random()*30)+"%");var p=jQuery("#searchInput").val();f.ajax({url:f.handleUrlParam("/platform/myreport/manage/query-reps/"),data:{page:n,rows:g,type:l,labelIds:m,searchText:e,navi:o},success:function(s){jQuery("#content").html("");$("body,html").animate({scrollTop:0},100);if(s.reportList.rows.length==0){var q=[];var t=m.split(",");if(t!=""){jQuery(t).each(function(y,w){var x=jQuery("label[value='"+w+"']").find("strong").html();if(y==0){x=f.getMessage("report.label.noReportLabel")+x}q.push(x)})}if(p!=""){q.push(f.getMessage("report.label.noReportTxt")+p)}if(!jQuery("#firstbutton").hasClass("clickedButton")){var r=q.length==0?"":f.getMessage("report.label.noReportAnd");q.push(r+jQuery(".report-panel .search-btn-group .clickedButton").html().replace(/&nbsp;/g,""))}var v="";if(q.length==0){v="<div>!</div><div>"+f.getMessage("report.label.noReport3")+"</div>"}else{v="<div>!</div><div>"+f.getMessage("report.label.noReport1")+'<span style="font-weight:bold;">“'+q+"”</span>"+f.getMessage("report.label.noReport2")+"</div>"}var u=jQuery("<div>",{"class":"noreport-msg",html:v});jQuery("#content").html(u)}else{jQuery.each(s.reportList.rows,function(x,w){a(w)})}jQuery("#loadingbar2").css("width","99.5%").delay(200).fadeOut(400,function(){$(this).remove()})},error:function(q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"异常",message:"查询报表异常，请稍后再试 ！"})}})}function k(n,l,m,o){jQuery(".loadingbar.waiting.reportLoading").remove();jQuery("<div>",{id:"loadingbar2","class":"loadingbar waiting reportLoading",html:"<dt/><dd/>"}).appendTo(".report-panel .butRow");jQuery("#loadingbar2").width((50+Math.random()*30)+"%");var p=jQuery("#searchInput").val();f.ajax({url:f.handleUrlParam("/platform/myreport/manage/query-reps/"),data:{page:n,rows:g,type:l,labelIds:m,searchText:p,navi:o},success:function(u){b=0;e=p;jQuery("#content").html("");$("body,html").animate({scrollTop:0},100);if(u.reportList.rows.length==0){var r=[];var v=m.split(",");if(v!=""){jQuery(v).each(function(A,y){var z=jQuery("label[value='"+y+"']").find("strong").html();if(A==0){z=f.getMessage("report.label.noReportLabel")+z}r.push(z)})}if(p!=""){r.push(f.getMessage("report.label.noReportTxt")+p)}if(!jQuery("#firstbutton").hasClass("clickedButton")){var t=r.length==0?"":f.getMessage("report.label.noReportAnd");r.push(t+jQuery(".report-panel .search-btn-group .clickedButton").html().replace(/&nbsp;/g,""))}var x="";if(r.length==0){x="<div>!</div><div>"+f.getMessage("report.label.noReport3")+"</div>"}else{x="<div>!</div><div>"+f.getMessage("report.label.noReport1")+'<span style="font-weight:bold;">“'+r+"”</span>"+f.getMessage("report.label.noReport2")+"</div>"}var w=jQuery("<div>",{"class":"noreport-msg",html:x});jQuery("#content").html(w)}jQuery.each(u.reportList.rows,function(z,y){a(y)});jQuery("#page").page("destroy");jQuery("#page").page({total:u.reportList.total,pageSize:g,showJump:true,firstBtnText:"首页",lastBtnText:"尾页",jumpBtnText:"跳转"}).on("pageClicked",function(z,y){b=y;d(y,l,m,o)}).on("jumpClicked",function(z,y){b=y;d(y,l,m,o)});var q=jQuery(".page").width();var s=Number(jQuery(".m-pagination-page").width())+Number(jQuery(".m-pagination-jump").width());jQuery(".m-pagination-page").css("margin-left",(q-s)/2+"px");jQuery("#loadingbar2").css("width","99.5%").delay(200).fadeOut(400,function(){$(this).remove()})},error:function(q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"异常",message:"查询报表异常，请稍后再试 ！"})}})}var h=(window.screen.width*0.21-30)/2;function a(n){var F=jQuery("<div>",{"class":"thumbnail effect",reportId:n.reportId,appType:n.appType});var E=jQuery("<div>",{css:{height:h+"px",background:"url("+n.imgByte+") no-repeat","background-size":"100% auto"},"class":"repImg"});var o=jQuery("<div>",{"class":"txt"});var D=jQuery("<strong>",{html:n.reportName,style:"margin-left:2%",title:n.reportName});var y=jQuery("<div>",{"class":"help-block",html:'<div class="comment">'+f.getMessage("home.label.comment")+"<strong> "+(n.commentCount==null?0:n.commentCount)+" </strong></div>"});var w=n.score;var u=jQuery("<i>",{"class":"fa fa-star-o",});var t=jQuery("<i>",{"class":"fa fa-star-o",});var s=jQuery("<i>",{"class":"fa fa-star-o",});var r=jQuery("<i>",{"class":"fa fa-star-o",});var q=jQuery("<i>",{"class":"fa fa-star-o",});var C=[];C.push(u);C.push(t);C.push(s);C.push(r);C.push(q);if(w.length==1){for(var v=1;v<=w;v++){C[v-1].attr("class","fa fa-star")}}else{for(var v=1;v<=w.substring(0,1);v++){C[v-1].attr("class","fa fa-star")}C[w.substring(0,1)].attr("class","fa fa-star-half-o")}var m=jQuery("<div>",{"class":"stars"});var z='<div class="visit">'+f.getMessage("home.label.visit")+'<strong class="times"> '+n.visitCount+" </strong></div>";var B=jQuery("<hr>",{});var p=jQuery("<div>",{"class":"but"});var l=jQuery("<div>",{"class":"eidtbtn",html:'<i class="fa fa-pencil butFa"></i><span>'+f.getMessage("report.button.edit")+"</span>"});var A=jQuery("<div>",{"class":"delbtn",html:'<i class="fa fa-trash-o butFa"></i><span>'+f.getMessage("report.button.delete")+"</span>"});var x=jQuery("<div>",{"class":"sharebtn",html:'<i class="fa fa-share butFa"></i><span>'+f.getMessage("report.button.share")+"</span>"});if(jobIds.indexOf("A")>-1){p.append(l).append(A).append(x)}else{if(n.createId==sessionUserId){p.append(l).append(A).append(x)}}m.append(C);y.append(m).append(z);if("1"==n.appType){o.append(D).append("<div class='help-block'>").find(".help-block").append(z).find(".visit").css("textAlign","left")}else{o.append(D).append(y)}F.append(E).append(o).append(B).append(p);jQuery("#content").append(F)}});