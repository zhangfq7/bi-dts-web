define(["sabace","share","mymessage"],function(f,j,c){var g=20;var b=0;var e="";var k=0;var h=[];if(typeof(sessionStorage.goalChoose)!="undefine"&&sessionStorage.goalChoose!=""&&sessionStorage.goalChoose!=null){h=JSON.parse(sessionStorage.goalChoose)}else{sessionStorage.goalChoose=""}jQuery(function(){jQuery(".btn-group button").bind("click",function(){jQuery(this).removeClass("normalButton").addClass("clickedButton theme-background").siblings().addClass("normalButton").removeClass("clickedButton theme-background")});jQuery(".btn-group").on("mouseover",".normalButton",function(){jQuery(".normalButton").removeClass("theme-background");jQuery(this).addClass("theme-background")}).on("mouseleave",".normalButton",function(){jQuery(this).removeClass("theme-background")});var p="all";jQuery(".top").on("click",".more",function(){jQuery(".moreLabel").toggle();var q=f.getMessage("report.label.more");if(jQuery(this).find("strong").html()==q){q=f.getMessage("report.label.back")}jQuery(this).find("strong").html(q)});var o="";jQuery(".search-btn-group button").bind("click",function(){p=jQuery(this).val();l(0,p,o)});jQuery("#firstbutton").click();f.ajax({url:f.handleUrlParam("/platform/myreport/manage/query-label"),success:function(q){if(q.length>0){jQuery(".report-panel .top>div,.report-panel .top>hr").show()}jQuery.each(q,function(w,t){var u=jQuery("<label>",{"class":"checkbox-diy col-xs-1",value:t.labelId});var s=jQuery("<input>",{type:"checkbox","data-toggle":"checkbox"});var r=jQuery("<label>",{html:t.labelName});u.append(s).append(r);if(w>4){u.addClass("moreLabel");jQuery(".more").show()}jQuery(".more").before(u)});jQuery('[data-toggle="checkbox"]').iCheck({checkboxClass:"icheckbox_minimal",radioClass:"iradio_minimal"});$("input").on("ifChanged",function(r){var s=jQuery(".top").find(":checked").parents(".checkbox-diy");o="";jQuery.each(s,function(u,t){if(u==0){o+=jQuery(t).attr("value")}else{o=o+","+jQuery(t).attr("value")}});l(0,p,o)})},error:function(q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:f.getMessage("top.label.fail"),message:q.responseText})}});jQuery("#search").bind("click",function(){l(0,p,o)});jQuery("#searchInput").keydown(function(q){if(q.keyCode==13){jQuery("#search").trigger("click")}});jQuery(".tool button").bind("click",function(){f.ajax({async:false,url:f.handleUrlParam("/platform/myreport/view/get-all-Data"),success:function(q){if((q.importList==null||q.importList.length==0)&&(q.dbList==null||q.dbList.length==0)&&(q.linkList=null||q.linkList.length==0)){bi.dialog.show({title:"页面跳转提醒",message:'您好，您还没有上传数据源，无法制作报表！<span class="timeSpan">5</span> 秒钟将自动跳转到上传数据源页面！<br><a href="'+f.handleUrlParam("/platform/resmanage/data/data-file-import")+'">立即跳转</a>',cssClass:"timeout-dialog",onshown:function(){f.interval(function(){jQuery(".timeSpan").html(jQuery(".timeSpan").html()-1)},1000);f.timeout(function(){top.document.location.href=f.handleUrlParam("/platform/resmanage/data/data-file-import")},5000)}})}else{window.open(f.handleUrlParam("/platform/dataview/create"))}},error:function(q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:f.getMessage("top.label.fail"),message:q.responseText})}})});jQuery("#content").on("click",".eidtbtn",function(){var s=jQuery(this);var r=s.parents(".thumbnail").attr("reportId");var q=s.parents(".thumbnail").attr("appType");window.open(f.handleUrlParam("/platform/dataview/edit")+"?reportId="+r+"&appType="+q)});jQuery("#content").on("click",".delbtn",function(){var r=jQuery(this);var q=r.parents(".thumbnail").attr("reportId");bi.dialog.confirm({type:bi.dialog.TYPE_DANGER,title:f.getMessage("home.label.confirmBox"),message:f.getMessage("report.msg.delete"),callback:function(s){if(s){f.ajax({loading:{title:f.getMessage("report.button.delete"),text:f.getMessage("report.button.deleteing"),},url:f.handleUrlParam("/platform/myreport/manage/del-rep/"),data:{reportId:q},success:function(t){bi.dialog.show({title:f.getMessage("home.label.TipBox"),message:f.getMessage("report.button.deleteSuccess"),cssClass:"register-dialog",nl2br:false,closable:true});l(b,p,o)},error:function(t){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:f.getMessage("top.label.fail"),message:t.responseText})}})}}})});jQuery("#content").on("click",".sharebtn",function(){if(jQuery("#companyFlag").val()==0){bi.dialog.show({title:f.getMessage("home.label.TipBox"),message:f.getMessage("report.share.noCompanyMsg"),cssClass:"register-dialog",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:f.getMessage("home.button.sure"),action:function(t){t.close();dialog.close()}}]});return}k=1;var s=jQuery(this);var q=s.parents(".thumbnail").attr("reportId");var r;if(publishType==0){r=f.handleUrlParam("/platform/myreport/manage/share-rep")+"?reportId="+q}else{if(publishType==1){r=f.handleUrlParam("/third-party/publish-rep")+"?reportId="+q;bi.dialog.show({title:f.getMessage("report.publish.title"),message:$('<div id="dd"></div>').load(r),spinicon:"glyphicon glyphicon-refresh",cssClass:"share-dialog",closable:true,closeByBackdrop:false,closeByKeyboard:false,onshown:function(t){j.init()},buttons:[{label:f.getMessage("home.button.cancel"),cssClass:"btn-default btn-sm",action:function(t){t.close();k=0}},{label:f.getMessage("home.button.sure"),cssClass:"btn-primary btn-sm",action:function(t){j.publish(t);k=0}}]});return}}bi.dialog.show({title:f.getMessage("report.share.title"),message:$('<div id="dd"></div>').load(r),spinicon:"glyphicon glyphicon-refresh",cssClass:"share-dialog",closable:true,closeByBackdrop:false,closeByKeyboard:false,onshown:function(t){j.init()},buttons:[{label:f.getMessage("home.button.cancel"),cssClass:"btn-default btn-sm",action:function(t){t.close();k=0}},{label:f.getMessage("home.button.sure"),cssClass:"btn-primary btn-sm",action:function(t){j.sure(t);k=0}}]})});var m="";jQuery("#operSure").click(function(){var r=JSON.stringify("sessionStorage.goalChoose");var t=[];sessionStorage.removeItem("goalChoose");for(var u=0;u<h.length;u++){var q=-1;for(var s=0;s<r.length;s++){if(h[u].reportId==r[s].reportId){q=s}}if(q>-1){t.push(r[s])}else{t.push(h[u])}}console.log(sessionStorage.goalChoose);console.log(h);sessionStorage.goalChoose=JSON.stringify(t);window.parent.document.getElementById("goalPanel").style.display="none";console.log(t);n(t)});function n(s){if(s){$(".penetrate .list",parent.document).remove();var q=s.length;for(var r=0;r<q;r++){$("#addPenetrate",parent.document).before('<div proptype="penetrate" class="list close" style="display:block"><div class="propTitle"><i class="fa fa-caret-right"></i><i class="fa fa-caret-down"></i><div class="text">穿透主题 </div><div  class="delAttrDim delPenetrate" style="display: block" title="移除该主题"></div></div><div class="propContanier" style="display: none;"><div class="items"><div class="label">主标题:</div><div class="config"><input class="theme-text" style="width:143px" class="input" type="text" value='+s[r].reportName+'></div></div><div class="items"><div class="label">目标仪表板:</div><div class="config"><input id="panelId'+r+'" class="panel-text" style="width:120px" class="input" type="text" placeholder="请选择" code='+s[r].reportId+" value="+s[r].reportGoal+" readonly ></div></div></div>")}}}jQuery("#operClose").click(function(){window.parent.document.getElementById("goalPanel").style.display="none"});jQuery("#content").on("click",".repImg,.txt",function(){var r={};var u=jQuery(this).parents(".thumbnail").attr("reportId");var q=jQuery(this).parents(".thumbnail").attr("appType");var x=jQuery(this).siblings(".txt").children("strong").text();var w=x;r.reportId=u;r.reportGoal=x;r.reportName=w;var v=h.length;var t=-1;if($(this).parent().hasClass("thumChoose")){$(this).parent().removeClass("thumChoose");for(var s=0;s<v;s++){if(h[s].reportId==r.reportId){t=s}}if(t!=-1){h.splice(t,1)}}else{$(this).parent().addClass("thumChoose");h.push(r)}});jQuery(window).scroll(function(){if(jQuery(window).scrollTop()>=100){jQuery(".actGotop").fadeIn(300);jQuery(".report-panel").addClass("suspension")}else{if(jQuery(window).scrollTop()<90){jQuery(".actGotop").fadeOut(300);jQuery(".report-panel").removeClass("suspension")}}});jQuery(".actGotop").click(function(){jQuery("html,body").animate({scrollTop:"0px"},800)})});function d(o,m,n){jQuery(".loadingbar.waiting.reportLoading").remove();jQuery("<div>",{id:"loadingbar2","class":"loadingbar waiting reportLoading",html:"<dt/><dd/>"}).appendTo(".report-panel .butRow");jQuery("#loadingbar2").width((50+Math.random()*30)+"%");var p=jQuery("#searchInput").val();f.ajax({url:f.handleUrlParam("/platform/myreport/manage/query-reps/"),data:{page:o,rows:g,type:m,labelIds:n,searchText:e},success:function(s){jQuery("#content").html("");$("body,html").animate({scrollTop:0},100);if(s.reportList.rows.length==0){var q=[];var t=n.split(",");if(t!=""){jQuery(t).each(function(y,w){var x=jQuery("label[value='"+w+"']").find("strong").html();if(y==0){x=f.getMessage("report.label.noReportLabel")+x}q.push(x)})}if(p!=""){q.push(f.getMessage("report.label.noReportTxt")+p)}if(!jQuery("#firstbutton").hasClass("clickedButton")){var r=q.length==0?"":f.getMessage("report.label.noReportAnd");q.push(r+jQuery(".report-panel .search-btn-group .clickedButton").html().replace(/&nbsp;/g,""))}var v="";if(q.length==0){v="<div>!</div><div>"+f.getMessage("report.label.noReport3")+"</div>"}else{v="<div>!</div><div>"+f.getMessage("report.label.noReport1")+'<span style="font-weight:bold;">“'+q+"”</span>"+f.getMessage("report.label.noReport2")+"</div>"}var u=jQuery("<div>",{"class":"noreport-msg",html:v});jQuery("#content").html(u)}else{jQuery.each(s.reportList.rows,function(x,w){a(w)})}jQuery("#loadingbar2").css("width","99.5%").delay(200).fadeOut(400,function(){$(this).remove()})},error:function(q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"异常",message:"查询报表异常，请稍后再试 ！"})}})}function l(o,m,n){jQuery(".loadingbar.waiting.reportLoading").remove();jQuery("<div>",{id:"loadingbar2","class":"loadingbar waiting reportLoading",html:"<dt/><dd/>"}).appendTo(".report-panel .butRow");jQuery("#loadingbar2").width((50+Math.random()*30)+"%");var p=jQuery("#searchInput").val();f.ajax({url:f.handleUrlParam("/platform/myreport/manage/query-reps/"),data:{page:o,rows:g,type:m,labelIds:n,searchText:p},success:function(u){b=0;e=p;jQuery("#content").html("");$("body,html").animate({scrollTop:0},100);if(u.reportList.rows.length==0){var r=[];var v=n.split(",");if(v!=""){jQuery(v).each(function(A,y){var z=jQuery("label[value='"+y+"']").find("strong").html();if(A==0){z=f.getMessage("report.label.noReportLabel")+z}r.push(z)})}if(p!=""){r.push(f.getMessage("report.label.noReportTxt")+p)}if(!jQuery("#firstbutton").hasClass("clickedButton")){var t=r.length==0?"":f.getMessage("report.label.noReportAnd");r.push(t+jQuery(".report-panel .search-btn-group .clickedButton").html().replace(/&nbsp;/g,""))}var x="";if(r.length==0){x="<div>!</div><div>"+f.getMessage("report.label.noReport3")+"</div>"}else{x="<div>!</div><div>"+f.getMessage("report.label.noReport1")+'<span style="font-weight:bold;">“'+r+"”</span>"+f.getMessage("report.label.noReport2")+"</div>"}var w=jQuery("<div>",{"class":"noreport-msg",html:x});jQuery("#content").html(w)}jQuery.each(u.reportList.rows,function(z,y){a(y)});jQuery("#page").page("destroy");jQuery("#page").page({total:u.reportList.total,pageSize:g,showJump:true,firstBtnText:"首页",lastBtnText:"尾页",jumpBtnText:"跳转"}).on("pageClicked",function(z,y){b=y;d(y,m,n)}).on("jumpClicked",function(z,y){b=y;d(y,m,n)});var q=jQuery(".page").width();var s=Number(jQuery(".m-pagination-page").width())+Number(jQuery(".m-pagination-jump").width());jQuery(".m-pagination-page").css("margin-left",(q-s)/2+"px");jQuery("#loadingbar2").css("width","99.5%").delay(200).fadeOut(400,function(){$(this).remove()})},error:function(q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"异常",message:"查询报表异常，请稍后再试 ！"})}})}var i=(window.screen.width*0.21-30)/2;function a(p){var I=jQuery("<div>",{"class":"thumbnail effect",reportId:p.reportId,appType:p.appType});for(var y=0;y<h.length;y++){if(h[y].reportId==p.reportId){I.addClass("thumChoose")}}var H=jQuery("<div>",{css:{height:i+"px",background:"url("+p.imgByte+") no-repeat","background-size":"100% auto"},"class":"repImg"});var q=jQuery("<div>",{"class":"txt"});var G=jQuery("<strong>",{html:p.reportName,style:"margin-left:2%",title:p.reportName});var B=jQuery("<div>",{"class":"help-block",html:'<div class="comment">'+f.getMessage("home.label.comment")+"<strong> "+(p.commentCount==null?0:p.commentCount)+" </strong></div>"});var z=p.score;var w=jQuery("<i>",{"class":"fa fa-star-o",});var v=jQuery("<i>",{"class":"fa fa-star-o",});var u=jQuery("<i>",{"class":"fa fa-star-o",});var t=jQuery("<i>",{"class":"fa fa-star-o",});var s=jQuery("<i>",{"class":"fa fa-star-o",});var F=[];F.push(w);F.push(v);F.push(u);F.push(t);F.push(s);if(z.length==1){for(var x=1;x<=z;x++){F[x-1].attr("class","fa fa-star")}}else{for(var x=1;x<=z.substring(0,1);x++){F[x-1].attr("class","fa fa-star")}F[z.substring(0,1)].attr("class","fa fa-star-half-o")}var o=jQuery("<div>",{"class":"stars"});var C='<div class="visit">'+f.getMessage("home.label.visit")+'<strong class="times"> '+p.visitCount+" </strong></div>";var E=jQuery("<hr>",{});var r=jQuery("<div>",{"class":"but"});var m=jQuery("<div>",{"class":"eidtbtn",html:'<i class="fa fa-pencil butFa"></i><span>'+f.getMessage("report.button.edit")+"</span>"});var D=jQuery("<div>",{"class":"delbtn",html:'<i class="fa fa-trash-o butFa"></i><span>'+f.getMessage("report.button.delete")+"</span>"});var A=jQuery("<div>",{"class":"sharebtn",html:'<i class="fa fa-share butFa"></i><span>'+f.getMessage("report.button.share")+"</span>"});r.append(m).append(D).append(A);o.append(F);B.append(o).append(C);if("1"==p.appType){q.append(G).append("<div class='help-block'>").find(".help-block").append(C).find(".visit").css("textAlign","left")}else{q.append(G).append(B)}var n=jQuery("<div>",{"class":"choose"});I.append(H).append(q).append(E).append(r).append(n);jQuery("#content").append(I)}});