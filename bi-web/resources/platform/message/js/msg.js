define(["sabace","layout","mymessage"],function(a,c,b){var d={};d.model={fist:true,checkIndex:"",isHaveMsg:true,allSelectFlag:false};d.view={getMsgByPram:function(e){return a.ajax({url:webpath+"/platform/msg/get-msg",data:e})},getMsg:function(f){var g=jQuery(".msg-leve-panel .clickClass").attr("pro");if(g==undefined){g="all"}var e={rows:jQuery(".ui-layout-west .pagination-page-list :selected").val(),page:f,type:g};if(g=="all"){e.msgLevel=""}else{if(g=="new"){e.readState=0}else{if(g=="level1"){e.msgLevel=1}else{if(g=="level2"){e.msgLevel=2}else{if(g=="level3"){e.msgLevel=3}}}}}d.view.getMsgByPram(e).done(function(h){var j=jQuery(".ui-layout-north .msg-leve-panel");if(h.levelInfo==null||h.levelInfo.allCount==0){d.model.isHaveMsg=false;jQuery(".ui-layout-west,.ui-layout-center,.ui-layout-resizer-west").hide();jQuery("#msgcontent .noMsg").show();jQuery(".msg-button-panel button").prop("disabled","disabled").css("cursor","not-allowed")}else{d.model.isHaveMsg=true;jQuery(".ui-layout-west,.ui-layout-center,.ui-layout-resizer-west").show();jQuery("#msgcontent .noMsg").hide();jQuery(".msg-button-panel button").removeAttr("disabled").css("cursor","pointer")}var j=jQuery(".ui-layout-north .msg-leve-panel");j.html("");if(h.levelInfo==null||h.levelInfo.allCount==0){j.append('<div><div class="msg-level no-read"></div> <span>'+a.getMessage("msg.label.new")+'(<span class="noreadCount">0</span>)</span></div>')}else{j.append('<div pro="all"><span class="all">'+a.getMessage("msg.label.all")+"("+h.levelInfo.allCount+")</span></div>");if(h.levelInfo.noReadCount!=0){j.append('<div pro="new"><div class="msg-level no-read"></div> <span>'+a.getMessage("msg.label.new")+'(<span class="noreadCount">'+h.levelInfo.noReadCount+"</span>)</span></div>")}if(h.levelInfo.level1Count!=0){j.append('<div pro="level1"><div class="msg-level level-1"></div> <span>'+a.getMessage("msg.label.ordinary")+"("+h.levelInfo.level1Count+")</span></div>")}if(h.levelInfo.level2Count!=0){j.append('<div pro="level2"><div class="msg-level level-2"></div> <span>'+a.getMessage("msg.label.important")+"("+h.levelInfo.level2Count+")</span></div>")}if(h.levelInfo.level3Count!=0){j.append('<div pro="level3"><div class="msg-level level-3"></div> <span>'+a.getMessage("msg.label.urgent")+"("+h.levelInfo.level3Count+")</span></div>")}}jQuery(".msg-leve-panel>div[pro="+h.type+"]").addClass("clickClass theme-background theme-border-color");if(h.msgList.rows.length!=0){jQuery(".ui-layout-west .totalPages").html(h.msgList.totalPages);jQuery(".ui-layout-west .pageNum").html(h.msgList.page);var i=jQuery(".ui-layout-west .msglist");i.animate({scrollTop:0},100).html("");jQuery.each(h.msgList.rows,function(m,l){var r=jQuery("<div>",{"class":"list-group-item "+(l.readState=="0"?"noread":"hasread"),pro:l.msgId});var q=jQuery("<div>",{"class":"msg-left-level",html:(l.readState=="0"?'<div class="msg-level no-read "></div>':"")+'<div class="msg-level level-'+l.msgLevel+'"></div>'});var k=jQuery("<div>",{"class":"msg-left-img",html:'<img src="'+webpath+"/platform/readUserImg/"+funcId+"?t="+new Date()+"&userImgId="+l.sendUserId+'" />'});var p=jQuery("<div>",{"class":"msg-left-info",html:'<div class="userName">'+l.sendUserName+'</div><div class="title">'+l.msgTitle+"</div>"});var o=jQuery("<div>",{"class":"msg-left-time",html:a.date.getDateDiff(l.sendTime),pro:l.sendTime});var n=jQuery("<div>",{"class":"msg-left-content",html:l.msgContent});r.append(q).append(k).append(p).append(o).append(n);i.append(r)});if(d.model.allSelectFlag){i.find(">div").addClass("allSelected theme-background-deep")}jQuery(".ui-layout-west .icon-btn div").removeClass("disabled-btn");if(h.msgList.page==1){jQuery(".ui-layout-west .first-btn,.ui-layout-west .prev-btn").addClass("disabled-btn")}if(h.msgList.page==h.msgList.totalPages){jQuery(".ui-layout-west .next-btn,.ui-layout-west .last-btn").addClass("disabled-btn")}if(d.model.fist==true){d.model.fist=false;jQuery(".msglist :first").trigger("click")}}else{if(h.levelInfo!=null&&h.levelInfo.allCount!=0){d.view.getMsg(1)}}jQuery("#msgcontent").css("visibility","visible")})}};d.controller={init:function(){jQuery("#msgcontent").layout({closable:false,north__size:40,west__size:300,north__spacing_open:-1,spacing_open:2,resizerDragOpacity:0.2,onresizeall_end:function(){if(!d.model.isHaveMsg){jQuery(".ui-layout-resizer").hide()}else{jQuery(".ui-layout-resizer").show()}jQuery(".msglist").height(jQuery(".ui-layout-west").height()-31).niceScroll()},onresize_end:function(){var f=jQuery(".ui-layout-west");if(f.width()<=300){f.css("width","300px");jQuery(".ui-layout-resizer").css("left","300px")}},center:{minWidth:300}});jQuery(".ui-layout-west,.ui-layout-center,.ui-layout-resizer-west").hide();jQuery(".msglist").height(jQuery(".ui-layout-west").height()-31).niceScroll();d.view.getMsg(1);jQuery(".ui-layout-west .first-btn").parent().bind("click",function(){if(jQuery(this).find(".first-btn").hasClass("disabled-btn")){return}d.view.getMsg(1)});jQuery(".ui-layout-west .prev-btn").parent().bind("click",function(){if(jQuery(this).find(".prev-btn").hasClass("disabled-btn")){return}d.view.getMsg(jQuery(".ui-layout-west .pageNum").html()-1)});jQuery(".ui-layout-west .next-btn").parent().bind("click",function(){if(jQuery(this).find(".next-btn").hasClass("disabled-btn")){return}d.view.getMsg(jQuery(".ui-layout-west .pageNum").html()-(-1))});jQuery(".ui-layout-west .last-btn").parent().bind("click",function(){if(jQuery(this).find(".last-btn").hasClass("disabled-btn")){return}d.view.getMsg(jQuery(".ui-layout-west .totalPages").html())});jQuery(".ui-layout-west .pagination-page-list").bind("change",function(){d.view.getMsg(1)});var e=false;jQuery(".msg-button-panel .allSelect").bind("click",function(){e=!e;d.model.allSelectFlag=e;if(e==false){jQuery(this).html('<span class="glyphicon glyphicon-tags"></span>'+a.getMessage("msg.button.open"));jQuery(".ui-layout-west .msglist .list-group-item").removeClass("singleSelect theme-background").removeClass("allSelected theme-background-deep")}else{jQuery(this).html('<span class="glyphicon glyphicon-tags"></span>'+a.getMessage("msg.button.close"));jQuery(".ui-layout-west .msglist .list-group-item").removeClass("singleSelect theme-background").addClass("allSelected theme-background-deep")}});a.interval(function(){if(!e){d.view.getMsg(jQuery(".pageNum").html())}},30000);jQuery(".msg-leve-panel").on("click",">div",function(){var f=jQuery(this);f.addClass("clickClass theme-background theme-border-color");f.siblings().removeClass("clickClass theme-background theme-border-color");d.view.getMsg(1)});jQuery(".msg-button-panel :nth-child(2)").bind("click",function(){var g=jQuery(".singleSelect,.allSelected");var f=[];jQuery.each(g,function(j,h){var k=jQuery(h);f.push(k.attr("pro"));k.removeClass("noread").removeClass("singleSelect theme-background").removeClass("allSelected theme-background-deep");k.find(".no-read").remove();if(!k.hasClass("hasread")){k.addClass("hasread")}});if(e){jQuery(".msg-button-panel .allSelect").trigger("click")}a.ajax({url:a.handleUrlParam("/platform/msg/set-read-state"),data:{msgIdArr:f.toString()},success:function(h){},error:function(h){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:a.getMessage("top.label.fail"),message:h.responseText})}})});jQuery(".msg-button-panel :nth-child(3)").bind("click",function(){var f=jQuery(".singleSelect,.allSelected");if(f.size()==0){bi.dialog.show({title:a.getMessage("home.label.TipBox"),message:a.getMessage("msg.label.deleteTip"),cssClass:"register-dialog",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:a.getMessage("home.button.sure"),action:function(g){g.close()}}]});return}bi.dialog.confirm({title:a.getMessage("home.label.confirmBox"),message:a.getMessage("msg.label.deleteMsg"),callback:function(g){if(g){var h=[];jQuery.each(f,function(k,j){var l=jQuery(j);h.push(l.attr("pro"))});a.ajax({url:a.handleUrlParam("/platform/msg/delete-msg"),data:{msgIdArr:h.toString()},success:function(i){d.view.getMsg(jQuery(".pageNum").html())},error:function(i){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:a.getMessage("top.label.fail"),message:i.responseText})}})}}})});jQuery(".ui-layout-west .msglist").on("click",".list-group-item",function(m){var p=jQuery(this);if(!m.shiftKey){if(!e){d.model.checkIndex=p.index();jQuery(".ui-layout-center").html("");var f=p.find(".msg-left-level :last").clone();var q=p.find(".msg-left-info .title").html();jQuery(".ui-layout-center").append('<div class="center-title"></div>');jQuery(".ui-layout-center .center-title").html(f).append(q);var l=p.find(".msg-left-info .userName").html();var g=p.find(".msg-left-time").attr("pro");jQuery(".ui-layout-center").append('<div class="center-time"></div>');jQuery(".ui-layout-center .center-time").html("<div>"+a.getMessage("msg.label.sender")+l+"</div>").append("<div>"+g+"</div>");var n=p.find(".msg-left-content").html();jQuery(".ui-layout-center").append('<div class="center-content"></div>');jQuery(".ui-layout-center .center-content").html(n);if(p.hasClass("noread")){a.ajax({url:a.handleUrlParam("/platform/msg/set-read-state"),data:{msgIdArr:p.attr("pro")},success:function(i){p.removeClass("noread").addClass("hasread");p.find(".no-read").remove();jQuery(".noreadCount").html(jQuery(".noreadCount").html()-1);require(["top"],function(t){t.getMsg()})},error:function(i){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:a.getMessage("top.label.fail"),message:i.responseText})}})}p.siblings().removeClass("singleSelect theme-background");p.addClass("singleSelect theme-background")}else{p.toggleClass("allSelected theme-background-deep")}}else{if(!e){var k=jQuery(".singleSelect");if(k.length>0){var r=d.model.checkIndex;var j=p.index();if(r>j){var s=j;j=r;r=s}var o=jQuery(".ui-layout-west .msglist .list-group-item");o.removeClass("singleSelect theme-background");for(var h=r;h<=j;h++){o.eq(h).addClass("singleSelect theme-background")}}return}}});jQuery(".ui-layout-north .msg-leve-panel").on("mouseover",'>div:not(".clickClass")',function(){jQuery("this").siblings().removeClass("theme-background theme-border-color");jQuery(this).addClass("theme-background theme-border-color")}).on("mouseleave",'>div:not(".clickClass")',function(){jQuery(this).removeClass("theme-background theme-border-color")})}};return d.controller});