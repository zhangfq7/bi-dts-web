define(["sabace","navi/message"],function(g,k){$(function(){c();e();$("#search").on("click",b);jQuery("#add").on("click",h);jQuery("#edit").on("click",j);jQuery("#delete").on("click",a);$(window).resize(function(){$("#naviTree").setGridWidth($("#naviListPanel").width()-20)})});function c(){var p=$("#level1").val();var n=$("#level2").val();var m=$("#level3").val();var o=$("#creater").val();var l={level1:p,level2:n,level3:m,creater:encodeURI(o)};$("#naviTree").jqGrid({url:g.handleUrlParam("/platform/resmanage/navi/search"),styleUI:"Bootstrap",postData:l,regional:"cn",loadtext:g.getMessage("navi.msg.loading"),gridComplete:function(){$("#naviTree tbody tr.jqgrow").each(function(){var q=$(this);var r=q.find('td[aria-describedby="naviTree_level"]').html();if(r==3){q.find('td[aria-describedby="naviTree_"] input[type="checkbox"]').hide()}else{q.find('td[aria-describedby="naviTree_"] input[type="checkbox"]').on("click",f)}})},onSelectRow:function(q){var s=$("#naviTree").jqGrid("getRowData",q);if(s.level==3){return}var r=$("tr[id="+q+"]>td>input").prop("checked");$("input[type=checkbox]").prop("checked",false);$("tr[id="+q+"]>td>input").prop("checked",!r);if(r){$("#naviTree").trigger("reloadGrid")}if("false"==s.optFlag){$("#edit").addClass("disabled");$("#delete").addClass("disabled")}else{$("#edit").removeClass("disabled");$("#delete").removeClass("disabled")}},beforeSelectRow:function(q){},loadComplete:function(){$(".tree-wrap").width(function(){return $(this).width()+14})},colModel:[{name:"",index:"navi_id",formatter:"checkbox",formatoptions:{disabled:false},width:30},{name:"navi_id",index:"navi_id",sorttype:"int",key:true,hidden:true},{name:"navi_name",index:"naviName",sorttype:"string",label:g.getMessage("navi.label.navi.Name"),width:150,sortable:false},{name:"description",index:"description",sorttype:"numeric",label:g.getMessage("navi.label.navi.Dec"),align:"left",width:150,sortable:false},{name:"user_name",index:"user_name",sorttype:"numeric",label:g.getMessage("navi.label.navi.Creater"),align:"left",width:90,sortable:false},{name:"createTime",index:"createTime",sorttype:"numeric",label:g.getMessage("navi.label.navi.Time"),align:"left",width:120,sortable:false},{name:"boss_id",hidden:true},{name:"optFlag",hidden:true},{name:"level",hidden:true},{name:"naviCode",hidden:true}],forceFit:true,height:"auto",autowidth:true,sortname:"navi_id",scrollrows:true,treeGrid:true,ExpandColumn:"navi_name",treedatatype:"json",treeGridModel:"adjacency",treeReader:{parent_id_field:"boss_id",level_field:"level",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},columnsResize:true,sortorder:"asc",datatype:"json",pager:"#pager",})}function f(){var l=$(this).prop("checked");$("input[type=checkbox]").prop("checked",false);$(this).prop("checked",!l);$("#naviTree").jqGrid("setSelection",$(this).parent().next().text())}function e(){$("#level1").append('<option value="">&nbsp</option>');$("#level2").append('<option value="">&nbsp</option>');$("#level1").chosen({disable_search:true});$("#level2").chosen({disable_search:true});i("1","",function(n){if(n==null||n.length==0){$("#level1").empty();$("#level1").append('<option value ="">无</option>');$("#level1").trigger("chosen:updated");return}for(var l=0;l<n.length;l++){var m=n[l];$("#level1").append('<option value ="'+m.naviId+'">'+m.naviName+"</option>")}$("#level1").bind("change",function(){var o=$("#level1").val();if(o!=""){d(o)}else{$("#level2").empty();$("#level2").append('<option value="">&nbsp</option>');$("#level2").trigger("chosen:updated")}});$("#level1").trigger("chosen:updated")})}function d(l){$("#level2").empty();$("#level2").append('<option value="">&nbsp</option>');$("#level2").trigger("chosen:updated");i("2",l,function(o){if(o==null||o.length==0){$("#level2").empty();$("#level2").append('<option value ="">无</option>');$("#level2").trigger("chosen:updated");return}for(var m=0;m<o.length;m++){var n=o[m];$("#level2").append('<option value ="'+n.naviId+'">'+n.naviName+"</option>")}$("#level2").trigger("chosen:updated")})}function i(n,l,m){g.ajax({url:g.handleUrlParam("/platform/resmanage/navi/level"),data:{level:n,parentNaviId:l},success:function(o){m(o)},error:function(o){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:g.getMessage("navi.msg.prompt"),message:o.responseText||g.getMessage("navi.label.level.error")})}})}function b(){var p=$("#level1").val();var n=$("#level2").val();var m=$("#level3").val();var o=$("#creater").val();var l={level1:p,level2:n,level3:m,creater:encodeURI(o)};$("#naviTree").clearGridData();$("#naviTree").jqGrid("setGridParam",{postData:l}).trigger("reloadGrid")}function h(){$("#parentNaviName").attr("value","");$("#naviName").attr("value","");$("#description").html("");var r=$("#naviTree").jqGrid("getGridParam","selrow");var m=$("#naviTree").jqGrid("getRowData",r);var p=m.navi_name;var o=m.navi_id;var q=m.level||0;var n=$("#"+r).find("input[type='checkbox']").prop("checked");if(n&&q>1){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:g.getMessage("navi.label.tip"),message:g.getMessage("navi.msg.add.notallowed")});return}$("#level1addMenu").hide();$("#level1CreateMenu").show();if(!n){o=undefined;p="最上级导航"}if(g.IsEmpty(p)){p="最上级导航"}$("#parentNaviName").attr("value",p);var l=bi.dialog.show({title:g.getMessage("navi.label.addNavi"),message:$("#add-page").outerHTML(),nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,cssClass:"navi-add-dialog",buttons:[{label:g.getMessage("navi.button.cancel"),action:function(s){s.close()}},{label:g.getMessage("navi.button.save"),cssClass:"btn-info",action:function(s){var t=l.getModalBody().find("#add-page").validationEngine("validate");if(!t){return false}bi.dialog.confirm({title:g.getMessage("navi.msg.confirm"),message:g.getMessage("navi.msg.saveConfirm"),callback:function(v){if(!v){return}var w=o;var y=l.getModalBody().find("#naviName").val();var x=l.getModalBody().find("#description").val();var u={parentNaviId:w,naviName:y,naviDesc:x,naviLevel:parseInt(q)+1};g.ajax({data:u,loading:{title:g.getMessage("navi.label.tip"),text:g.getMessage("navi.label.pleaseWait")},url:g.handleUrlParam("/platform/resmanage/navi/add-navi"),success:function(z){if(z.isSame==true){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:g.getMessage("navi.msg.prompt"),message:z.responseText||g.getMessage("navi.msg.same")});return}l.close();window.location.href=g.handleUrlParam("/platform/resmanage/navi/list")},error:function(z){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:g.getMessage("navi.label.tip"),message:z.responseText||g.getMessage("navi.msg.save.exception")})}})}})}}]});l.getModalBody().find("#add-page").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"topRight",showOneMessage:true})}function j(){if(jQuery("#edit").hasClass("disabled")){return}jQuery("#parentNaviName").attr("value","");jQuery("#naviName").attr("value","");jQuery("#description").html("");var n=$("#naviTree").jqGrid("getGridParam","selrow");var r=$("#naviTree").jqGrid("getRowData",n);var o=r.navi_name;var s=r.navi_id;var t=r.description;var p=r.boss_id;var m=r.level||0;var q=r.naviCode;if(g.IsEmpty(p)){var u="最上级字段"}else{var r=$("#naviTree").jqGrid("getRowData",p);var u=r.navi_name}var l=jQuery("#"+n).find("input[type='checkbox']").prop("checked");if(g.IsEmpty(n)||!l){bi.dialog.show({type:"type-warning",title:g.getMessage("navi.msg.prompt"),message:g.getMessage("navi.msg.empty"),});return}$("#level1addMenu").show();$("#level1CreateMenu").hide();jQuery("#parentNaviName").attr("value",u);jQuery("#naviName").attr("value",o);jQuery("#description").html(t);$("#level1add").empty();if(m==1){$("#level1add").append('<option value ="">最上级导航</option>');$("#level1add").attr("disabled","disabled")}else{$("#level1add").attr("disabled",false)}i("1","",function(y){if(y==null||y.length==0){$("#level1add").empty();$("#level1add").append('<option value ="">最上级导航</option>');return}if(m!=1){for(var w=0;w<y.length;w++){var x=y[w];$("#level1add").append('<option value ="'+x.naviId+'">'+x.naviName+"</option>")}}if(m==2){$("#level1add").find("option[value='"+q.substring(0,6)+"']").attr("selected",true)}var v=bi.dialog.show({title:g.getMessage("navi.label.editNavi"),message:$("#add-page").outerHTML(),nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,cssClass:"navi-add-dialog",onshown:function(z){$(".modal .modal-dialog .modal-content .modal-body select.form-control").chosen({disable_search:true})},buttons:[{label:g.getMessage("navi.button.cancel"),action:function(z){z.close()}},{label:g.getMessage("navi.button.save"),cssClass:"btn-info",action:function(z){var A=v.getModalBody().find("#add-page").validationEngine("validate");if(!A){return false}bi.dialog.confirm({title:g.getMessage("navi.msg.confirm"),message:g.getMessage("navi.msg.saveConfirm"),callback:function(C){if(!C){return}var F=v.getModalBody().find("#naviName").val();var E=v.getModalBody().find("#description").val();var D=v.getModalBody().find("#level1add").val();if(D==q.substring(0,6)){D=""}var B={naviId:s,naviCode:q,naviName:F,naviDesc:E,naviLevel:m,parentNaviId:D};g.ajax({loading:{title:g.getMessage("navi.label.tip"),text:g.getMessage("navi.label.pleaseWait")},url:g.handleUrlParam("/platform/resmanage/navi/edit-navi"),data:B,success:function(G){if(G.isSame==true){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:g.getMessage("navi.msg.prompt"),message:G.responseText||g.getMessage("navi.msg.same")});return}v.close();window.location.href=g.handleUrlParam("/platform/resmanage/navi/list")},error:function(G){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:g.getMessage("navi.label.tip"),message:G.responseText||g.getMessage("navi.msg.save.exception")})}})}})}}]});v.getModalBody().find("#add-page").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"topRight",showOneMessage:true})})}function a(){if(jQuery("#delete").hasClass("disabled")){return}var r=$("#naviTree").jqGrid("getGridParam","selrow");var n=$("#naviTree").jqGrid("getRowData",r);var p=n.navi_id;var m=n.boss_id;var l=n.naviCode;var q=n.level||0;var o=jQuery("#"+r).find("input[type='checkbox']").prop("checked");if(g.IsEmpty(r)||!o){bi.dialog.show({type:"type-warning",title:g.getMessage("navi.msg.prompt"),message:g.getMessage("navi.msg.choose.navi"),});return}else{bi.dialog.confirm({title:g.getMessage("navi.msg.prompt"),message:g.getMessage("navi.msg.confirm.delete"),callback:function(s){if(s){g.ajax({type:"post",cache:false,dataType:"json",data:{naviId:p,naviCode:l,naviLevel:q},url:g.handleUrlParam("/platform/resmanage/navi/delete-navi"),success:function(t){if(t.isHasChild==true){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:g.getMessage("navi.msg.prompt"),message:t.responseText||g.getMessage("navi.msg.del.haschild")});return}bi.dialog.show({title:g.getMessage("navi.msg.prompt"),message:t.responseText||g.getMessage("navi.msg.success")});window.location.href=g.handleUrlParam("/platform/resmanage/navi/list")},error:function(t){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:g.getMessage("navi.msg.prompt"),message:t.responseText||g.getMessage("navi.msg.save.exception")})}})}}})}}});