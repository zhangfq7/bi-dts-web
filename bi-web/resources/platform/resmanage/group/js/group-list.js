define(["sabace","group/message"],function(d,g){jQuery(function(){e();jQuery("#search").on("click",h);jQuery("#add").on("click",f);jQuery("#edit").on("click",c);jQuery("#delete").on("click",b);jQuery(window).resize(function(){$("#groupTree").setGridWidth($("#groupListPanel").width()-20)})});function e(){var k=jQuery("#listGroupName").val();var i=jQuery("#listDescription").val();var j=jQuery("#creater").val();postData={groupName:encodeURI(k),description:encodeURI(i),creater:j};jQuery("#groupTree").jqGrid({url:d.handleUrlParam("/platform/resmanage/group/search"),styleUI:"Bootstrap",postData:postData,regional:"cn",loadtext:d.getMessage("group.msg.loading"),gridComplete:function(){jQuery("input[type=checkbox]").on("click",a)},onSelectRow:function(l){var m=jQuery("tr[id="+l+"]>td>input").prop("checked");jQuery("input[type=checkbox]").prop("checked",false);jQuery("tr[id="+l+"]>td>input").prop("checked",!m);if(m){$("#groupTree").trigger("reloadGrid")}var n=$("#groupTree").jqGrid("getRowData",l);if("false"==n.optFlag){jQuery("#edit").addClass("disabled");jQuery("#delete").addClass("disabled")}else{jQuery("#edit").removeClass("disabled");jQuery("#delete").removeClass("disabled")}},beforeSelectRow:function(l){},loadComplete:function(){$(".tree-wrap").width(function(){return $(this).width()+14})},colModel:[{name:"",index:"group_id",formatter:"checkbox",formatoptions:{disabled:false},width:30},{name:"group_id",index:"group_id",sorttype:"int",key:true,hidden:true},{name:"group_name",index:"groupName",sorttype:"string",label:d.getMessage("group.label.group.Name"),width:150,sortable:false},{name:"description",index:"description",sorttype:"numeric",label:d.getMessage("group.label.group.Dec"),align:"left",width:150,sortable:false},{name:"user_name",index:"user_name",sorttype:"numeric",label:d.getMessage("group.label.group.Creater"),align:"left",width:90,sortable:false},{name:"createTime",index:"createTime",sorttype:"numeric",label:d.getMessage("group.label.group.Time"),align:"left",width:120,sortable:false},{name:"boss_id",hidden:true},{name:"optFlag",hidden:true}],forceFit:true,height:"auto",autowidth:true,sortname:"group_id",scrollrows:true,treeGrid:true,ExpandColumn:"group_name",treedatatype:"json",treeGridModel:"adjacency",treeReader:{parent_id_field:"boss_id",level_field:"level",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},columnsResize:true,sortorder:"asc",datatype:"json",pager:"#pager",})}function f(){jQuery("#parentGroupName").attr("value","");jQuery("#groupName").attr("value","");jQuery("#description").html("");var n=$("#groupTree").jqGrid("getGridParam","selrow");var k=$("#groupTree").jqGrid("getRowData",n);var m=k.group_name;var j=k.group_id;var l=jQuery("#"+n).find("input[type='checkbox']").prop("checked");if(!l){j=undefined;m="最上级指标"}if(d.IsEmpty(m)){m="最上级指标"}jQuery("#parentGroupName").attr("value",m);var i=bi.dialog.show({title:d.getMessage("group.label.addGroup"),message:jQuery("#add-page").outerHTML(),nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,cssClass:"group-add-dialog",buttons:[{label:d.getMessage("group.button.cancel"),action:function(o){o.close()}},{label:d.getMessage("group.button.save"),cssClass:"btn-info",action:function(o){var p=i.getModalBody().find("#add-page").validationEngine("validate");if(!p){return false}bi.dialog.confirm({title:d.getMessage("group.msg.confirm"),message:d.getMessage("group.msg.saveConfirm"),callback:function(r){if(!r){return}var s=j;var u=i.getModalBody().find("#groupName").val();var t=i.getModalBody().find("#description").val();var q={parentGroupId:s,groupName:u,groupDesc:t,};d.ajax({data:q,loading:{title:d.getMessage("group.label.tip"),text:d.getMessage("group.label.pleaseWait")},url:d.handleUrlParam("/platform/resmanage/group/add-group"),success:function(v){if(!v.flag){bi.dialog.show({type:bi.dialog.TYPE_WARNING,title:d.getMessage("group.label.warn"),message:d.getMessage("group.msg.group.name.Repetition")})}jQuery("#groupTree").trigger("reloadGrid");i.close()},error:function(v){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:d.getMessage("group.label.tip"),message:v.responseText||d.getMessage("group.msg.save.exception")})}})}})}}]});i.getModalBody().find("#add-page").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true})}function c(){if(jQuery("#edit").hasClass("disabled")){return}jQuery("#parentGroupName").attr("value","");jQuery("#groupName").attr("value","");jQuery("#description").html("");var j=$("#groupTree").jqGrid("getGridParam","selrow");var m=$("#groupTree").jqGrid("getRowData",j);var q=m.group_name;var k=m.group_id;var l=m.description;var p=m.boss_id;if(d.IsEmpty(p)){var o="最上级字段"}else{var m=$("#groupTree").jqGrid("getRowData",p);var o=m.group_name}var i=jQuery("#"+j).find("input[type='checkbox']").prop("checked");if(d.IsEmpty(j)||!i){bi.dialog.show({type:"type-warning",title:d.getMessage("group.msg.prompt"),message:d.getMessage("group.msg.empty"),});return}jQuery("#parentGroupName").attr("value",o);jQuery("#groupName").attr("value",q);jQuery("#description").html(l);var n=bi.dialog.show({title:d.getMessage("group.label.editGroup"),message:jQuery("#add-page").outerHTML(),nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,cssClass:"group-add-dialog",buttons:[{label:d.getMessage("group.button.cancel"),action:function(r){r.close()}},{label:d.getMessage("group.button.save"),cssClass:"btn-info",action:function(r){var s=n.getModalBody().find("#add-page").validationEngine("validate");if(!s){return false}bi.dialog.confirm({title:d.getMessage("group.msg.confirm"),message:d.getMessage("group.msg.saveConfirm"),callback:function(u){if(!u){return}var w=n.getModalBody().find("#groupName").val();var v=n.getModalBody().find("#description").val();var t={groupId:k,groupName:w,groupDesc:v,parentGroupId:p};d.ajax({loading:{title:d.getMessage("group.label.tip"),text:d.getMessage("group.label.pleaseWait")},url:d.handleUrlParam("/platform/resmanage/group/edit-group"),data:t,success:function(x){if(!x.flag){bi.dialog.show({type:bi.dialog.TYPE_WARNING,title:d.getMessage("group.label.warn"),message:d.getMessage("group.msg.group.edit.name.Repetition")})}n.close();jQuery("#groupTree").trigger("reloadGrid")},error:function(x){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:d.getMessage("group.label.tip"),message:x.responseText||d.getMessage("group.msg.save.exception")})}})}})}}]});n.getModalBody().find("#add-page").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"topRight",showOneMessage:true})}function b(){if(jQuery("#delete").hasClass("disabled")){return}var m=$("#groupTree").jqGrid("getGridParam","selrow");var k=$("#groupTree").jqGrid("getRowData",m);var j=k.group_id;var i=k.boss_id;var l=jQuery("#"+m).find("input[type='checkbox']").prop("checked");if(d.IsEmpty(m)||!l){bi.dialog.show({type:"type-warning",title:d.getMessage("group.msg.prompt"),message:d.getMessage("group.msg.choose.group"),});return}else{bi.dialog.confirm({title:d.getMessage("group.msg.prompt"),message:d.getMessage("group.msg.confirm.delete"),callback:function(n){if(n){d.ajax({type:"post",cache:false,dataType:"json",data:{groupId:j},url:d.handleUrlParam("/platform/resmanage/group/delete-group"),success:function(o){jQuery("#groupTree").trigger("reloadGrid");bi.dialog.show({title:d.getMessage("group.msg.prompt"),message:o.responseText||d.getMessage("group.msg.success")})},error:function(o){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:d.getMessage("group.msg.prompt"),message:o.responseText||d.getMessage("group.msg.save.exception")})}})}}})}}function h(){var k=jQuery("#listGroupName").val();var i=jQuery("#listDescription").val();var j=jQuery("#creater").val();postData={groupName:encodeURI(k),description:encodeURI(i),creater:encodeURI(j)};jQuery("#groupTree").clearGridData();jQuery("#groupTree").jqGrid("setGridParam",{postData:postData}).trigger("reloadGrid")}function a(){var i=jQuery(this).prop("checked");jQuery("input[type=checkbox]").prop("checked",false);jQuery(this).prop("checked",!i);jQuery("#groupTree").jqGrid("setSelection",jQuery(this).parent().next().text())}});