define(["sabace"],function(c){var e={};var h;var b;jQuery(function(){a()});function a(){c.ajax({url:c.handleUrlParam("/platform/resmanage/data/query-data-common"),data:{dataId:dataId,type:type},success:function(n){if(n.resFlag=="success"){f(n)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:c.getMessage("data.db.title.tips"),message:n.msg});return false}},error:function(n){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:c.getMessage("data.db.title.tips"),message:c.getMessage("data.view.message.dataError")})}});jQuery("#downFileButton").on("click",function(){bi.dialog.confirm({title:"提示",message:"确定下载该数据？",callback:function(n){if(n){c.ajax({type:"post",cache:false,dataType:"json",url:c.handleUrlParam("/platform/resmanage/db/down-file"),data:{dataId:dataId,fileName:h,downType:jQuery("#downType").val()},loading:{title:"提示",text:"正在生成文件，请稍后..."},success:function(o){b=bi.dialog.show({title:"提示",message:"文件正在生成中，请稍候！",nl2br:false,closable:false,closeByBackdrop:false,closeByKeyboard:false});l(o)},error:function(o){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:c.getMessage("user.label.error"),message:o.responseText||c.getMessage("user.label.delError")})}})}}})});function m(n){c.ajax({type:"post",cache:false,dataType:"json",url:c.handleUrlParam("/platform/resmanage/db/ajax-query-log"),data:{logId:n},success:function(o){o=o[0];if("1"==o.fileState){bi.dialog.show({title:"提示",message:"是否转离线下载！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"是",cssClass:"btn-info",action:function(p){b.close();j(n);p.close()}},{label:"否",cssClass:"btn-info",action:function(p){timer1=setInterval(function(){k(n)},5000);p.close()}}]})}else{if("2"==o.fileState){bi.dialog.show({title:"提示",message:"文件生成成功,请点击确认进行下载！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(p){b.close();i(o);p.close()}}]})}else{if("4"==o.fileState){bi.dialog.show({title:"提示",message:"文件生成失败！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(p){b.close();p.close()}}]})}else{if("7"==o.fileState){bi.dialog.show({title:"提示",message:"文件已删除！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(p){b.close();p.close()}}]})}}}}},error:function(o){}})}function k(n){c.ajax({type:"post",cache:false,dataType:"json",url:c.handleUrlParam("/platform/resmanage/db/ajax-query-log"),data:{logId:n},success:function(o){o=o[0];if("2"==o.fileState){bi.dialog.show({title:"提示",message:"文件生成成功，请点击确认进行下载！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(p){b.close();i(o);p.close()}}]});clearInterval(timer1)}else{if("4"==o.fileState){bi.dialog.show({title:"提示",message:"文件生成失败！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(p){b.close();p.close()}}]})}else{if("7"==o.fileState){bi.dialog.show({title:"提示",message:"文件已删除！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(p){b.close();p.close()}}]})}}}},error:function(o){}})}function j(n){c.ajax({type:"post",cache:false,dataType:"json",url:c.handleUrlParam("/platform/resmanage/db/modify-download"),data:{logId:n,fileName:h},loading:{title:"提示",text:"正在生成文件，请稍后..."},success:function(o){bi.dialog.show({title:"提示",message:"文件已转离线，请到文件下载页面查询！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(p){p.close()}}]})},error:function(o){}})}function l(n){logId=n.logId;interval=setTimeout(function(){m(n.logId)},5000)}function i(n){jQuery("#downData").remove();jQuery("<form>",{id:"downData",method:"post",action:c.handleUrlParam("/platform/resmanage/db/download-file"),target:"_self",html:"<input name='fileName' type='hidden' value='"+h+"'/><input name='logId' type='hidden' value='"+n.logId+"'/>"}).appendTo("body");jQuery("#downData").submit()}}function g(){var q=[];var n=e.colModelList;var m=n.length;var l=jQuery(".data-grid-info").width()-68;var k=180;if(m*k<l){k=Math.floor(l/m)}var s=null;var r=null;var p=null;var j={hidden:true,name:"jqGridError"};q.push(j);for(var o=0;o<m;o++){s=n[o].label;r=n[o].name;p=n[o].filter;if(p=="2"){_align="right"}else{_align="left"}q.push({label:s,name:r,align:_align,hlign:"center",sortable:false,width:k})}jQuery("#dataGrid").jqGrid({url:c.handleUrlParam("/platform/resmanage/data/query-column-data"),datatype:"json",styleUI:"Bootstrap",postData:{dataId:dataId,type:type,zsCount:e.zsCount},colModel:q,rownumbers:true,rownumWidth:"60px",shrinkToFit:false,autowidth:true,height:"auto",viewrecords:true,rowNum:10,rowList:[10,20,30],pager:"#dataGridPager",regional:"cn",jsonReader:{records:"total",total:"totalPages"},loadComplete:function(){var t=jQuery(this);var i=t.jqGrid("getRowData");if(i.length==1){var u=i[0];if("true"==u.jqGridError){t.find("#1").remove();jQuery(".ui-jqgrid-bdiv").append('<div class="noResult" style="font-size:12px;height:28px;line-height:35px;text-align:center;">数据还未生成，请稍后再试！</div>')}else{if("noData"==u.jqGridError){t.find("#1").remove();jQuery(".ui-jqgrid-bdiv").append('<div class="noResult" style="font-size:12px;height:28px;line-height:35px;text-align:center;">没有查询到结果数据！</div>')}}}h=$("#dataName").text()}});d();$(window).resize(function(){d()})}function f(j){var i=j.configBean;e.colModelList=j.colModelList;e.zsCount=i.dataNum;if(type=="1"){jQuery("#dataName").html(i.dataName);jQuery("#dataType").html(c.getMessage("data.view.message.file"));jQuery("#dataDesc").html(i.dataDesc);jQuery("#dataNum").html(i.dataNum);jQuery("#adminName").html(i.createName);jQuery("#adminTime").html(i.createTime);jQuery("#lastUpdateTime").html(i.lastUpdateTime)}else{if(type=="2"){jQuery("#dataName").html(i.dataName);jQuery("#dataType").html(c.getMessage("data.view.message.table"));jQuery("#dataDesc").html(i.tableDesc);jQuery("#dbName").html(i.dbName);jQuery("#dataTable").html(i.dataTable);jQuery("#splitType").html(i.splitType);jQuery("#updatePeriod").html(i.updatePeriod);jQuery("#nextUpdateTime").html(i.nextUpdateTime);jQuery("#storageType").html(i.storageType);jQuery("#dataNum").html(i.dataNum);jQuery("#adminName").html(i.createName);jQuery("#adminTime").html(i.createTime);jQuery("#lastUpdateTime").html(i.lastUpdateTime)}else{if(type=="4"){jQuery("#dataType").html("openAPI");jQuery("#serviceName").html(i.serviceName);jQuery("#methodName").html(i.methodName);jQuery("#serviceUrl").html(i.serviceUrl);jQuery("#paramStr").html(i.paramStr);jQuery("#dataDesc").html(i.tableDesc);jQuery("#dataName").html(i.dataTable);jQuery("#updatePeriod").html(i.updatePeriod);jQuery("#nextUpdateTime").html(i.nextUpdateTime);jQuery("#storageType").html(i.storageType);jQuery("#dataNum").html(i.dataNum);jQuery("#adminName").html(i.createName);jQuery("#adminTime").html(i.createTime);jQuery("#lastUpdateTime").html(i.lastUpdateTime)}else{if(type=="5"){jQuery("#dataName").html(i.dataName);jQuery("#dataType").html("数据库直连");jQuery("#dataDesc").html(i.tableDesc);jQuery("#dbName").html(i.dbName);jQuery("#dataTable").html(i.dataTable);jQuery("#tableAlias").html(i.tableAlias);jQuery("#dateFieldId").html(i.dateFieldId);jQuery("#tableType").html(i.tableType);jQuery("#tablesStorage").html(i.tablesStorage);jQuery("#storageField").html(i.storageField);jQuery("#tableTime").html(i.tableTime)}else{if(type=="7"){jQuery("#dataType").html("视图");jQuery("#dbName").html(i.dbName);jQuery("#viewTable").html(i.viewTable);jQuery("#viewJoin").html(i.viewJoin);jQuery("#viewName").html(i.viewName);jQuery("#dataDesc").html(i.viewDesc)}}}}}g()}function d(){jQuery("#dataGrid").setGridWidth(jQuery(".data-grid-info").width()-5)}});