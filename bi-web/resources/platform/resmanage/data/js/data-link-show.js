define(["sabace"],function(d){var f={};var b;var e;var c;var g=$(".name-td").text();var a;f.module={dataId:""};f.view={initresultShowDataGrid:function(o,p){var h=0;for(var m=0;m<p.length;m++){h++}var l=h;var k=jQuery(".data-link-show").width()-45;var j=180;if(l*j<k){j=Math.floor(k/l)}var t=new Array;var r;for(var m=0;m<p.length;m++){r={};r.label=p[m].attrName;r.name=p[m].attrId;r.align="left";r.hlign="left";r.width=j;t.push(r)}jQuery("#downFileButton").on("click",function(){var i=o;bi.dialog.confirm({title:"提示",message:"确定下载该数据？",callback:function(w){if(w){d.ajax({type:"post",cache:false,dataType:"json",url:d.handleUrlParam("/platform/resmanage/db/down-file"),data:{dataId:i,fileName:g,downType:jQuery("#downType").val()},loading:{title:"提示",text:"正在生成文件，请稍后..."},success:function(x){a=bi.dialog.show({title:"提示",message:"文件正在生成，请稍候！",nl2br:false,closable:false,closeByBackdrop:false,closeByKeyboard:false});u(x)},error:function(x){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:d.getMessage("user.label.error"),message:x.responseText||d.getMessage("user.label.delError")})}})}}})});function q(i){d.ajax({type:"post",cache:false,dataType:"json",url:d.handleUrlParam("/platform/resmanage/db/ajax-query-log"),data:{logId:i},success:function(w){w=w[0];if("1"==w.fileState){bi.dialog.show({title:"提示",message:"是否转离线下载！",nl2br:false,closable:false,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"是",cssClass:"btn-info",action:function(x){a.close();v(i);x.close()}},{label:"否",cssClass:"btn-info",action:function(x){e=setInterval(function(){n(i)},5000);x.close()}}]})}else{if("2"==w.fileState){bi.dialog.show({title:"提示",message:"文件生成成功,请点击确认进行下载！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(x){a.close();s(w);x.close()}}]})}else{if("4"==w.fileState){bi.dialog.show({title:"提示",message:"文件生成失败！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(x){a.close();x.close()}}]})}else{if("7"==w.fileState){bi.dialog.show({title:"提示",message:"文件已删除！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(x){a.close();x.close()}}]})}}}}},error:function(w){}})}function n(i){d.ajax({type:"post",cache:false,dataType:"json",url:d.handleUrlParam("/platform/resmanage/db/ajax-query-log"),data:{logId:i},success:function(w){w=w[0];if("2"==w.fileState){bi.dialog.show({title:"提示",message:"文件生成成功，请点击确认进行下载！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(x){a.close();s(w);x.close()}}]});clearInterval(e)}else{if("4"==w.fileState){bi.dialog.show({title:"提示",message:"文件生成失败！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(x){a.close();x.close()}}]})}else{if("7"==w.fileState){bi.dialog.show({title:"提示",message:"文件已删除！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(x){a.close();x.close()}}]})}}}},error:function(w){}})}function v(i){d.ajax({type:"post",cache:false,dataType:"json",url:d.handleUrlParam("/platform/resmanage/db/modify-download"),data:{logId:i,fileName:g},loading:{title:"提示",text:"正在下载，请稍后..."},success:function(w){bi.dialog.show({title:"提示",message:"文件已转离线，请到文件下载页面查询！",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",cssClass:"btn-info",action:function(x){x.close()}}]})},error:function(w){}})}function u(i){c=i.logId;b=setTimeout(function(){q(i.logId)},5000)}function s(i){jQuery("#downData").remove();jQuery("<form>",{id:"downData",method:"post",action:d.handleUrlParam("/platform/resmanage/db/download-file"),target:"_self",html:"<input name='fileName' type='hidden' value='"+g+"'/><input name='logId' type='hidden' value='"+i.logId+"'/>"}).appendTo("body");jQuery("#downData").submit()}jQuery("#resultShowDataGrid").jqGrid({url:d.handleUrlParam("/platform/resmanage/datalink/query-show-result"),datatype:"json",postData:{dataId:o},styleUI:"Bootstrap",colModel:t,height:280,jsonReader:{records:"total",total:"totalPages"},rowNum:10,rownumbers:true,pager:"#jqGridPagerTempShow",regional:"cn",shrinkToFit:false,autowidth:true,rownumWidth:"60px"});f.view.resizeGrid()},initDataResultShow:function(){var h={dataId:f.module.dataId};d.ajax({url:d.handleUrlParam("/platform/resmanage/datalink/query-show-param"),data:h,success:function(i){f.view.initresultShowDataGrid(f.module.dataId,i.selectParamArray);f.view.initDataLinkShow(i.dataLinkBean)},error:function(i){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:d.getMessage("data.db.title.tips"),message:i.responseText||d.getMessage("data.import.message.sysAbnormal")})}})},resizeGrid:function(){jQuery("#resultShowDataGrid").setGridWidth(jQuery(".data-link-show").width()-40)},initDataLinkShow:function(h){jQuery(".link-table .name-td").html(h.dataName);g=$(".name-td").text();if("1"==h.followOrigin){jQuery(".link-table .update-td").html(d.getMessage("data.dataLink.label.yesLabel"))}else{jQuery(".link-table .update-td").html(d.getMessage("data.dataLink.label.noLabel"))}jQuery(".link-table .create-td").html(h.createName);jQuery(".link-table .create-time-td").html(h.createTime);jQuery(".link-table .num-td").html(h.dataNum);jQuery(".link-table .data-update-td").html(h.updateTime);jQuery(".link-table .desc-content").html(h.dataDesc);log(h);var l=h.nodeDataArray;var k="";for(var j=0;j<l.length;j++){k+=l[j].nodeDataName;if(j<l.length-1){k+=","}}jQuery(".link-table .datalink-td").html(k)}};f.controller={init:function(){f.view.initDataResultShow()},setDataId:function(h){f.module.dataId=h}};return f.controller});