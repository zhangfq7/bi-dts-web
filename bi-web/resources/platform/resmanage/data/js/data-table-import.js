define(["sabace","proviceOrCitySelect"],function(A,z){var M={};var u={};var w={};var G="add";var ak=0;var a=null;var h=[];var at=[];var aj=[];var v=[];var ac="0";var D=[];var p=[];jQuery(function(){jQuery(".chosen-select").chosen();jQuery("#nextUpdateTime").datetimepicker({format:"YYYY-MM-DD HH:mm:ss",sideBySide:true,minDate:moment().format("YYYY-MM-DD"),});if(dataId!=""){G="edit"}M.dbId=dbId;if(G=="add"){if(dbId==null||dbId==""){ab()}else{if(dataBaseName==null||dataBaseName==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.notDataSource")})}else{jQuery("#dbName").val(dataBaseName)}}}Q();q();if(G=="edit"){al()}jQuery(".step-tab").on("click",I);jQuery("#tableButton").on("click",X);jQuery("#cancelButton").on("click",c);jQuery("#saveButton").on("click",Z);jQuery("#fieldCanButton").on("click",ad);jQuery("#fieldSaveButton").on("click",S);jQuery("#completeSaveButton").on("click",x);aq(1);jQuery("#generateData").on("click",aa);jQuery("#tableForm").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true});jQuery("#updatePeriod").on("change",C);jQuery(".funcForm").slideUp()});function ab(){A.ajax({url:A.handleUrlParam("/platform/resmanage/data/get-user-db"),success:function(aA){if(aA.resFlag=="success"){var aB=aA.dbList;var au=aB.length;var aw=null;var av=null;var az=null;var ay="<option selected></option>";for(var ax=0;ax<au;ax++){aw=aB[ax];av=aw.dbId;az=aw.dbName;ay+='<option value="'+av+'">'+az+"</option>"}jQuery("#selectDB").append(ay);jQuery("#selectDB").trigger("chosen:updated")}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:"您当前还没有配置数据库,请先配置数据库"});return}},error:function(au){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:au.responseText||"查询用户所有数据库异常"})}})}function q(){A.ajax({url:A.handleUrlParam("/platform/resmanage/data/query-classify-list"),success:function(au){B(au.classifyList)},error:function(au){}})}function B(aw){jQuery("#classifySel").append("");var aA=aw.length;var av=null;var az=null;var au=null;var ay="<option></option>";ay+='<option value="">无</option>';if(aA>0){for(var ax=0;ax<aA;ax++){av=aw[ax];au=av.classifyId;az=av.classifyName;ay+='<option value="'+au+'">'+az+"</option>"}}jQuery("#classifySel").append(ay);jQuery("#classifySel").trigger("chosen:updated")}function C(){if(this.value!="I"){jQuery("#xxgxsj").removeClass("hide");jQuery("#sjxz").removeClass("hide");if(this.value=="D"||this.value=="W"||this.value=="M"){jQuery("#ccfs").removeClass("hide");jQuery("#ccxz").removeClass("hide")}else{jQuery("#ccfs").addClass("hide");jQuery("#ccxz").addClass("hide")}}else{jQuery("#xxgxsj").addClass("hide");jQuery("#sjxz").addClass("hide");jQuery("#ccfs").addClass("hide");jQuery("#ccxz").addClass("hide")}}function Q(){document.onmousedown=function(av){var aw=av.target;if(aw.id=="dimName"||aw.id=="dimNameForOther"){return}if(aw.id=="dimSearch"||aw.id=="dimSearchForOther"){var au="1";if(aw.id=="dimSearchForOther"){au="2"}H(au);return}if(aw.id=="dim"||aw.id=="dimSelect"){jQuery(".data-info-grid th #dimOther").poshytip("hide");jQuery(".data-info-grid th #columnOper").poshytip("hide");return}if(aw.id=="dimOther"||aw.id=="dimOtherSelect"){jQuery(".data-info-grid th #dim").poshytip("hide");jQuery(".data-info-grid th #columnOper").poshytip("hide");return}if(aw.id=="columnOper"){jQuery(".data-info-grid th #dimOther").poshytip("hide");jQuery(".data-info-grid th #dim").poshytip("hide");return}if(aw==undefined||aw.id!="dim"||aw.id!="columnOper"||aw.id!="dimOther"){jQuery(".data-info-grid th #dim").poshytip("hide");jQuery(".data-info-grid th #dimOther").poshytip("hide");jQuery(".data-info-grid th #columnOper").poshytip("hide");return}}}function H(av){var au=null;if(av=="1"){au=jQuery(".tip-yellowsimple #dimName").val()}else{au=jQuery(".tip-yellowsimple #dimNameForOther").val()}A.ajax({url:A.handleUrlParam("/platform/resmanage/data/data-search-dim"),data:{dimName:au},success:function(ax){var aw=ax.dimList;J(av,aw,au)},error:function(aw){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.queryFilterTypeError")})}})}function al(){M.dataId=dataId;A.ajax({url:A.handleUrlParam("/platform/resmanage/data/get-table-data"),data:{dataId:M.dataId},loading:{title:A.getMessage("data.import.title.execute"),text:'<span class="f16 bolder gray">'+A.getMessage("data.import.text.DBInfoLoading")+"</span>",spin:true},success:function(au){if(au.resFlag=="success"){ar(au)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:au.msg});return}},error:function(au){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:au.responseText||A.getMessage("data.import.message.queryEditDataError")})}})}function O(au){if(au=="7"){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.lastData")})}}function ar(au){M=au.tableConfigBean;M.attrData=au.attrDatas;M.columnData=au.columnDatas;M.dimData=au.dimDatas;M.footerData=au.footerDatas;M.columnNum=au.columnNum;if(M.attrData.length==0){G="add"}else{O(M.importState);var aG=au.attrDatas;var ax=aG.length;var az=null;var av=null;var aC=null;var aA=null;var aB={};for(var aI=0;aI<ax;aI++){az=aG[aI].filterType;av=aG[aI].fieldName;h.push(az);aj.push(av);aC=aG[aI].attrId;aA=aG[aI].dimId;aB={attrId:aC,filterType:az,dimId:aA};D.push(aB)}jQuery("#oneStep").addClass("active-Finished");jQuery("#twoStep").removeClass("active-notFinished");jQuery("#twoStep").addClass("active-Finished");jQuery("#thirdStep").removeClass("active-notFinished");jQuery("#thirdStep").addClass("active-Finished");jQuery("#fourStep").removeClass("active-notFinished");jQuery("#fourStep").addClass("active-Finished");jQuery(".main-panel").removeClass("hide");var aO=au.dbName;M.dataBaseName=aO;jQuery("#dbName").val(aO);ah();var aD=M.dataTable;var aw=M.splitType;var aE=M.dataName;var ay=M.updatePeriod;var aJ=M.nextUpdateTime;var aN=M.storageType;var aP=M.tableDesc;jQuery("#dataTable").val(aD);jQuery("#dataTable").prop("disabled",true);jQuery("#splitType").val(aw).setDisabled(true);jQuery("#splitType").trigger("chosen:updated");jQuery("#dataName").val(aE);jQuery("#updatePeriod").val(ay);jQuery("#updatePeriod").trigger("chosen:updated");if(ay!="I"){jQuery("#xxgxsj").removeClass("hide");jQuery("#sjxz").removeClass("hide");if(aJ=="-1"){jQuery("#nextUpdateTime").val(M.lastUpdateTime)}else{jQuery("#nextUpdateTime").val(aJ)}if(ay=="D"||ay=="W"||ay=="M"){jQuery("#ccfs").removeClass("hide");jQuery("#ccxz").removeClass("hide");jQuery("#storageType").val(aN);jQuery("#storageType").trigger("chosen:updated")}else{jQuery("#ccfs").addClass("hide");jQuery("#ccxz").addClass("hide")}}else{jQuery("#xxgxsj").addClass("hide");jQuery("#sjxz").addClass("hide");jQuery("#ccfs").addClass("hide");jQuery("#ccxz").addClass("hide")}jQuery("#tableDesc").val(aP);var aM=jQuery("#splitType").find("option:selected").text();var aL=jQuery("#updatePeriod").find("option:selected").text();jQuery("#dbName_finish").html(aO);jQuery("#dataTable_finish").html(aD);jQuery("#dataName_finish").html(aE);jQuery("#splitType_finish").html(aM);jQuery("#updatePeriod_finish").html(aL);if(ay!="I"){jQuery("#xxgxsj_finish").removeClass("hide");jQuery("#sjxz_finish").removeClass("hide");jQuery("#nextUpdateTime_finish").html(aJ);if(ay=="D"||ay=="W"||ay=="M"){jQuery("#ccfs_finish").removeClass("hide");jQuery("#ccxz_finish").removeClass("hide");var aK=jQuery("#storageType").find("option:selected").text();jQuery("#storageType_finish").html(aK)}else{jQuery("#ccfs_finish").addClass("hide");jQuery("#ccxz_finish").addClass("hide")}}else{jQuery("#xxgxsj_finish").addClass("hide");jQuery("#sjxz_finish").addClass("hide");jQuery("#ccfs_finish").addClass("hide");jQuery("#ccxz_finish").addClass("hide")}jQuery("#tableDesc_finish").html(aP);var aF=M.classifyId;M.classifyId=aF;jQuery("#classifySel").val(aF);jQuery("#classifySel").trigger("chosen:updated");var aH=jQuery("#classifySel").find("option:selected").text();if(aH==null||aH==""){aH="无"}M.classifyName=aH;jQuery("#classify_finish").html(aH)}}function X(){var ay=$("#tableForm").validationEngine("validate");if(!ay){return false}if(G=="add"&&(dbId==null||dbId=="")){var av=jQuery("#selectDB").val();var au=jQuery("#selectDB").find("option:selected").text();if(av==null||av==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:"您还没有选择归属数据库，请选择归属数据库！"});return}dataBaseName=au;M.dbId=av}else{var ax=jQuery("#dbName").val();if(ax==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.notDataSource")});return}}M.dataTable=jQuery.trim(jQuery("#dataTable").val());M.splitType=jQuery("#splitType").val();M.dataName=jQuery.trim(jQuery("#dataName").val());M.updatePeriod=jQuery("#updatePeriod").val();M.updatePeriodText=jQuery("#updatePeriod").find("option:selected").text();M.splitType=jQuery("#splitType").val();M.splitTypeText=jQuery("#splitType").find("option:selected").text();M.storageType=jQuery("#storageType").val();M.storageTypeText=jQuery("#storageType").find("option:selected").text();M.tableDesc=jQuery.trim(jQuery("#tableDesc").val());M.nextUpdateTime=jQuery("#nextUpdateTime").val();M.classifyId=jQuery("#classifySel").val();M.classifyName=jQuery("#classifySel").find("option:selected").text();if(M.dataTable.indexOf("$")>0){if(M.splitType==0){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.subTable")});return}}else{if(M.splitType!=0){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.notSubTable")});return}}if(M.updatePeriod==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.updatePeriod")});return}if(M.updatePeriod!="I"){if(M.nextUpdateTime==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.nextUpdateTime")});return}if(M.updatePeriod=="D"||M.updatePeriod=="W"||M.updatePeriod=="M"){if(M.storageType==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.storageType")});return}}}if(M.updatePeriod=="I"){M.nextUpdateTime="";M.storageType=""}else{if(M.updatePeriod=="S"){M.storageType=""}}var aw={dbId:M.dbId,dataTable:M.dataTable,dataName:M.dataName,splitType:M.splitType,updatePeriod:M.updatePeriod,storageType:M.storageType,tableDesc:M.tableDesc,dataId:M.dataId,nextUpdateTime:M.nextUpdateTime,opType:G,classifyId:M.classifyId,classifyName:M.classifyName};A.ajax({url:A.handleUrlParam("/platform/resmanage/data/creat-from-table"),data:aw,loading:{title:A.getMessage("data.import.title.execute"),text:A.getMessage("data.import.text.queryTableLoading")},success:function(az){if(az.resFlag=="success"){V(az)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:az.msg});return}},error:function(az){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:az.responseText||A.getMessage("data.import.message.importTableError")})}})}function V(au){M=au.tableConfigBean;M.attrData=au.attrDatas;M.columnData=au.columnDatas;M.dimData=au.dimDatas;M.footerData=au.footerDatas;aq(2);jQuery("#oneStep").addClass("active-Finished");if(jQuery("#twoStep").hasClass("active-Finished")){jQuery("#twoStep").removeClass("active-Finished")}jQuery("#twoStep").removeClass("active-notFinished");jQuery("#tableInfo").addClass("hide");jQuery("#dataInfo").removeClass("hide");ah()}function aq(av){var au=25*(av-1)+4+"%";jQuery("#stepLine").css("margin-left",au)}function E(aw,au,ax){var av="";if(ax==""||(ax!=null&&"数值".indexOf(ax)>-1)){av+=" <li class ='fixedDim' value='2' title='数值'><div class='num-pic'></div><span>数值</span></li>"}if(ax==""||(ax!=null&&"月份".indexOf(ax)>-1)){av+=" <li class ='fixedDim' value='4' title='月份'><div class='month-pic'></div>月份</li>"}if(ax==""||(ax!=null&&"日期".indexOf(ax)>-1)){av+=" <li class ='fixedDim' value='6' title='日期'><div class='date-pic'></div>日期</li>"}if(ax==""||(ax!=null&&"时间".indexOf(ax)>-1)){av+=" <li class ='fixedDim' value='7' title='时间'><div class='time-pic'></div>时间</li>"}if(ax==""||(ax!=null&&"字符".indexOf(ax)>-1)){av+=" <li class ='fixedDim' value='9' title='字符'><div class='char-pic'></div>字符</li>"}if(ax==""||(ax!=null&&"省份".indexOf(ax)>-1)){av+=" <li class ='fixedDim' value='A' title='省份'><div class='province-pic'></div>省份</li>"}if(ax==""||(ax!=null&&"地市".indexOf(ax)>-1)){av+=" <li class ='fixedDim' value='B' title='地市'><div class='city-pic'></div>地市</li>"}if(ax==""||(ax!=null&&"区县".indexOf(ax)>-1)){av+=" <li class ='fixedDim' value='C' title='区县'><div class='county-pic'></div>区县</li>"}av+=" <li class='divider'></li>";return av}function m(aw,av,ax){var au="";if(ax==""||(ax!=null&&"数值".indexOf(ax)>-1)){au+=" <li class ='fixedDim' value='2' title='数值'><div class='num-pic'></div><span>数值</span></li>"}if(ax==""||(ax!=null&&"字符".indexOf(ax)>-1)){au+=" <li class ='fixedDim' value='9' title='字符'><div class='char-pic'></div>字符</li>"}au+=" <li class='divider'></li>";return au}function J(az,aA,aw){var ax=null;var aD=null;if(az=="1"){ax=jQuery(".tip-yellowsimple #dimSelect");ax.empty()}else{if(az=="2"){aD=jQuery(".tip-yellowsimple #dimOtherSelect");aD.empty()}else{ax=jQuery("#dimSelect");ax.empty();aD=jQuery("#dimOtherSelect");aD.empty()}}var aC=E(az,aA,aw);if(az=="2"||az=="3"){var av=m(az,aA,aw)}var aE=0;if(aA!=null&&aA!=""){var au=null;var aB=null;aE=aA.length;for(var ay=0;ay<aE;ay++){au=aA[ay].name;aB=aA[ay].value;aC+=" <li value="+aB+" title="+au+"><div class='dim-pic'></div>"+au+"</li>";if(az=="2"||az=="3"){av+=" <li value="+aB+" title="+au+"><div class='dim-pic'></div>"+au+"</li>"}}}if(az=="1"||az=="3"){ax.append(aC)}if(az=="2"||az=="3"){aD.append(av)}if(aE*30>200){jQuery("#dim-select").height(360)}if(az=="2"||az=="3"){if((aE-3)*30>200){jQuery("#dim-other-select").height(360)}}}function k(av,aC){if(jQuery("#columnOper")){jQuery("#columnOper").empty()}J("3",aC,"");var aE=[];var ay=av.length;var ax=jQuery(window).width()*0.94;var aw=200;if(ay*aw<ax){aw=Math.floor(ax/ay)}var aF=null;var aA=null;var aG=null;var au=null;var aD=null;var aH=null;var aB="<div id='columnOper'></div>";for(var az=0;az<ay;az++){aG=av[az].columnFilterTypeName;aF=av[az].columnLabel;au=av[az].filterType;aH=av[az].attrClass;if(typeof(aG)=="undefined"){aG="字符"}if(au=="2"){aD="right"}else{aD="left"}if(aH=="0"){aA="<div id='dim'><span title="+aG+" class='dimText'>"+aG+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+aF+aB}else{aA="<div id='dimOther'><span title="+aG+" class='dimText'>"+aG+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+aF+aB}aE.push({label:aA,name:aF,align:aD,hlign:"center",sortable:false,width:aw})}return aE}function ah(){if(!jQuery("#dataGrid").is(":empty")){jQuery.jgrid.gridUnload("dataGrid")}w=k(M.attrData,M.dimData);u={datatype:"local",styleUI:"Bootstrap",regional:"cn",data:M.columnData,colModel:w,rownumbers:true,autowidth:true,shrinkToFit:false,height:"auto",footerrow:true,loadComplete:function(){jQuery("#dataInfo #dimOther").parent().parent().css("background-color","#DAE9E9");if(M.footerData.length<1){jQuery(".data-info-grid .ui-jqgrid-sdiv").hide()}else{jQuery(".data-info-grid .ui-jqgrid-sdiv").show();var ay={};var av=M.footerData.length;var au=null;for(var ax=0;ax<av;ax++){au=M.footerData[ax];ay[au.name]=au.desc}jQuery(this).footerData("set",ay)}var aw=jQuery(this).parents().find(".data-info-grid th");aw.click(function(){M.currentColNum=jQuery(this)[0].cellIndex;var aA=jQuery(this);var az=jQuery(aA).attr("id");jQuery("th").removeClass("jqgrid-underline");jQuery("th[id="+az+"]").addClass("jqgrid-underline");K()});aw.find("#dim").on("click",function(){M.currentColNum=jQuery(this).parent().parent()[0].cellIndex;var az=M.attrData[M.currentColNum-1].filterType;aw.find("#dim").poshytip("hide");jQuery(this).poshytip({className:"tip-yellowsimple",content:jQuery("#dim-select").outerHTML(),showTimeout:1,alignTo:"target",alignX:"bottom",alignY:"bottom",showOn:"none",offsetY:5,offsetX:-128,keepInViewport:false});jQuery(this).poshytip("show");jQuery(".tip-yellowsimple #dim-select li[value='"+az+"']").prepend("<i class='fa fa-check dimItemsCheck'></i>");jQuery(".tip-yellowsimple #dim-select li[value='"+az+"']").css("background-color","#2CC2A7");jQuery(".tip-yellowsimple #dim-select").niceScroll();jQuery(".tip-yellowsimple").on("click","#dimSelect li",function(){t(jQuery(this).attr("value"),jQuery(this).text())});A.stopBubble(event)});aw.find("#dimOther").on("click",function(){M.currentColNum=jQuery(this).parent().parent()[0].cellIndex;var az=M.attrData[M.currentColNum-1].filterType;aw.find("#dimOther").poshytip("hide");jQuery(this).poshytip({className:"tip-yellowsimple",content:jQuery("#dim-other-select").outerHTML(),showTimeout:1,alignTo:"target",alignX:"bottom",alignY:"bottom",showOn:"none",offsetY:5,offsetX:-128,keepInViewport:false});jQuery(this).poshytip("show");jQuery(".tip-yellowsimple #dim-other-select li[value='"+az+"']").prepend("<i class='fa fa-check dimItemsCheck'></i>");jQuery(".tip-yellowsimple #dim-other-select li[value='"+az+"']").css("background-color","#2CC2A7");jQuery(".tip-yellowsimple #dim-other-select").niceScroll();jQuery(".tip-yellowsimple").on("click","#dimOtherSelect li",function(){t(jQuery(this).attr("value"),jQuery(this).text())});A.stopBubble(event)});aw.find("#columnOper").on("click",function(){aw.find("#columnOper").poshytip("hide");jQuery(this).poshytip({className:"tip-yellowsimple",content:jQuery("#columnOperMenu").outerHTML(),showTimeout:1,alignTo:"target",alignX:"bottom",alignY:"bottom",showOn:"none",offsetY:6,offsetX:-82,keepInViewport:false});jQuery(this).poshytip("show");M.currentColNum=jQuery(this).parent().parent()[0].cellIndex;jQuery("#columnOperMenu .addLeftColumn").on("click",am);jQuery("#columnOperMenu .addRightColumn").on("click",an);jQuery("#columnOperMenu .delThecolumn").on("click",d);A.stopBubble(event)})}};jQuery("#dataGrid").jqGrid(u);$(window).resize(function(){Y()})}function K(){var au=M.attrData[M.currentColNum-1];if(au.attrClass=="1"){a=M.currentColNum;jQuery("#colNameSpan").text(au.columnLabel);if(au.fieldName!=""){jQuery("#funcTxt").val(au.funcLabel)}jQuery(".funcForm").slideDown()}else{a=null;jQuery("#funcTxt").val("");jQuery(".funcForm").slideUp()}}function b(av){var ay=M.attrData;var az=M.columnNum;var ax=null;var au=false;for(var aw=0;aw<az;aw++){if(aw!=av){ax=ay[aw];if("A"==ax.filterType||"B"==ax.filterType){au=true;break}}}return au}function P(ax,au,aw){var av=A.handleUrlParam("/platform/resmanage/data/data-select-city");bi.dialog.show({title:A.getMessage("data.import.title.selectProAndCity"),message:jQuery('<div id="selectProvinceOrCity"></div>').load(av),spinicon:"glyphicon glyphicon-refresh",cssClass:"data-selectProvinceOrCity",onshown:function(ay){z.init()},buttons:[{label:A.getMessage("data.import.label.sure"),cssClass:"btn-info",action:function(ay){var az=z.saveSelect();if(az.flag){M.attrData[ax].superRange=az.selectValue;ay.close();y(ax,au,aw)}}},{label:A.getMessage("data.import.label.cancel"),cssClass:"btn-default",action:function(ay){ay.close()}}]})}function ag(au){var ax=M.attrData;var ay=M.columnNum;var aw=null;for(var av=0;av<ay;av++){if(av!=au){aw=ax[av];if("C"==aw.filterType){if(typeof(aw.superRange)!="undefined"&&aw.superRange!=""){aw.superRange=""}}}}}function t(aC,av){ak=jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft();var aB=M.currentColNum-1;var ay={};ay.selectValue=aC;ay.selectName=av;var au=M.attrData[aB];ay.columnLabel=au.columnLabel;ay.colLength=au.colLength;ay.colScale=au.colScale;ay.fieldName=au.fieldName;ay.dataId=M.dataId;var az=au.originFilterType;var aA=au.filterType;var aw=aC;var ax=true;if(au.attrClass=="1"){if(typeof(au.fieldName)=="undefined"||au.fieldName==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.no")+" "+au.columnLabel+" "+A.getMessage("data.import.message.customChangeFilter")});return}}if(az=="9"||az=="4"||az=="6"||az=="7"){if(aw=="2"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.cannotChange")+T(az)+",不可切换成数值！"});return}}if(aA!=aC){if(aw=="2"||aw=="4"||aw=="6"||aw=="7"||aw=="9"||aw=="A"||aw=="B"||aw=="C"){if(aw=="C"){ax=b(aB);if(!ax){P(aB,ay,au)}}else{if(aw=="A"||aw=="B"){ag(aB)}}if(ax){y(aB,ay,au)}}else{W(aB,ay,au)}}}function y(aw,au,av){A.ajax({url:A.handleUrlParam("/platform/resmanage/data/change-column-type"),data:{changeData:JSON.stringify(au),columnData:JSON.stringify(M.columnData),type:"2"},loading:{title:A.getMessage("data.import.title.execute"),text:A.getMessage("data.import.text.loading")},success:function(aA){if(aA.resFlag=="success"){jQuery.jgrid.gridUnload("dataGrid");M.columnData=aA.columnDatas;av.filterType=au.selectValue;av.attrType=aA.attrType;av.colLength=aA.colLength;av.colScale=aA.colScale;av.columnType=aA.columnType;av.columnFilterTypeName=aA.columnFilterTypeName;var ax="<div id='columnOper'></div>";var aB=null;if(av.attrClass=="0"){aB="<div id='dim'><span title="+au.selectName+" class='dimText'>"+au.selectName+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+au.columnLabel+ax}else{aB="<div id='dimOther'><span title="+au.selectName+" class='dimText'>"+au.selectName+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+au.columnLabel+ax}var ay=u.colModel;var az=null;if(av.filterType=="2"){az="right"}else{az="left"}ay[aw].label=aB;ay[aw].align=az;u.colModel=ay;u.data=M.columnData;jQuery("#dataGrid").jqGrid(u)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.restoreData")})}Y();o()},error:function(ax){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:ax.responseText||A.getMessage("data.import.message.dataGenerationError")})}})}function T(av){var au="";if(av=="2"){au="数值"}else{if(av=="4"){au="月份"}else{if(av=="6"){au="日期"}else{if(av=="7"){au="时间"}else{if(av=="9"){au="字符"}}}}}return au}function W(aw,au,av){av.filterType=au.selectValue;A.ajax({url:A.handleUrlParam("/platform/resmanage/data/dim-change"),data:{changeData:JSON.stringify(au),columnData:JSON.stringify(M.columnData)},loading:{title:A.getMessage("data.import.title.execute"),text:A.getMessage("data.import.text.loading")},success:function(az){if(az.resFlag=="success"){jQuery.jgrid.gridUnload("dataGrid");M.columnData=az.columnData;av.filterType=au.selectValue;av.columnFilterTypeName=au.selectName;var ax="<div id='columnOper'></div>";var aA=null;if(av.attrClass=="0"){aA="<div id='dim'><span title="+au.selectName+" class='dimText'>"+au.selectName+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+au.columnLabel+ax}else{aA="<div id='dimOther'><span title="+au.selectName+" class='dimText'>"+au.selectName+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+au.columnLabel+ax}var ay=u.colModel;ay[aw].label=aA;ay[aw].align="left";u.colModel=ay;u.data=M.columnData;jQuery("#dataGrid").jqGrid(u)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.restoreData")})}Y();o()},error:function(ax){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.dataGenerationError")})}})}function aa(){var au=jQuery.trim(jQuery("#funcTxt").val());if(au==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.inputFunc")});return}if(a==null){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.selectCustomColumn")});return}M.funcTxt=au;ao(a)}function ao(au){ak=jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft();A.ajax({url:A.handleUrlParam("/platform/resmanage/data/process-func"),data:{dataId:M.dataId,columnIndex:au,funcTxt:M.funcTxt,attrData:JSON.stringify(M.attrData),columnData:JSON.stringify(M.columnData)},loading:{title:A.getMessage("data.import.title.execute"),text:A.getMessage("data.import.text.loading")},success:function(aw){if(aw.resFlag=="success"){jQuery.jgrid.gridUnload("dataGrid");M.columnData=aw.columnDatas;var av=M.attrData[a-1];av.funcLabel=M.funcTxt;av.fieldName=aw.fileName;av.attrType=aw.attrType;av.originAttrType=aw.attrType;av.columnType=aw.columnType;av.originColumnType=aw.columnType;av.filterType=aw.filterType;av.originFilterType=aw.filterType;av.colLength=aw.colLength;av.originColLength=aw.colLength;av.colScale=aw.colScale;av.originColScale=aw.colScale;av.columnFilterTypeName=aw.columnFilterTypeName;w=k(M.attrData,M.dimData);u.colModel=w;u.data=M.columnData;jQuery("#dataGrid").jqGrid(u)}else{jQuery.jgrid.gridUnload("dataGrid");var av=M.attrData[a-1];av.fieldName="";av.funcLabel="";w=k(M.attrData,M.dimData);u.colModel=w;u.data=M.columnData;jQuery("#dataGrid").jqGrid(u);if(aw.resFlag=="filterFail"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:aw.msg})}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.reEnterFunc")})}}Y();o()},error:function(av){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.processFunError")})}})}function i(ax,aB,au){ak=jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft();var ay=jQuery("#dataGrid").jqGrid("getRowData");var aA=[];var az=null;for(var aw=0;aw<ay.length;aw++){az={};for(var av=0;av<aB;av++){if(av>ax){az[au[av]]=ay[aw][au[av-1]]}else{az[au[av]]=ay[aw][au[av]]}}az[au[ax]]="";aA.push(az)}M.attrData=n(M.attrData,ax);jQuery.jgrid.gridUnload("dataGrid");M.columnData=aA;w=k(M.attrData,M.dimData);u.colModel=w;u.data=M.columnData;jQuery("#dataGrid").jqGrid(u);Y();o()}function o(){ak=ak;jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft(ak)}function n(ay,aw){var aA=M.columnNum;var au=null;var ax=null;var az=null;for(var av=0;av<aA;av++){au=ay[av];ax=au.attrClass;if(ax=="1"&&aw!=av){az=au.funcLabel;if(typeof(az)!="undefined"&&az!=""){au.funcLabel=U(az,aw,aA)}}}return ay}function U(az,av,aD){var au=L(aD);var aC=null;var aB=null;var aE=null;var aA=-1;var ax=0;var aw=/[A-Z]$/;for(var ay=av;ay<aD;ay++){ax=az.length;aC="$"+au[ay];aE="$()"+au[ay+1];aA=az.indexOf(aC);if(aA>-1){if(aA+3<=ax){aB=az.substr(aA,3);if(aw.test(aB)){if(az.substr(aA+1,2)==au[ay]){az=az.replace(new RegExp("\\"+aB,"g"),aE)}}else{az=az.replace(new RegExp("\\"+aC,"g"),aE)}}else{if(aA+2==ax){az=az.replace(new RegExp("\\"+aC,"g"),aE)}}}}az=az.replace(new RegExp("\\$\\(\\)","g"),"$");return az}function am(){var az=M.columnNum+1;M.columnNum=az;var aw=M.currentColNum-1;var au=L(az);var ay={orderId:aw+1,columnLabel:au[aw],attrType:"3",filterType:"9",attrClass:"1",isUsed:"1"};var ax={name:au[aw],desc:""};for(var av=0;av<az;av++){if(av==aw){M.attrData.insert(av,ay);M.footerData.insert(av,ax)}else{if(av>aw){M.attrData[av].orderId=av+1;M.attrData[av].columnLabel=au[av];M.footerData[av].name=au[av]}}}i(aw,az,au)}function L(aA){var au=new Array();var az="A";var ay=az.charCodeAt();var av=0;var ax=0;for(var aw=0;aw<aA;aw++){if(aw<26){au.push(String.fromCharCode(ay+aw)+"")}else{av=Math.floor(aw/26);if((av-1)>0){ax=aw-26*av}au.push(au[aw-25*av-ax-1]+au[aw-26*av]);ax++}}return au}function an(){var az=M.columnNum+1;M.columnNum=az;var aw=M.currentColNum;var au=L(az);var ay={orderId:aw+1,columnLabel:au[aw],attrType:"3",filterType:"9",attrClass:"1",isUsed:"1"};var ax={name:au[aw],desc:""};for(var av=0;av<az;av++){if(av==aw){M.attrData.insert(av,ay);M.footerData.insert(av,ax)}else{if(av>aw){M.attrData[av].orderId=av+1;M.attrData[av].columnLabel=au[av];M.footerData[av].name=au[av]}}}i(aw,az,au)}function d(){if(M.attrData[M.currentColNum-1].attrClass=="0"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.notDelCustomColumn")});return}var ax="$"+M.attrData[M.currentColNum-1].columnLabel;var av=null;var au=null;var az=null;var ay=[];for(var aw=0;aw<M.columnNum;aw++){av=M.attrData[aw];if(aw!=M.currentColNum-1&&av.attrClass=="1"){az=av.funcLabel;au=av.columnLabel;if(typeof(az)!="undefined"&&az!=""){if(az.indexOf(ax)>=0){ay.push(au)}}}}if(ay.length>0){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.delColumnConfirm")+ay+A.getMessage("data.import.message.quoteColumn")});return}bi.dialog.confirm({title:A.getMessage("data.import.text.delColumn"),message:A.getMessage("data.import.message.delColumnConfirm"),callback:function(aA){if(aA){var aE=M.columnNum-1;var aD=M.currentColNum-1;M.columnNum=aE;var aB=L(aE+1);for(var aC=0;aC<aE+1;aC++){if(aC==aD){M.attrData.splice(aC,1);M.footerData.splice(aC,1)}else{if(aC>aD){M.attrData[aC-1].orderId=aC;M.attrData[aC-1].columnLabel=aB[aC-1];M.footerData[aC-1].name=aB[aC-1]}}}ai(aD,aE,aB)}}})}function ai(ax,aB,au){jQuery(".funcForm").slideUp();ak=jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft();var ay=jQuery("#dataGrid").jqGrid("getRowData");var aA=[];var az=null;for(var aw=0;aw<ay.length;aw++){az={};for(var av=0;av<aB;av++){if(av>=ax){az[au[av]]=ay[aw][au[av+1]]}else{az[au[av]]=ay[aw][au[av]]}}aA.push(az)}jQuery.jgrid.gridUnload("dataGrid");M.attrData=F(M.attrData,ax);M.columnData=aA;w=k(M.attrData,M.dimData);u.colModel=w;u.data=M.columnData;jQuery("#dataGrid").jqGrid(u);Y();o()}function F(ay,aw){var aA=M.columnNum;var au=null;var ax=null;var az=null;for(var av=0;av<aA;av++){au=ay[av];ax=au.attrClass;if(ax=="1"&&aw!=av){az=au.funcLabel;if(typeof(az)!="undefined"&&az!=""){au.funcLabel=g(az,aw,aA)}}}return ay}function g(az,av,aD){var au=L(aD+1);var aC=null;var aB=null;var aE=null;var aA=-1;var ax=0;var aw=/[A-Z]$/;for(var ay=av;ay<aD+1;ay++){ax=az.length;aC="$"+au[ay];aE="$()"+au[ay-1];aA=az.indexOf(aC);if(aA>-1){if(aA+3<=ax){aB=az.substr(aA,3);if(aw.test(aB)){if(az.substr(aA+1,2)==au[ay]){az=az.replace(new RegExp("\\"+aB,"g"),aE)}}else{az=az.replace(new RegExp("\\"+aC,"g"),aE)}}else{if(aA+2==ax){az=az.replace(new RegExp("\\"+aC,"g"),aE)}}}}az=az.replace(new RegExp("\\$\\(\\)","g"),"$");return az}function c(){aq(1);jQuery("#dataInfo").addClass("hide");jQuery("#tableInfo").removeClass("hide")}function Z(){for(var au=0;au<M.columnNum;au++){if(M.attrData[au].attrClass=="1"){if(typeof(M.attrData[au].fieldName)=="undefined"||M.attrData[au].fieldName==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.no")+" "+M.attrData[au].columnLabel+" 列是自定义列,该列还没有生成数据,请输入函数生成该列数据或选择删除该列！"});return}}}aq(3);jQuery("#oneStep").addClass("active-Finished");jQuery("#twoStep").addClass("active-Finished");if(jQuery("#thirdStep").hasClass("active-Finished")){jQuery("#thirdStep").removeClass("active-Finished")}jQuery("#thirdStep").removeClass("active-notFinished");jQuery("#dataInfo").addClass("hide");jQuery("#fieldInfo").removeClass("hide");j()}function j(){if(!jQuery("#fieldGrid").is(":empty")){jQuery.jgrid.gridUnload("fieldGrid")}A.ajax({url:A.handleUrlParam("/platform/resmanage/data/data-common-field"),data:{attrData:JSON.stringify(M.attrData)},success:function(au){if(au.resFlag=="success"){e(au)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.queryDataFail")});return}},error:function(au){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:au.responseText||A.getMessage("data.import.message.queryFieldFail")})}})}function e(av){var au=av.columnData;jQuery("#fieldGrid").jqGrid({datatype:"local",styleUI:"Bootstrap",data:au,regional:"cn",autowidth:true,height:"auto",rowNum:100000,colModel:[{label:A.getMessage("data.import.label.columnLabel"),name:"columnLabel",align:"center",hlign:"center",width:50,sortable:false,},{label:A.getMessage("data.import.label.fieldName"),name:"fieldName",align:"left",hlign:"center",sortable:false},{label:A.getMessage("data.import.label.attrName"),name:"attrName",align:"center",hlign:"center",sortable:false,editable:true,edittype:"text"},{label:A.getMessage("data.import.label.groupName"),name:"groupName",align:"center",hlign:"center",sortable:false,editable:true},{name:"groupId",align:"center",hlign:"center",hidden:true},{label:A.getMessage("data.import.label.attrType"),name:"attrType",align:"center",hlign:"center",sortable:false,formatter:"select",editoptions:{value:A.getMessage("data.import.label.attrTypeFormat")}},{label:A.getMessage("data.import.label.isUsed")+':<i class="fa fa-square-o check-box" id="allCheck"></i>)',name:"isUsed",align:"center",hlign:"center",sortable:false,formatter:function(aw,ax,az){var ay="";if(aw=="1"){ay='<i class="fa fa-check-square-o check-box" id="usedCheck" value="1"></i>'}else{ay='<i class="fa fa-square-o check-box" id="usedCheck" value="0"></i>'}return ay}}],loadComplete:function(){var aw=jQuery(this).parents().find(".field-info-grid th #allCheck");var ay=jQuery(this).parents().find(".field-info-grid td #usedCheck");aw.on("click",function(){var aB=jQuery(this).hasClass("fa-square-o");if(aB){jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o");ay.removeClass("fa-square-o");ay.removeClass("fa-check-square-o");ay.addClass("fa-check-square-o");ay.attr("value","1")}else{jQuery(this).removeClass("fa-check-square-o");jQuery(this).addClass("fa-square-o");ay.removeClass("fa-square-o");ay.removeClass("fa-check-square-o");ay.addClass("fa-square-o");ay.attr("value","0")}});ay.on("click",function(){aw.removeClass("fa-check-square-o");aw.addClass("fa-square-o");var aB=jQuery(this).hasClass("fa-square-o");if(aB){jQuery(this).attr("value","1");jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o")}else{jQuery(this).attr("value","0");jQuery(this).removeClass("fa-check-square-o");jQuery(this).addClass("fa-square-o")}A.stopBubble(event)});for(var ax=2;ax<=M.columnNum;ax++){$("#fieldGrid").jqGrid("editRow",ax,false);var az=jQuery(this).find("#"+ax+"_groupName");az.attr("readOnly",true);ae(az)}$("#fieldGrid").jqGrid("editRow",1,false);var aA=jQuery(this).find("#1_groupName");aA.attr("readOnly",true);ae(aA)}});l();$(window).resize(function(){l()})}function ae(au){jQuery(au).treeselect({height:200,chkStyle:"radio",searchAjaxParam:"groupName",width:(jQuery(au).width()+25),url:A.handleUrlParam("/platform/resmanage/data/data-query-group")})}function ad(){aq(2);jQuery("#fieldInfo").addClass("hide");jQuery("#dataInfo").removeClass("hide")}function ap(ax){var ay=0;var au=ax.length;var av=-1;for(var aw=0;aw<au;aw++){av=ax.charCodeAt(aw);if(av>=0&&av<=128){ay+=1}else{ay+=3}}return ay}function S(){var aB=0;var ay=[];for(var aA=1;aA<=M.columnNum;aA++){var aw=jQuery("#fieldGrid").jqGrid("getRowData",aA);var aC=jQuery(".field-info-grid #fieldGrid #"+aA+" .fa").attr("value");var aD=jQuery("#"+aA+"_attrName").val();var az=null;if(typeof(jQuery("#"+aA+"_groupName").attr("trueValue"))=="undefined"){az=aw.groupId}else{az=jQuery("#"+aA+"_groupName").attr("trueValue")}if(aC=="1"){if(aD==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.no")+" "+aw.columnLabel+" "+A.getMessage("data.import.message.columnEmpty")});return}}if(aD!=""){var aF=ap(aD);if(aF>90){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.no")+" "+aw.columnLabel+" "+A.getMessage("data.import.message.columnLength")});return}}if(aC=="0"){aB++}if(aC=="1"){for(var ax in ay){if(ay[ax]==aD){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.no")+" "+aw.columnLabel+" "+A.getMessage("data.import.message.columnRepet")});return}}}ay.push(aD);M.attrData[aA-1].isUsed=aC;M.attrData[aA-1].attrName=aD;M.attrData[aA-1].groupId=az}if(aB==M.columnNum){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.selectUsedColumn")});return}aq(4);jQuery("#oneStep").addClass("active-Finished");jQuery("#twoStep").addClass("active-Finished");jQuery("#thirdStep").addClass("active-Finished");if(jQuery("#fourStep").hasClass("active-Finished")){jQuery("#fourStep").removeClass("active-Finished")}jQuery("#fourStep").removeClass("active-notFinished");jQuery("#fieldInfo").addClass("hide");jQuery("#completeInfo").removeClass("hide");if(G=="add"){jQuery("#dbName_finish").html(dataBaseName)}else{jQuery("#dbName_finish").html(M.dataBaseName)}jQuery("#dataTable_finish").html(M.dataTable);jQuery("#dataName_finish").html(M.dataName);var av=jQuery("#splitType").find("option:selected").text();var aE=jQuery("#updatePeriod").find("option:selected").text();var au=jQuery("#storageType").find("option:selected").text();jQuery("#splitType_finish").html(av);jQuery("#updatePeriod_finish").html(aE);jQuery("#tableDesc_finish").html(M.tableDesc);if(M.classifyName==null||M.classifyName==""){M.classifyName="无"}jQuery("#classify_finish").html(M.classifyName);if(M.updatePeriod!="I"){jQuery("#xxgxsj_finish").removeClass("hide");jQuery("#sjxz_finish").removeClass("hide");jQuery("#nextUpdateTime_finish").html(M.nextUpdateTime);if(M.updatePeriod=="D"||M.updatePeriod=="W"||M.updatePeriod=="M"){jQuery("#ccfs_finish").removeClass("hide");jQuery("#ccxz_finish").removeClass("hide");jQuery("#storageType_finish").html(au)}else{jQuery("#ccfs_finish").addClass("hide");jQuery("#ccxz_finish").addClass("hide")}}else{jQuery("#xxgxsj_finish").addClass("hide");jQuery("#sjxz_finish").addClass("hide");jQuery("#ccfs_finish").addClass("hide");jQuery("#ccxz_finish").addClass("hide")}R()}function R(){A.ajax({url:A.handleUrlParam("/platform/resmanage/data/query-last-column"),loading:{title:A.getMessage("data.import.title.execute"),text:A.getMessage("data.import.text.configLoading")},data:{dataId:M.dataId,attrData:JSON.stringify(M.attrData),columnData:JSON.stringify(M.columnData)},success:function(au){if(au.resFlag=="success"){M.columnData=au.columnData;s()}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.queryDataFail")});return}},error:function(au){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:au.responseText||A.getMessage("data.import.message.queryDataError")})}})}function s(){var ax=M.attrData;var aC=M.columnData;var aF=ax.length;var aw=$(".complete-info-grid").width()-45;var av=180;if(aF*av<aw){av=Math.floor(aw/aF)}var aE=[];var az=null;var au=null;var aD=null;var aB=null;for(var ay=0;ay<aF;ay++){az=ax[ay];aB=az.isUsed;if(aB=="1"){au=az.filterType;if(au=="2"){aD="right"}else{aD="left"}aE.push({label:az.attrName,name:az.columnLabel,align:aD,hlign:"center",sortable:false,width:av})}}var aA={datatype:"local",data:aC,styleUI:"Bootstrap",colModel:aE,regional:"cn",rownumbers:true,shrinkToFit:false,autowidth:true,height:"auto"};if(jQuery("#completeGrid").is(":empty")){jQuery("#completeGrid").jqGrid(aA)}else{jQuery.jgrid.gridUnload("completeGrid");jQuery("#completeGrid").jqGrid(aA)}N();$(window).resize(function(){N()})}function x(){bi.dialog.confirm({title:A.getMessage("data.import.title.saveData"),message:A.getMessage("data.import.message.savaDataConfirm"),callback:function(au){if(au){r()}}})}function r(){var aK={dbId:M.dbId,dataTable:M.dataTable,dataName:M.dataName,splitType:M.splitType,updatePeriod:M.updatePeriod,storageType:M.storageType,tableDesc:M.tableDesc,dataId:M.dataId,nextUpdateTime:M.nextUpdateTime,attrData:JSON.stringify(M.attrData),importStateType:ac,classifyId:M.classifyId};var ax=A.handleUrlParam("/platform/resmanage/data/save-table-info");if(G=="edit"){at=[];v=[];p=[];var aE=M.attrData;var av=aE.length;var ay=null;var au=null;var aB=null;var az=null;var aA={};for(var aH=0;aH<av;aH++){ay=aE[aH].filterType;au=aE[aH].fieldName;at.push(ay);v.push(au);aB=aE[aH].attrId;az=aE[aH].dimId;aA={attrId:aB,filterType:ay,dimId:az};p.push(aA)}if(h.toString()!=at.toString()||aj.toString()!=v.toString()){aK.importStateType="1"}ax=A.handleUrlParam("/platform/resmanage/data/save-table-data")}if(aK.importStateType=="1"){var aC=D.length;var aI=p.length;var aA={};var aJ={};var aB=null;var aF=null;var ay=null;var aL=null;var az=null;var aw=null;var aG=false;for(var aH=0;aH<aI;aH++){aA=p[aH];aB=aA.attrId;ay=aA.filterType;az=aA.dimId;if(aB!=null){for(var aD=0;aD<aC;aD++){aJ=D[aD];aF=aJ.attrId;aL=aJ.filterType;if(aB==aF){if(ay!=aL){aG=true;break}else{if(ay=="1"){if(az!=aw){aG=true;break}}}}}}}if(aG){aK.importStateType="4"}}A.ajax({url:ax,data:aK,loading:{title:A.getMessage("data.import.title.execute"),text:A.getMessage("data.import.text.loading")},success:function(aM){if(aM.resFlag=="success"){af()}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:aM.msg});return}},error:function(aM){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:A.getMessage("data.import.title.tips"),message:aM.responseText||"数据表数据配置失败！"})}})}function af(){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:A.getMessage("data.import.title.tips"),message:A.getMessage("data.import.message.savaTableData"),closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:A.getMessage("data.import.label.sure"),cssClass:"btn-info",action:function(au){au.close();jQuery("#tableButton").addClass("hide");jQuery(".bottom-button-common").addClass("hide");jQuery("#completeSaveButton").addClass("hide")}},{label:A.getMessage("data.import.label.closePage"),cssClass:"btn-default",action:function(){if(jQuery.isFunction(window.opener.reloadDataList)){window.opener.reloadDataList()}window.close()}}]})}function I(){var au=jQuery(this).find(".step-title-num");var av=jQuery(this).attr("id");if(au.hasClass("active-Finished")||!au.hasClass("active-notFinished")){if(av=="tableTab"){aq(1);jQuery("#"+f()+"").addClass("hide");jQuery("#tableInfo").removeClass("hide")}else{if(av=="dataTab"){aq(2);jQuery("#"+f()+"").addClass("hide");jQuery("#dataInfo").removeClass("hide");Y()}else{if(av=="fieldTab"){aq(3);jQuery("#"+f()+"").addClass("hide");jQuery("#fieldInfo").removeClass("hide");if(jQuery("#fieldGrid").is(":empty")){j()}else{l()}}else{if(av=="completeTab"){aq(4);jQuery("#"+f()+"").addClass("hide");jQuery("#completeInfo").removeClass("hide");if(jQuery("#completeGrid").is(":empty")){R()}else{N()}}}}}}}function Y(){jQuery("#dataGrid").setGridWidth($(".data-info-grid").width()-5)}function l(){jQuery("#fieldGrid").setGridWidth($(".field-info-grid").width()-5);jQuery("#fieldGrid").setGridHeight($(".field-info-grid").height()-38)}function N(){jQuery("#completeGrid").setGridWidth($(".complete-info-grid").width()-5)}function f(){if(jQuery(".table-info").is(":visible")){return"tableInfo"}if(jQuery(".data-info").is(":visible")){return"dataInfo"}if(jQuery(".field-info").is(":visible")){return"fieldInfo"}if(jQuery(".complete-info").is(":visible")){return"completeInfo"}}});