define(["sabace","data-downfile"],function(a,c){var b={};b.view={initDataDownFileList:function(){var g=$("#logId").val();var k=$("#fileName").val();var e=$("#fileState").val();var i=$("#userName").val();var d=$("#fileProgress").val();var j=$("#adminTime").val();var h=$("#taskTotalsecond").val();var f={};f.logId=g;f.fileName=k;f.fileState=e;f.userName=i;f.fileProgress=d;f.adminTime=j;f.taskTotalsecond=h;$("#downFileListGrid").jqGrid({url:a.handleUrlParam("/platform/resmanage/db/query-downfile-list"),styleUI:"Bootstrap",datatype:"json",postData:f,mtype:"post",forceFit:true,colModel:[{index:"logId",label:"选择",formatter:function(l,m,o){var n='<input type="checkbox" id="selectLogId" value="'+o.logId+'" name="'+o.fileName+'" fileState="'+o.fileState+'" userName="'+o.userName+'" />';n+='<div style="display:none">'+o.depDesc+"</div>";return n},cellattr:function(q,n,o,l,p){if(!o.logId){var m=jQuery(this).jqGrid("getGridParam","colModel");return"colspan="+m.length}},hlign:"center",align:"center",sortable:false,width:30,title:false},{label:"文件名称",name:"fileName",width:80,align:"left",hlign:"center",sortable:false},{label:"生成状态",name:"fileState",width:50,align:"left",hlign:"center",sortable:false,formatter:function(l,m,n){if(l==1){return"正在生成"}else{if(l==2){return"生成完毕"}else{if(l==4){return"生成失败"}else{return"文件已删除"}}}}},{label:"生成进度",name:"fileProgress",width:80,align:"left",hlign:"center",sortable:false},{label:"操作人",name:"userName",width:80,align:"left",hlign:"center",sortable:false,},{label:"操作时间",name:"adminTime",width:80,align:"left",hlign:"center",sortable:false,},{label:"下载耗时（秒）",name:"taskTotalsecond",width:80,align:"left",hlign:"center",sortable:false,},{label:"操作",name:"operate",width:100,align:"center",hlign:"center",sortable:false,formatter:function(l,n,o){var m=o.logId;var p=o.fileName;if(o.fileState=="2"){return"<a href='javascript:void(0)' class='data-downfile' data-logid='"+m+"' data-filename='"+p+"'>下载</a> /  <a href='javascript:void(0)' class='downfile-del' data-logid='"+m+"'>删除</a> "}else{return""}}}],viewrecords:true,autowidth:true,height:"auto",rowNum:10,rowList:[10,20,30],pager:"#downFileListGridPager",jsonReader:{records:"total",total:"totalPages"},afterInsertRow:function(m,l){jQuery(this).jqGrid("setCell",rowid,"operate","<a>操作</a>")},regional:"cn"})}};b.controller={init:function(){$(window).resize(function(){a.timeout(function(){$("#downFileListGrid").setGridWidth($("#listPanel").width()-5)},100)});jQuery("#searchButton").on("click",function(){f()});jQuery("#batchDelFile").on("click",function(){h()});$("#downFileList").on("click",".data-downfile",function(){var j=$(this).data("logid");var k=$(this).data("filename");bi.dialog.confirm({title:"提示",message:"是否确定下载该数据报表",callback:function(l){if(l){g({logId:j,fileName:k})}}})});function g(j){jQuery("#downData").remove();jQuery("<form>",{id:"downData",method:"post",action:a.handleUrlParam("/platform/resmanage/db/download-file"),target:"_self",html:"<input name='fileName' type='hidden' value='"+j.fileName+"'/><input name='logId' type='hidden' value='"+j.logId+"'/>"}).appendTo("body");jQuery("#downData").submit()}function e(){f()}b.view.initDataDownFileList();function f(){var j={};j.fileName=$("#fileName").val();jQuery("#downFileListGrid").jqGrid("setGridParam",{postData:j}).trigger("reloadGrid")}function i(j){a.ajax({url:a.handleUrlParam("/platform/resmanage/db/delete-downfile"),data:{logId:j},loading:{title:"提示",text:"正在删除文件，请稍后..."},success:function(k){if(k.resFlag=="success"){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:"提示",message:"文件删除成功！"});e()}},error:function(k){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"错误",message:"文件下载失败，请找管理员处理！"})}})}function d(k){var j={};j.logIdArray=k;a.ajax({url:a.handleUrlParam("/platform/resmanage/db/delete-downfile-list"),data:j,loading:{title:"提示",text:"正在删除，请稍后！"},success:function(l){if(l.delFlag=="true"){bi.dialog.show({title:"提示",message:"您选择的文件信息已删除成功！",onhide:function(){e()}})}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"提示",message:"您选择的文件信息删除失败，请重试！"})}},error:function(l){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"提示",message:"删除文件信息的过程中出现异常！"})}})}function h(){var m=$("#selectLogId:checked");if(m.length<1){bi.dialog.show({type:"type-warning",title:"提示",message:"请至少选择一条要删除的文件信息！",});return}var n=[];for(var k=0;k<m.length;k++){n[k]=jQuery(m[k]).val();var o=jQuery(m[k]).attr("name");var j=jQuery(m[k]).attr("fileState");var l=jQuery(m[k]).attr("userName");if(parseInt(j)!=2){bi.dialog.show({type:"type-warning",title:"提示",message:"部分文件没有生成完成，不允许删除，请检查后再试！",});return}}bi.dialog.confirm({title:"确认",message:"您确定需要删除该文件吗？",callback:function(p){if(!p){return}d(n)}})}$("#downFileList").on("click",".downfile-del",function(){var j=$(this).data("logid");bi.dialog.confirm({title:"提示",message:"您确定需要删除该文件吗？",callback:function(k){if(k){i(j)}}})})}};return b.controller});