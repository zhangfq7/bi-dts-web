define(["sabace","proviceOrCitySelect"],function(ac,M){var q={};var an={};var J={};var au="add";var w=0;var ap=null;var al=[];var U=[];var ab=[];var R=[];var b="0";var r=[];var av=[];jQuery(function(){jQuery(".chosen-select").chosen();jQuery("#nextUpdateTime").datetimepicker({format:"YYYY-MM-DD HH:mm:ss",sideBySide:true,minDate:moment().format("YYYY-MM-DD"),});if(dataId!=""){au="edit"}q.dbId=dbId;if(au=="add"){if(dbId==null||dbId==""){ak()}else{if(dataBaseName==null||dataBaseName==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.notDataSource")})}else{jQuery("#dbName").val(dataBaseName);if(interfaceTag){jQuery("#dataTable").val(dataTable);jQuery("#dataName").val(tableName);if(dataTable.length>0){if(dataTable.lastIndexOf("YYYYMMDD")>0){jQuery("#splitType").val("1");jQuery("#splitType").trigger("chosen:updated")}else{if(dataTable.lastIndexOf("YYYYMM")>0){jQuery("#splitType").val("4");jQuery("#splitType").trigger("chosen:updated")}else{if(dataTable.lastIndexOf("CITY")>0){jQuery("#splitType").val("0");jQuery("#splitType").trigger("chosen:updated")}}}}}else{E()}}}}y();Y();if(au=="edit"){S()}jQuery(".step-tab").on("click",I);jQuery("#tableButton").on("click",H);jQuery("#cancelButton").on("click",n);jQuery("#saveButton").on("click",ah);jQuery("#fieldCanButton").on("click",am);jQuery("#fieldSaveButton").on("click",t);jQuery("#completeSaveButton").on("click",aa);p(1);jQuery("#generateData").on("click",K);jQuery("#tableForm").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true});jQuery("#updatePeriod").on("change",aj);jQuery(".funcForm").slideUp();jQuery("#selectDB").on("change",E);jQuery("#dataTable").on("change",W)});function ak(){ac.ajax({url:ac.handleUrlParam("/platform/resmanage/data/get-user-db"),data:{interfaceFlag:"1"},success:function(aC){if(aC.resFlag=="success"){var aD=aC.dbList;var aw=aD.length;var ay=null;var ax=null;var aB=null;var aA="<option selected></option>";for(var az=0;az<aw;az++){ay=aD[az];ax=ay.dbId;aB=ay.dbName;aA+='<option value="'+ax+'">'+aB+"</option>"}jQuery("#selectDB").append(aA);jQuery("#selectDB").trigger("chosen:updated")}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:"您当前还没有配置数据库,请先配置数据库"});return}},error:function(aw){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:aw.responseText||"查询用户所有数据库异常"})}})}function Y(){ac.ajax({url:ac.handleUrlParam("/platform/resmanage/data/query-classify-list"),success:function(aw){L(aw.classifyList)},error:function(aw){}})}function E(){jQuery("#dataTable").html("");ac.ajax({url:ac.handleUrlParam("/platform/resmanage/data/get-dacp-table"),data:{dbName:dataBaseName},success:function(aD){if(aD.resFlag=="success"){var aC=aD.tableArr;var aE=aC.length;var aA=null;var aw=null;var ax=null;var aB=null;var az="<option selected></option>";for(var ay=0;ay<aE;ay++){aA=aC[ay];aw=aA.dataName;ax=aA.dataCnName;aB=aA.schemaName;az+='<option value="'+aB+"."+aw+'" dataCnName="'+ax+'">'+aB+"."+aw+"</option>"}jQuery("#dataTable").append(az);jQuery("#dataTable").trigger("chosen:updated")}else{if(aD.resFlag=="fail"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:"没有查询到数据库表，请确认配置接口中存在数据库表！"});return}else{if(aD.resFlag=="error"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:"接口查询失败!"});return}}}},error:function(aw){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:aw.responseText||"查询数据库表异常！"})}})}function W(){var aw=jQuery(this).find("option:selected").attr("dataCnName");jQuery("#dataName").val(aw);var ax=this.value;if(ax.length>0){if(ax.lastIndexOf("YYYYMMDD")>0){jQuery("#splitType").val("1");jQuery("#splitType").trigger("chosen:updated")}else{if(ax.lastIndexOf("YYYYMM")>0){jQuery("#splitType").val("4");jQuery("#splitType").trigger("chosen:updated")}else{if(ax.lastIndexOf("CITY")>0){jQuery("#splitType").val("0");jQuery("#splitType").trigger("chosen:updated")}}}}}function L(ay){var aC=ay.length;var ax=null;var aB=null;var aw=null;var aA="<option selected></option>";aA+='<option value="">无</option>';if(aC>0){for(var az=0;az<aC;az++){ax=ay[az];aw=ax.classifyId;aB=ax.classifyName;aA+='<option value="'+aw+'">'+aB+"</option>"}}jQuery("#classifySel").append(aA);jQuery("#classifySel").trigger("chosen:updated")}function aj(){if(this.value!="I"){jQuery("#xxgxsj").removeClass("hide");jQuery("#sjxz").removeClass("hide");if(this.value=="D"||this.value=="W"||this.value=="M"){jQuery("#ccfs").removeClass("hide");jQuery("#ccxz").removeClass("hide")}else{jQuery("#ccfs").addClass("hide");jQuery("#ccxz").addClass("hide")}}else{jQuery("#xxgxsj").addClass("hide");jQuery("#sjxz").addClass("hide");jQuery("#ccfs").addClass("hide");jQuery("#ccxz").addClass("hide")}}function y(){document.onmousedown=function(ax){var ay=ax.target;if(ay.id=="dimName"||ay.id=="dimNameForOther"){return}if(ay.id=="dimSearch"||ay.id=="dimSearchForOther"){var aw="1";if(ay.id=="dimSearchForOther"){aw="2"}ai(aw);return}if(ay.id=="dim"||ay.id=="dimSelect"){jQuery(".data-info-grid th #dimOther").poshytip("hide");jQuery(".data-info-grid th #columnOper").poshytip("hide");return}if(ay.id=="dimOther"||ay.id=="dimOtherSelect"){jQuery(".data-info-grid th #dim").poshytip("hide");jQuery(".data-info-grid th #columnOper").poshytip("hide");return}if(ay.id=="columnOper"){jQuery(".data-info-grid th #dimOther").poshytip("hide");jQuery(".data-info-grid th #dim").poshytip("hide");return}if(ay==undefined||ay.id!="dim"||ay.id!="columnOper"||ay.id!="dimOther"){jQuery(".data-info-grid th #dim").poshytip("hide");jQuery(".data-info-grid th #dimOther").poshytip("hide");jQuery(".data-info-grid th #columnOper").poshytip("hide");return}}}function ai(ax){var aw=null;if(ax=="1"){aw=jQuery(".tip-yellowsimple #dimName").val()}else{aw=jQuery(".tip-yellowsimple #dimNameForOther").val()}ac.ajax({url:ac.handleUrlParam("/platform/resmanage/data/data-search-dim"),data:{dimName:aw},success:function(az){var ay=az.dimList;d(ax,ay,aw)},error:function(ay){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.queryFilterTypeError")})}})}function S(){q.dataId=dataId;ac.ajax({url:ac.handleUrlParam("/platform/resmanage/data/get-table-data"),data:{dataId:q.dataId},loading:{title:ac.getMessage("data.import.title.execute"),text:'<span class="f16 bolder gray">'+ac.getMessage("data.import.text.DBInfoLoading")+"</span>",spin:true},success:function(aw){if(aw.resFlag=="success"){l(aw)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:aw.msg});return}},error:function(aw){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:aw.responseText||ac.getMessage("data.import.message.queryEditDataError")})}})}function O(aw){if(aw=="7"){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.lastData")})}}function l(aw){q=aw.tableConfigBean;q.attrData=aw.attrDatas;q.columnData=aw.columnDatas;q.dimData=aw.dimDatas;q.footerData=aw.footerDatas;q.columnNum=aw.columnNum;if(q.attrData.length==0){au="add"}else{O(q.importState);var aI=aw.attrDatas;var az=aI.length;var aB=null;var ax=null;var aE=null;var aC=null;var aD={};for(var aK=0;aK<az;aK++){aB=aI[aK].filterType;ax=aI[aK].fieldName;al.push(aB);ab.push(ax);aE=aI[aK].attrId;aC=aI[aK].dimId;aD={attrId:aE,filterType:aB,dimId:aC};r.push(aD)}jQuery("#oneStep").addClass("active-Finished");jQuery("#twoStep").removeClass("active-notFinished");jQuery("#twoStep").addClass("active-Finished");jQuery("#thirdStep").removeClass("active-notFinished");jQuery("#thirdStep").addClass("active-Finished");jQuery("#fourStep").removeClass("active-notFinished");jQuery("#fourStep").addClass("active-Finished");jQuery(".main-panel").removeClass("hide");var aQ=aw.dbName;q.dataBaseName=aQ;jQuery("#dbName").val(aQ);e();var aF=q.dataTable;var ay=q.splitType;var aG=q.dataName;var aA=q.updatePeriod;var aL=q.nextUpdateTime;var aP=q.storageType;var aR=q.tableDesc;jQuery("#dataTable").val(aF);jQuery("#dataTable").prop("disabled",true);jQuery("#splitType").val(ay).setDisabled(true);jQuery("#splitType").trigger("chosen:updated");jQuery("#dataName").val(aG);jQuery("#updatePeriod").val(aA);jQuery("#updatePeriod").trigger("chosen:updated");if(aA!="I"){jQuery("#xxgxsj").removeClass("hide");jQuery("#sjxz").removeClass("hide");if(aL=="-1"){jQuery("#nextUpdateTime").val(q.lastUpdateTime)}else{jQuery("#nextUpdateTime").val(aL)}if(aA=="D"||aA=="W"||aA=="M"){jQuery("#ccfs").removeClass("hide");jQuery("#ccxz").removeClass("hide");jQuery("#storageType").val(aP);jQuery("#storageType").trigger("chosen:updated")}else{jQuery("#ccfs").addClass("hide");jQuery("#ccxz").addClass("hide")}}else{jQuery("#xxgxsj").addClass("hide");jQuery("#sjxz").addClass("hide");jQuery("#ccfs").addClass("hide");jQuery("#ccxz").addClass("hide")}jQuery("#tableDesc").val(aR);var aO=jQuery("#splitType").find("option:selected").text();var aN=jQuery("#updatePeriod").find("option:selected").text();jQuery("#dbName_finish").html(aQ);jQuery("#dataTable_finish").html(aF);jQuery("#dataName_finish").html(aG);jQuery("#splitType_finish").html(aO);jQuery("#updatePeriod_finish").html(aN);if(aA!="I"){jQuery("#xxgxsj_finish").removeClass("hide");jQuery("#sjxz_finish").removeClass("hide");jQuery("#nextUpdateTime_finish").html(aL);if(aA=="D"||aA=="W"||aA=="M"){jQuery("#ccfs_finish").removeClass("hide");jQuery("#ccxz_finish").removeClass("hide");var aM=jQuery("#storageType").find("option:selected").text();jQuery("#storageType_finish").html(aM)}else{jQuery("#ccfs_finish").addClass("hide");jQuery("#ccxz_finish").addClass("hide")}}else{jQuery("#xxgxsj_finish").addClass("hide");jQuery("#sjxz_finish").addClass("hide");jQuery("#ccfs_finish").addClass("hide");jQuery("#ccxz_finish").addClass("hide")}jQuery("#tableDesc_finish").html(aR);var aH=q.classifyId;q.classifyId=aH;jQuery("#classifySel").val(aH);jQuery("#classifySel").trigger("chosen:updated");var aJ=jQuery("#classifySel").find("option:selected").text();if(aJ==null||aJ==""){aJ="无"}q.classifyName=aJ;jQuery("#classify_finish").html(aJ)}}function H(){var aA=$("#tableForm").validationEngine("validate");if(!aA){return false}if(au=="add"&&(dbId==null||dbId=="")){var ax=jQuery("#selectDB").val();var aw=jQuery("#selectDB").find("option:selected").text();if(ax==null||ax==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:"您还没有选择归属数据库，请选择归属数据库！"});return}dataBaseName=aw;q.dbId=ax}else{var az=jQuery("#dbName").val();if(az==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.notDataSource")});return}}q.dataTable=jQuery.trim(jQuery("#dataTable").val());q.splitType=jQuery("#splitType").val();q.dataName=jQuery.trim(jQuery("#dataName").val());q.updatePeriod=jQuery("#updatePeriod").val();q.updatePeriodText=jQuery("#updatePeriod").find("option:selected").text();q.splitType=jQuery("#splitType").val();q.splitTypeText=jQuery("#splitType").find("option:selected").text();q.storageType=jQuery("#storageType").val();q.storageTypeText=jQuery("#storageType").find("option:selected").text();q.tableDesc=jQuery.trim(jQuery("#tableDesc").val());q.nextUpdateTime=jQuery("#nextUpdateTime").val();q.classifyId=jQuery("#classifySel").val();q.classifyName=jQuery("#classifySel").find("option:selected").text();if(q.updatePeriod==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.updatePeriod")});return}if(q.updatePeriod!="I"){if(q.nextUpdateTime==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.nextUpdateTime")});return}if(q.updatePeriod=="D"||q.updatePeriod=="W"||q.updatePeriod=="M"){if(q.storageType==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.storageType")});return}}}if(q.updatePeriod=="I"){q.nextUpdateTime="";q.storageType=""}else{if(q.updatePeriod=="S"){q.storageType=""}}var ay={dbId:q.dbId,dataTable:q.dataTable,dataName:q.dataName,splitType:q.splitType,updatePeriod:q.updatePeriod,storageType:q.storageType,tableDesc:q.tableDesc,dataId:q.dataId,nextUpdateTime:q.nextUpdateTime,opType:au,classifyId:q.classifyId,classifyName:q.classifyName};ac.ajax({url:ac.handleUrlParam("/platform/resmanage/data/creat-dacp-table"),data:ay,loading:{title:ac.getMessage("data.import.title.execute"),text:ac.getMessage("data.import.text.queryTableLoading")},success:function(aB){if(aB.resFlag=="success"){s(aB)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:aB.msg});return}},error:function(aB){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:aB.responseText||ac.getMessage("data.import.message.importTableError")})}})}function s(aw){q=aw.tableConfigBean;q.attrData=aw.attrDatas;q.columnData=aw.columnDatas;q.dimData=aw.dimDatas;q.footerData=aw.footerDatas;p(2);jQuery("#oneStep").addClass("active-Finished");if(jQuery("#twoStep").hasClass("active-Finished")){jQuery("#twoStep").removeClass("active-Finished")}jQuery("#twoStep").removeClass("active-notFinished");jQuery("#tableInfo").addClass("hide");jQuery("#dataInfo").removeClass("hide");e()}function p(ax){var aw=25*(ax-1)+4+"%";jQuery("#stepLine").css("margin-left",aw)}function Z(ay,aw,az){var ax="";if(az==""||(az!=null&&"数值".indexOf(az)>-1)){ax+=" <li class ='fixedDim' value='2' title='数值'><div class='num-pic'></div><span>数值</span></li>"}if(az==""||(az!=null&&"月份".indexOf(az)>-1)){ax+=" <li class ='fixedDim' value='4' title='月份'><div class='month-pic'></div>月份</li>"}if(az==""||(az!=null&&"日期".indexOf(az)>-1)){ax+=" <li class ='fixedDim' value='6' title='日期'><div class='date-pic'></div>日期</li>"}if(az==""||(az!=null&&"时间".indexOf(az)>-1)){ax+=" <li class ='fixedDim' value='7' title='时间'><div class='time-pic'></div>时间</li>"}if(az==""||(az!=null&&"字符".indexOf(az)>-1)){ax+=" <li class ='fixedDim' value='9' title='字符'><div class='char-pic'></div>字符</li>"}if(az==""||(az!=null&&"省份".indexOf(az)>-1)){ax+=" <li class ='fixedDim' value='A' title='省份'><div class='province-pic'></div>省份</li>"}if(az==""||(az!=null&&"地市".indexOf(az)>-1)){ax+=" <li class ='fixedDim' value='B' title='地市'><div class='city-pic'></div>地市</li>"}if(az==""||(az!=null&&"区县".indexOf(az)>-1)){ax+=" <li class ='fixedDim' value='C' title='区县'><div class='county-pic'></div>区县</li>"}ax+=" <li class='divider'></li>";return ax}function h(ay,ax,az){var aw="";if(az==""||(az!=null&&"数值".indexOf(az)>-1)){aw+=" <li class ='fixedDim' value='2' title='数值'><div class='num-pic'></div><span>数值</span></li>"}if(az==""||(az!=null&&"字符".indexOf(az)>-1)){aw+=" <li class ='fixedDim' value='9' title='字符'><div class='char-pic'></div>字符</li>"}aw+=" <li class='divider'></li>";return aw}function d(aB,aC,ay){var az=null;var aF=null;if(aB=="1"){az=jQuery(".tip-yellowsimple #dimSelect");az.empty()}else{if(aB=="2"){aF=jQuery(".tip-yellowsimple #dimOtherSelect");aF.empty()}else{az=jQuery("#dimSelect");az.empty();aF=jQuery("#dimOtherSelect");aF.empty()}}var aE=Z(aB,aC,ay);if(aB=="2"||aB=="3"){var ax=h(aB,aC,ay)}var aG=0;if(aC!=null&&aC!=""){var aw=null;var aD=null;aG=aC.length;for(var aA=0;aA<aG;aA++){aw=aC[aA].name;aD=aC[aA].value;aE+=" <li value="+aD+" title="+aw+"><div class='dim-pic'></div>"+aw+"</li>";if(aB=="2"||aB=="3"){ax+=" <li value="+aD+" title="+aw+"><div class='dim-pic'></div>"+aw+"</li>"}}}if(aB=="1"||aB=="3"){az.append(aE)}if(aB=="2"||aB=="3"){aF.append(ax)}if(aG*30>200){jQuery("#dim-select").height(360)}if(aB=="2"||aB=="3"){if((aG-3)*30>200){jQuery("#dim-other-select").height(360)}}}function C(ax,aE){if(jQuery("#columnOper")){jQuery("#columnOper").empty()}d("3",aE,"");var aG=[];var aA=ax.length;var az=jQuery(window).width()*0.94;var ay=200;if(aA*ay<az){ay=Math.floor(az/aA)}var aH=null;var aC=null;var aI=null;var aw=null;var aF=null;var aJ=null;var aD="<div id='columnOper'></div>";for(var aB=0;aB<aA;aB++){aI=ax[aB].columnFilterTypeName;aH=ax[aB].columnLabel;aw=ax[aB].filterType;aJ=ax[aB].attrClass;if(typeof(aI)=="undefined"){aI="字符"}if(aw=="2"){aF="right"}else{aF="left"}if(aJ=="0"){aC="<div id='dim'><span title="+aI+" class='dimText'>"+aI+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+aH+aD}else{aC="<div id='dimOther'><span title="+aI+" class='dimText'>"+aI+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+aH+aD}aG.push({label:aC,name:aH,align:aF,hlign:"center",sortable:false,width:ay})}return aG}function e(){if(!jQuery("#dataGrid").is(":empty")){jQuery.jgrid.gridUnload("dataGrid")}J=C(q.attrData,q.dimData);an={datatype:"local",styleUI:"Bootstrap",regional:"cn",data:q.columnData,colModel:J,rownumbers:true,autowidth:true,shrinkToFit:false,height:"auto",footerrow:true,loadComplete:function(){jQuery("#dataInfo #dimOther").parent().parent().css("background-color","#DAE9E9");if(q.footerData.length<1){jQuery(".data-info-grid .ui-jqgrid-sdiv").hide()}else{jQuery(".data-info-grid .ui-jqgrid-sdiv").show();var aA={};var ax=q.footerData.length;var aw=null;for(var az=0;az<ax;az++){aw=q.footerData[az];aA[aw.name]=aw.desc}jQuery(this).footerData("set",aA)}var ay=jQuery(this).parents().find(".data-info-grid th");ay.click(function(){q.currentColNum=jQuery(this)[0].cellIndex;var aC=jQuery(this);var aB=jQuery(aC).attr("id");jQuery("th").removeClass("jqgrid-underline");jQuery("th[id="+aB+"]").addClass("jqgrid-underline");D()});ay.find("#dim").on("click",function(){q.currentColNum=jQuery(this).parent().parent()[0].cellIndex;var aB=q.attrData[q.currentColNum-1].filterType;ay.find("#dim").poshytip("hide");jQuery(this).poshytip({className:"tip-yellowsimple",content:jQuery("#dim-select").outerHTML(),showTimeout:1,alignTo:"target",alignX:"bottom",alignY:"bottom",showOn:"none",offsetY:5,offsetX:-128,keepInViewport:false});jQuery(this).poshytip("show");jQuery(".tip-yellowsimple #dim-select li[value='"+aB+"']").prepend("<i class='fa fa-check dimItemsCheck'></i>");jQuery(".tip-yellowsimple #dim-select li[value='"+aB+"']").css("background-color","#2CC2A7");jQuery(".tip-yellowsimple #dim-select").niceScroll();jQuery(".tip-yellowsimple").on("click","#dimSelect li",function(){a(jQuery(this).attr("value"),jQuery(this).text())});ac.stopBubble(event)});ay.find("#dimOther").on("click",function(){q.currentColNum=jQuery(this).parent().parent()[0].cellIndex;var aB=q.attrData[q.currentColNum-1].filterType;ay.find("#dimOther").poshytip("hide");jQuery(this).poshytip({className:"tip-yellowsimple",content:jQuery("#dim-other-select").outerHTML(),showTimeout:1,alignTo:"target",alignX:"bottom",alignY:"bottom",showOn:"none",offsetY:5,offsetX:-128,keepInViewport:false});jQuery(this).poshytip("show");jQuery(".tip-yellowsimple #dim-other-select li[value='"+aB+"']").prepend("<i class='fa fa-check dimItemsCheck'></i>");jQuery(".tip-yellowsimple #dim-other-select li[value='"+aB+"']").css("background-color","#2CC2A7");jQuery(".tip-yellowsimple #dim-other-select").niceScroll();jQuery(".tip-yellowsimple").on("click","#dimOtherSelect li",function(){a(jQuery(this).attr("value"),jQuery(this).text())});ac.stopBubble(event)});ay.find("#columnOper").on("click",function(){ay.find("#columnOper").poshytip("hide");jQuery(this).poshytip({className:"tip-yellowsimple",content:jQuery("#columnOperMenu").outerHTML(),showTimeout:1,alignTo:"target",alignX:"bottom",alignY:"bottom",showOn:"none",offsetY:6,offsetX:-82,keepInViewport:false});jQuery(this).poshytip("show");q.currentColNum=jQuery(this).parent().parent()[0].cellIndex;jQuery("#columnOperMenu .addLeftColumn").on("click",N);jQuery("#columnOperMenu .addRightColumn").on("click",ae);jQuery("#columnOperMenu .delThecolumn").on("click",m);ac.stopBubble(event)})}};jQuery("#dataGrid").jqGrid(an);$(window).resize(function(){z()})}function D(){var aw=q.attrData[q.currentColNum-1];if(aw.attrClass=="1"){ap=q.currentColNum;jQuery("#colNameSpan").text(aw.columnLabel);if(aw.fieldName!=""){jQuery("#funcTxt").val(aw.funcLabel)}jQuery(".funcForm").slideDown()}else{ap=null;jQuery("#funcTxt").val("");jQuery(".funcForm").slideUp()}}function af(ax){var aA=q.attrData;var aB=q.columnNum;var az=null;var aw=false;for(var ay=0;ay<aB;ay++){if(ay!=ax){az=aA[ay];if("A"==az.filterType||"B"==az.filterType){aw=true;break}}}return aw}function X(az,aw,ay){var ax=ac.handleUrlParam("/platform/resmanage/data/data-select-city");bi.dialog.show({title:ac.getMessage("data.import.title.selectProAndCity"),message:jQuery('<div id="selectProvinceOrCity"></div>').load(ax),spinicon:"glyphicon glyphicon-refresh",cssClass:"data-selectProvinceOrCity",onshown:function(aA){M.init()},buttons:[{label:ac.getMessage("data.import.label.sure"),cssClass:"btn-info",action:function(aA){var aB=M.saveSelect();if(aB.flag){q.attrData[az].superRange=aB.selectValue;aA.close();ar(az,aw,ay)}}},{label:ac.getMessage("data.import.label.cancel"),cssClass:"btn-default",action:function(aA){aA.close()}}]})}function aq(aw){var az=q.attrData;var aA=q.columnNum;var ay=null;for(var ax=0;ax<aA;ax++){if(ax!=aw){ay=az[ax];if("C"==ay.filterType){if(typeof(ay.superRange)!="undefined"&&ay.superRange!=""){ay.superRange=""}}}}}function a(aE,ax){w=jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft();var aD=q.currentColNum-1;var aA={};aA.selectValue=aE;aA.selectName=ax;var aw=q.attrData[aD];aA.columnLabel=aw.columnLabel;aA.colLength=aw.colLength;aA.colScale=aw.colScale;aA.fieldName=aw.fieldName;aA.dataId=q.dataId;var aB=aw.originFilterType;var aC=aw.filterType;var ay=aE;var az=true;if(aw.attrClass=="1"){if(typeof(aw.fieldName)=="undefined"||aw.fieldName==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.no")+" "+aw.columnLabel+" "+ac.getMessage("data.import.message.customChangeFilter")});return}}if(aB=="9"||aB=="4"||aB=="6"||aB=="7"){if(ay=="2"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.cannotChange")+x(aB)+",不可切换成数值！"});return}}if(aC!=aE){if(ay=="2"||ay=="4"||ay=="6"||ay=="7"||ay=="9"||ay=="A"||ay=="B"||ay=="C"){if(ay=="C"){az=af(aD);if(!az){X(aD,aA,aw)}}else{if(ay=="A"||ay=="B"){aq(aD)}}if(az){ar(aD,aA,aw)}}else{g(aD,aA,aw)}}}function ar(ay,aw,ax){ac.ajax({url:ac.handleUrlParam("/platform/resmanage/data/change-column-type"),data:{changeData:JSON.stringify(aw),columnData:JSON.stringify(q.columnData),type:"2"},loading:{title:ac.getMessage("data.import.title.execute"),text:ac.getMessage("data.import.text.loading")},success:function(aC){if(aC.resFlag=="success"){jQuery.jgrid.gridUnload("dataGrid");q.columnData=aC.columnDatas;ax.filterType=aw.selectValue;ax.attrType=aC.attrType;ax.colLength=aC.colLength;ax.colScale=aC.colScale;ax.columnType=aC.columnType;ax.columnFilterTypeName=aC.columnFilterTypeName;var az="<div id='columnOper'></div>";var aD=null;if(ax.attrClass=="0"){aD="<div id='dim'><span title="+aw.selectName+" class='dimText'>"+aw.selectName+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+aw.columnLabel+az}else{aD="<div id='dimOther'><span title="+aw.selectName+" class='dimText'>"+aw.selectName+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+aw.columnLabel+az}var aA=an.colModel;var aB=null;if(ax.filterType=="2"){aB="right"}else{aB="left"}aA[ay].label=aD;aA[ay].align=aB;an.colModel=aA;an.data=q.columnData;jQuery("#dataGrid").jqGrid(an)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.restoreData")})}z();G()},error:function(az){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:az.responseText||ac.getMessage("data.import.message.dataGenerationError")})}})}function x(ax){var aw="";if(ax=="2"){aw="数值"}else{if(ax=="4"){aw="月份"}else{if(ax=="6"){aw="日期"}else{if(ax=="7"){aw="时间"}else{if(ax=="9"){aw="字符"}}}}}return aw}function g(ay,aw,ax){ax.filterType=aw.selectValue;ac.ajax({url:ac.handleUrlParam("/platform/resmanage/data/dim-change"),data:{changeData:JSON.stringify(aw),columnData:JSON.stringify(q.columnData)},loading:{title:ac.getMessage("data.import.title.execute"),text:ac.getMessage("data.import.text.loading")},success:function(aB){if(aB.resFlag=="success"){jQuery.jgrid.gridUnload("dataGrid");q.columnData=aB.columnData;ax.filterType=aw.selectValue;ax.columnFilterTypeName=aw.selectName;var az="<div id='columnOper'></div>";var aC=null;if(ax.attrClass=="0"){aC="<div id='dim'><span title="+aw.selectName+" class='dimText'>"+aw.selectName+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+aw.columnLabel+az}else{aC="<div id='dimOther'><span title="+aw.selectName+" class='dimText'>"+aw.selectName+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+aw.columnLabel+az}var aA=an.colModel;aA[ay].label=aC;aA[ay].align="left";an.colModel=aA;an.data=q.columnData;jQuery("#dataGrid").jqGrid(an)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.restoreData")})}z();G()},error:function(az){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.dataGenerationError")})}})}function K(){var aw=jQuery.trim(jQuery("#funcTxt").val());if(aw==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.inputFunc")});return}if(ap==null){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.selectCustomColumn")});return}q.funcTxt=aw;at(ap)}function at(aw){w=jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft();ac.ajax({url:ac.handleUrlParam("/platform/resmanage/data/process-func"),data:{dataId:q.dataId,columnIndex:aw,funcTxt:q.funcTxt,attrData:JSON.stringify(q.attrData),columnData:JSON.stringify(q.columnData)},loading:{title:ac.getMessage("data.import.title.execute"),text:ac.getMessage("data.import.text.loading")},success:function(ay){if(ay.resFlag=="success"){jQuery.jgrid.gridUnload("dataGrid");q.columnData=ay.columnDatas;var ax=q.attrData[ap-1];ax.funcLabel=q.funcTxt;ax.fieldName=ay.fileName;ax.attrType=ay.attrType;ax.originAttrType=ay.attrType;ax.columnType=ay.columnType;ax.originColumnType=ay.columnType;ax.filterType=ay.filterType;ax.originFilterType=ay.filterType;ax.colLength=ay.colLength;ax.originColLength=ay.colLength;ax.colScale=ay.colScale;ax.originColScale=ay.colScale;ax.columnFilterTypeName=ay.columnFilterTypeName;J=C(q.attrData,q.dimData);an.colModel=J;an.data=q.columnData;jQuery("#dataGrid").jqGrid(an)}else{jQuery.jgrid.gridUnload("dataGrid");var ax=q.attrData[ap-1];ax.fieldName="";ax.funcLabel="";J=C(q.attrData,q.dimData);an.colModel=J;an.data=q.columnData;jQuery("#dataGrid").jqGrid(an);if(ay.resFlag=="filterFail"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ay.msg})}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.reEnterFunc")})}}z();G()},error:function(ax){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.processFunError")})}})}function j(az,aD,aw){w=jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft();var aA=jQuery("#dataGrid").jqGrid("getRowData");var aC=[];var aB=null;for(var ay=0;ay<aA.length;ay++){aB={};for(var ax=0;ax<aD;ax++){if(ax>az){aB[aw[ax]]=aA[ay][aw[ax-1]]}else{aB[aw[ax]]=aA[ay][aw[ax]]}}aB[aw[az]]="";aC.push(aB)}q.attrData=i(q.attrData,az);jQuery.jgrid.gridUnload("dataGrid");q.columnData=aC;J=C(q.attrData,q.dimData);an.colModel=J;an.data=q.columnData;jQuery("#dataGrid").jqGrid(an);z();G()}function G(){w=w;jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft(w)}function i(aA,ay){var aC=q.columnNum;var aw=null;var az=null;var aB=null;for(var ax=0;ax<aC;ax++){aw=aA[ax];az=aw.attrClass;if(az=="1"&&ay!=ax){aB=aw.funcLabel;if(typeof(aB)!="undefined"&&aB!=""){aw.funcLabel=A(aB,ay,aC)}}}return aA}function A(aB,ax,aF){var aw=v(aF);var aE=null;var aD=null;var aG=null;var aC=-1;var az=0;var ay=/[A-Z]$/;for(var aA=ax;aA<aF;aA++){az=aB.length;aE="$"+aw[aA];aG="$()"+aw[aA+1];aC=aB.indexOf(aE);if(aC>-1){if(aC+3<=az){aD=aB.substr(aC,3);if(ay.test(aD)){if(aB.substr(aC+1,2)==aw[aA]){aB=aB.replace(new RegExp("\\"+aD,"g"),aG)}}else{aB=aB.replace(new RegExp("\\"+aE,"g"),aG)}}else{if(aC+2==az){aB=aB.replace(new RegExp("\\"+aE,"g"),aG)}}}}aB=aB.replace(new RegExp("\\$\\(\\)","g"),"$");return aB}function N(){var aB=q.columnNum+1;q.columnNum=aB;var ay=q.currentColNum-1;var aw=v(aB);var aA={orderId:ay+1,columnLabel:aw[ay],attrType:"3",filterType:"9",attrClass:"1",isUsed:"1"};var az={name:aw[ay],desc:""};for(var ax=0;ax<aB;ax++){if(ax==ay){q.attrData.insert(ax,aA);q.footerData.insert(ax,az)}else{if(ax>ay){q.attrData[ax].orderId=ax+1;q.attrData[ax].columnLabel=aw[ax];q.footerData[ax].name=aw[ax]}}}j(ay,aB,aw)}function v(aC){var aw=new Array();var aB="A";var aA=aB.charCodeAt();var ax=0;var az=0;for(var ay=0;ay<aC;ay++){if(ay<26){aw.push(String.fromCharCode(aA+ay)+"")}else{ax=Math.floor(ay/26);if((ax-1)>0){az=ay-26*ax}aw.push(aw[ay-25*ax-az-1]+aw[ay-26*ax]);az++}}return aw}function ae(){var aB=q.columnNum+1;q.columnNum=aB;var ay=q.currentColNum;var aw=v(aB);var aA={orderId:ay+1,columnLabel:aw[ay],attrType:"3",filterType:"9",attrClass:"1",isUsed:"1"};var az={name:aw[ay],desc:""};for(var ax=0;ax<aB;ax++){if(ax==ay){q.attrData.insert(ax,aA);q.footerData.insert(ax,az)}else{if(ax>ay){q.attrData[ax].orderId=ax+1;q.attrData[ax].columnLabel=aw[ax];q.footerData[ax].name=aw[ax]}}}j(ay,aB,aw)}function m(){if(q.attrData[q.currentColNum-1].attrClass=="0"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.notDelCustomColumn")});return}var az="$"+q.attrData[q.currentColNum-1].columnLabel;var ax=null;var aw=null;var aB=null;var aA=[];for(var ay=0;ay<q.columnNum;ay++){ax=q.attrData[ay];if(ay!=q.currentColNum-1&&ax.attrClass=="1"){aB=ax.funcLabel;aw=ax.columnLabel;if(typeof(aB)!="undefined"&&aB!=""){if(aB.indexOf(az)>=0){aA.push(aw)}}}}if(aA.length>0){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.delColumnConfirm")+aA+ac.getMessage("data.import.message.quoteColumn")});return}bi.dialog.confirm({title:ac.getMessage("data.import.text.delColumn"),message:ac.getMessage("data.import.message.delColumnConfirm"),callback:function(aC){if(aC){var aG=q.columnNum-1;var aF=q.currentColNum-1;q.columnNum=aG;var aD=v(aG+1);for(var aE=0;aE<aG+1;aE++){if(aE==aF){q.attrData.splice(aE,1);q.footerData.splice(aE,1)}else{if(aE>aF){q.attrData[aE-1].orderId=aE;q.attrData[aE-1].columnLabel=aD[aE-1];q.footerData[aE-1].name=aD[aE-1]}}}o(aF,aG,aD)}}})}function o(az,aD,aw){jQuery(".funcForm").slideUp();w=jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft();var aA=jQuery("#dataGrid").jqGrid("getRowData");var aC=[];var aB=null;for(var ay=0;ay<aA.length;ay++){aB={};for(var ax=0;ax<aD;ax++){if(ax>=az){aB[aw[ax]]=aA[ay][aw[ax+1]]}else{aB[aw[ax]]=aA[ay][aw[ax]]}}aC.push(aB)}jQuery.jgrid.gridUnload("dataGrid");q.attrData=k(q.attrData,az);q.columnData=aC;J=C(q.attrData,q.dimData);an.colModel=J;an.data=q.columnData;jQuery("#dataGrid").jqGrid(an);z();G()}function k(aA,ay){var aC=q.columnNum;var aw=null;var az=null;var aB=null;for(var ax=0;ax<aC;ax++){aw=aA[ax];az=aw.attrClass;if(az=="1"&&ay!=ax){aB=aw.funcLabel;if(typeof(aB)!="undefined"&&aB!=""){aw.funcLabel=F(aB,ay,aC)}}}return aA}function F(aB,ax,aF){var aw=v(aF+1);var aE=null;var aD=null;var aG=null;var aC=-1;var az=0;var ay=/[A-Z]$/;for(var aA=ax;aA<aF+1;aA++){az=aB.length;aE="$"+aw[aA];aG="$()"+aw[aA-1];aC=aB.indexOf(aE);if(aC>-1){if(aC+3<=az){aD=aB.substr(aC,3);if(ay.test(aD)){if(aB.substr(aC+1,2)==aw[aA]){aB=aB.replace(new RegExp("\\"+aD,"g"),aG)}}else{aB=aB.replace(new RegExp("\\"+aE,"g"),aG)}}else{if(aC+2==az){aB=aB.replace(new RegExp("\\"+aE,"g"),aG)}}}}aB=aB.replace(new RegExp("\\$\\(\\)","g"),"$");return aB}function n(){p(1);jQuery("#dataInfo").addClass("hide");jQuery("#tableInfo").removeClass("hide")}function ah(){for(var aw=0;aw<q.columnNum;aw++){if(q.attrData[aw].attrClass=="1"){if(typeof(q.attrData[aw].fieldName)=="undefined"||q.attrData[aw].fieldName==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.no")+" "+q.attrData[aw].columnLabel+" 列是自定义列,该列还没有生成数据,请输入函数生成该列数据或选择删除该列！"});return}}}p(3);jQuery("#oneStep").addClass("active-Finished");jQuery("#twoStep").addClass("active-Finished");if(jQuery("#thirdStep").hasClass("active-Finished")){jQuery("#thirdStep").removeClass("active-Finished")}jQuery("#thirdStep").removeClass("active-notFinished");jQuery("#dataInfo").addClass("hide");jQuery("#fieldInfo").removeClass("hide");c()}function c(){if(!jQuery("#fieldGrid").is(":empty")){jQuery.jgrid.gridUnload("fieldGrid")}ac.ajax({url:ac.handleUrlParam("/platform/resmanage/data/data-common-field"),data:{attrData:JSON.stringify(q.attrData)},success:function(aw){if(aw.resFlag=="success"){ad(aw)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.queryDataFail")});return}},error:function(aw){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:aw.responseText||ac.getMessage("data.import.message.queryFieldFail")})}})}function ad(ax){var aw=ax.columnData;jQuery("#fieldGrid").jqGrid({datatype:"local",styleUI:"Bootstrap",data:aw,regional:"cn",autowidth:true,height:"auto",rowNum:100000,colModel:[{label:ac.getMessage("data.import.label.columnLabel"),name:"columnLabel",align:"center",hlign:"center",width:50,sortable:false,},{label:ac.getMessage("data.import.label.fieldName"),name:"fieldName",align:"left",hlign:"center",sortable:false},{label:ac.getMessage("data.import.label.attrName"),name:"attrName",align:"center",hlign:"center",sortable:false,editable:true,edittype:"text"},{label:ac.getMessage("data.import.label.groupName"),name:"groupName",align:"center",hlign:"center",sortable:false,editable:true},{name:"groupId",align:"center",hlign:"center",hidden:true},{label:ac.getMessage("data.import.label.attrType"),name:"attrType",align:"center",hlign:"center",sortable:false,formatter:"select",editoptions:{value:ac.getMessage("data.import.label.attrTypeFormat")}},{label:ac.getMessage("data.import.label.isUsed")+':<i class="fa fa-square-o check-box" id="allCheck"></i>)',name:"isUsed",align:"center",hlign:"center",sortable:false,formatter:function(ay,az,aB){var aA="";if(ay=="1"){aA='<i class="fa fa-check-square-o check-box" id="usedCheck" value="1"></i>'}else{aA='<i class="fa fa-square-o check-box" id="usedCheck" value="0"></i>'}return aA}}],loadComplete:function(){var ay=jQuery(this).parents().find(".field-info-grid th #allCheck");var aA=jQuery(this).parents().find(".field-info-grid td #usedCheck");ay.on("click",function(){var aD=jQuery(this).hasClass("fa-square-o");if(aD){jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o");aA.removeClass("fa-square-o");aA.removeClass("fa-check-square-o");aA.addClass("fa-check-square-o");aA.attr("value","1")}else{jQuery(this).removeClass("fa-check-square-o");jQuery(this).addClass("fa-square-o");aA.removeClass("fa-square-o");aA.removeClass("fa-check-square-o");aA.addClass("fa-square-o");aA.attr("value","0")}});aA.on("click",function(){ay.removeClass("fa-check-square-o");ay.addClass("fa-square-o");var aD=jQuery(this).hasClass("fa-square-o");if(aD){jQuery(this).attr("value","1");jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o")}else{jQuery(this).attr("value","0");jQuery(this).removeClass("fa-check-square-o");jQuery(this).addClass("fa-square-o")}ac.stopBubble(event)});for(var az=2;az<=q.columnNum;az++){$("#fieldGrid").jqGrid("editRow",az,false);var aB=jQuery(this).find("#"+az+"_groupName");aB.attr("readOnly",true);V(aB)}$("#fieldGrid").jqGrid("editRow",1,false);var aC=jQuery(this).find("#1_groupName");aC.attr("readOnly",true);V(aC)}});f();$(window).resize(function(){f()})}function V(aw){jQuery(aw).treeselect({height:200,chkStyle:"radio",searchAjaxParam:"groupName",width:(jQuery(aw).width()+25),url:ac.handleUrlParam("/platform/resmanage/data/data-query-group")})}function am(){p(2);jQuery("#fieldInfo").addClass("hide");jQuery("#dataInfo").removeClass("hide")}function ao(az){var aA=0;var aw=az.length;var ax=-1;for(var ay=0;ay<aw;ay++){ax=az.charCodeAt(ay);if(ax>=0&&ax<=128){aA+=1}else{aA+=3}}return aA}function t(){var aD=0;var aA=[];for(var aC=1;aC<=q.columnNum;aC++){var ay=jQuery("#fieldGrid").jqGrid("getRowData",aC);var aE=jQuery(".field-info-grid #fieldGrid #"+aC+" .fa").attr("value");var aF=jQuery("#"+aC+"_attrName").val();var aB=null;if(typeof(jQuery("#"+aC+"_groupName").attr("trueValue"))=="undefined"){aB=ay.groupId}else{aB=jQuery("#"+aC+"_groupName").attr("trueValue")}if(aE=="1"){if(aF==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.no")+" "+ay.columnLabel+" "+ac.getMessage("data.import.message.columnEmpty")});return}}if(aF!=""){var aH=ao(aF);if(aH>90){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.no")+" "+ay.columnLabel+" "+ac.getMessage("data.import.message.columnLength")});return}}if(aE=="0"){aD++}if(aE=="1"){for(var az in aA){if(aA[az]==aF){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.no")+" "+ay.columnLabel+" "+ac.getMessage("data.import.message.columnRepet")});return}}}aA.push(aF);q.attrData[aC-1].isUsed=aE;q.attrData[aC-1].attrName=aF;q.attrData[aC-1].groupId=aB}if(aD==q.columnNum){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.selectUsedColumn")});return}p(4);jQuery("#oneStep").addClass("active-Finished");jQuery("#twoStep").addClass("active-Finished");jQuery("#thirdStep").addClass("active-Finished");if(jQuery("#fourStep").hasClass("active-Finished")){jQuery("#fourStep").removeClass("active-Finished")}jQuery("#fourStep").removeClass("active-notFinished");jQuery("#fieldInfo").addClass("hide");jQuery("#completeInfo").removeClass("hide");if(au=="add"){jQuery("#dbName_finish").html(dataBaseName)}else{jQuery("#dbName_finish").html(q.dataBaseName)}jQuery("#dataTable_finish").html(q.dataTable);jQuery("#dataName_finish").html(q.dataName);var ax=jQuery("#splitType").find("option:selected").text();var aG=jQuery("#updatePeriod").find("option:selected").text();var aw=jQuery("#storageType").find("option:selected").text();jQuery("#splitType_finish").html(ax);jQuery("#updatePeriod_finish").html(aG);jQuery("#tableDesc_finish").html(q.tableDesc);if(q.classifyName==null||q.classifyName==""){q.classifyName="无"}jQuery("#classify_finish").html(q.classifyName);if(q.updatePeriod!="I"){jQuery("#xxgxsj_finish").removeClass("hide");jQuery("#sjxz_finish").removeClass("hide");jQuery("#nextUpdateTime_finish").html(q.nextUpdateTime);if(q.updatePeriod=="D"||q.updatePeriod=="W"||q.updatePeriod=="M"){jQuery("#ccfs_finish").removeClass("hide");jQuery("#ccxz_finish").removeClass("hide");jQuery("#storageType_finish").html(aw)}else{jQuery("#ccfs_finish").addClass("hide");jQuery("#ccxz_finish").addClass("hide")}}else{jQuery("#xxgxsj_finish").addClass("hide");jQuery("#sjxz_finish").addClass("hide");jQuery("#ccfs_finish").addClass("hide");jQuery("#ccxz_finish").addClass("hide")}u()}function u(){ac.ajax({url:ac.handleUrlParam("/platform/resmanage/data/query-last-column"),loading:{title:ac.getMessage("data.import.title.execute"),text:ac.getMessage("data.import.text.configLoading")},data:{dataId:q.dataId,attrData:JSON.stringify(q.attrData),columnData:JSON.stringify(q.columnData)},success:function(aw){if(aw.resFlag=="success"){q.columnData=aw.columnData;P()}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.queryDataFail")});return}},error:function(aw){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:aw.responseText||ac.getMessage("data.import.message.queryDataError")})}})}function P(){var az=q.attrData;var aE=q.columnData;var aH=az.length;var ay=$(".complete-info-grid").width()-45;var ax=180;if(aH*ax<ay){ax=Math.floor(ay/aH)}var aG=[];var aB=null;var aw=null;var aF=null;var aD=null;for(var aA=0;aA<aH;aA++){aB=az[aA];aD=aB.isUsed;if(aD=="1"){aw=aB.filterType;if(aw=="2"){aF="right"}else{aF="left"}aG.push({label:aB.attrName,name:aB.columnLabel,align:aF,hlign:"center",sortable:false,width:ax})}}var aC={datatype:"local",data:aE,styleUI:"Bootstrap",colModel:aG,regional:"cn",rownumbers:true,shrinkToFit:false,autowidth:true,height:"auto"};if(jQuery("#completeGrid").is(":empty")){jQuery("#completeGrid").jqGrid(aC)}else{jQuery.jgrid.gridUnload("completeGrid");jQuery("#completeGrid").jqGrid(aC)}Q();$(window).resize(function(){Q()})}function aa(){bi.dialog.confirm({title:ac.getMessage("data.import.title.saveData"),message:ac.getMessage("data.import.message.savaDataConfirm"),callback:function(aw){if(aw){B()}}})}function B(){var aM={dbId:q.dbId,dataTable:q.dataTable,dataName:q.dataName,splitType:q.splitType,updatePeriod:q.updatePeriod,storageType:q.storageType,tableDesc:q.tableDesc,dataId:q.dataId,nextUpdateTime:q.nextUpdateTime,attrData:JSON.stringify(q.attrData),importStateType:b,classifyId:q.classifyId};var az=ac.handleUrlParam("/platform/resmanage/data/save-dacp-table-info");if(au=="edit"){U=[];R=[];av=[];var aG=q.attrData;var ax=aG.length;var aA=null;var aw=null;var aD=null;var aB=null;var aC={};for(var aJ=0;aJ<ax;aJ++){aA=aG[aJ].filterType;aw=aG[aJ].fieldName;U.push(aA);R.push(aw);aD=aG[aJ].attrId;aB=aG[aJ].dimId;aC={attrId:aD,filterType:aA,dimId:aB};av.push(aC)}if(al.toString()!=U.toString()||ab.toString()!=R.toString()){aM.importStateType="1"}az=ac.handleUrlParam("/platform/resmanage/data/save-table-data")}if(aM.importStateType=="1"){var aE=r.length;var aK=av.length;var aC={};var aL={};var aD=null;var aH=null;var aA=null;var aN=null;var aB=null;var ay=null;var aI=false;for(var aJ=0;aJ<aK;aJ++){aC=av[aJ];aD=aC.attrId;aA=aC.filterType;aB=aC.dimId;if(aD!=null){for(var aF=0;aF<aE;aF++){aL=r[aF];aH=aL.attrId;aN=aL.filterType;if(aD==aH){if(aA!=aN){aI=true;break}else{if(aA=="1"){if(aB!=ay){aI=true;break}}}}}}}if(aI){aM.importStateType="4"}}ac.ajax({url:az,data:aM,loading:{title:ac.getMessage("data.import.title.execute"),text:ac.getMessage("data.import.text.loading")},success:function(aO){if(aO.resFlag=="success"){ag()}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:aO.msg});return}},error:function(aO){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:ac.getMessage("data.import.title.tips"),message:aO.responseText||"数据表数据配置失败！"})}})}function ag(){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:ac.getMessage("data.import.title.tips"),message:ac.getMessage("data.import.message.savaTableData"),closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:ac.getMessage("data.import.label.sure"),cssClass:"btn-info",action:function(aw){aw.close();jQuery("#tableButton").addClass("hide");jQuery(".bottom-button-common").addClass("hide");jQuery("#completeSaveButton").addClass("hide")}},{label:ac.getMessage("data.import.label.closePage"),cssClass:"btn-default",action:function(){if(jQuery.isFunction(window.opener.reloadDataList)){window.opener.reloadDataList()}window.close()}}]})}function I(){var aw=jQuery(this).find(".step-title-num");var ax=jQuery(this).attr("id");if(aw.hasClass("active-Finished")||!aw.hasClass("active-notFinished")){if(ax=="tableTab"){p(1);jQuery("#"+T()+"").addClass("hide");jQuery("#tableInfo").removeClass("hide")}else{if(ax=="dataTab"){p(2);jQuery("#"+T()+"").addClass("hide");jQuery("#dataInfo").removeClass("hide");z()}else{if(ax=="fieldTab"){p(3);jQuery("#"+T()+"").addClass("hide");jQuery("#fieldInfo").removeClass("hide");if(jQuery("#fieldGrid").is(":empty")){c()}else{f()}}else{if(ax=="completeTab"){p(4);jQuery("#"+T()+"").addClass("hide");jQuery("#completeInfo").removeClass("hide");if(jQuery("#completeGrid").is(":empty")){u()}else{Q()}}}}}}}function z(){jQuery("#dataGrid").setGridWidth($(".data-info-grid").width()-5)}function f(){jQuery("#fieldGrid").setGridWidth($(".field-info-grid").width()-5);jQuery("#fieldGrid").setGridHeight($(".field-info-grid").height()-38)}function Q(){jQuery("#completeGrid").setGridWidth($(".complete-info-grid").width()-5)}function T(){if(jQuery(".table-info").is(":visible")){return"tableInfo"}if(jQuery(".data-info").is(":visible")){return"dataInfo"}if(jQuery(".field-info").is(":visible")){return"fieldInfo"}if(jQuery(".complete-info").is(":visible")){return"completeInfo"}}});