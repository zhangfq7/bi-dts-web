define(["sabace","dbSource","data-message","userSelect"],function(d,c,e,b){var a={};a.view={initDataManageList:function(){var h=$("#dbId").val();var i=$("#dbName").val();var g=$("#dbDesc").val();var j=$("#dbType").val();var k=$("#createTime").val();var f={};f.dbId=h;f.dbName=i;f.dbDesc=g;f.dbType=j;f.createTime=k;$("#dataListGrid").jqGrid({url:d.handleUrlParam("/platform/resmanage/db/data-manage-list"),styleUI:"Bootstrap",datatype:"json",postData:f,mtype:"post",forceFit:true,colModel:[{label:"数据名称",name:"dbName",width:75,align:"left",hlign:"center",sortable:false,formatter:function(l,m,n){if(n.addFlag=="9"){return"<span style='color: red'>"+n.dbName+"</span>"}return n.dbName}},{label:"获取方式",name:"interfaceFlag",width:75,align:"left",hlign:"center",sortable:false,formatter:function(l,m,n){if(n.interfaceFlag=="1"){if(n.addFlag=="9"){return"<span style='color: red'>接口</span>"}return"接口"}else{if(n.interfaceFlag=="2"){if(n.addFlag=="9"){return"<span style='color: red'>直连</span>"}return"直连"}else{if(n.addFlag=="9"){return"<span style='color: red'>本地</span>"}return"本地"}}}},{label:"数据描述",name:"dbDesc",width:90,align:"left",hlign:"center",sortable:false,formatter:function(l,m,n){if(n.addFlag=="9"){return"<span style='color: red'>"+n.dbDesc+"</span>"}return n.dbDesc}},{label:"数据库类型",name:"dbType",width:80,align:"left",hlign:"center",sortable:false,formatter:function(l,m,n){if(n.addFlag=="9"){return"<span style='color: red'>"+n.dbType+"</span>"}return n.dbType}},{label:"创建人",name:"createUserName",width:80,align:"left",hlign:"center",sortable:false,formatter:function(l,m,n){if(n.addFlag=="9"){return"<span style='color: red'>"+n.createUserName+"</span>"}return n.createUserName}},{label:"创建时间",name:"createTime",width:80,align:"left",hlign:"center",sortable:false,formatter:function(l,m,n){if(n.addFlag=="9"){return"<span style='color: red'>"+n.createTime+"</span>"}return n.createTime}},{label:"分享",name:"isShare",width:80,align:"left",hlign:"center",hidden:true,sortable:false},{label:"是否手工创建",name:"addFlag",width:80,ahlign:"center",hidden:true,sortable:false},{label:"操作",name:"operate",width:100,align:"center",hlign:"center",sortable:false,formatter:function(m,o,p){var n=p.dbId;if(p.interfaceFlag=="1"){return"<a href='javascript:void(0)' class='data-query' dbId='"+n+"'>查看</a> /  <a href='javascript:void(0)' class='data-number' interfaceFlag='"+p.interfaceFlag+"' dbId='"+n+"' dbName='"+p.dbName+"'>取数</a> /  "}else{if(p.isShare=="1"){return"<a href='javascript:void(0)' class='data-query' dbId='"+n+"'>查看</a> /  <a href='javascript:void(0)' class='data-number' interfaceFlag='"+p.interfaceFlag+"' dbId='"+n+"'>取数</a> "}else{var l="<a href='javascript:void(0)' class='data-query' dbId='"+n+"'>查看</a> /  ";if(p.addFlag=="1"){l+="<a href='javascript:void(0)' class='data-edit' dbId='"+n+"'>修改</a> /  "}l+="<a href='javascript:void(0)' class='data-number' interfaceFlag='"+p.interfaceFlag+"' dbId='"+n+"' dbName='"+p.dbName+"'>取数</a> /  ";if(p.addFlag=="1"||p.addFlag=="9"){l+="<a href='javascript:void(0)' class='data-del' interfaceFlag='"+p.interfaceFlag+"' dbId='"+n+"'>删除</a> "}return l}}}}],viewrecords:true,autowidth:true,height:"auto",rowNum:10,rowList:[10,20,30],rownumbers:true,pager:"#dataListGridPager",jsonReader:{records:"total",total:"totalPages"},afterInsertRow:function(m,l){jQuery(this).jqGrid("setCell",rowid,"operate","<a>操作</a>")},regional:"cn"})}};a.controller={init:function(){jQuery(".data-manage-btn button").bind("click",function(){jQuery(this).removeClass("normal-button").addClass("clicked-button theme-background").siblings().addClass("normal-button").removeClass("clicked-button theme-background")});jQuery(".data-manage-btn button").on("mouseover",".normal-button",function(){jQuery(".normalButton").removeClass("theme-background");jQuery(".data-manage-btn button").addClass("theme-background")}).on("mouseleave",".normal-button",function(){jQuery(".data-manage-btn button").removeClass("theme-background")});$(window).resize(function(){d.timeout(function(){$("#dataListGrid").setGridWidth($("#listPanel").width()-5)},100)});$("#addDMButton").on("click",function(){l("add")});$("#selectDatabase").on("click",function(){bi.dialog.show({id:"createOpenApi",title:"请选择数据库",nl2br:false,cssClass:"dacp-database-list-dialog",message:jQuery('<div id="tableContainer" style="padding-right:5px;text-align:center">请稍候...</div>'),closable:true,closeByBackdrop:false,closeByKeyboard:false,onshown:function(){jQuery("#tableContainer").html('<table style="width:90%" id="dacpDatabaseTable"></table>');g()},buttons:[{label:"取消",cssClass:"btn-default",action:function(p){p.close()}}]})});jQuery("#searchButton").on("click",function(){m()});jQuery(".data-manage-btn").on("click",".btn",function(){var p=$(this).attr("flag");m(p)});function g(){jQuery("#dacpDatabaseTable").jqGrid({url:d.handleUrlParam("/platform/resmanage/db/query-dacp-database-list"),styleUI:"Bootstrap",datatype:"json",colModel:[{label:"数据库名称",name:"dbName",width:30,align:"left",sortable:false},{label:"描述",name:"dbDesc",width:30,align:"left",sortable:false},{label:"数据库类型",name:"dbType",width:17,align:"left",sortable:false},{label:"数据库用户名",name:"dbUser",width:20,align:"left",sortable:false},{label:"数据库密码",name:"dbPassword",width:17,align:"left",sortable:false},{label:"数据库连接串",name:"dbUrl",width:30,align:"left",sortable:false},{label:"数据库驱动信息",name:"dbDriver",width:30,align:"left",sortable:false},{label:"操作",name:"dbType",width:20,align:"center",sortable:false,formatter:function(p,q,r){return'<a href="javascript:void(0)" id="'+q.rowId+'" class="dacp-database-select">引用</a>'}}],autowidth:true,height:"auto",rowNum:100000,regional:"cn",loadComplete:function(p){jQuery(".dacp-database-select").on("click",function(){var q=this.id-1;var r=p[q];r.type="add";r.interfaceFlag="1";console.log(r);d.ajax({type:"post",cache:false,dataType:"json",url:d.handleUrlParam("/platform/resmanage/db/data-db-edit"),data:r,loading:{title:"请稍后...",text:"正在保存，请稍候..."},success:function(s){if(s.retFlag=="0"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"提示",message:"数据库连接信息错误",buttons:[{label:"确定",cssClass:"btn-info",action:function(t){bi.dialog.closeAll()}}]})}else{if(s.retFlag=="3"){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:"提示",message:"保存成功",buttons:[{label:"确定",cssClass:"btn-info",action:function(t){jQuery("#dataListGrid").jqGrid().trigger("reloadGrid");bi.dialog.closeAll()}}]})}else{if(s.retFlag=="4"){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:"提示",message:"您已经使用过该数据库了",buttons:[{label:"确定",cssClass:"btn-info",action:function(t){bi.dialog.closeAll()}}]})}else{if(s.retFlag=="2"){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:"提示",message:"数据库驱动不匹配",buttons:[{label:"确定",cssClass:"btn-info",action:function(t){bi.dialog.closeAll()}}]})}}}}},error:function(s){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"提示",message:s.responseText||"设置OpenApi失效异常!"})}})})}})}function o(){m()}a.view.initDataManageList();function m(q){var p={};p.dbName=$("#dbNameText").val();p.dbType=q;jQuery("#dataListGrid").jqGrid("setGridParam",{postData:p}).trigger("reloadGrid")}function i(q,p){var s={};if(p==""){s.dbId=q}else{s.dataId=p}var r=d.handleUrlParam("/platform/resmanage/data/data-table-import-direct");f(r,s)}function h(q,p){var s={};if(p==""){s.dbId=q}else{s.dataId=p}var r=d.handleUrlParam("/platform/resmanage/data/data-table-import");f(r,s)}function n(q,p,s){var t={};if(p==""){t.dbId=q;t.dbName=s}else{t.dataId=p}var r=d.handleUrlParam("/platform/resmanage/data/data-table-import-dacp");f(r,t)}function f(r,t){var s="";for(var q in t){s+="<input name='"+q+"' value='"+t[q]+"'/>"}var p=jQuery("<form></form>",{method:"post",action:r,target:"_blank",html:s});jQuery("body").append(p);p.submit();jQuery(p).remove()}function k(r,p){var q=d.handleUrlParam("/platform/resmanage/db/data-user-select");bi.dialog.show({title:"用户选择",message:jQuery('<div id="userList"></div>').load(q),spinicon:"glyphicon glyphicon-refresh",cssClass:"data-userList",onshown:function(s){b.init(r,p)},buttons:[{label:d.getMessage("data.dataLink.label.Sure"),cssClass:"btn-info",action:function(s){b.saveUserSelect()}},{label:d.getMessage("data.dataLink.label.Cancel"),cssClass:"btn-default",action:function(s){s.close()}}]})}function l(s,p){var w=d.getMessage("data.datlist.label.addDS");if(s=="edit"){w=d.getMessage("data.datlist.label.modifyDS")}else{if(s=="view"){w=d.getMessage("data.datlist.label.viewDS")}}var q=d.handleUrlParam("/platform/resmanage/db/data-db");var t=[{label:d.getMessage("data.datlist.label.nextStep"),cssClass:"btn-info",action:function(x){if(c.next()){x.setButtons(v);x.updateButtons()}}},{label:d.getMessage("data.dataLink.label.Cancel"),action:function(x){x.close()}}];var v=[{label:d.getMessage("data.datlist.label.reselection"),cssClass:"btn-info",action:function(x){c.reSelect();x.setButtons(t);x.updateButtons()}},{label:d.getMessage("data.datlist.label.test"),cssClass:"btn-info",action:function(x){c.test()}},{label:d.getMessage("data.dataLink.label.Sure"),cssClass:"btn-info",action:function(x){c.save(o)}},{label:d.getMessage("data.dataLink.label.Cancel"),action:function(x){x.close()}}];var r=[{label:"确定",cssClass:"btn-info",action:function(x){x.close()}}];var u=[{label:d.getMessage("data.datlist.label.test"),cssClass:"btn-info",action:function(x){c.test()}},{label:d.getMessage("data.dataLink.label.Sure"),cssClass:"btn-info",action:function(x){c.save(o)}},{label:d.getMessage("data.dataLink.label.Cancel"),action:function(x){x.close()}}];bi.dialog.show({title:w,message:jQuery('<div id="source"></div>').load(q),spinicon:"glyphicon glyphicon-refresh",cssClass:"data-source",closable:true,closeByBackdrop:false,closeByKeyboard:false,onshown:function(x){if(s=="add"){x.setButtons(t)}else{if(s=="edit"){x.setButtons(u)}else{if(s=="view"){x.setButtons(r)}}}c.init(s,p)}})}function j(p,q){d.ajax({url:d.handleUrlParam("/platform/resmanage/db/data-db-delete"),data:{dbId:p,interfaceFlag:q},success:function(r){if(r.resFlag=="success"){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:d.getMessage("data.dataLink.label.prompt"),message:d.getMessage("data.datlist.label.delSuccess")});o()}},error:function(r){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:d.getMessage("data.dataLink.label.prompt"),message:r.responseText||d.getMessage("data.datlist.label.delFail")})}})}$("#dataList").on("click",".data-edit",function(){var p=$(this).attr("dbId");l("edit",p)});$("#dataList").on("click",".data-query",function(){var p=$(this).attr("dbId");l("view",p)});$("#dataList").on("click",".data-number",function(){var p=$(this).attr("dbId");var r=$(this).attr("dbName");var q=$(this).attr("interfaceFlag");if(q=="1"){var r=$(this).attr("dbName");n(p,"",r)}else{if(q=="2"){i(p,"")}else{h(p,"")}}});$("#dataList").on("click",".data-grant",function(){var p=$(this).attr("dbId");k("1",p)});$("#dataList").on("click",".data-del",function(){var p=$(this).attr("dbId");var q=$(this).attr("interfaceFlag");var r="";r="该数据源删除后，与此数据源相关的工作表、视图、仪表板、维度等都将被删除，是否继续？";bi.dialog.confirm({title:"提示",message:r,callback:function(s){if(s){j(p,q)}}})})}};return a.controller});