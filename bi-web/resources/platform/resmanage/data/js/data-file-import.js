define(["sabace","upload","proviceOrCitySelect"],function(al,x,R){var aN=null;var aO=null;var a={};var ax={};var O={};var ab=null;var E=null;var aI=null;var C=0;var av="1";var ae=false;var aA=null;var m=null;var v=null;var aM=null;var ar=null;var au=[];var ad=[];var ai=[];var X=[];var d="0";var ak=true;var aq=false;var w=[];var aK=[];jQuery(function(){F();jQuery('[data-toggle="radio"]').iCheck({checkboxClass:"icheckbox_minimal",radioClass:"iradio_minimal"});jQuery(".chosen-select").chosen();aL();jQuery(".step-tab").on("click",N);jQuery("input[name='optionsRadio']").on("ifChecked",am);aP();if(opType=="edit"||opType=="append"){Z()}jQuery("#fileButton").on("click",aC);jQuery("#cancelButton").on("click",s);jQuery("#saveButton").on("click",ap);jQuery("#fieldCanButton").on("click",aw);jQuery("#fieldSaveButton").on("click",y);jQuery("#completeSaveButton").on("click",ag);u(1);jQuery("#generateData").on("click",Q);jQuery("#fileForm").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true});jQuery("#fileUploadType .txt").on("click",B);jQuery("#fileUploadType .excel").on("click",aJ);jQuery("#fileUploadType .csv").on("click",aF);jQuery(".funcForm").slideUp();jQuery("#uploadFile").on("click",ay);jQuery("#uploadCancel").on("click",aD);jQuery("#reUploadFile").on("click",aH)});function F(){document.onmousedown=function(aR){var aS=aR.target;if(aS.id=="dimName"||aS.id=="dimNameForOther"){return}if(aS.id=="dimSearch"||aS.id=="dimSearchForOther"){var aQ="1";if(aS.id=="dimSearchForOther"){aQ="2"}at(aQ);return}if(aS.id=="dim"||aS.id=="dimSelect"){jQuery(".data-info-grid th #dimOther").poshytip("hide");jQuery(".data-info-grid th #columnOper").poshytip("hide");return}if(aS.id=="dimOther"||aS.id=="dimOtherSelect"){jQuery(".data-info-grid th #dim").poshytip("hide");jQuery(".data-info-grid th #columnOper").poshytip("hide");return}if(aS.id=="columnOper"){jQuery(".data-info-grid th #dimOther").poshytip("hide");jQuery(".data-info-grid th #dim").poshytip("hide");return}if(aS==undefined||aS.id!="dim"||aS.id!="columnOper"||aS.id!="dimOther"){jQuery(".data-info-grid th #dim").poshytip("hide");jQuery(".data-info-grid th #dimOther").poshytip("hide");jQuery(".data-info-grid th #columnOper").poshytip("hide");return}}}function at(aR){var aQ=null;if(aR=="1"){aQ=jQuery(".tip-yellowsimple #dimName").val()}else{aQ=jQuery(".tip-yellowsimple #dimNameForOther").val()}al.ajax({url:al.handleUrlParam("/platform/resmanage/data/data-search-dim"),data:{dimName:aQ},success:function(aT){var aS=aT.dimList;e(aR,aS,aQ)},error:function(aS){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.queryFilterTypeError")})}})}function Z(){a.dataId=dataId;al.ajax({url:al.handleUrlParam("/platform/resmanage/data/get-file-data"),data:{dataId:a.dataId},loading:{title:al.getMessage("data.import.title.execute"),text:'<span class="f16 bolder gray">'+al.getMessage("data.import.text.fileInfoLoading")+"</span>",spin:true},success:function(aQ){if(aQ.resFlag=="success"){p(aQ)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:aQ.msg});return}},error:function(aQ){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:aQ.responseText||al.getMessage("data.import.message.queryEditDataError")})}})}function T(aQ){if(!ak){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.reUpload")})}else{if(aQ=="7"){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.lastData")})}}}function p(a0){a=a0.fileConfigBean;a.attrData=a0.attrDatas;a.columnData=a0.columnDatas;a.dimData=a0.dimDatas;a.footerData=a0.footerDatas;a.columnNum=a0.columnNum;P(a0.classifyList,false);if(a0.reUpload=="fail"){ak=false}if(a.attrData.length==0){opType="add"}else{T(a.importState);var aQ=a0.attrDatas;var aU=aQ.length;var aR=null;var a1=null;var aX=null;var a3=null;var a2={};for(var aW=0;aW<aU;aW++){aR=aQ[aW].filterType;a1=aQ[aW].fieldName;au.push(aR);ai.push(a1);aX=aQ[aW].attrId;a3=aQ[aW].dimId;a2={attrId:aX,filterType:aR,dimId:a3};w.push(a2)}jQuery("#oneStep").addClass("active-Finished");jQuery("#twoStep").removeClass("active-notFinished");jQuery("#twoStep").addClass("active-Finished");if(opType=="edit"){if(ak){jQuery("#dataInfo").removeClass("hide");jQuery("#fileInfo").addClass("hide");u(2)}}if(!ak){jQuery(".bottom-button-common").addClass("hide")}jQuery("#thirdStep").removeClass("active-notFinished");jQuery("#thirdStep").addClass("active-Finished");jQuery("#fourStep").removeClass("active-notFinished");jQuery("#fourStep").addClass("active-Finished");jQuery(".main-panel").removeClass("hide");f();var aT=a.dataName;E=aT;var aS=a.dataNum;var aZ=a.dataDesc;aI=aZ;jQuery("#dataName").val(aT);jQuery("#dataNum").val(aS);jQuery("#recordNum").val(aS);jQuery("#dataDesc").val(aZ);jQuery("#dataName_finish").html(aT);jQuery("#dataNum_finish").html(aS);jQuery("#recordNum_finish").html(aS);jQuery("#dataDesc_finish").html(aZ);var aV=a.classifyId;a.classifyId=aV;jQuery("#classifySel").val(aV);jQuery("#classifySel").trigger("chosen:updated");var aY=jQuery("#classifySel").find("option:selected").text();if(aY==null||aY==""){aY="无"}a.classifyName=aY;jQuery("#classify_finish").html(aY)}}function B(){jQuery("#filePicker input:file").attr("accept",".txt");jQuery("#filePicker input:file").trigger("click")}function aJ(){jQuery("#filePicker input:file").attr("accept",".xls,.xlsx");jQuery("#filePicker input:file").trigger("click")}function aF(){jQuery("#filePicker input:file").attr("accept",".csv");jQuery("#filePicker input:file").trigger("click")}function aL(){m={background:"rgba(244, 244, 244, 0.51)",lines:11,length:11,width:5,radius:14,color:"#fff",corners:1,rotate:0,direction:1,speed:1,trail:60,shadow:true,hwaccel:false,className:"spinner",zIndex:2000000000,top:"50%",left:"50%"};v=jQuery("<div>",{id:"fileSpin",css:{position:"absolute",bottom:0,right:0,left:0,top:0,background:m.background,"z-index":99999999,display:"none"}});aM=m.width+m.length+m.radius;ar=jQuery("<div>",{id:"fileSpinText",html:'<span class="f16 bolder gray">文件上传完成,正在校验文件,请稍后...</span>',css:{position:"absolute","min-width":"400px",top:"50%",left:"50%",color:"#fff","margin-top":aM+10,"margin-left":"-200px","text-align":"center"}})}function aP(){if(!WebUploader.Uploader.support()){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.updateFlashPlayer")});throw new Error("WebUploader does not support the browser you are using.")}aN=WebUploader.create({pick:{id:"#filePicker",label:al.getMessage("data.import.uploader.label")},dnd:".file-block",accept:{title:"doc",extensions:"txt,xls,csv,xlsx",mimeTypes:["text/plain","application/vnd.ms-excel","text/csv","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].join(",")},swf:resPath+"/bace/js/webuploader/swf/Uploader.swf",disableGlobalDnd:true,chunked:false,server:al.handleUrlParam("/platform/resmanage/data/data-file-upload"),auto:false,resize:false,threads:1,fileNumLimit:1,fileSizeLimit:500*1024*1024,fileSingleSizeLimit:500*1024*1024,timeout:0});aN.on("fileQueued",function(aS){jQuery(".file-uploader-text").addClass("hide");jQuery(".file-upload-pic").addClass("hide");jQuery(".import-file").removeClass("hide");jQuery(".import-type-pic").addClass("hide");var aU=aS.name;var aT=aS.ext;var aQ=aS.size;var aR=null;if(aT=="txt"){jQuery("#txtType").removeClass("hide");aR="文本文件"}else{if(aT=="csv"){jQuery("#csvType").removeClass("hide");aR="csv 文件"}else{jQuery("#excelType").removeClass("hide");aR="Excel 文件"}}aQ=Y(aQ);jQuery("#importFileName").html(aU);jQuery("#importFileType").html(aR);jQuery("#importFileSize").html(aQ);jQuery(".file-info-label").removeClass("hide");jQuery(".upload-button").removeClass("hide")});aN.on("error",function(aQ){aO=k(aQ);bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:aO});return});aN.on("uploadProgress",function(aS,aR){var aQ=jQuery(".progress");var aT=aQ.find(".progress-bar");if(!aT.length){aT=jQuery('<div class="progress-bar progress-bar-info progress-bar-striped active" style="width: 0%;"><div class="fileSucFlag"></div></div>').appendTo(aQ).find(".progress-bar")}aT.css({width:aR*100+"%"});aT.find(".fileSucFlag").text(Math.ceil(aR*100)+"%");if(aT.find(".fileSucFlag").text()=="100%"){if(!jQuery(".file-block #fileSpin").length){jQuery(".file-block").append(v);v.spin(m).show();v.append(ar)}}});aN.on("uploadSuccess",function(aR,aQ){ab=aR.name;ab=ab.substring(0,ab.indexOf("."));aR.statusText="complete";v.spin("close");v.remove();if(aQ.resFlag=="success"){a=aQ.fileConfigBean;jQuery("#fileButton").removeClass("hide")}else{if(aQ.resFlag=="checkFail"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:aQ.msg})}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:aQ.msg})}}});aN.on("uploadError",function(aQ){v.spin("close");v.remove();bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.uploadFileError")})})}function Y(aQ){if(aQ===0){return"0 B"}var aR=1024;sizes=["B","KB","MB","GB","TB","PB","EB","ZB","YB"];i=Math.floor(Math.log(aQ)/Math.log(aR));return(aQ/Math.pow(aR,i)).toFixed(2)+" "+sizes[i]}function aD(){jQuery(".import-file").addClass("hide");jQuery(".file-info-label").addClass("hide");jQuery(".file-info-title").addClass("hide");jQuery(".upload-button").addClass("hide");jQuery(".file-uploader-text").removeClass("hide");jQuery(".file-upload-pic").removeClass("hide");jQuery(".progress").addClass("hide");aN.reset()}function ay(){a.firstLineTitle=jQuery("input[name='optionsRadio']:checked").val();jQuery(".file-info-label").addClass("hide");jQuery(".file-info-title").addClass("hide");jQuery(".progress").removeClass("hide");if(opType=="edit"&&a.firstLineTitle=="1"||opType=="append"&&a.firstLineTitle=="1"){a.changeTitleType=jQuery("input[name='titleRadio']:checked").val()}aN.options.formData={opType:opType,firstLineTitle:a.firstLineTitle,changeTitleType:a.changeTitleType,dataId:dataId};aN.upload();jQuery(".upload-button").addClass("hide");jQuery("#reUploadFile").removeClass("hide")}function aH(){jQuery(".import-file").addClass("hide");jQuery(".file-info-label").addClass("hide");jQuery(".file-info-title").addClass("hide");jQuery(".upload-button").addClass("hide");jQuery(".file-uploader-text").removeClass("hide");jQuery(".file-upload-pic").removeClass("hide");jQuery(".progress").addClass("hide");jQuery("#reUploadFile").addClass("hide");jQuery("#fileButton").addClass("hide");aN.reset()}function k(aT){var aU="";var aS=aN.options.fileSingleSizeLimit;var aR=aN.options.fileNumLimit;var aQ=aN.options.fileSizeLimit;switch(aT){case"F_EXCEED_SIZE":aU=al.getMessage("data.import.uploader.exceedSize")+aS+"M";break;case"Q_EXCEED_NUM_LIMIT":aU=al.getMessage("data.import.uploader.exceedNumLimit")+aR+al.getMessage("data.import.uploader.individual");break;case"Q_EXCEED_SIZE_LIMIT":aU=al.getMessage("data.import.uploader.exceedSizeLimit")+aQ+"M";break;case"Q_TYPE_DENIED":aU=al.getMessage("data.import.uploader.typeDenied");break;case"F_DUPLICATE":aU=al.getMessage("data.import.uploader.duplicate");break;case"success":aU=al.getMessage("data.import.uploader.success");break;default:aU=al.getMessage("data.import.uploader.default");break}return aU}function am(){if(opType=="edit"||opType=="append"){var aQ=jQuery(this).val();if(aQ=="1"){jQuery(".file-info-title").removeClass("hide")}else{jQuery(".file-info-title").addClass("hide")}}}function aC(){ak=true;jQuery(".bottom-button-common").removeClass("hide");var aR=aN.getFiles().length;var aQ=aN.getFiles()[0];if(aR<1){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.selectFile")});return}else{if(aQ.statusText!="complete"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.uploadFile")});return}}al.ajax({url:al.handleUrlParam("/platform/resmanage/data/data-file-create"),data:{opType:opType,fileConfig:JSON.stringify(a)},loading:{title:al.getMessage("data.import.title.execute"),text:al.getMessage("data.import.text.loading")},success:function(aS){if(aS.resFlag=="success"){q(aS)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:aS.msg});return}},error:function(aS){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.getFileInfoError")})}})}function q(aQ){u(2);jQuery("#oneStep").addClass("active-Finished");if(jQuery("#twoStep").hasClass("active-Finished")){jQuery("#twoStep").removeClass("active-Finished")}jQuery("#twoStep").removeClass("active-notFinished");jQuery("#fileInfo").addClass("hide");jQuery("#dataInfo").removeClass("hide");a=aQ.fileConfigBean;a.columnData=aQ.columnDatas;a.attrData=aQ.attrDatas;a.dimData=aQ.dimDatas;a.footerData=aQ.footerDatas;f();if(opType=="add"||opType=="edit"){av="2"}else{if(opType=="append"){av="3"}}}function u(aR){var aQ=25*(aR-1)+4+"%";jQuery("#stepLine").css("margin-left",aQ)}function ah(aS,aQ,aT){var aR="";if(aT==""||(aT!=null&&"数值".indexOf(aT)>-1)){aR+=" <li class ='fixedDim' value='2' title='数值'><div class='num-pic'></div><span>数值</span></li>"}if(aT==""||(aT!=null&&"月份".indexOf(aT)>-1)){aR+=" <li class ='fixedDim' value='4' title='月份'><div class='month-pic'></div>月份</li>"}if(aT==""||(aT!=null&&"日期".indexOf(aT)>-1)){aR+=" <li class ='fixedDim' value='6' title='日期'><div class='date-pic'></div>日期</li>"}if(aT==""||(aT!=null&&"时间".indexOf(aT)>-1)){aR+=" <li class ='fixedDim' value='7' title='时间'><div class='time-pic'></div>时间</li>"}if(aT==""||(aT!=null&&"字符".indexOf(aT)>-1)){aR+=" <li class ='fixedDim' value='9' title='字符'><div class='char-pic'></div>字符</li>"}if(aT==""||(aT!=null&&"省份".indexOf(aT)>-1)){aR+=" <li class ='fixedDim' value='A' title='省份'><div class='province-pic'></div>省份</li>"}if(aT==""||(aT!=null&&"地市".indexOf(aT)>-1)){aR+=" <li class ='fixedDim' value='B' title='地市'><div class='city-pic'></div>地市</li>"}if(aT==""||(aT!=null&&"区县".indexOf(aT)>-1)){aR+=" <li class ='fixedDim' value='C' title='区县'><div class='county-pic'></div>区县</li>"}aR+=" <li class='divider'></li>";return aR}function j(aS,aR,aT){var aQ="";if(aT==""||(aT!=null&&"数值".indexOf(aT)>-1)){aQ+=" <li class ='fixedDim' value='2' title='数值'><div class='num-pic'></div><span>数值</span></li>"}if(aT==""||(aT!=null&&"字符".indexOf(aT)>-1)){aQ+=" <li class ='fixedDim' value='9' title='字符'><div class='char-pic'></div>字符</li>"}aQ+=" <li class='divider'></li>";return aQ}function e(aV,aW,aS){var aT=null;var aZ=null;if(aV=="1"){aT=jQuery(".tip-yellowsimple #dimSelect");aT.empty()}else{if(aV=="2"){aZ=jQuery(".tip-yellowsimple #dimOtherSelect");aZ.empty()}else{aT=jQuery("#dimSelect");aT.empty();aZ=jQuery("#dimOtherSelect");aZ.empty()}}var aY=ah(aV,aW,aS);if(aV=="2"||aV=="3"){var aR=j(aV,aW,aS)}var a0=0;if(aW!=null&&aW!=""){var aQ=null;var aX=null;a0=aW.length;for(var aU=0;aU<a0;aU++){aQ=aW[aU].name;aX=aW[aU].value;aY+=" <li value="+aX+" title="+aQ+"><div class='dim-pic'></div>"+aQ+"</li>";if(aV=="2"||aV=="3"){aR+=" <li value="+aX+" title="+aQ+"><div class='dim-pic'></div>"+aQ+"</li>"}}}if(aV=="1"||aV=="3"){aT.append(aY)}if(aV=="2"||aV=="3"){aZ.append(aR)}if(a0*30>200){jQuery("#dim-select").height(360)}if(aV=="2"||aV=="3"){if((a0-3)*30>200){jQuery("#dim-other-select").height(360)}}}function J(aR,aZ){if(jQuery("#columnOper")){jQuery("#columnOper").empty()}e("3",aZ,"");var a0=[];var aU=aR.length;var aT=$(".data-info-grid").width()-45;if(opType=="append"){aT=jQuery(window).width()*0.94}var aS=200;if(aU*aS<aT){aS=Math.floor(aT/aU)}var aY="<div id='columnOper'></div>";var a1=null;var a2=null;var aQ=null;var aX=null;var aW=null;var a3=null;for(var aV=0;aV<aU;aV++){a1=aR[aV].columnLabel;a2=aR[aV].columnFilterTypeName;aQ=aR[aV].filterType;a3=aR[aV].attrClass;if(typeof(a2)=="undefined"){a2="字符"}if(aQ=="2"){aX="right"}else{aX="left"}if(a3=="0"){aW="<div id='dim'><span title="+a2+" class='dimText'>"+a2+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+a1+aY}else{aW="<div id='dimOther'><span title="+a2+" class='dimText' >"+a2+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+a1+aY}a0.push({label:aW,name:a1,align:aX,hlign:"center",sortable:false,width:aS})}return a0}function f(){if(!jQuery("#dataGrid").is(":empty")){jQuery.jgrid.gridUnload("dataGrid")}O=J(a.attrData,a.dimData);ax={datatype:"local",styleUI:"Bootstrap",regional:"cn",data:a.columnData,colModel:O,rownumbers:true,autowidth:true,shrinkToFit:false,height:"auto",footerrow:true,loadComplete:function(){jQuery("#dataInfo #dimOther").parent().parent().css("background-color","#DAE9E9");if(a.footerData.length<1){jQuery(".data-info-grid .ui-jqgrid-sdiv").hide()}else{jQuery(".data-info-grid .ui-jqgrid-sdiv").show();ae=true;var aU={};var aR=a.footerData.length;var aQ=null;for(var aT=0;aT<aR;aT++){aQ=a.footerData[aT];aU[aQ.name]=aQ.desc}jQuery(this).footerData("set",aU)}var aS=jQuery(this).parents().find(".data-info-grid th");aS.click(function(){a.currentColNum=jQuery(this)[0].cellIndex;var aW=jQuery(this);var aV=jQuery(aW).attr("id");jQuery("th").removeClass("jqgrid-underline");jQuery("th[id="+aV+"]").addClass("jqgrid-underline");K()});aS.find("#dim").on("click",function(){a.currentColNum=jQuery(this).parent().parent()[0].cellIndex;var aV=a.attrData[a.currentColNum-1].filterType;aS.find("#dim").poshytip("hide");jQuery(this).poshytip({className:"tip-yellowsimple",content:jQuery("#dim-select").outerHTML(),showTimeout:1,alignTo:"target",alignX:"bottom",alignY:"bottom",showOn:"none",offsetY:5,offsetX:-128,keepInViewport:false});jQuery(this).poshytip("show");jQuery(".tip-yellowsimple #dim-select li[value='"+aV+"']").prepend("<i class='fa fa-check dimItemsCheck'></i>");jQuery(".tip-yellowsimple #dim-select li[value='"+aV+"']").css("background-color","#2CC2A7");jQuery(".tip-yellowsimple #dim-select").niceScroll();jQuery(".tip-yellowsimple").on("click","#dimSelect li",function(){b(jQuery(this).attr("value"),jQuery(this).text())});al.stopBubble(event)});aS.find("#dimOther").on("click",function(){a.currentColNum=jQuery(this).parent().parent()[0].cellIndex;var aV=a.attrData[a.currentColNum-1].filterType;aS.find("#dimOther").poshytip("hide");jQuery(this).poshytip({className:"tip-yellowsimple",content:jQuery("#dim-other-select").outerHTML(),showTimeout:1,alignTo:"target",alignX:"bottom",alignY:"bottom",showOn:"none",offsetY:5,offsetX:-128,keepInViewport:false});jQuery(this).poshytip("show");jQuery(".tip-yellowsimple #dim-other-select li[value='"+aV+"']").prepend("<i class='fa fa-check dimItemsCheck'></i>");jQuery(".tip-yellowsimple #dim-other-select li[value='"+aV+"']").css("background-color","#2CC2A7");jQuery(".tip-yellowsimple #dim-other-select").niceScroll();jQuery(".tip-yellowsimple").on("click","#dimOtherSelect li",function(){b(jQuery(this).attr("value"),jQuery(this).text())});al.stopBubble(event)});aS.find("#columnOper").on("click",function(){aS.find("#columnOper").poshytip("hide");jQuery(this).poshytip({className:"tip-yellowsimple",content:jQuery("#columnOperMenu").outerHTML(),showTimeout:1,alignTo:"target",alignX:"bottom",alignY:"bottom",showOn:"none",offsetY:6,offsetX:-82,keepInViewport:false});jQuery(this).poshytip("show");a.currentColNum=jQuery(this).parent().parent()[0].cellIndex;jQuery("#columnOperMenu .addLeftColumn").on("click",S);jQuery("#columnOperMenu .addRightColumn").on("click",an);jQuery("#columnOperMenu .delTheColumn").on("click",r);al.stopBubble(event)})}};jQuery("#dataGrid").jqGrid(ax);$(window).resize(function(){G()})}function K(){var aQ=a.attrData[a.currentColNum-1];if(aQ.attrClass=="1"){aA=a.currentColNum;jQuery("#colNameSpan").text(aQ.columnLabel);if(aQ.fieldName!=""){jQuery("#funcTxt").val(aQ.funcLabel)}jQuery(".funcForm").slideDown()}else{aA=null;jQuery("#funcTxt").val("");jQuery(".funcForm").slideUp()}}function ao(aR){var aU=a.attrData;var aV=a.columnNum;var aT=null;var aQ=false;for(var aS=0;aS<aV;aS++){if(aS!=aR){aT=aU[aS];if("A"==aT.filterType||"B"==aT.filterType){aQ=true;break}}}return aQ}function af(aT,aQ,aS){var aR=al.handleUrlParam("/platform/resmanage/data/data-select-city");bi.dialog.show({title:al.getMessage("data.import.title.selectProAndCity"),message:jQuery('<div id="selectProvinceOrCity"></div>').load(aR),spinicon:"glyphicon glyphicon-refresh",cssClass:"data-selectProvinceOrCity",onshown:function(aU){R.init()},buttons:[{label:al.getMessage("data.import.label.sure"),cssClass:"btn-info",action:function(aU){var aV=R.saveSelect();if(aV.flag){a.attrData[aT].superRange=aV.selectValue;aU.close();aE(aT,aQ,aS)}}},{label:al.getMessage("data.import.label.cancel"),cssClass:"btn-default",action:function(aU){aU.close()}}]})}function aB(aQ){var aT=a.attrData;var aU=a.columnNum;var aS=null;for(var aR=0;aR<aU;aR++){if(aR!=aQ){aS=aT[aR];if("C"==aS.filterType){if(typeof(aS.superRange)!="undefined"&&aS.superRange!=""){aS.superRange=""}}}}}function b(aY,aR){C=jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft();var aX=a.currentColNum-1;var aU={};aU.selectValue=aY;aU.selectName=aR;var aQ=a.attrData[aX];aU.columnLabel=aQ.columnLabel;aU.colLength=aQ.colLength;aU.colScale=aQ.colScale;aU.fieldName=aQ.fieldName;aU.dataId=a.dataId;var aV=aQ.originFilterType;var aW=aQ.filterType;var aS=aY;var aT=true;if(aQ.attrClass=="1"){if(typeof(aQ.fieldName)=="undefined"||aQ.fieldName==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.no")+" "+aQ.columnLabel+" "+al.getMessage("data.import.message.customChangeFilter")});return}}if(aV=="2"){if(aS=="4"||aS=="6"||aS=="7"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.cannotChange")+D(aS)+"!"});return}}if(aW!=aS){if(aS=="2"||aS=="4"||aS=="6"||aS=="7"||aS=="9"||aS=="A"||aS=="B"||aS=="C"){if(aS=="C"){aT=ao(aX);if(!aT){af(aX,aU,aQ)}}else{if(aS=="A"||aS=="B"){aB(aX)}}if(aT){aE(aX,aU,aQ)}}else{h(aX,aU,aQ)}}}function aE(aS,aQ,aR){al.ajax({url:al.handleUrlParam("/platform/resmanage/data/change-column-type"),data:{changeData:JSON.stringify(aQ),columnData:JSON.stringify(a.columnData),type:"1"},loading:{title:al.getMessage("data.import.title.execute"),text:al.getMessage("data.import.text.loading")},success:function(aW){if(aW.resFlag=="success"){jQuery.jgrid.gridUnload("dataGrid");a.columnData=aW.columnDatas;aR.filterType=aQ.selectValue;aR.attrType=aW.attrType;aR.colLength=aW.colLength;aR.colScale=aW.colScale;aR.columnType=aW.columnType;aR.columnFilterTypeName=aW.columnFilterTypeName;var aT="<div id='columnOper'></div>";var aX=null;if(aR.attrClass=="0"){aX="<div id='dim'><span title="+aQ.selectName+" class='dimText'>"+aQ.selectName+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+aQ.columnLabel+aT}else{aX="<div id='dimOther'><span title="+aQ.selectName+" class='dimText'>"+aQ.selectName+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+aQ.columnLabel+aT}var aU=ax.colModel;var aV=null;if(aR.filterType=="2"){aV="right"}else{aV="left"}aU[aS].label=aX;aU[aS].align=aV;ax.colModel=aU;ax.data=a.columnData;jQuery("#dataGrid").jqGrid(ax)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.restoreData")})}G();M()},error:function(aT){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:aT.responseText||al.getMessage("data.import.message.dataGenerationError")})}})}function D(aR){var aQ="";if(aR=="2"){aQ="数值"}else{if(aR=="4"){aQ="月份"}else{if(aR=="6"){aQ="日期"}else{if(aR=="7"){aQ="时间"}else{if(aR=="9"){aQ="字符"}}}}}return aQ}function h(aS,aQ,aR){aR.filterType=aQ.selectValue;al.ajax({url:al.handleUrlParam("/platform/resmanage/data/dim-change"),data:{changeData:JSON.stringify(aQ),columnData:JSON.stringify(a.columnData)},loading:{title:al.getMessage("data.import.title.execute"),text:al.getMessage("data.import.text.loading")},success:function(aV){if(aV.resFlag=="success"){jQuery.jgrid.gridUnload("dataGrid");a.columnData=aV.columnData;aR.filterType=aQ.selectValue;aR.columnFilterTypeName=aQ.selectName;var aT="<div id='columnOper'></div>";var aW=null;if(aR.attrClass=="0"){aW="<div id='dim'><span title="+aQ.selectName+" class='dimText'>"+aQ.selectName+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+aQ.columnLabel+aT}else{aW="<div id='dimOther'><span title="+aQ.selectName+" class='dimText'>"+aQ.selectName+"</span><span class='glyphicon glyphicon-chevron-down dimDown'></span></div>"+aQ.columnLabel+aT}var aU=ax.colModel;aU[aS].label=aW;aU[aS].align="left";ax.colModel=aU;ax.data=a.columnData;jQuery("#dataGrid").jqGrid(ax)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.restoreData")})}G();M()},error:function(aT){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.dataGenerationError")})}})}function Q(){var aQ=jQuery.trim(jQuery("#funcTxt").val());if(aQ==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.inputFunc")});return}if(aA==null){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.selectCustomColumn")});return}a.funcTxt=aQ;aG(aA)}function aG(aQ){C=jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft();al.ajax({url:al.handleUrlParam("/platform/resmanage/data/process-func"),data:{dataId:a.dataId,columnIndex:aQ,funcTxt:a.funcTxt,attrData:JSON.stringify(a.attrData),columnData:JSON.stringify(a.columnData)},loading:{title:al.getMessage("data.import.title.execute"),text:al.getMessage("data.import.text.loading")},success:function(aS){if(aS.resFlag=="success"){jQuery.jgrid.gridUnload("dataGrid");a.columnData=aS.columnDatas;var aR=a.attrData[aA-1];aR.funcLabel=a.funcTxt;aR.fieldName=aS.fileName;aR.attrType=aS.attrType;aR.originAttrType=aS.attrType;aR.columnType=aS.columnType;aR.originColumnType=aS.columnType;aR.filterType=aS.filterType;aR.originFilterType=aS.filterType;aR.colLength=aS.colLength;aR.originColLength=aS.colLength;aR.colScale=aS.colScale;aR.originColScale=aS.colScale;aR.columnFilterTypeName=aS.columnFilterTypeName;O=J(a.attrData,a.dimData);ax.colModel=O;ax.data=a.columnData;jQuery("#dataGrid").jqGrid(ax)}else{jQuery.jgrid.gridUnload("dataGrid");var aR=a.attrData[aA-1];aR.fieldName="";aR.funcLabel="";O=J(a.attrData,a.dimData);ax.colModel=O;ax.data=a.columnData;jQuery("#dataGrid").jqGrid(ax);if(aS.resFlag=="filterFail"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:aS.msg})}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.reEnterFunc")})}}G();M()},error:function(aR){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.processFunError")})}})}function n(aT,aX,aQ){C=jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft();var aU=jQuery("#dataGrid").jqGrid("getRowData");var aW=[];var aV=null;for(var aS=0;aS<aU.length;aS++){aV={};for(var aR=0;aR<aX;aR++){if(aR>aT){aV[aQ[aR]]=aU[aS][aQ[aR-1]]}else{aV[aQ[aR]]=aU[aS][aQ[aR]]}}aV[aQ[aT]]="";aW.push(aV)}a.attrData=l(a.attrData,aT);jQuery.jgrid.gridUnload("dataGrid");a.columnData=aW;O=J(a.attrData,a.dimData);ax.colModel=O;ax.data=a.columnData;jQuery("#dataGrid").jqGrid(ax);G();M()}function M(){C=C;jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft(C)}function l(aU,aS){var aW=a.columnNum;var aQ=null;var aT=null;var aV=null;for(var aR=0;aR<aW;aR++){aQ=aU[aR];aT=aQ.attrClass;if(aT=="1"&&aS!=aR){aV=aQ.funcLabel;if(typeof(aV)!="undefined"&&aV!=""){aQ.funcLabel=I(aV,aS,aW)}}}return aU}function I(aV,aR,aZ){var aQ=A(aZ);var aY=null;var aX=null;var a0=null;var aW=-1;var aT=0;var aS=/[A-Z]$/;for(var aU=aR;aU<aZ;aU++){aT=aV.length;aY="$"+aQ[aU];a0="$()"+aQ[aU+1];aW=aV.indexOf(aY);if(aW>-1){if(aW+3<=aT){aX=aV.substr(aW,3);if(aS.test(aX)){if(aV.substr(aW+1,2)==aQ[aU]){aV=aV.replace(new RegExp("\\"+aX,"g"),a0)}}else{aV=aV.replace(new RegExp("\\"+aY,"g"),a0)}}else{if(aW+2==aT){aV=aV.replace(new RegExp("\\"+aY,"g"),a0)}}}}aV=aV.replace(new RegExp("\\$\\(\\)","g"),"$");return aV}function S(){var aV=a.columnNum+1;a.columnNum=aV;var aS=a.currentColNum-1;var aQ=A(aV);var aU={orderId:aS+1,columnLabel:aQ[aS],attrType:"3",filterType:"9",attrClass:"1",isUsed:"1"};var aT={name:aQ[aS],desc:""};for(var aR=0;aR<aV;aR++){if(aR==aS){a.attrData.insert(aR,aU);if(ae){a.footerData.insert(aR,aT)}}else{if(aR>aS){a.attrData[aR].orderId=aR+1;a.attrData[aR].columnLabel=aQ[aR];if(ae){a.footerData[aR].name=aQ[aR]}}}}n(aS,aV,aQ)}function A(aW){var aQ=new Array();var aV="A";var aU=aV.charCodeAt();var aR=0;var aT=0;for(var aS=0;aS<aW;aS++){if(aS<26){aQ.push(String.fromCharCode(aU+aS)+"")}else{aR=Math.floor(aS/26);if((aR-1)>0){aT=aS-26*aR}aQ.push(aQ[aS-25*aR-aT-1]+aQ[aS-26*aR]);aT++}}return aQ}function an(){var aV=a.columnNum+1;a.columnNum=aV;var aS=a.currentColNum;var aQ=A(aV);var aU={orderId:aS+1,columnLabel:aQ[aS],attrType:"3",filterType:"9",attrClass:"1",isUsed:"1"};var aT={name:aQ[aS],desc:""};for(var aR=0;aR<aV;aR++){if(aR==aS){a.attrData.insert(aR,aU);if(ae){a.footerData.insert(aR,aU)}}else{if(aR>aS){a.attrData[aR].orderId=aR+1;a.attrData[aR].columnLabel=aQ[aR];if(ae){a.footerData[aR].name=aQ[aR]}}}}n(aS,aV,aQ)}function r(){if(a.attrData[a.currentColNum-1].attrClass=="0"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.notDelCustomColumn")});return}var aT="$"+a.attrData[a.currentColNum-1].columnLabel;var aR=null;var aQ=null;var aV=null;var aU=[];for(var aS=0;aS<a.columnNum;aS++){aR=a.attrData[aS];if(aS!=a.currentColNum-1&&aR.attrClass=="1"){aV=aR.funcLabel;aQ=aR.columnLabel;if(typeof(aV)!="undefined"&&aV!=""){if(aV.indexOf(aT)>=0){aU.push(aQ)}}}}if(aU.length>0){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.delColumnConfirm")+aU+al.getMessage("data.import.message.quoteColumn")});return}bi.dialog.confirm({title:al.getMessage("data.import.text.delColumn"),message:al.getMessage("data.import.message.delColumnConfirm"),callback:function(aW){if(aW){var a0=a.columnNum-1;var aZ=a.currentColNum-1;a.columnNum=a0;var aX=A(a0+1);for(var aY=0;aY<a0+1;aY++){if(aY==aZ){a.attrData.splice(aY,1);if(ae){a.footerData.splice(aY,1)}}else{if(aY>aZ){a.attrData[aY-1].orderId=aY;a.attrData[aY-1].columnLabel=aX[aY-1];if(ae){a.footerData[aY-1].name=aX[aY-1]}}}}t(aZ,a0,aX)}}})}function t(aT,aX,aQ){jQuery(".funcForm").slideUp();C=jQuery(".data-info-grid .ui-jqgrid .ui-jqgrid-bdiv").scrollLeft();var aU=jQuery("#dataGrid").jqGrid("getRowData");var aW=[];var aV=null;for(var aS=0;aS<aU.length;aS++){aV={};for(var aR=0;aR<aX;aR++){if(aR>=aT){aV[aQ[aR]]=aU[aS][aQ[aR+1]]}else{aV[aQ[aR]]=aU[aS][aQ[aR]]}}aW.push(aV)}jQuery.jgrid.gridUnload("dataGrid");a.attrData=o(a.attrData,aT);a.columnData=aW;O=J(a.attrData,a.dimData);ax.colModel=O;ax.data=a.columnData;jQuery("#dataGrid").jqGrid(ax);G();M()}function o(aU,aS){var aW=a.columnNum;var aQ=null;var aT=null;var aV=null;for(var aR=0;aR<aW;aR++){aQ=aU[aR];aT=aQ.attrClass;if(aT=="1"&&aS!=aR){aV=aQ.funcLabel;if(typeof(aV)!="undefined"&&aV!=""){aQ.funcLabel=L(aV,aS,aW)}}}return aU}function L(aV,aR,aZ){var aQ=A(aZ+1);var aY=null;var aX=null;var a0=null;var aW=-1;var aT=0;var aS=/[A-Z]$/;for(var aU=aR;aU<aZ+1;aU++){aT=aV.length;aY="$"+aQ[aU];a0="$()"+aQ[aU-1];aW=aV.indexOf(aY);if(aW>-1){if(aW+3<=aT){aX=aV.substr(aW,3);if(aS.test(aX)){if(aV.substr(aW+1,2)==aQ[aU]){aV=aV.replace(new RegExp("\\"+aX,"g"),a0)}}else{aV=aV.replace(new RegExp("\\"+aY,"g"),a0)}}else{if(aW+2==aT){aV=aV.replace(new RegExp("\\"+aY,"g"),a0)}}}}aV=aV.replace(new RegExp("\\$\\(\\)","g"),"$");return aV}function s(){u(1);jQuery("#dataInfo").addClass("hide");jQuery("#fileInfo").removeClass("hide")}function ap(){for(var aQ=0;aQ<a.columnNum;aQ++){if(a.attrData[aQ].attrClass=="1"){if(typeof(a.attrData[aQ].fieldName)=="undefined"||a.attrData[aQ].fieldName==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.no")+" "+a.attrData[aQ].columnLabel+" "+al.getMessage("data.import.message.delCustomColumn")});return}}}u(3);jQuery("#oneStep").addClass("active-Finished");jQuery("#twoStep").addClass("active-Finished");if(jQuery("#thirdStep").hasClass("active-Finished")){jQuery("#thirdStep").removeClass("active-Finished")}jQuery("#thirdStep").removeClass("active-notFinished");jQuery("#dataInfo").addClass("hide");jQuery("#fieldInfo").removeClass("hide");if(opType=="add"){jQuery("#dataName").val(ab)}else{jQuery("#dataName").val(E);jQuery("#dataDesc").val(aI)}jQuery("#dataNum").val(a.dataNum);jQuery("#recordNum").val(a.dataNum);c()}function c(){if(!jQuery("#fieldGrid").is(":empty")){jQuery.jgrid.gridUnload("fieldGrid")}al.ajax({dataType:"json",mtype:"post",url:al.handleUrlParam("/platform/resmanage/data/data-common-field"),data:{attrData:JSON.stringify(a.attrData)},success:function(aQ){if(aQ.resFlag=="success"){aj(aQ)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.queryDataFail"),});return}},error:function(aQ){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:aQ.responseText||al.getMessage("data.import.message.queryFieldFail")})}})}function P(aS,aX){jQuery("#classifySel").append("");var aW=aS.length;var aR=null;var aV=null;var aQ=null;var aU="<option></option>";aU+='<option value="">无</option>';if(aW>0){for(var aT=0;aT<aW;aT++){aR=aS[aT];aQ=aR.classifyId;aV=aR.classifyName;aU+='<option value="'+aQ+'">'+aV+"</option>"}}jQuery("#classifySel").append(aU);if(aX&&opType=="add"){if(!aq){jQuery("#classifySel").trigger("chosen:updated");aq=true}}}function aj(aR){P(aR.classifyList,true);var aQ=aR.columnData;jQuery("#fieldGrid").jqGrid({datatype:"local",styleUI:"Bootstrap",data:aQ,regional:"cn",autowidth:true,height:"auto",rowNum:100000,colModel:[{label:al.getMessage("data.import.label.columnLabel"),name:"columnLabel",align:"center",hlign:"center",width:50,sortable:false,},{label:al.getMessage("data.import.label.attrName"),name:"attrName",align:"center",hlign:"center",sortable:false,editable:true,edittype:"text"},{label:al.getMessage("data.import.label.groupName"),name:"groupName",align:"center",hlign:"center",sortable:false,editable:true},{label:al.getMessage("data.import.label.attrType"),name:"attrType",align:"center",hlign:"center",sortable:false,formatter:"select",editoptions:{value:al.getMessage("data.import.label.attrTypeFormat")}},{label:al.getMessage("data.import.label.groupName"),name:"groupId",align:"center",hlign:"center",hidden:true},{label:al.getMessage("data.import.label.isUsed")+'：<i class="fa fa-square-o check-box" id="allCheck"></i>)',name:"isUsed",align:"center",hlign:"center",sortable:false,formatter:function(aS,aT,aV){var aU="";if(aS=="1"){aU='<i class="fa fa-check-square-o check-box" id="usedCheck" value="1"></i>'}else{aU='<i class="fa fa-square-o check-box" id="usedCheck" value="0"></i>'}return aU}}],loadComplete:function(){var aT=jQuery(this).parents().find(".field-info-grid th #allCheck");var aV=jQuery(this).parents().find(".field-info-grid td #usedCheck");aT.on("click",function(){var aX=jQuery(this).hasClass("fa-square-o");if(aX){jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o");aV.removeClass("fa-square-o");aV.removeClass("fa-check-square-o");aV.addClass("fa-check-square-o");aV.attr("value","1")}else{jQuery(this).removeClass("fa-check-square-o");jQuery(this).addClass("fa-square-o");aV.removeClass("fa-square-o");aV.removeClass("fa-check-square-o");aV.addClass("fa-square-o");aV.attr("value","0")}});aV.on("click",function(){aT.removeClass("fa-check-square-o");aT.addClass("fa-square-o");var aX=jQuery(this).hasClass("fa-square-o");if(aX){jQuery(this).attr("value","1");jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o")}else{jQuery(this).attr("value","0");jQuery(this).removeClass("fa-check-square-o");jQuery(this).addClass("fa-square-o")}al.stopBubble(event)});for(var aU=2;aU<=a.columnNum;aU++){$("#fieldGrid").jqGrid("editRow",aU,false);var aS=jQuery(this).find("#"+aU+"_groupName");aS.attr("readOnly",true);ac(aS)}$("#fieldGrid").jqGrid("editRow",1,false);var aW=jQuery(this).find("#1_groupName");aW.attr("readOnly",true);ac(aW)}});g();$(window).resize(function(){g()})}function ac(aQ){jQuery(aQ).treeselect({height:200,chkStyle:"radio",searchAjaxParam:"groupName",width:(jQuery(aQ).width()+25),url:al.handleUrlParam("/platform/resmanage/data/data-query-group")})}function aw(){u(2);jQuery("#fieldInfo").addClass("hide");jQuery("#dataInfo").removeClass("hide")}function az(aT){var aU=0;var aQ=aT.length;var aR=-1;for(var aS=0;aS<aQ;aS++){aR=aT.charCodeAt(aS);if(aR>=0&&aR<=128){aU+=1}else{aU+=3}}return aU}function y(){var aU=$("#fileForm").validationEngine("validate");if(!aU){return false}a.dataName=jQuery.trim(jQuery("#dataName").val());a.dataNum=jQuery("#dataNum").val();a.dataDesc=jQuery.trim(jQuery("#dataDesc").val());var aW=0;var aS=[];for(var aV=1;aV<=a.columnNum;aV++){var aQ=jQuery("#fieldGrid").jqGrid("getRowData",aV);var aX=jQuery(".field-info-grid #fieldGrid #"+aV+" .fa").attr("value");var aY=jQuery.trim(jQuery("#"+aV+"_attrName").val());var aT=null;if(typeof(jQuery("#"+aV+"_groupName").attr("trueValue"))=="undefined"){aT=aQ.groupId}else{aT=jQuery("#"+aV+"_groupName").attr("trueValue")}if(aX=="1"){if(aY==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.no")+" "+aQ.columnLabel+" "+al.getMessage("data.import.message.columnEmpty")});return}}if(aY!=""){var aZ=az(aY);if(aZ>90){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.no")+" "+aQ.columnLabel+" "+al.getMessage("data.import.message.columnLength")});return}}if(aX=="0"){aW++}if(aX=="1"){for(var aR in aS){if(aS[aR]==aY){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.no")+" "+aQ.columnLabel+" "+al.getMessage("data.import.message.columnRepet")});return}}}aS.push(aY);a.attrData[aV-1].isUsed=aX;a.attrData[aV-1].attrName=aY;a.attrData[aV-1].groupId=aT}if(aW==a.columnNum){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.selectUsedColumn")});return}a.classifyId=jQuery("#classifySel").val();a.classifyName=jQuery("#classifySel").find("option:selected").text();u(4);jQuery("#oneStep").addClass("active-Finished");jQuery("#twoStep").addClass("active-Finished");jQuery("#thirdStep").addClass("active-Finished");if(jQuery("#fourStep").hasClass("active-Finished")){jQuery("#fourStep").removeClass("active-Finished")}jQuery("#fourStep").removeClass("active-notFinished");jQuery("#fieldInfo").addClass("hide");jQuery("#completeInfo").removeClass("hide");jQuery("#dataName_finish").html(a.dataName);jQuery("#dataNum_finish").html(a.dataNum);jQuery("#recordNum_finish").html(a.dataNum);if(a.classifyName==null||a.classifyName==""){a.classifyName="无"}jQuery("#classify_finish").html(a.classifyName);jQuery("#dataDesc_finish").html(a.dataDesc);z()}function z(){al.ajax({url:al.handleUrlParam("/platform/resmanage/data/query-last-column"),loading:{title:al.getMessage("data.import.title.execute"),text:al.getMessage("data.import.text.configLoading")},data:{dataId:a.dataId,attrData:JSON.stringify(a.attrData),columnData:JSON.stringify(a.columnData)},success:function(aQ){if(aQ.resFlag=="success"){a.columnData=aQ.columnData;U()}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.queryDataFail")});return}},error:function(aQ){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:aQ.responseText||al.getMessage("data.import.message.queryDataError")})}})}function U(){var aT=a.attrData;var aY=a.columnData;var a1=aT.length;var a0=[];var aS=$(".complete-info-grid").width()-45;var aR=180;if(a1*aR<aS){aR=Math.floor(aS/a1)}var aV=null;var aQ=null;var aZ=null;var aX=null;for(var aU=0;aU<a1;aU++){aV=aT[aU];aX=aV.isUsed;if(aX=="1"){aQ=aV.filterType;if(aQ=="2"){aZ="right"}else{aZ="left"}a0.push({label:aV.attrName,name:aV.columnLabel,align:aZ,hlign:"center",sortable:false,width:aR})}}var aW={datatype:"local",styleUI:"Bootstrap",regional:"cn",data:aY,colModel:a0,rownumbers:true,shrinkToFit:false,autowidth:true,height:"auto"};if(jQuery("#completeGrid").is(":empty")){jQuery("#completeGrid").jqGrid(aW)}else{jQuery.jgrid.gridUnload("completeGrid");jQuery("#completeGrid").jqGrid(aW)}W();$(window).resize(function(){W()})}function ag(){bi.dialog.confirm({title:al.getMessage("data.import.title.saveData"),message:al.getMessage("data.import.message.savaDataConfirm"),callback:function(aQ){if(aQ){H()}}})}function H(){var aT=al.handleUrlParam("/platform/resmanage/data/save-file-info");var a6={dataId:a.dataId,dataName:a.dataName,dataNum:a.dataNum,dataDesc:a.dataDesc,filePath:a.filePath,firstLineTitle:a.firstLineTitle,fileSuffix:a.fileSuffix,attrData:JSON.stringify(a.attrData),modType:av,importStateType:d,classifyId:a.classifyId};if(opType=="edit"||opType=="append"){ad=[];X=[];aK=[];var a0=a.attrData;var aR=a0.length;var aU=null;var aQ=null;var aX=null;var aV=null;var aW={};for(var a3=0;a3<aR;a3++){aU=a0[a3].filterType;aQ=a0[a3].fieldName;ad.push(aU);X.push(aQ);aX=a0[a3].attrId;aV=a0[a3].dimId;aW={attrId:aX,filterType:aU,dimId:aV};aK.push(aW)}if(au.toString()!=ad.toString()||ai.toString()!=X.toString()){a6.importStateType="1"}if(av=="2"||av=="3"){a6.importStateType="1"}aT=al.handleUrlParam("/platform/resmanage/data/save-file-data")}if(a6.importStateType=="1"){var aY=w.length;var a4=aK.length;var aW={};var a5={};var aX=null;var a1=null;var aU=null;var a7=null;var aV=null;var aS=null;var a2=false;for(var a3=0;a3<a4;a3++){aW=aK[a3];aX=aW.attrId;aU=aW.filterType;aV=aW.dimId;if(aX!=null){for(var aZ=0;aZ<aY;aZ++){a5=w[aZ];a1=a5.attrId;a7=a5.filterType;if(aX==a1){if(aU!=a7){a2=true;break}else{if(aU=="1"){if(aV!=aS){a2=true;break}}}}}}}if(a2){a6.importStateType="4"}}al.ajax({url:aT,data:a6,loading:{title:al.getMessage("data.import.title.execute"),text:al.getMessage("data.import.text.loading")},success:function(a8){if(a8.resFlag=="success"){V()}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:a8.msg});return}},error:function(a8){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:al.getMessage("data.import.title.tips"),message:a8.responseText||"文件数据配置失败！"})}})}function V(){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:al.getMessage("data.import.title.tips"),message:al.getMessage("data.import.message.savaFileData"),closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:al.getMessage("data.import.label.sure"),cssClass:"btn-info",action:function(aQ){aQ.close();jQuery("#fileButton").addClass("hide");jQuery(".bottom-button-common").addClass("hide");jQuery("#completeSaveButton").addClass("hide")}},{label:al.getMessage("data.import.label.closePage"),cssClass:"btn-default",action:function(){if(jQuery.isFunction(window.opener.reloadDataList)){window.opener.reloadDataList()}window.close()}}]})}function N(){var aQ=jQuery(this).find(".step-title-num");var aR=jQuery(this).attr("id");if(aQ.hasClass("active-Finished")||!aQ.hasClass("active-notFinished")){if(aR=="fileTab"){u(1);jQuery("#"+aa()+"").addClass("hide");jQuery("#fileInfo").removeClass("hide")}else{if(aR=="dataTab"){u(2);jQuery("#"+aa()+"").addClass("hide");jQuery("#dataInfo").removeClass("hide");G()}else{if(aR=="fieldTab"){u(3);jQuery("#"+aa()+"").addClass("hide");jQuery("#fieldInfo").removeClass("hide");if(jQuery("#fieldGrid").is(":empty")){c()}else{g()}}else{if(aR=="completeTab"){if(!ak){return false}u(4);jQuery("#"+aa()+"").addClass("hide");jQuery("#completeInfo").removeClass("hide");if(jQuery("#completeGrid").is(":empty")){z()}else{W()}}}}}}}function G(){jQuery("#dataGrid").setGridWidth($(".data-info-grid").width()-5)}function g(){jQuery("#fieldGrid").setGridWidth($(".field-info-grid").width()-5);jQuery("#fieldGrid").setGridHeight($(".field-info-grid").height()-38)}function W(){jQuery("#completeGrid").setGridWidth($(".complete-info-grid").width()-5)}function aa(){if(jQuery(".file-info").is(":visible")){return"fileInfo"}if(jQuery(".data-info").is(":visible")){return"dataInfo"}if(jQuery(".field-info").is(":visible")){return"fieldInfo"}if(jQuery(".complete-info").is(":visible")){return"completeInfo"}}});