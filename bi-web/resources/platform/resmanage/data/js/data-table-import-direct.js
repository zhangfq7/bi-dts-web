define(["sabace"],function(s){var z={};var l={};var o={};var w="add";var a=null;var Q={};var H="0";jQuery(function(){jQuery(".chosen-select").chosen();i();jQuery("#setTableTimeSql").on("click",function(){D()});if(dataId!=""){w="edit"}z.dbId=dbId;if(w=="add"){if(s.IsEmpty(dbId)){F()}else{if(s.IsEmpty(dataBaseName)){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:s.getMessage("data.import.message.notDataSource")})}else{jQuery("#dbName").val(dataBaseName);if(interfaceTag){jQuery("#dataTable").val(dataTable);jQuery("#dataName").val(tableName);if(dataTable.length>0){if(dataTable.lastIndexOf("YYYYMMDD")>0||dataTable.lastIndexOf("YYYYMM")>0){jQuery("#tableStorage").val("2");jQuery("#tableStorage").trigger("chosen:updated");if(jQuery("#ccc").hasClass("hide")){jQuery("#ccc").removeClass("hide")}}}}}}}if(w=="edit"){N()}jQuery(".step-tab").on("click",y);jQuery("#nextButton").on("click",x);jQuery("#fieldCanButton").on("click",J);jQuery("#fieldSaveButton").on("click",q);O(1);jQuery("#tableForm").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true});jQuery("#tableStorage").on("change",g);jQuery("#selectDB").on("change",function(){var R=jQuery("#selectDB").val();var S=Q[R];s.ajax({url:s.handleUrlParam("/platform/resmanage/data/get-project-name"),data:{proId:S},success:function(W){var U=W.proName;var T=jQuery("#dataName").val();var V=T.split("_");if(null!=U||""!=U){jQuery("#dataName").val(U+"_"+V[V.length-1])}}})})});function N(){z.dataId=dataId;s.ajax({url:s.handleUrlParam("/platform/resmanage/data/get-table-data-direct"),data:{dataId:z.dataId},loading:{title:s.getMessage("data.import.title.execute"),text:'<span class="f16 bolder gray">'+s.getMessage("data.import.text.DBInfoLoading")+"</span>",spin:true},success:function(R){if(R.resFlag=="success"){P(R)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:R.msg});return}},error:function(R){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:R.responseText||s.getMessage("data.import.message.queryEditDataError")})}})}function P(R){z=R.tableConfigBean;z.columnData=R.columnData;z.columnNum=R.columnNum;if(z.columnData.length==0){w="add"}else{jQuery("#dbName").val(z.dbName);jQuery("#classifySel").val(z.classifyId);jQuery("#classifySel").trigger("chosen:updated");jQuery("#dataTable").val(z.dataTable);jQuery("#dataName").val(z.dataName);jQuery("#tableTime").val(z.tableTime);jQuery("#tableType").val(z.tableType);jQuery("#tableType").trigger("chosen:updated");jQuery("#tableStorage").val(z.tablesStorage);jQuery("#tableStorage").trigger("chosen:updated");jQuery("#storageField").val(z.storageField);jQuery("#storageSql").val(z.storageSql);jQuery("#tableDesc").val(z.tableDesc);if(z.tablesStorage!="0"){if(z.tablesStorage=="A"){jQuery("#aaa").removeClass("hide");jQuery("#bbb").removeClass("hide");jQuery("#ccc").removeClass("hide")}else{if(z.tablesStorage=="2"){jQuery("#ccc").removeClass("hide")}}}}}function F(){s.ajax({url:s.handleUrlParam("/platform/resmanage/data/get-user-db"),data:{interfaceFlag:"2"},success:function(Y){if(Y.resFlag=="success"){var R=Y.dbList;var X=R.length;var S=null;var V=null;var W=null;var Z=null;var U="<option selected></option>";for(var T=0;T<X;T++){S=R[T];V=S.dbId;W=S.dbName;Z=S.proId;U+='<option " value="'+V+'">'+W+"</option>";Q[V]=Z}jQuery("#selectDB").append(U);jQuery("#selectDB").trigger("chosen:updated")}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:"您当前还没有配置数据库,请先配置数据库"});return}},error:function(R){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:R.responseText||"查询用户所有数据库异常"})}})}function D(){z.etlDbId=(z.etlDbId==undefined?"":z.etlDbId);z.tableTimeSql=(z.tableTimeSql==undefined?"":z.tableTimeSql);var R={etlDbId:z.etlDbId,tableTimeSql:z.tableTimeSql};if(!jQuery("#tableTimePanel")[0]){jQuery("body").append("<div id='tableTimePanel' style='display:none;position: relative'></div>")}jQuery("#tableTimePanel").load(s.handleUrlParam("/platform/resmanage/data/table-date"),R,function(){m()})}function m(){$.dialog({id:"tableTimeDialog",title:"设置数据更新日期",padding:"0",width:"600px",height:"260px",lock:true,content:jQuery("#tableTimePanel")[0],okVal:"查询",ok:function(){var R=$("#tableForm").validationEngine("validate");if(!R){return false}if(s.IsEmpty(etlDbId)){$.dialog.alert("请选择ETL数据库！");return false}if(s.IsEmpty(tableTimeSql)){$.dialog.alert("请输入数据日期更新SQL！");return false}$.ajax({url:s.handleUrlParam("/platform/resmanage/data/query-table-time"),contentType:"charset=utf-8",data:{etlDbId:jQuery("#etlDbId option:selected").val(),tableTimeSql:jQuery("#tableTimeSql").val(),},success:function(S){if(S.tableTime!="error"){z.tableTime=S.tableTime;z.etlDbId=S.etlDbId;z.tableTimeSql=S.tableTimeSql;jQuery("#tableTime").val(S.tableTime);$.dialog.closeAll("tableTimeDialog")}else{$.dialog.alert("数据日期查询失败")}},error:function(S){$.dialog.alert("系统异常，数据日期查询失败，请稍后重试");return false}});return false}})}function G(T,R,S){if(!jQuery("#tableDimPanel")[0]){jQuery("body").append("<div id='tableDimPanel' style='display:none;position: relative;'></div>")}jQuery("#tableDimPanel").load(s.handleUrlParam("/platform/resmanage/data/table-dim"),function(){h(S);L();jQuery("#dimSearchButton").on("click",function(){var U=L();if(U){jQuery("#succQueryListTable").jqGrid("clearGridData");jQuery("#succQueryListTable").jqGrid("setGridParam",{datatype:"local",data:z.dimList}).trigger("reloadGrid")}})})}function p(S,R){$("#"+R+"_dimDiv").text("");$("#"+R+"_dimDiv").attr("value","")}function B(T,R,S){if(!jQuery("#attrCaliberPanel")[0]){jQuery("body").append("<div id='attrCaliberPanel' style='display:none;position: relative'></div>")}jQuery("#attrCaliberPanel").load(s.handleUrlParam("/platform/resmanage/data/attr-caliber"),function(){k(S);b();jQuery("#caliberSearchButton").on("click",function(){var U=b();if(U){jQuery("#queryCaliberListTable").jqGrid("clearGridData");jQuery("#queryCaliberListTable").jqGrid("setGridParam",{datatype:"local",data:z.caliberList}).trigger("reloadGrid")}})})}function b(){caliberName=$("#caliber_name").val();var R={caliberName:caliberName};var S=false;s.ajax({url:s.handleUrlParam("/platform/resmanage/data/query-attr-caliber"),data:R,async:false,success:function(T){z.caliberList=T.caliberList;u();S=true},error:function(T){S=false}});return S}function k(R){$.dialog({id:"attrCaliberDialog",title:"请选择口径信息",padding:"0",width:"715px",height:"260px",top:"50px",lock:true,resize:false,drag:false,content:jQuery("#attrCaliberPanel")[0],okVal:"确定",ok:function(){var S=$("#tableForm").validationEngine("validate");if(!S){return false}$("#"+R+"_caliberDiv").text(z.caliberName);$("#"+R+"_caliberDiv").attr("value",z.caliberId)}})}function n(S,R){$("#"+R+"_caliberDiv").text("");$("#"+R+"_caliberDiv").attr("value","")}function u(){var R=z.caliberList;jQuery("#queryCaliberListTable").jqGrid({datatype:"local",styleUI:"Bootstrap",data:R,colModel:[{label:"口径名称",name:"caliberName",index:"caliberName",sortable:false,align:"center",hlign:"center"},{label:"口径描述",name:"caliberDesc",index:"caliberDesc",sortable:false,align:"center",hlign:"center"},{label:"选择",name:"caliberIdHtml",index:"caliberIdHtml",sortable:false,width:"60px",align:"center",hlign:"center"},{label:"口径编码",name:"caliberId",index:"caliberId",hidden:true,hlign:"center"}],rowNum:10,autowidth:true,height:"auto",rowList:[10,20,30],viewrecords:true,forceFit:true,sortorder:"desc",gridview:false,shrinkToFit:true,pager:"#queryCaliberListTablePagerDiv",jsonReader:{root:"result",total:"totalPage",page:"currentPage",records:"rowNumber",repeatitems:false},afterInsertRow:function(T,S){var U='<input type="radio"  id="selectId" name="selectId"  title="'+S.caliberName+'" value="'+S.caliberId+'" ';U+="/> ";jQuery(this).jqGrid("setCell",T,"caliberIdHtml",U)},beforeSelectRow:function(T,U){jQuery("#queryCaliberListTable").find("tr[id='"+T+"']").find("input[type=radio]").prop("checked",true);var S=jQuery(this);var V=S.jqGrid("getRowData",T);z.caliberId=V.caliberId;z.caliberName=V.caliberName},loadComplete:function(U,V){var T=jQuery(this);var S=T.jqGrid("getRowData");if(S.length==0){$(".ui-paging-info").text("  总记录共   0   条  ")}}})}function h(R){$.dialog({id:"tableDimDialog",title:"请选择维度信息",padding:"0",width:"650px",height:"260px",top:"50px",lock:true,resize:false,drag:false,content:jQuery("#tableDimPanel")[0],okVal:"确定",ok:function(){var S=$("#tableForm").validationEngine("validate");if(!S){return false}$("#"+R+"_dimDiv").text(z.dimName);$("#"+R+"_dimDiv").attr("value",z.dimId)}})}window.checkDim=G;window.deleteDim=p;window.checkCaliber=B;window.deleteCaliber=n;function L(){dimName=$("#dim_name").val();var S={dimName:dimName};var R=false;s.ajax({url:s.handleUrlParam("/platform/resmanage/data/query-dim-list"),data:S,async:false,success:function(T){z.dimList=T.dimList;c();R=true},error:function(T){R=false}});return R}function c(){var R=z.dimList;jQuery("#succQueryListTable").jqGrid({datatype:"local",styleUI:"Bootstrap",data:R,colModel:[{label:"维度名称",name:"dimName",index:"dimName",width:"3px",sortable:false,align:"center",hlign:"center"},{label:"CODE字段",name:"dimCodeAttr",index:"dimCodeAttr",width:"3px",sortable:false,align:"center",hlign:"center"},{label:"名称字段",name:"dimLabelAttr",index:"dimLabelAttr",width:"3px",sortable:false,align:"center",hlign:"center"},{label:"选择",name:"dimIdHtml",index:"dimIdHtml",width:"2px",sortable:false,align:"center",title:false,hlign:"center"},{label:"维度编码",name:"dimId",index:"dimId",hidden:true}],rowNum:10,autowidth:true,height:"auto",rowList:[10,20,30],viewrecords:true,sortorder:"desc",gridview:false,shrinkToFit:true,pager:"#succQueryListTablePagerDiv",jsonReader:{root:"result",total:"totalPage",page:"currentPage",records:"rowNumber",repeatitems:false},afterInsertRow:function(T,S){var U='<input type="radio"  id="selectId" name="selectId"  title="'+S.dimName+'" value="'+S.dimId+'" ';U+="/> ";jQuery(this).jqGrid("setCell",T,"dimIdHtml",U)},beforeSelectRow:function(T,U){jQuery("#succQueryListTable").find("tr[id='"+T+"']").find("input[type=radio]").prop("checked",true);var S=jQuery(this);var V=S.jqGrid("getRowData",T);z.dimId=V.dimId;z.dimName=V.dimName},loadComplete:function(U,V){var T=jQuery(this);var S=T.jqGrid("getRowData");if(S.length==0){$(".ui-paging-info").text("  总记录共   0   条  ")}}})}function i(){s.ajax({url:s.handleUrlParam("/platform/resmanage/data/query-classify-list"),success:function(R){t(R.classifyList)},error:function(R){}})}function t(T){jQuery("#classifySel").append("");var X=T.length;var S=null;var W=null;var R=null;var V="<option></option>";V+='<option value="">无</option>';if(X>0){for(var U=0;U<X;U++){S=T[U];R=S.classifyId;W=S.classifyName;V+='<option value="'+R+'">'+W+"</option>"}}jQuery("#classifySel").append(V);jQuery("#classifySel").trigger("chosen:updated")}function g(){jQuery("#aaa").addClass("hide");jQuery("#bbb").addClass("hide");jQuery("#ccc").addClass("hide");if(this.value!="0"){if(this.value=="A"){jQuery("#aaa").removeClass("hide");jQuery("#bbb").removeClass("hide");jQuery("#ccc").removeClass("hide")}else{if(this.value=="1"||this.value=="2"){jQuery("#ccc").removeClass("hide")}}}}function x(){var W=$("#tableForm").validationEngine("validate");if(!W){return false}if(w=="add"&&(s.IsEmpty(dbId))){var S=jQuery("#selectDB").val();var R=jQuery("#selectDB").find("option:selected").text();if(s.IsEmpty(S)){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:"您还没有选择归属数据库，请选择归属数据库！"});return}dataBaseName=R;z.dbId=S}else{var V=jQuery("#dbName").val();if(V==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:s.getMessage("data.import.message.notDataSource")});return}}if(!interfaceTag){interfaceTag=false}z.classifyId=jQuery("#classifySel").val();z.classifyName=jQuery("#classifySel").find("option:selected").text();z.dataTable=jQuery.trim(jQuery("#dataTable").val());z.dataName=jQuery.trim(jQuery("#dataName").val());z.tableType=jQuery("#tableType").val();z.tableTypeText=jQuery("#tableType").find("option:selected").text();z.tableStorage=jQuery("#tableStorage").val();z.tableStorageText=jQuery("#tableStorage").find("option:selected").text();z.storageField=jQuery("#storageField").val();z.storageSql=jQuery.trim(jQuery("#storageSql").val());z.tableDesc=jQuery.trim(jQuery("#tableDesc").val());if(s.IsEmpty(z.tableTime)){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:s.getMessage("data.import.message.tableTime")});return}if(z.dataTable.indexOf("$")>0){if(z.tableStorage==0){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:s.getMessage("data.import.message.subTable")});return}}else{if(z.tableStorage!=0){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:s.getMessage("data.import.message.notSubTable")});return}}if(w=="edit"&&dataId!=""){var U=z.columnData;var X=z.columnNum;r(U,X);return true}var T={dbId:z.dbId,dataTable:z.dataTable,dataName:z.dataName,tableTime:z.tableTime,etlDbId:z.etlDbId,tableTimeSql:z.tableTimeSql,classifyId:z.classifyId,classifyName:z.classifyName,tableType:z.tableType,tablesStorage:z.tableStorage,storageField:z.storageField,storageSql:z.storageSql,tableDesc:z.tableDesc,dataId:z.dataId,opType:w,classifyId:z.classifyId,classifyName:z.classifyName,interfaceTag:interfaceTag};s.ajax({url:s.handleUrlParam("/platform/resmanage/data/creat-from-table-direct"),data:T,loading:{title:s.getMessage("data.import.title.execute"),text:s.getMessage("data.import.text.queryTableLoading")},success:function(Z){if(Z.resFlag=="success"){var Y=Z.columnData;var aa=Z.columnNum;r(Y,aa)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:Z.msg});return}},error:function(Y){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:Y.responseText||s.getMessage("data.import.message.importTableError")})}})}function O(S){var R=40*(S-1)+8+"%";jQuery("#stepLine").css("margin-left",R)}function r(R,S){O(2);jQuery("#oneStep").addClass("active-Finished");if(jQuery("#twoStep").hasClass("active-Finished")){jQuery("#twoStep").removeClass("active-Finished")}jQuery("#twoStep").removeClass("active-notFinished");jQuery("#tableInfo").addClass("hide");jQuery("#fieldInfo").removeClass("hide");d(R,S)}function d(R,S){z.attrData=R;tableStorage=z.tablesStorage;jQuery("#fieldGrid").jqGrid({datatype:"local",styleUI:"Bootstrap",data:R,regional:"cn",autowidth:true,height:"auto",rowNum:100000,gridview:false,colModel:[{label:s.getMessage("data.import.label.columnLabel"),name:"columnLabel",align:"center",hlign:"center",width:50,sortable:false,},{label:s.getMessage("data.import.label.fieldName"),name:"fieldName",align:"left",hlign:"center",sortable:false},{label:s.getMessage("data.import.label.attrName"),name:"attrName",align:"center",hlign:"center",sortable:false,editable:true,edittype:"text"},{label:s.getMessage("data.import.label.groupName"),name:"groupName",align:"center",hlign:"center",sortable:false,editable:true,},{name:"groupId",align:"center",hlign:"center",hidden:true},{label:s.getMessage("data.import.label.columnType"),name:"columnType",align:"center",hlign:"center",sortable:false},{label:s.getMessage("data.import.label.attrType"),name:"attrType",align:"center",hlign:"center",sortable:false,hidden:true,editable:true,formatter:"select",edittype:"select",editoptions:{value:s.getMessage("data.import.label.attrTypeFormat")}},{label:s.getMessage("data.import.label.filterType"),name:"filterType",index:"filterType",width:140,sortable:false,align:"center",hlign:"center"},{name:"dimId",align:"center",hlign:"center",hidden:true},{name:"dimName",align:"center",hlign:"center",hidden:true},{name:"expression",align:"center",hlign:"center",hidden:true},{label:s.getMessage("data.import.label.dimName"),name:"dim_html",index:"dim_html",width:140,sortable:false,align:"center",hlign:"center",title:false,formatter:function(T,ab,W){var aa="";var Y=(W.columnLabel==undefined?"":W.columnLabel);if(W.filterType=="1"){var Z=(W.dimId==undefined?"":W.dimId);var V=(W.dimName==undefined?"":W.dimName);var U='<div style="float:left;width:70%" id="dimNameDiv"><span class="blue12" id="'+Y+'_dimDiv" value="'+Z+'">'+V+"</span></div>";U+='<div style="float:right">[<img src="'+webpath+'/resources/platform/resmanage/data/img/editfind.png" width="14" height="14" style="cursor:pointer" onclick="checkDim(this, \''+dbId+"', '"+Y+'\')" title="选择维度" align="absbottom"/> ';U+='<img src="'+webpath+'/resources/platform/resmanage/data/img/editdelete.png" width="14" height="14" style="cursor:pointer" onclick="deleteDim(this,\''+Y+'\')" title="删除选择的维度" align="absbottom"/>]</div>';aa=U}else{if(W.filterType=="4"){var X=(W.expression==undefined?"":W.expression);aa+='<select id="'+Y+'_expression" name="expression">';aa+=' <option value="yyyy-MM" '+(X=="yyyy-MM"?"selected":"")+">yyyy-MM</option>";aa+=' <option value="yyyyMM" '+(X=="yyyyMM"?"selected":"")+">yyyyMM</option>";aa+="</select>"}else{if(W.filterType=="6"){var X=(W.expression==undefined?"":W.expression);aa+='<select id="'+Y+'_expression" name="expression">';aa+=' <option value="yyyy-MM-dd" '+(X=="yyyy-MM-dd"?"selected":"")+">yyyy-MM-dd</option>";aa+=' <option value="yyyyMMdd" '+(X=="yyyyMMdd"?"selected":"")+">yyyyMMdd</option>";aa+="</select>"}else{if(W.filterType=="7"){var X=(W.expression==undefined?"":W.expression);aa+='<select id="'+Y+'_expression" name="expression" style="width:100%;height:80%">';aa+=' <option value="yyyy-MM-dd HH:mm:ss" '+(X=="yyyy-MM-dd HH:mm:ss"?"selected":"")+">yyyy-MM-dd HH:mm:ss</option>";aa+=' <option value="yyyyMMddHHmmss" '+(X=="yyyyMMddHHmmss"?"selected":"")+">yyyyMMddHHmmss</option>";aa+="</select>"}else{aa+=""}}}}return aa}},{label:s.getMessage("data.import.label.caliberName"),name:"caliberName",index:"dim_html",width:140,sortable:false,align:"center",hlign:"center",title:false,formatter:function(T,V,aa){var Z="";var X=(aa.columnLabel==undefined?"":aa.columnLabel);var W=(aa.caliberId==undefined?"":aa.caliberId);var U=(aa.caliberName==undefined?"":aa.caliberName);var Y='<div style="float:left;width:70%" id="caliberNameDiv"><span class="blue12" id="'+X+'_caliberDiv" value="'+W+'">'+U+"</span></div>";Y+='<div style="float:right">[<img src="'+webpath+'/resources/platform/resmanage/data/img/editfind.png" width="14" height="14" style="cursor:pointer" onclick="checkCaliber(this, \''+dbId+"', '"+X+'\')" title="选择口径" align="absbottom"/> ';Y+='<img src="'+webpath+'/resources/platform/resmanage/data/img/editdelete.png" width="14" height="14" style="cursor:pointer" onclick="deleteCaliber(this,\''+X+'\')" title="删除选择的口径" align="absbottom"/>]</div>';Z=Y;return Z}},{label:s.getMessage("data.import.label.isUsed")+':<i class="fa fa-square-o check-box" id="allCheck"></i>)',name:"isUsed",align:"center",hlign:"center",sortable:false,formatter:function(T,U,W){var V="";if(T=="1"){V='<i class="fa fa-check-square-o check-box" id="usedCheck" value="1"></i>'}else{V='<i class="fa fa-square-o check-box" id="usedCheck" value="0"></i>'}return V}},{label:s.getMessage("data.import.label.dateField"),name:"dateFieldId",align:"center",hlign:"center",sortable:false,editable:true,edittype:"select",editoptions:{value:s.getMessage("data.import.label.dateFieldType"),dataEvents:[{type:"change",fn:function(Z){var Y=$(this).val();var X=$(this).closest("tr").index();var V=R[X-1].fieldName;var W=jQuery("#"+X+"_filterTypeDispalay").val();if(!(W=="4"||W=="6"||W=="7")){$.dialog.alert("非日期类型字段！");$(this).val("");return false}z.dateFieldId=(z.dateFieldId==undefined?"":z.dateFieldId);if(Y=="1"&&(!z.dateFieldId=="")){bi.dialog.confirm({title:s.getMessage("data.import.title.saveData"),message:s.getMessage("data.import.message.dataFiledConfirm"),callback:function(ab){if(ab){for(var ac=1;ac<=R.length;ac++){if(R[ac-1].fieldName==z.dateFieldId){jQuery("#"+ac+"_dateFieldId").val("");var aa=jQuery("select#"+ac+"_filterTypeDispalay option");for(var ac=0;ac<aa.length;ac++){aa[ac].hidden=false}break}}z.dateFieldId=V}}})}else{if(Y=="1"&&(z.dateFieldId=="")){z.dateFieldId=V}else{z.dateFieldId=""}}var T=jQuery("select#"+X+"_filterTypeDispalay option");for(var U=0;U<T.length;U++){if(Y=="1"){if(T[U].value=="2"||T[U].value=="3"||T[U].value=="9"){T[U].hidden=true}}else{T[U].hidden=false}}}}]}}],afterInsertRow:function(V,T){var W=jQuery("#"+V+"_filterTypeDispalay").find("option:selected").val();var X="";if(T.attrType=="1"){var U=(T.filterType==undefined?"":T.filterType);X+='<select id="'+V+'_filterTypeDispalay" name="filterTypeDispalay" onchange="changeDisplayType(this,\''+V+"')\">";X+=' <option value="">--请选择--</option>';X+=' <option value="1" '+(U=="1"?"selected":"")+">维度选择</option>";X+=' <option value="2" '+(U=="2"?"selected":"")+">数值间隔</option>";X+=' <option value="3" '+(U=="3"?"selected":"")+">精确查找</option>";X+="</select>";jQuery(this).jqGrid("setCell",V,"filterType",X)}else{if(T.attrType=="2"){var U=(T.filterType==undefined?"":T.filterType);X+='<select id="'+V+'_filterTypeDispalay" name="filterTypeDispalay" onchange="changeDisplayType(this,\''+V+"')\">";X+=' <option value="">--请选择--</option>';X+=' <option value="4" '+(U=="4"?"selected":"")+">月份</option>";X+=' <option value="6" '+(U=="6"?"selected":"")+">日期</option>";X+=' <option value="7" '+(U=="7"?"selected":"")+">时间</option>";X+="</select>";jQuery(this).jqGrid("setCell",V,"filterType",X)}else{var U=(T.filterType==undefined?"":T.filterType);X+='<select id="'+V+'_filterTypeDispalay" name="filterTypeDispalay" onchange="changeDisplayType(this,\''+V+"')\">";X+=' <option value="">--请选择--</option>';X+=' <option value="1" '+(U=="1"?"selected":"")+">维度选择</option>";X+=' <option value="2" '+(U=="2"?"selected":"")+">数值间隔</option>";X+=' <option value="3" '+(U=="3"?"selected":"")+">精确查找</option>";X+=' <option value="4" '+(U=="4"?"selected":"")+">月份</option>";X+=' <option value="6" '+(U=="6"?"selected":"")+">日期</option>";X+=' <option value="7" '+(U=="7"?"selected":"")+">时间</option>";X+=' <option value="9" '+(U=="9"?"selected":"")+">模糊查询</option>";X+="</select>";jQuery(this).jqGrid("setCell",V,"filterType",X)}}},loadComplete:function(){var aa=jQuery(this).parents().find(".field-info-grid th #allCheck");var V=jQuery(this).parents().find(".field-info-grid td #usedCheck");aa.on("click",function(){var ac=jQuery(this).hasClass("fa-square-o");if(ac){jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o");V.removeClass("fa-square-o");V.removeClass("fa-check-square-o");V.addClass("fa-check-square-o");V.attr("value","1")}else{jQuery(this).removeClass("fa-check-square-o");jQuery(this).addClass("fa-square-o");V.removeClass("fa-square-o");V.removeClass("fa-check-square-o");V.addClass("fa-square-o");V.attr("value","0")}});V.on("click",function(){aa.removeClass("fa-check-square-o");aa.addClass("fa-square-o");var ac=jQuery(this).hasClass("fa-square-o");if(ac){jQuery(this).attr("value","1");jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o")}else{jQuery(this).attr("value","0");jQuery(this).removeClass("fa-check-square-o");jQuery(this).addClass("fa-square-o")}s.stopBubble(event)});for(var Y=1;Y<=S;Y++){$("#fieldGrid").jqGrid("editRow",Y,false);var X=jQuery(this).find("#"+Y+"_groupName");I(X);$("#"+Y+"_groupName").attr("truevalue","0");$("#"+Y+"_groupName").val("默认属性组");$("#"+Y+"_filterTypeDispalay").addClass("selectFiledClass");$("#"+Y+"_expression").addClass("selectFiledClass");$("#"+Y+"_dateFieldId").addClass("selectFiledClass");$("#"+Y+"_dateFieldId").removeClass("form-control");$("#"+Y+"_dateFieldId").attr("size","");var Z=R[Y-1].fieldName;var T=(z.dateFieldId==undefined?"":z.dateFieldId);if(T==Z){$("#"+Y+"_dateFieldId").val("1")}var U=$("#"+Y+"_dateFieldId").val();var ab=jQuery("select#"+Y+"_filterTypeDispalay option");for(var W=0;W<ab.length;W++){if(U=="1"){if(ab[W].value=="2"||ab[W].value=="3"||ab[W].value=="9"){ab[W].hidden=true}}}}}});f();$(window).resize(function(){f()})}function I(R){jQuery(R).treeselect({height:200,chkStyle:"radio",searchAjaxParam:"groupName",width:(jQuery(R).width()+25),url:s.handleUrlParam("/platform/resmanage/data/data-query-group"),onCheck:function(){$("#div"+this.id).fadeOut("fast")}})}function v(U,S){var V="";if(U.value=="1"){var T="";var R="";V='<div style="float:left;width:70%" id="dimNameDiv"><span class="blue12" id="'+S+'_dimDiv" width="80%" value='+R+">"+T+"</span></div>";V+='<div style="float:right">[<img src="'+webpath+'/resources/platform/resmanage/data/img/editfind.png" width="14" height="14" style="cursor:pointer" onclick="checkDim(this, \''+dbId+"', '"+S+'\')" title="选择维度" align="absbottom"/> ';V+='<img src="'+webpath+'/resources/platform/resmanage/data/img/editdelete.png" width="14" height="14" style="cursor:pointer" onclick="deleteDim(this,\''+S+'\')" title="删除选择的维度" align="absbottom"/>]</div>'}else{if(U.value=="4"){V+='<select id="'+S+'_expression" name="expression" class="selectFiledClass">';V+=' <option value="yyyy-MM">yyyy-MM</option>';V+=' <option value="yyyyMM">yyyyMM</option>';V+="</select>"}else{if(U.value=="6"){V+='<select id="'+S+'_expression" name="expression" class="selectFiledClass">';V+=' <option value="yyyy-MM-dd">yyyy-MM-dd</option>';V+=' <option value="yyyyMMdd">yyyyMMdd</option>';V+="</select>"}else{if(U.value=="7"){V+='<select id="'+S+'_expression" name="expression" class="selectFiledClass">';V+=' <option value="yyyy-MM-dd HH:mm:ss" >yyyy-MM-dd HH:mm:ss</option>';V+=' <option value="yyyyMMddHHmmss">yyyyMMddHHmmss</option>';V+="</select>"}else{V+="&nbsp;"}}}}$("#"+S,"#fieldGrid").find("td").eq(11).empty().html(V)}window.changeDisplayType=v;function J(){O(1);jQuery("#fieldInfo").addClass("hide");jQuery("#tableInfo").removeClass("hide")}function q(){bi.dialog.confirm({title:s.getMessage("data.import.title.saveData"),message:s.getMessage("data.import.message.savaDataConfirm"),callback:function(R){if(R){j()}}})}function j(){var W=z.attrData;var V=W.length;for(var T=1;T<=V;T++){W[T-1].attrName=$("#"+T+"_attrName").val();W[T-1].groupId=$("#"+T+"_groupName").attr("truevalue");var U=$("#"+T+"_filterTypeDispalay").find("option:selected").val();W[T-1].filterType=U;W[T-1].dimId=$("#"+T+"_dimDiv").attr("value");W[T-1].dimId=(W[T-1].dimId==undefined?"":W[T-1].dimId);W[T-1].caliberId=$("#"+T+"_caliberDiv").attr("value");W[T-1].caliberId=(W[T-1].caliberId==undefined?"":W[T-1].caliberId);if(U=="1"&&W[T-1].dimId==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:s.getMessage("data.connect.message.dimSelect"),});return}W[T-1].expression=$("#"+T+"_expression").val();var X=jQuery("#fieldGrid").jqGrid("getRowData",T);W[T-1].isUsed=$(X.isUsed).attr("value")}z.attrData=W;var S={dbId:z.dbId,dataTable:z.dataTable,dataName:z.dataName,tableTime:z.tableTime,etlDbId:z.etlDbId,tableTimeSql:z.tableTimeSql,classifyId:z.classifyId,classifyName:z.classifyName,tableType:z.tableType,tablesStorage:z.tableStorage,storageField:z.storageField,storageSql:z.storageSql,tableDesc:z.tableDesc,dataId:z.dataId,opType:w,classifyId:z.classifyId,classifyName:z.classifyName,attrData:JSON.stringify(z.attrData),dateFieldId:z.dateFieldId};var R=s.handleUrlParam("/platform/resmanage/data/save-table-info-direct");if(w=="edit"){R=s.handleUrlParam("/platform/resmanage/data/save-table-data-direct")}s.ajax({url:R,data:S,loading:{title:s.getMessage("data.import.title.execute"),text:s.getMessage("data.import.text.loading")},success:function(Y){if(Y.resFlag=="success"){K()}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:Y.msg});return}},error:function(Y){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("data.import.title.tips"),message:Y.responseText||"数据表数据配置失败！"})}})}function K(){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:s.getMessage("data.import.title.tips"),message:s.getMessage("data.import.message.savaTableData"),closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:s.getMessage("data.import.label.sure"),cssClass:"btn-info",action:function(R){if(w=="add"){C()}if(jQuery.isFunction(window.opener.reloadDataList)){window.opener.reloadDataList()}R.close();window.close();jQuery("#tableButton").addClass("hide");jQuery(".bottom-button-common").addClass("hide");jQuery("#completeSaveButton").addClass("hide")}},{label:s.getMessage("data.import.label.closePage"),cssClass:"btn-default",action:function(){if(jQuery.isFunction(window.opener.reloadDataList)){window.opener.reloadDataList()}window.close()}}]})}function C(){var R=s.handleUrlParam("/platform/resmanage/data/data-list");M(R,"")}function M(T,V){var U="";for(var S in V){U+="<input name='"+S+"' value='"+V[S]+"'/>"}var R=jQuery("<form></form>",{method:"post",action:T,target:"_blank",html:U});jQuery("body").append(R);R.submit();jQuery(R).remove()}function y(){var R=jQuery(this).find(".step-title-num");var S=jQuery(this).attr("id");if(R.hasClass("active-Finished")||!R.hasClass("active-notFinished")){if(S=="tableTab"){O(1);jQuery("#"+e()+"").addClass("hide");jQuery("#tableInfo").removeClass("hide")}else{if(S=="fieldTab"){O(2);jQuery("#"+e()+"").addClass("hide");jQuery("#fieldInfo").removeClass("hide");if(jQuery("#fieldGrid").is(":empty")){initFieldGrid()}else{f()}}}}}function E(){jQuery("#dataGrid").setGridWidth($(".data-info-grid").width()-5)}function f(){jQuery("#fieldGrid").setGridWidth($(".field-info-grid").width()-5);jQuery("#fieldGrid").setGridHeight($(".field-info-grid").height()-38)}function A(){jQuery("#completeGrid").setGridWidth($(".complete-info-grid").width()-5)}function e(){if(jQuery(".table-info").is(":visible")){return"tableInfo"}if(jQuery(".data-info").is(":visible")){return"dataInfo"}if(jQuery(".field-info").is(":visible")){return"fieldInfo"}if(jQuery(".complete-info").is(":visible")){return"completeInfo"}}});