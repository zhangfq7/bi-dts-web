define(["sabace"],function(l){var E={};var p="add";var d=[];var J=[];var H=[];var z=[];var r=[];var D=false;var v=[];jQuery(function(){jQuery(".chosen-select").chosen();if(viewId!=""){p="edit"}if(p=="add"){y()}g();if(p=="edit"){K()}jQuery(".step-tab").on("click",q);jQuery("#viewButton").on("click",j);jQuery("#tableCancelButton").on("click",L);jQuery("#tableSaveButton").on("click",u);jQuery("#linkCancelButton").on("click",w);jQuery("#linkSaveButton").on("click",n);jQuery("#fieldSaveButton").on("click",s);O(1);jQuery("#viewForm").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true});jQuery("#tableInfo #tableBlock").niceScroll();jQuery("#tableType").on("change",function(){b("filter")});jQuery("#tableBlock").on("click",".table-item",k);jQuery("#tableSelected").on("click","#selectedClose",I)});function y(){l.ajax({url:l.handleUrlParam("/platform/resmanage/data/get-user-db"),data:{interfaceFlag:"2"},success:function(W){if(W.resFlag=="success"){var X=W.dbList;var Q=X.length;var S=null;var R=null;var V=null;var U="<option selected></option>";for(var T=0;T<Q;T++){S=X[T];R=S.dbId;V=S.dbName;U+='<option value="'+R+'">'+V+"</option>"}jQuery("#selectDB").append(U);jQuery("#selectDB").trigger("chosen:updated")}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:"您当前还没有配置直连数据库,请先配置直连数据库"});return}},error:function(Q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:Q.responseText||"查询用户所有直连数据库异常"})}})}function g(){l.ajax({url:l.handleUrlParam("/platform/resmanage/data/query-classify-list"),success:function(Q){m(Q.classifyList)},error:function(Q){}})}function m(S){jQuery("#classifySel").append("");var W=S.length;var R=null;var V=null;var Q=null;var U="<option></option>";U+='<option value="">无</option>';if(W>0){for(var T=0;T<W;T++){R=S[T];Q=R.classifyId;V=R.classifyName;U+='<option value="'+Q+'">'+V+"</option>"}}jQuery("#classifySel").append(U);jQuery("#classifySel").trigger("chosen:updated")}function K(){E.viewId=viewId;l.ajax({url:l.handleUrlParam("/platform/resmanage/tableview/get-table-view"),data:{viewId:E.viewId},loading:{title:l.getMessage("data.import.title.execute"),text:'<span class="f16 bolder gray">'+l.getMessage("data.import.text.DBInfoLoading")+"</span>",spin:true},success:function(Q){if(Q.resFlag=="success"){P(Q)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:Q.msg});return}},error:function(Q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:Q.responseText||"视图信息获取异常！"})}})}function P(Q){jQuery("#oneStep").addClass("active-Finished");jQuery("#twoStep").removeClass("active-notFinished");jQuery("#twoStep").addClass("active-Finished");jQuery("#thirdStep").removeClass("active-notFinished");jQuery("#thirdStep").addClass("active-Finished");jQuery("#fourStep").removeClass("active-notFinished");jQuery("#fourStep").addClass("active-Finished");jQuery(".main-panel").removeClass("hide");E=Q.tableViewConfigInfo;jQuery("#viewName").val(E.viewName);jQuery("#dbName").val(E.dbName);jQuery("#classifySel").val(E.classifyId);jQuery("#classifySel").trigger("chosen:updated");jQuery("#viewDesc").val(E.viewDesc);d=Q.allTableArr;x(d);v=Q.tableList;F(v);z=Q.joinFieldArr;J=Q.joinAttrArr;r=Q.viewFieldArr;H=Q.viewAttrArr}function x(T){var R="";var S=null;for(var Q=0;Q<T.length;Q++){S=T[Q];R+='<div class="table-all-div divDispaly" id="'+S.dataId+'" title="'+S.dataName+'">';R+='<div class="table-all-name">';R+='	<span class="f14">'+S.dataName+"</span>";R+="</div>";R+='<i class="fa fa-close f12 table-select-close" id="selectedClose" title="删除"></i>';R+="</div>"}jQuery("#tableInfo .table-selected").append(R)}function O(R){var Q=25*(R-1)+4+"%";jQuery("#stepLine").css("margin-left",Q)}function j(){var T=$("#viewForm").validationEngine("validate");if(!T){return false}if(p=="add"){D=false;if(typeof(E.dbId)=="undefined"){E.dbId=""}var R=jQuery("#selectDB").val();var Q=jQuery("#selectDB").find("option:selected").text();if(R==null||R==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:"您还没有选择归属数据库，请选择归属数据库！"});return}if(E.dbId!=R&&""!=E.dbId){D=true}E.dbId=R}else{var S=jQuery("#dbName").val();if(S==""){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:l.getMessage("data.import.message.notDataSource")});return}}E.viewName=jQuery.trim(jQuery("#viewName").val());E.classifyId=jQuery("#classifySel").val();E.viewDesc=jQuery.trim(jQuery("#viewDesc").val());b("all")}function b(S){var Q={};Q.dbId=E.dbId;if("filter"==S){var R=jQuery("#tableType").val();if(!l.IsEmpty(R)){Q.tableType=R}}l.ajax({url:l.handleUrlParam("/platform/resmanage/tableview/get-connect-table"),data:Q,loading:{title:l.getMessage("data.import.title.execute"),text:"正在查询工作表，请稍后....."},success:function(T){N(T.tableList,S)},error:function(T){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:T.responseText||"查询数据表异常！"})}})}function N(R,Q){if("all"==Q){O(2);jQuery("#oneStep").addClass("active-Finished");if(jQuery("#twoStep").hasClass("active-Finished")){jQuery("#twoStep").removeClass("active-Finished")}jQuery("#twoStep").removeClass("active-notFinished");jQuery("#viewInfo").addClass("hide");jQuery("#tableInfo").removeClass("hide")}if("add"==p&&"all"==Q){if(D){jQuery("#tableInfo .table-selected").empty();d=[];if(jQuery("#thirdStep").hasClass("active-Finished")){jQuery("#thirdStep").removeClass("active-Finished")}if(!jQuery("#thirdStep").hasClass("active-notFinished")){jQuery("#thirdStep").addClass("active-notFinished")}z=[];if(jQuery("#fourStep").hasClass("active-Finished")){jQuery("#fourStep").removeClass("active-Finished")}if(!jQuery("#fourStep").hasClass("active-notFinished")){jQuery("#fourStep").addClass("active-notFinished")}r=[]}}F(R)}function F(S){var Q=S.length;var W="";var X=null;var R=null;var T=null;var aa="";var Y=false;var Z=null;if(Q>0){for(var V=0;V<Q;V++){Y=false;X=S[V];T=X.dataId;for(var U=0;U<d.length;U++){Z=d[U];if(T==Z.dataId){Y=true;break}}R=X.dataName;if(Y){aa+="<div class='table-item items-checked divDispaly' id='"+T+"' title='"+R+"'>";aa+="  <i class='fa fa-check-circle-o item-check'></i>"}else{aa+="<div class='table-item items-not-checked divDispaly' id='"+T+"' title='"+R+"'>";aa+="  <i class='fa fa-check-circle-o item-check hide'></i>"}aa+="	<div class='table-items-name'>";aa+="		<span class='f14'>"+R+"</span>";aa+="	</div>";aa+="</div>"}W+=aa}jQuery("#tableBlock").empty().append(W)}function k(){var R=jQuery(this).attr("id");var Q=jQuery(this).attr("title");if(jQuery(this).hasClass("items-not-checked")){jQuery(this).removeClass("items-not-checked");jQuery(this).addClass("items-checked");jQuery(this).find(".item-check").removeClass("hide");M(R,Q,"add")}else{if(jQuery(this).hasClass("items-checked")){jQuery(this).removeClass("items-checked");jQuery(this).addClass("items-not-checked");jQuery(this).find(".item-check").addClass("hide");M(R,Q,"delete")}}}function M(R,Q,T){var U={};if("add"==T){U.dataId=R;U.dataName=Q;d.push(U);o(R,Q,T)}else{for(var S=0;S<d.length;S++){U=d[S];if(R==U.dataId){d=d.del(S);o(R,Q,T);break}}}}function I(){var Q=jQuery(this).parent().attr("id");M(Q,"","delete");jQuery("#tableBlock").find("#"+Q).removeClass("items-checked");jQuery("#tableBlock").find("#"+Q).addClass("items-not-checked");jQuery("#tableBlock").find("#"+Q).find(".item-check").addClass("hide")}function o(R,Q,T){if("add"==T){var S="";S+='<div class="table-all-div divDispaly" id="'+R+'" title="'+Q+'">';S+='<div class="table-all-name">';S+='	<span class="f14">'+Q+"</span>";S+="</div>";S+='<i class="fa fa-close f12 table-select-close" id="selectedClose" title="删除"></i>';S+="</div>";jQuery("#tableInfo .table-selected").append(S)}else{jQuery("#tableInfo .table-selected").find("#"+R).remove()}}function L(){O(1);jQuery("#tableInfo").addClass("hide");jQuery("#viewInfo").removeClass("hide")}function u(){if(d.length<2){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:"请选择至少2张业务数据表!"});return}C()}function C(){l.ajax({url:l.handleUrlParam("/platform/resmanage/tableview/get-link-field"),data:{dataArrJson:JSON.stringify(d),opType:p,joinArrJson:JSON.stringify(z)},success:function(Q){if(Q.resFlag=="success"){J=Q.attrList;A()}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:"您当前选择的业务数据表之间不存在关联关系，请重新选择业务数据表!"});return}},error:function(Q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:Q.responseText||"业务数据表之间关联关系查询异常!"})}})}function A(){O(3);jQuery("#oneStep").addClass("active-Finished");jQuery("#twoStep").addClass("active-Finished");if(jQuery("#thirdStep").hasClass("active-Finished")){jQuery("#thirdStep").removeClass("active-Finished")}jQuery("#thirdStep").removeClass("active-notFinished");jQuery("#tableInfo").addClass("hide");jQuery("#linkInfo").removeClass("hide");B()}function B(){if(!jQuery("#linkGrid").is(":empty")){jQuery.jgrid.gridUnload("linkGrid")}jQuery("#linkGrid").jqGrid({datatype:"local",styleUI:"Bootstrap",data:J,regional:"cn",autowidth:true,height:"auto",rowNum:100000,rownumbers:true,colModel:[{label:"字段Id",name:"attrId",align:"left",hlign:"center",sortable:false,hidden:true},{label:"关联字段",name:"fieldName",align:"center",hlign:"center",sortable:false},{label:"关联字段中文名称",name:"attrName",align:"left",hlign:"center",sortable:false},{label:'是否选择(<i class="fa fa-square-o check-box" id="allCheck"></i>)',name:"isUsed",align:"center",hlign:"center",sortable:false,formatter:function(Q,R,T){var S="";if(Q=="1"){S='<i class="fa fa-check-square-o check-box" id="usedCheck" value="1"></i>'}else{S='<i class="fa fa-square-o check-box" id="usedCheck" value="0"></i>'}return S}}],loadComplete:function(){var Q=jQuery(this).parents().find(".link-info-grid th #allCheck");var R=jQuery(this).parents().find(".link-info-grid td #usedCheck");Q.on("click",function(){var S=jQuery(this).hasClass("fa-square-o");if(S){jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o");R.removeClass("fa-square-o");R.removeClass("fa-check-square-o");R.addClass("fa-check-square-o");R.attr("value","1")}else{jQuery(this).removeClass("fa-check-square-o");jQuery(this).addClass("fa-square-o");R.removeClass("fa-square-o");R.removeClass("fa-check-square-o");R.addClass("fa-square-o");R.attr("value","0")}});R.on("click",function(){Q.removeClass("fa-check-square-o");Q.addClass("fa-square-o");var S=jQuery(this).hasClass("fa-square-o");if(S){jQuery(this).attr("value","1");jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o")}else{jQuery(this).attr("value","0");jQuery(this).removeClass("fa-check-square-o");jQuery(this).addClass("fa-square-o")}l.stopBubble(event)})}});h();$(window).resize(function(){h()})}function w(){O(2);jQuery("#linkInfo").addClass("hide");jQuery("#tableInfo").removeClass("hide")}function n(){z=[];var T=null;var S=null;var Q=null;for(var R=1;R<=J.length;R++){S=jQuery("#linkGrid").jqGrid("getRowData",R);T=jQuery(".link-info-grid #linkGrid #"+R+" .fa").attr("value");if("1"==T){Q={};Q.fieldName=S.fieldName;z.push(Q)}}if(z.length==0){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:"您还没有配置关联条件，请您至少选择一个关联字段作为关联条件!"});return}else{f()}}function f(){l.ajax({url:l.handleUrlParam("/platform/resmanage/tableview/get-view-field"),data:{dataArrJson:JSON.stringify(d),opType:p,viewArrJson:JSON.stringify(r)},success:function(Q){if(Q.resFlag=="success"){H=Q.attrList;c()}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:"您当前选择的业务数据表之间不存在关联关系，请重新选择业务数据表!"});return}},error:function(Q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:Q.responseText||"业务数据表之间关联关系查询异常!"})}})}function c(){O(4);jQuery("#oneStep").addClass("active-Finished");jQuery("#twoStep").addClass("active-Finished");jQuery("#thirdStep").addClass("active-Finished");if(jQuery("#fourStep").hasClass("active-Finished")){jQuery("#fourStep").removeClass("active-Finished")}jQuery("#fourStep").removeClass("active-notFinished");jQuery("#linkInfo").addClass("hide");jQuery("#fieldInfo").removeClass("hide");i()}function i(){if(!jQuery("#fieldGrid").is(":empty")){jQuery.jgrid.gridUnload("fieldGrid")}jQuery("#fieldGrid").jqGrid({datatype:"local",styleUI:"Bootstrap",data:H,regional:"cn",autowidth:true,height:"auto",rowNum:100000,rownumbers:true,colModel:[{label:"工作表Id",name:"dataId",align:"left",hlign:"center",sortable:false,hidden:true},{label:"字段Id",name:"attrId",align:"left",hlign:"center",sortable:false,hidden:true},{label:"工作表中文名称",name:"dataName",align:"center",hlign:"center",sortable:false},{label:"字段名称",name:"fieldName",align:"center",hlign:"center",sortable:false},{label:"字段中文名称",name:"attrName",align:"left",hlign:"center",sortable:false},{label:'是否展示(<i class="fa fa-square-o check-box" id="allCheck"></i>)',name:"isUsed",align:"center",hlign:"center",sortable:false,formatter:function(Q,R,T){var S="";if(Q=="1"){S='<i class="fa fa-check-square-o check-box" id="usedCheck" value="1"></i>'}else{S='<i class="fa fa-square-o check-box" id="usedCheck" value="0"></i>'}return S}}],loadComplete:function(){var Q=jQuery(this).parents().find(".field-info-grid th #allCheck");var R=jQuery(this).parents().find(".field-info-grid td #usedCheck");Q.on("click",function(){var S=jQuery(this).hasClass("fa-square-o");if(S){jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o");R.removeClass("fa-square-o");R.removeClass("fa-check-square-o");R.addClass("fa-check-square-o");R.attr("value","1")}else{jQuery(this).removeClass("fa-check-square-o");jQuery(this).addClass("fa-square-o");R.removeClass("fa-square-o");R.removeClass("fa-check-square-o");R.addClass("fa-square-o");R.attr("value","0")}});R.on("click",function(){Q.removeClass("fa-check-square-o");Q.addClass("fa-square-o");var S=jQuery(this).hasClass("fa-square-o");if(S){jQuery(this).attr("value","1");jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o")}else{jQuery(this).attr("value","0");jQuery(this).removeClass("fa-check-square-o");jQuery(this).addClass("fa-square-o")}l.stopBubble(event)})}});G();$(window).resize(function(){G()})}function s(){r=[];var T=null;var S=null;var R=null;for(var Q=1;Q<=H.length;Q++){S=jQuery("#fieldGrid").jqGrid("getRowData",Q);T=jQuery(".field-info-grid #fieldGrid #"+Q+" .fa").attr("value");if("1"==T){R={};R.dataId=S.dataId;R.attrId=S.attrId;r.push(R)}}if(r.length==0){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:"您还没有配置展示字段，请您至少选择一个字段作为展示字段!"});return}else{bi.dialog.confirm({title:"保存视图",message:"您确定保存该视图信息吗？",callback:function(U){if(U){e()}}})}}function e(){var Q={dbId:E.dbId,viewName:E.viewName,classifyId:E.classifyId,viewDesc:E.viewDesc,dataArrJson:JSON.stringify(d),joinArrJson:JSON.stringify(z),viewArrJson:JSON.stringify(r),opType:p};if("edit"==p){Q.viewId=viewId}l.ajax({url:l.handleUrlParam("/platform/resmanage/tableview/save-view-info"),data:Q,loading:{title:l.getMessage("data.import.title.execute"),text:l.getMessage("data.import.text.loading")},success:function(R){if(R.resFlag=="success"){t()}},error:function(R){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:l.getMessage("data.import.title.tips"),message:R.responseText||"视图信息保存异常!"})}})}function t(){bi.dialog.show({type:bi.dialog.TYPE_INFO,title:l.getMessage("data.import.title.tips"),message:"视图配置成功!",closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:l.getMessage("data.import.label.sure"),cssClass:"btn-info",action:function(Q){Q.close();jQuery("#viewButton").addClass("hide");jQuery(".bottom-button-common").addClass("hide");jQuery("#fieldSaveButton").addClass("hide")}},{label:l.getMessage("data.import.label.closePage"),cssClass:"btn-default",action:function(){if(jQuery.isFunction(window.opener.reloadDataList)){window.opener.reloadDataList()}window.close()}}]})}function h(){jQuery("#linkGrid").setGridWidth(jQuery(".link-info-grid").width()-5);jQuery("#linkGrid").setGridHeight(jQuery(".link-info-grid").height()-38)}function G(){jQuery("#fieldGrid").setGridWidth(jQuery(".field-info-grid").width()-5);jQuery("#fieldGrid").setGridHeight(jQuery(".field-info-grid").height()-38)}function q(){var Q=jQuery(this).find(".step-title-num");var R=jQuery(this).attr("id");if(Q.hasClass("active-Finished")||!Q.hasClass("active-notFinished")){if(R=="viewTab"){O(1);jQuery("#"+a()+"").addClass("hide");jQuery("#viewInfo").removeClass("hide")}else{if(R=="tableTab"){O(2);jQuery("#"+a()+"").addClass("hide");jQuery("#tableInfo").removeClass("hide")}else{if(R=="linkTab"){O(3);jQuery("#"+a()+"").addClass("hide");jQuery("#linkInfo").removeClass("hide");if(jQuery("#linkGrid").is(":empty")){B()}else{h()}}else{if(R=="fieldTab"){O(4);jQuery("#"+a()+"").addClass("hide");jQuery("#fieldInfo").removeClass("hide");if(jQuery("#fieldGrid").is(":empty")){i()}else{G()}}}}}}}function a(){if(jQuery(".view-info").is(":visible")){return"viewInfo"}if(jQuery(".table-info").is(":visible")){return"tableInfo"}if(jQuery(".link-info").is(":visible")){return"linkInfo"}if(jQuery(".field-info").is(":visible")){return"fieldInfo"}}});