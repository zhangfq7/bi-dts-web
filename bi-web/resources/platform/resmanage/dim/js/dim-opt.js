define(["sabace","handsontable","dimOpt/message"],function(r,l,h){var f;var n=1;var y;var u;var g;var D;var v;var j=true;var K=false;var H;jQuery(function(){jQuery("#firstStep-div .form-horizontal").validationEngine({validationEventTrigger:"input propertychange paste keyup",promptPosition:"bottomLeft",showOneMessage:true,scroll:false,});x();$("#dbId").chosen({disable_search:false});if(!r.IsEmpty(dimId)){G()}});function G(){var O={dimId:dimId};r.ajax({url:r.handleUrlParam("/platform/resmanage/dim/query-dim-info"),data:O,success:function(P){b(P)},error:function(P){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:r.getMessage("dim.title.error"),message:r.getMessage("dim.message.query.dimInfo.error")})},loading:{spin:true}})}function b(T){jQuery("#dimName").val(T.dimName);var W=jQuery("#parentDimName");W.attr("trueValue",T.parentDimId);W.attr("value",T.parentDimName);n=T.createType;if("1"==n){var Q=jQuery("#textEdit");Q.removeClass("fa-square-o");Q.addClass("fa-check-square-o");var R=jQuery("#dataImport");R.removeClass("fa-check-square-o");R.addClass("fa-square-o")}else{if("2"==n){jQuery("#dataImport").removeClass("fa-square-o");jQuery("#dataImport").addClass("fa-check-square-o");jQuery("#textEdit").removeClass("fa-check-square-o");jQuery("#textEdit").addClass("fa-square-o");var X=jQuery("#dataId");X.attr("trueValue",T.dataId);X.attr("value",T.dataName);X.val(T.dataName);var Y=jQuery("#dimCodeAttr");Y.attr("key",T.dimCodeAttr);Y.attr("value",T.dimCodeName);Y.val(T.dimCodeName);var U=jQuery("#dimLabelAttr");U.attr("key",T.dimLabelAttr);U.attr("value",T.dimLabelName);U.val(T.dimLabelName);var P=jQuery("#parentCodeAttr");P.attr("key",T.parentCodeAttr);P.attr("value",T.parentCodeName);P.val(T.parentCodeName);var V=jQuery("#dimOrderAttr");V.attr("key",T.dimOrderAttr);V.attr("value",T.dimOrderName);V.val(T.dimOrderName)}else{if("3"==n){jQuery("#configSql").removeClass("fa-square-o");jQuery("#configSql").addClass("fa-check-square-o");jQuery("#textEdit").removeClass("fa-check-square-o");jQuery("#textEdit").addClass("fa-square-o");var O=jQuery("#dbId");O.val(T.dbId);O.trigger("chosen:updated");var S=jQuery("#dimSqlStr");S.val(T.dimSql);var Y=jQuery("#dimCodeAttrSql");Y.val(T.dimCodeAttr);var U=jQuery("#dimLabelAttrSql");U.val(T.dimLabelAttr);var P=jQuery("#parentCodeAttrSql");P.val(T.parentCodeAttr);var V=jQuery("#dimOrderAttrSql");V.val(T.dimOrderAttr)}}}jQuery("#dimDesc").val(T.dimDesc)}function x(){var P=jQuery("#firstStep-div .checkBox");P.on("click",function(){f=jQuery(this).hasClass("fa-square-o");if(f){P.removeClass("fa-check-square-o");P.addClass("fa-square-o");jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o")}});jQuery("#firstStep-div .radio-label").on("click",function(){jQuery(this).prev().click()});var O=jQuery("#parentDimName");O.treeselect({height:200,chkStyle:"radio",searchAjaxParam:"dimName",width:(O.width()+21),url:r.handleUrlParam("/platform/resmanage/dim/upper-dim-tree")});jQuery("#first-next").on("click",function(){var R=$("#firstStep-div .form-horizontal").validationEngine("validate");if(!R){return}var Q=jQuery("#firstStep-div .fa-check-square-o");if(n!=Q.attr("value")){K=true}else{K=false}n=Q.attr("value");d()});L(1)}function B(){y.clear();var O={colHeaders:[r.getMessage("dim.label.dimCode"),r.getMessage("dim.label.dimLabel"),r.getMessage("dim.label.parentCode")],colWidths:240};y.updateSettings(O);if(y.countCols()>3){y.alter("remove_col",3,y.countCols()-3)}if(y.countCols()<3){y.alter("insert_col",3,3-y.countCols())}if(y.countRows()>5){y.alter("remove_row",5,y.countRows()-5)}y.render()}function d(){E();if(j){c();if(!r.IsEmpty(dimId)&&!K){if("2"==n){if(!r.IsEmpty(jQuery("#dataId").attr("trueValue"))){i()}}else{if("3"==n){}else{var O={dimId:dimId};r.ajax({url:r.handleUrlParam("/platform/resmanage/dim/dim-edit-data"),data:O,success:function(Q){y.loadData(Q.dataList)},error:function(Q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:r.getMessage("dim.title.error"),message:r.getMessage("dim.message.query.dimData.error")})}})}}}j=false}if(K){B();var P=jQuery("#dataId");P.attr("trueValue","");P.attr("value","");C()}p();jQuery("#second-before").on("click",function(){k()});jQuery("#second-next").on("click",function(){var Q=$("#secondStep-div .form-horizontal").validationEngine("validate");if(!Q){return}m()})}function p(){if(r.IsEmpty(v)){v=jQuery("#secondStep-div .form-horizontal").validationEngine({validationEventTrigger:"input propertychange paste keyup",promptPosition:"bottomLeft",showOneMessage:true,scroll:false})}}function M(){var O=jQuery("#dataId");O.treeselect({height:200,chkStyle:"radio",searchAjaxParam:"dataName",width:(O.width()+21),zindex:1030,url:r.handleUrlParam("/platform/resmanage/dim/import-data-tree"),onCheck:function(){var Q=$.fn.zTree.getZTreeObj(this.id);var P=Q.getCheckedNodes(true);g=jQuery(P[0]).attr("pId");D=jQuery(P[0]).attr("lastUpdateTime");C();if(!r.IsEmpty(O.attr("trueValue"))){i()}}})}function m(){w()}function e(){z();jQuery("#showDimName").text(jQuery("#dimName").val());jQuery("#showParentDim").text(jQuery("#parentDimName").val());jQuery("#showCreateType").text(jQuery(".fa-check-square-o").next().text());var O=jQuery("#dimDesc").val();jQuery("#showDimDesc").text(r.cutstr(O,130));jQuery("#showDimDesc").prop("title",O);if("2"==n){o()}else{if("3"==n){F()}else{q()}}jQuery("#save-before").on("click",function(){E()});jQuery("#save-add").on("click",function(){I()})}function c(){if(r.IsEmpty(y)){var O=document.getElementById("dimData");y=new Handsontable(O,{minSpareRows:1,rowHeaders:true,colHeaders:[r.getMessage("dim.label.dimCode"),r.getMessage("dim.label.dimLabel"),r.getMessage("dim.label.parentCode")],colWidths:240,contextMenuCopyPaste:{swfPath:"swf/ZeroClipboard.swf"}});y.alter("remove_col",3,2);y.render()}}function C(){var R=jQuery("#dimCodeAttr");R.attr("key","");R.attr("value","");var P=jQuery("#dimLabelAttr");P.attr("key","");P.attr("value","");var O=jQuery("#parentCodeAttr");O.attr("key","");O.attr("value","");var Q=jQuery("#dimOrderAttr");Q.attr("key","");Q.attr("value","")}function i(){var O={dataId:jQuery("#dataId").attr("trueValue")};r.ajax({url:r.handleUrlParam("/platform/resmanage/dim/dim-import-data"),data:O,loading:{title:r.getMessage("dim.title.tips"),text:r.getMessage("dim.message.loading")},success:function(P){s(P)},error:function(P){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:r.getMessage("dim.title.error"),message:r.getMessage("dim.message.query.data.error")})}})}function s(Q){y.loadData(Q.dataList);var P={colHeaders:Q.titleList,colWidths:Q.titleLength};var O=Q.titleList.length;if(O<3){y.alter("remove_col",O,3-O)}y.updateSettings(P);y.render();N()}function N(){var O=jQuery("#secondStep-div .opt-menu");jQuery(".data-head").poshytip({className:"tip-yellowsimple",content:O.outerHTML(),showTimeout:3,alignY:"bottom",liveEvents:true,show:function(){O.parent().attr("key",jQuery(this).attr("key"));O.parent().attr("value",jQuery(this).attr("value"));a()},keepInViewport:false})}function a(){var O=jQuery("#secondStep-div .opt-menu");var Q=O.parent().attr("key");var P=O.parent().attr("value");jQuery(".opt-menu").on("click",".opt-dimId",function(){var R=jQuery("#dimCodeAttr");R.attr("key",Q);R.attr("value",P);R.val(P)});jQuery(".opt-menu").on("click",".opt-dimName",function(){var R=jQuery("#dimLabelAttr");R.attr("key",Q);R.attr("value",P);R.val(P)});jQuery(".opt-menu").on("click",".opt-parentId",function(){var R=jQuery("#parentCodeAttr");R.attr("key",Q);R.attr("value",P);R.val(P)});jQuery(".opt-menu").on("click",".opt-orderId",function(){var R=jQuery("#dimOrderAttr");R.attr("key",Q);R.attr("value",P);R.val(P)})}function o(){var O={dataId:jQuery("#dataId").attr("trueValue"),dimId:jQuery("#dimCodeAttr").attr("key"),dimName:jQuery("#dimLabelAttr").attr("key"),parentCodeAttr:jQuery("#parentCodeAttr").attr("key"),dimOrderAttr:jQuery("#dimOrderAttr").attr("key")};r.ajax({url:r.handleUrlParam("/platform/resmanage/dim/get-import-result"),data:O,loading:{title:r.getMessage("dim.title.tips"),text:r.getMessage("dim.message.loading")},success:function(P){A(P.dataList,P.dataList.length)},error:function(P){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:r.getMessage("dim.title.error"),message:r.getMessage("dim.message.query.result.error")})}})}function F(){var O={dbId:jQuery("#dbId").val(),dimSql:jQuery("#dimSqlStr").val(),dimId:jQuery("#dimCodeAttrSql").val(),dimName:jQuery("#dimLabelAttrSql").val(),parentCodeAttr:jQuery("#parentCodeAttrSql").val(),dimOrderAttr:jQuery("#dimOrderAttrSql").val()};r.ajax({url:r.handleUrlParam("/platform/resmanage/dim/get-sql-result"),data:O,loading:{title:r.getMessage("dim.title.tips"),text:r.getMessage("dim.message.loading")},success:function(P){A(P.dataList,P.dataList.length)},error:function(P){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:r.getMessage("dim.title.error"),message:r.getMessage("dim.message.query.result.error")})}})}function w(){var O={createType:n,dataId:jQuery("#dataId").attr("trueValue"),dimId:jQuery("#dimCodeAttr").attr("key"),dimName:jQuery("#dimLabelAttr").attr("key"),dataList:JSON.stringify(y.getData())};if("3"==n){O.dimId=jQuery("#dimCodeAttrSql").val();O.dimName=jQuery("#dimLabelAttrSql").val();O.dbId=jQuery("#dbId").val();O.dimSql=jQuery("#dimSqlStr").val()}r.ajax({url:r.handleUrlParam("/platform/resmanage/dim/check-dim-data"),data:O,loading:{title:r.getMessage("dim.title.tips"),text:r.getMessage("dim.message.loading")},success:function(Q){var P=Q.result;if("valid"==P){e()}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:r.getMessage("dim.title.error"),message:Q.msg})}},error:function(P){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:r.getMessage("dim.title.error"),message:r.getMessage("dim.message.check.error")})}})}function A(Q,P){if(r.IsEmpty(u)){var O=document.getElementById("showData");u=new Handsontable(O,{data:Q,readOnly:true,minSpareRows:1,rowHeaders:true,colHeaders:[r.getMessage("dim.label.dimCode"),r.getMessage("dim.label.dimLabel"),r.getMessage("dim.label.parentCode")],colWidths:240,contextMenuCopyPaste:{swfPath:"swf/ZeroClipboard.swf"}})}else{u.loadData(Q)}u.render();jQuery("#showDimCount").text(P)}function q(){var O=y.countRows()-y.countEmptyRows();A(y.getData(),O)}function L(S){var R=jQuery(window).width()/3;var O=R-64;var P=R*(S-1)+32;O=O.toString()+"px";P=P.toString()+"px";var Q=jQuery("#stepLine");Q.css("margin-left",P);Q.css("width",O);Q.css("background-color","#6BACD5")}function J(O){L(O);jQuery(".step-title-num").addClass("active-notFinished");jQuery(".step-title-num:lt("+(O)+")").removeClass("active-notFinished")}function k(){J(1);t("firstStep-div")}function E(){J(2);t("secondStep-div");if("1"==n){jQuery("#dimInfoTable").removeClass("hide");jQuery("#dataDiv").addClass("hide");jQuery("#sqlDiv").addClass("hide");jQuery("#textDiv").removeClass("hide");jQuery("#dimData").css("height","349px")}else{if("2"==n){jQuery("#dimInfoTable").removeClass("hide");jQuery("#sqlDiv").addClass("hide");jQuery("#dataDiv").removeClass("hide");jQuery("#textDiv").addClass("hide");jQuery("#dimData").css("height","257px");M()}else{if("3"==n){jQuery("#dimInfoTable").addClass("hide");jQuery("#sqlDiv").removeClass("hide");jQuery("#dataDiv").addClass("hide");jQuery("#textDiv").addClass("hide")}}}}function z(){J(3);t("saveStep-div")}function t(O){jQuery(".step-div").addClass("hide");jQuery("#"+O).removeClass("hide")}function I(){var O={dimId:dimId,dimName:jQuery("#showDimName").text(),parentDimId:jQuery("#parentDimName").attr("trueValue"),dimRecordNum:jQuery("#showDimCount").text(),createType:n,dataId:jQuery("#dataId").attr("trueValue"),importType:g,lastUpdateTime:D,dimCodeAttr:jQuery("#dimCodeAttr").attr("key"),dimLabelAttr:jQuery("#dimLabelAttr").attr("key"),parentCodeAttr:jQuery("#parentCodeAttr").attr("key"),dimOrderAttr:jQuery("#dimOrderAttr").attr("key"),dimDesc:jQuery("#showDimDesc").text(),tableData:JSON.stringify(u.getData())};if(n=="3"){O.dbId=jQuery("#dbId").val();O.dimSql=jQuery("#dimSqlStr").val();O.dimCodeAttr=jQuery("#dimCodeAttrSql").val();O.dimLabelAttr=jQuery("#dimLabelAttrSql").val();O.parentCodeAttr=jQuery("#parentCodeAttrSql").val();O.dimOrderAttr=jQuery("#dimOrderAttrSql").val()}bi.dialog.confirm({title:r.getMessage("dim.title.confirm"),message:r.getMessage("dim.message.opt.confirm"),callback:function(P){if(P){r.ajax({url:r.handleUrlParam("/platform/resmanage/dim/save-dim-info"),data:O,loading:{title:r.getMessage("dim.title.tips"),text:r.getMessage("dim.message.opt.doing")},success:function(Q){if("succeed"==Q.result){bi.dialog.show({title:r.getMessage("dim.title.succeed"),message:r.getMessage("dim.message.opt.succeed"),onhidden:function(){window.close();opener.dimList.searchTable()}})}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:r.getMessage("dim.title.error"),message:r.getMessage("dim.message.opt.error")})}},error:function(Q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:r.getMessage("dim.title.error"),message:r.getMessage("dim.message.opt.error")})}})}}})}});