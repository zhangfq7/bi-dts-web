define(["sabace","handsontable","dimOpt/message"],function(s,l,h){var f;var n=1;var z;var v;var g;var E;var w;var j=true;var L=false;var I;jQuery(function(){jQuery("#firstStep-div .form-horizontal").validationEngine({validationEventTrigger:"input propertychange paste keyup",promptPosition:"bottomLeft",showOneMessage:true,scroll:false,});jQuery("#projectId").chosen({disable_search:true,width:"280px"});y();$("#dbId").chosen({disable_search:false});if(!s.IsEmpty(dimId)){H()}jQuery("#parentDimName").click()});function H(){var P={dimId:dimId};s.ajax({url:s.handleUrlParam("/platform/resmanage/dim/query-dim-info"),data:P,success:function(Q){b(Q)},error:function(Q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("dim.title.error"),message:s.getMessage("dim.message.query.dimInfo.error")})},loading:{spin:true}})}function b(U){jQuery("#dimName").val(U.dimName);var X=jQuery("#parentDimName");X.attr("trueValue",U.parentDimId);X.attr("value",U.parentDimName);n=U.createType;if("1"==n){var R=jQuery("#textEdit");R.removeClass("fa-square-o");R.addClass("fa-check-square-o");var S=jQuery("#dataImport");S.removeClass("fa-check-square-o");S.addClass("fa-square-o")}else{if("2"==n){jQuery("#dataImport").removeClass("fa-square-o");jQuery("#dataImport").addClass("fa-check-square-o");jQuery("#textEdit").removeClass("fa-check-square-o");jQuery("#textEdit").addClass("fa-square-o");var Y=jQuery("#dataId");Y.attr("trueValue",U.dataId);Y.attr("value",U.dataName);Y.val(U.dataName);var Z=jQuery("#dimCodeAttr");Z.attr("key",U.dimCodeAttr);Z.attr("value",U.dimCodeName);Z.val(U.dimCodeName);var V=jQuery("#dimLabelAttr");V.attr("key",U.dimLabelAttr);V.attr("value",U.dimLabelName);V.val(U.dimLabelName);var Q=jQuery("#parentCodeAttr");Q.attr("key",U.parentCodeAttr);Q.attr("value",U.parentCodeName);Q.val(U.parentCodeName);var W=jQuery("#dimOrderAttr");W.attr("key",U.dimOrderAttr);W.attr("value",U.dimOrderName);W.val(U.dimOrderName)}else{if("3"==n){jQuery("#configSql").removeClass("fa-square-o");jQuery("#configSql").addClass("fa-check-square-o");jQuery("#textEdit").removeClass("fa-check-square-o");jQuery("#textEdit").addClass("fa-square-o");var P=jQuery("#dbId");P.val(U.dbId);P.trigger("chosen:updated");var T=jQuery("#dimSqlStr");T.val(U.dimSql);var Z=jQuery("#dimCodeAttrSql");Z.val(U.dimCodeAttr);var V=jQuery("#dimLabelAttrSql");V.val(U.dimLabelAttr);var Q=jQuery("#parentCodeAttrSql");Q.val(U.parentCodeAttr);var W=jQuery("#dimOrderAttrSql");W.val(U.dimOrderAttr)}}}jQuery("#dimDesc").val(U.dimDesc);jQuery("#projectId").find("option[value='"+U.proId+"']").attr("selected",true);jQuery("#projectId").trigger("chosen:updated")}var o;function y(){var Q=jQuery("#firstStep-div .checkBox");Q.on("click",function(){f=jQuery(this).hasClass("fa-square-o");if(f){Q.removeClass("fa-check-square-o");Q.addClass("fa-square-o");jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o")}});jQuery("#firstStep-div .radio-label").on("click",function(){jQuery(this).prev().click()});var P=jQuery("#parentDimName");P.treeselect({height:200,chkStyle:"radio",searchAjaxParam:"dimName",width:(P.width()+21),url:s.handleUrlParam("/platform/resmanage/dim/upper-dim-tree")+"?proId="+jQuery.trim(jQuery("#projectId").find("option:selected").val())});jQuery("#first-next").on("click",function(){var S=$("#firstStep-div .form-horizontal").validationEngine("validate");if(!S){return}var R=jQuery("#firstStep-div .fa-check-square-o");if(n!=R.attr("value")){L=true}else{L=false}n=R.attr("value");d()});jQuery("#projectId").on("change",function(S,U){var R=jQuery("#parentDimName");var T=R.data("defaults");if(T&&T.url){R.val("");R.attr("trueValue","");R.attr("value","");T.url=s.handleUrlParam("/platform/resmanage/dim/upper-dim-tree")+"?proId="+jQuery.trim(jQuery("#projectId").find("option:selected").val());R.treeselectUpdate()}});M(1)}function C(){z.clear();var P={colHeaders:[s.getMessage("dim.label.dimCode"),s.getMessage("dim.label.dimLabel"),s.getMessage("dim.label.parentCode")],colWidths:240};z.updateSettings(P);if(z.countCols()>3){z.alter("remove_col",3,z.countCols()-3)}if(z.countCols()<3){z.alter("insert_col",3,3-z.countCols())}if(z.countRows()>5){z.alter("remove_row",5,z.countRows()-5)}z.render()}function d(){F();if(j){c();if(!s.IsEmpty(dimId)&&!L){if("2"==n){if(!s.IsEmpty(jQuery("#dataId").attr("trueValue"))){i()}}else{if("3"==n){}else{var P={dimId:dimId};s.ajax({url:s.handleUrlParam("/platform/resmanage/dim/dim-edit-data"),data:P,success:function(R){z.loadData(R.dataList)},error:function(R){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("dim.title.error"),message:s.getMessage("dim.message.query.dimData.error")})}})}}}j=false}if(L){C();var Q=jQuery("#dataId");Q.attr("trueValue","");Q.attr("value","");D()}q();jQuery("#second-before").on("click",function(){k()});jQuery("#second-next").on("click",function(){var R=$("#secondStep-div .form-horizontal").validationEngine("validate");if(!R){return}m()})}function q(){if(s.IsEmpty(w)){w=jQuery("#secondStep-div .form-horizontal").validationEngine({validationEventTrigger:"input propertychange paste keyup",promptPosition:"bottomLeft",showOneMessage:true,scroll:false})}}function N(){var P=jQuery("#dataId");P.treeselect({height:200,chkStyle:"radio",searchAjaxParam:"dataName",width:(P.width()+21),zindex:1030,url:s.handleUrlParam("/platform/resmanage/dim/import-data-tree"),onCheck:function(){var R=$.fn.zTree.getZTreeObj(this.id);var Q=R.getCheckedNodes(true);g=jQuery(Q[0]).attr("pId");E=jQuery(Q[0]).attr("lastUpdateTime");D();if(!s.IsEmpty(P.attr("trueValue"))){i()}}})}function m(){x()}function e(){A();jQuery("#showDimName").text(jQuery("#dimName").val());jQuery("#showParentDim").text(jQuery("#parentDimName").val());jQuery("#showCreateType").text(jQuery(".fa-check-square-o").next().text());var P=jQuery("#dimDesc").val();jQuery("#showDimDesc").text(s.cutstr(P,130));jQuery("#showDimDesc").prop("title",P);if("2"==n){p()}else{if("3"==n){G()}else{r()}}jQuery("#save-before").on("click",function(){F()});jQuery("#save-add").on("click",function(){J()})}function c(){if(s.IsEmpty(z)){var P=document.getElementById("dimData");z=new Handsontable(P,{minSpareRows:1,rowHeaders:true,colHeaders:[s.getMessage("dim.label.dimCode"),s.getMessage("dim.label.dimLabel"),s.getMessage("dim.label.parentCode")],colWidths:240,contextMenuCopyPaste:{swfPath:"swf/ZeroClipboard.swf"}});z.alter("remove_col",3,2);z.render()}}function D(){var S=jQuery("#dimCodeAttr");S.attr("key","");S.attr("value","");var Q=jQuery("#dimLabelAttr");Q.attr("key","");Q.attr("value","");var P=jQuery("#parentCodeAttr");P.attr("key","");P.attr("value","");var R=jQuery("#dimOrderAttr");R.attr("key","");R.attr("value","")}function i(){var P={dataId:jQuery("#dataId").attr("trueValue")};s.ajax({url:s.handleUrlParam("/platform/resmanage/dim/dim-import-data"),data:P,loading:{title:s.getMessage("dim.title.tips"),text:s.getMessage("dim.message.loading")},success:function(Q){t(Q)},error:function(Q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("dim.title.error"),message:s.getMessage("dim.message.query.data.error")})}})}function t(R){z.loadData(R.dataList);var Q={colHeaders:R.titleList,colWidths:R.titleLength};var P=R.titleList.length;if(P<3){z.alter("remove_col",P,3-P)}z.updateSettings(Q);z.render();O()}function O(){var P=jQuery("#secondStep-div .opt-menu");jQuery(".data-head").poshytip({className:"tip-yellowsimple",content:P.outerHTML(),showTimeout:3,alignY:"bottom",liveEvents:true,show:function(){P.parent().attr("key",jQuery(this).attr("key"));P.parent().attr("value",jQuery(this).attr("value"));a()},keepInViewport:false})}function a(){var P=jQuery("#secondStep-div .opt-menu");var R=P.parent().attr("key");var Q=P.parent().attr("value");jQuery(".opt-menu").on("click",".opt-dimId",function(){var S=jQuery("#dimCodeAttr");S.attr("key",R);S.attr("value",Q);S.val(Q)});jQuery(".opt-menu").on("click",".opt-dimName",function(){var S=jQuery("#dimLabelAttr");S.attr("key",R);S.attr("value",Q);S.val(Q)});jQuery(".opt-menu").on("click",".opt-parentId",function(){var S=jQuery("#parentCodeAttr");S.attr("key",R);S.attr("value",Q);S.val(Q)});jQuery(".opt-menu").on("click",".opt-orderId",function(){var S=jQuery("#dimOrderAttr");S.attr("key",R);S.attr("value",Q);S.val(Q)})}function p(){var P={dataId:jQuery("#dataId").attr("trueValue"),dimId:jQuery("#dimCodeAttr").attr("key"),dimName:jQuery("#dimLabelAttr").attr("key"),parentCodeAttr:jQuery("#parentCodeAttr").attr("key"),dimOrderAttr:jQuery("#dimOrderAttr").attr("key")};s.ajax({url:s.handleUrlParam("/platform/resmanage/dim/get-import-result"),data:P,loading:{title:s.getMessage("dim.title.tips"),text:s.getMessage("dim.message.loading")},success:function(Q){B(Q.dataList,Q.dataList.length)},error:function(Q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("dim.title.error"),message:s.getMessage("dim.message.query.result.error")})}})}function G(){var P={dbId:jQuery("#dbId").val(),dimSql:jQuery("#dimSqlStr").val(),dimId:jQuery("#dimCodeAttrSql").val(),dimName:jQuery("#dimLabelAttrSql").val(),parentCodeAttr:jQuery("#parentCodeAttrSql").val(),dimOrderAttr:jQuery("#dimOrderAttrSql").val()};s.ajax({url:s.handleUrlParam("/platform/resmanage/dim/get-sql-result"),data:P,loading:{title:s.getMessage("dim.title.tips"),text:s.getMessage("dim.message.loading")},success:function(Q){B(Q.dataList,Q.dataList.length)},error:function(Q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("dim.title.error"),message:s.getMessage("dim.message.query.result.error")})}})}function x(){var P={createType:n,dataId:jQuery("#dataId").attr("trueValue"),dimId:jQuery("#dimCodeAttr").attr("key"),dimName:jQuery("#dimLabelAttr").attr("key"),dataList:JSON.stringify(z.getData())};if("3"==n){P.dimId=jQuery("#dimCodeAttrSql").val();P.dimName=jQuery("#dimLabelAttrSql").val();P.dbId=jQuery("#dbId").val();P.dimSql=jQuery("#dimSqlStr").val()}s.ajax({url:s.handleUrlParam("/platform/resmanage/dim/check-dim-data"),data:P,loading:{title:s.getMessage("dim.title.tips"),text:s.getMessage("dim.message.loading")},success:function(R){var Q=R.result;if("valid"==Q){e()}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("dim.title.error"),message:R.msg})}},error:function(Q){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("dim.title.error"),message:s.getMessage("dim.message.check.error")})}})}function B(R,Q){if(s.IsEmpty(v)){var P=document.getElementById("showData");v=new Handsontable(P,{data:R,readOnly:true,minSpareRows:1,rowHeaders:true,colHeaders:[s.getMessage("dim.label.dimCode"),s.getMessage("dim.label.dimLabel"),s.getMessage("dim.label.parentCode")],colWidths:240,contextMenuCopyPaste:{swfPath:"swf/ZeroClipboard.swf"}})}else{v.loadData(R)}v.render();jQuery("#showDimCount").text(Q)}function r(){var P=z.countRows()-z.countEmptyRows();B(z.getData(),P)}function M(T){var S=jQuery(window).width()/3;var P=S-64;var Q=S*(T-1)+32;P=P.toString()+"px";Q=Q.toString()+"px";var R=jQuery("#stepLine");R.css("margin-left",Q);R.css("width",P);R.css("background-color","#6BACD5")}function K(P){M(P);jQuery(".step-title-num").addClass("active-notFinished");jQuery(".step-title-num:lt("+(P)+")").removeClass("active-notFinished")}function k(){K(1);u("firstStep-div")}function F(){K(2);u("secondStep-div");if("1"==n){jQuery("#dimInfoTable").removeClass("hide");jQuery("#dataDiv").addClass("hide");jQuery("#sqlDiv").addClass("hide");jQuery("#textDiv").removeClass("hide");jQuery("#dimData").css("height","349px")}else{if("2"==n){jQuery("#dimInfoTable").removeClass("hide");jQuery("#sqlDiv").addClass("hide");jQuery("#dataDiv").removeClass("hide");jQuery("#textDiv").addClass("hide");jQuery("#dimData").css("height","257px");N()}else{if("3"==n){jQuery("#dimInfoTable").addClass("hide");jQuery("#sqlDiv").removeClass("hide");jQuery("#dataDiv").addClass("hide");jQuery("#textDiv").addClass("hide")}}}}function A(){K(3);u("saveStep-div")}function u(P){jQuery(".step-div").addClass("hide");jQuery("#"+P).removeClass("hide")}function J(){var P={dimId:dimId,dimName:jQuery("#showDimName").text(),parentDimId:jQuery("#parentDimName").attr("trueValue"),dimRecordNum:jQuery("#showDimCount").text(),createType:n,dataId:jQuery("#dataId").attr("trueValue"),importType:g,lastUpdateTime:E,dimCodeAttr:jQuery("#dimCodeAttr").attr("key"),dimLabelAttr:jQuery("#dimLabelAttr").attr("key"),parentCodeAttr:jQuery("#parentCodeAttr").attr("key"),dimOrderAttr:jQuery("#dimOrderAttr").attr("key"),dimDesc:jQuery("#showDimDesc").text(),tableData:JSON.stringify(v.getData()),proId:jQuery.trim(jQuery("#projectId").find("option:selected").val())};if(n=="3"){P.dbId=jQuery("#dbId").val();P.dimSql=jQuery("#dimSqlStr").val();P.dimCodeAttr=jQuery("#dimCodeAttrSql").val();P.dimLabelAttr=jQuery("#dimLabelAttrSql").val();P.parentCodeAttr=jQuery("#parentCodeAttrSql").val();P.dimOrderAttr=jQuery("#dimOrderAttrSql").val()}bi.dialog.confirm({title:s.getMessage("dim.title.confirm"),message:s.getMessage("dim.message.opt.confirm"),callback:function(Q){if(Q){s.ajax({url:s.handleUrlParam("/platform/resmanage/dim/save-dim-info"),data:P,loading:{title:s.getMessage("dim.title.tips"),text:s.getMessage("dim.message.opt.doing")},success:function(R){if("succeed"==R.result){bi.dialog.show({title:s.getMessage("dim.title.succeed"),message:s.getMessage("dim.message.opt.succeed"),onhidden:function(){window.close();opener.dimList.searchTable()}})}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("dim.title.error"),message:s.getMessage("dim.message.opt.error")})}},error:function(R){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:s.getMessage("dim.title.error"),message:s.getMessage("dim.message.opt.error")})}})}}})}});