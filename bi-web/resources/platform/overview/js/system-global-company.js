define(["EBuilder","sabace","glober/message","system/serviceInfo"],function(e,d,n,i){var b={};b.modal={echartsObj:{}};var j=jQuery("#bi-nav").css("backgroundColor")||"#87cefa";var c=jQuery("<div>",{"class":"webuploader-pick-hover"});jQuery("body").append(c);var f=c.css("backgroundColor")||"#87cefa";c.remove();b.view={initSpace:function(){function q(w){if(w===0){return"0 B"}var x=1024,z=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],y=Math.floor(Math.log(w)/Math.log(x));return(w/Math.pow(x,y)).toFixed(1)+" <span>"+z[y]+"</span>"}function t(w){if(w===0){return"0 B"}var x=1024,z=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],y=Math.floor(Math.log(w)/Math.log(x));return(w/Math.pow(x,y)).toFixed(1)}var v=jQuery("#usedStorage>span").html().replace("M","");var u=jQuery(".allSpace>span").html().replace("M","");v=parseInt(v)<0?0:parseInt(v);u=parseInt(u)<0?0:parseInt(u);if(v>u){v=u}var p=t(u*1024*1024);var r=parseFloat(v/(u/p)).toFixed(1);var s=jQuery("#usedStorage");s.html(q(v*1024*1024));jQuery(".allSpace").html(q(u*1024*1024));jQuery("#allspace").html(r+"/"+q(u*1024*1024));jQuery("#allspace span").css({color:"#34495e","font-weight":"normal","font-size":"13px"});var o=v/u*100;if(o>80){s.removeClass("theme-background");s.css("background","orange")}if(o>90){s.removeClass("theme-background");s.css("background","red")}s.css({width:o+"%"})},initDashboard:function(){d.ajax({url:d.handleUrlParam("/platform/overview/sysGlobal/get-dashboard"),success:function(o){var p=[];if(o.resFlag=="success"){jQuery.each(o.visitList,function(r,q){var s={};s.name="第"+(r+1);s.group="访问排名";s.reportName=q.reportName;s.reportId=q.reportId;s.value=q.visitCount;p.push(s)});if(d.IsEmpty(p)){$("#dashboardChart").hide();$("#noDashboardData").show();return}else{$("#dashboardChart").show();$("#noDashboardData").hide();l(p)}}else{$("#dashboardChart").hide();$("#noDashboardData").show()}},error:function(o){$("#noDashboardData .text").html(o.responseText);$("#dashboardChart").hide();$("#noDashboardData").show()}})},initTplRank:function(){d.ajax({url:d.handleUrlParam("/platform/overview/sysGlobal/get-tpl-rank"),success:function(p){if(p.resFlag=="success"){var o=[];jQuery.each(p.tplList,function(r,q){var s={};s.group="引用数量";s.name="第"+(r+1);s.value=q.usedNum;s.tplName=q.tplName;s.tplId=q.tplId;s.thumbImg=q.thumbImg;o.push(s)});if(d.IsEmpty(o)){$("#tplRankChart").hide();$("#noTplRankData").show();return}else{$("#tplRankChart").show();$("#noTplRankData").hide();k(o)}}else{$("#tplRankChart").hide();$("#noTplRankData").show()}},error:function(o){$("#noTplRankData .text").html(o.responseText);$("#tplRankChart").hide();$("#noTplRankData").show()}})},initData:function(){d.ajax({url:d.handleUrlParam("/platform/overview/sysGlobal/get-data-pie"),success:function(p){if(p.resFlag=="success"){var s=p.dataBean;$("#dataSuccNum").html(s.succNum);$("#dataFailNum").html(s.failNum);var q=[];var o={};o.group="数据更新";o.name="成功";o.value=s.succNum;q.push(o);var r={};r.group="数据更新";r.name="失败";r.value=s.failNum;q.push(r);if(d.IsEmpty(q)){$("#dataChart").hide();$("#noDataData").show();return}else{$("#dataChart").show();$("#noDataData").hide();a(q)}}else{$("#dataChart").hide();$("#noDataData").show()}},error:function(o){$("#noDataData .text").html(o.responseText);$("#dataChart").hide();$("#noDataData").show()}})},initDataSource:function(){d.ajax({url:d.handleUrlParam("/platform/overview/sysGlobal/get-data-source"),success:function(v){var u=[];var o=v.numList;var p=v.reportNumList;var r=v.numBean;var t=v.reportNumBean;if(o!=null){jQuery.each(o,function(z,y){var A={};A.group="数据表数量";A.name=y.dbName;A.value=y.tableNum;u.push(A)})}if(p!=null){jQuery.each(p,function(z,y){var A={};A.group="仪表板数量";A.name=y.dbName;A.value=y.tableReportNum;u.push(A)})}var q={};q.group="数据表数量";q.name="文件";q.value=r.fileNum;u.push(q);var s={};s.group="仪表板数量";s.name="文件";s.value=t.fileReportNum;u.push(s);var x={};x.group="数据表数量";x.name="数据连接";x.value=r.linkNum;u.push(x);var w={};w.group="仪表板数量";w.name="数据连接";w.value=t.linkReportNum;u.push(w);if(d.IsEmpty(u)){$("#dataSourceChart").hide();$("#noDataSourceData").show();return}else{$("#dataSourceChart").show();$("#noDataSourceData").hide();g(u)}},error:function(o){$("#noDataSourceData .text").html(o.responseText);$("#dataSourceChart").hide();$("#noDataSourceData").show()}})},initDataTime:function(){d.ajax({url:d.handleUrlParam("/platform/overview/sysGlobal/get-data-time"),success:function(p){if(p.resFlag=="success"){var o=[];jQuery.each(p.timeList,function(r,q){var s={};s.group="耗时";s.name="第"+(r+1);s.value=q.taskTotalSecond;s.dataName=q.dataName;s.dataId=q.dataId;s.taskType=q.taskType;o.push(s)});if(d.IsEmpty(o)){$("#dataTimeChart").hide();$("#noDataTimeData").show();return}else{o.reverse();$("#dataTimeChart").show();$("#noDataTimeData").hide();h(o)}}else{$("#dataTimeChart").hide();$("#noDataTimeData").show()}},error:function(o){$("#noDataTimeData .text").html(o.responseText);$("#dataTimeChart").hide();$("#noDataTimeData").show()}})}};function l(o){$("#dashboardChart").EBuilder({data:o,type:["bar"],option:{tooltip:{formatter:function(){var p=arguments[0][0].data.reportName+": "+arguments[0][0].data.value+"次";return p}},legend:{show:false},toolbox:{show:false},color:[j],grid:{x:50,x2:30,y:8,y2:40},series:[{barWidth:25}],yAxis:[{axisLabel:{formatter:"{value}"},axisLine:{lineStyle:{color:j}}}],xAxis:[{axisLine:{lineStyle:{color:j}}}]},theme:["echarts/theme/blue"],callback:function(){b.modal.echartsObj.dashboard=this;var p=require("echarts/config");this.on(p.EVENT.CLICK,function(){window.open(d.handleUrlParam("/platform/dataview/view")+"?reportId="+arguments[0].data.reportId)})}})}function k(o){$("#tplRankChart").EBuilder({data:o,type:["bar"],option:{tooltip:{formatter:function(){var p=arguments[0][0].data.tplName+": "+arguments[0][0].data.value+"次";return p}},legend:{show:false},color:[j],toolbox:{show:false},grid:{x:50,x2:30,y:8,y2:40},series:[{barWidth:40}],yAxis:[{axisLabel:{formatter:"{value}"},axisLine:{lineStyle:{color:j}}}],xAxis:[{axisLine:{lineStyle:{color:j}}}]},theme:["echarts/theme/blue"],callback:function(){b.modal.echartsObj.tpl=this;var p=require("echarts/config");this.on(p.EVENT.CLICK,function(){var q=jQuery("<form></form>",{method:"post",action:d.handleUrlParam("/platform/myreport/tpl/report-tpl-view"),target:"_blank",html:"<input name='thumbImg' value='"+arguments[0].data.thumbImg+"'/>"});jQuery("body").append(q);q.submit();jQuery(q).remove()})}})}function a(o){$("#dataChart").EBuilder({data:o,type:["pie"],option:{toolbox:{show:false},tooltip:{enterable:true,showDelay:100},color:[j,f],legend:{show:false},series:[{radius:["60%","80%"]}]},theme:["echarts/theme/blue"],callback:function(){b.modal.echartsObj.data=this}})}function g(o){$("#dataSourceChart").EBuilder({data:o,type:["line"],option:{tooltip:{trigger:"axis",axisPointer:{lineStyle:{color:j}}},toolbox:{show:false},color:[j],xAxis:[{type:"category",boundaryGap:false,axisLine:{lineStyle:{color:j}}}],yAxis:[{axisLine:{lineStyle:{color:j}}}],series:[{type:"line",itemStyle:{normal:{areaStyle:{type:"default"}}},smooth:true},{type:"line",itemStyle:{normal:{areaStyle:{type:"default"}}},smooth:true}]},theme:["echarts/theme/blue"],callback:function(){b.modal.echartsObj.dataSource=this;var p=require("echarts/config")}})}function h(o){$("#dataTimeChart").EBuilder({data:o,type:["bar"],yx:true,option:{tooltip:{formatter:function(){var p=arguments[0][0].data.dataName+": "+arguments[0][0].data.value+"秒";return p}},legend:{show:false},color:[j],toolbox:{show:false},grid:{x:43,x2:30,y:0,y2:40},series:[{barWidth:15}],xAxis:[{axisLabel:{formatter:"{value}秒"},axisLine:{lineStyle:{color:j}}}],yAxis:[{axisLine:{lineStyle:{color:j}}}]},theme:["echarts/theme/blue"],callback:function(){b.modal.echartsObj.time=this;var p=require("echarts/config");this.on(p.EVENT.CLICK,function(){var u=arguments[0].data.taskType;var q=arguments[0].data.dataId;var s=null;var t=null;if(u=="1"||u=="2"){s=d.handleUrlParam("/platform/resmanage/data/data-common-view");t="<input name='dataId' value='"+q+"'/><input name='type' value='"+u+"'/>"}else{if(u=="3"){s=d.handleUrlParam("/platform/resmanage/datalink/data-link-show");t="<input name='dataLinkId' value='"+q+"'/>"}}var r=jQuery("<form></form>",{method:"post",action:s,target:"_blank",html:t});jQuery("body").append(r);r.submit();jQuery(r).remove()})}})}function m(){var o=jQuery(this).val();d.ajax({data:{type:o},url:d.handleUrlParam("/platform/overview/sysGlobal/get-dashboard"),success:function(p){var q=[];if(p.resFlag=="success"){if(o=="visit"){jQuery.each(p.visitList,function(s,r){var t={};t.name="第"+(s+1);t.group="访问排名";t.reportName=r.reportName;t.reportId=r.reportId;t.value=r.visitCount;q.push(t)})}else{if(o=="share"){jQuery.each(p.shareList,function(s,r){var t={};t.name="第"+(s+1);t.group="分享排名";t.reportName=r.reportName;t.reportId=r.reportId;t.value=r.shareNum;q.push(t)})}else{if(o=="email"){jQuery.each(p.emailList,function(s,r){var t={};t.name="第"+(s+1);t.group="邮件推送排名";t.reportName=r.reportName;t.reportId=r.reportId;t.value=r.emailNum;q.push(t)})}}}if(d.IsEmpty(q)){$("#dashboardChart").hide();$("#noDashboardData").show();return}else{$("#dashboardChart").show();$("#noDashboardData").hide();l(q)}}else{$("#dashboardChart").hide();$("#noDashboardData").show();return}},error:function(p){$("#noDashboardData .text").html(p.responseText);$("#dashboardChart").hide();$("#noDashboardData").show()}})}b.controller={init:function(){jQuery("#selectRank").chosen({disable_search:true});b.view.initSpace();b.view.initDashboard();b.view.initTplRank();b.view.initData();b.view.initDataSource();b.view.initDataTime();jQuery("#selectRank").bind("change",m);jQuery("#extendStorage").bind("click",function(){window.open(d.handleUrlParam("/platform/serviceopen/extend-storage"))});jQuery("#reportCount").bind("click",function(){window.open(d.handleUrlParam("/platform/myreport/view/report-list"))});jQuery("#dataSuccNum").bind("click",function(){var o=d.handleUrlParam("/platform/overview/sysGlobal/service-info")+"?state=9";bi.dialog.show({title:"七日内数据表更新监控-成功总数",message:jQuery('<div id="serviceInfo" ></div>').load(o),cssClass:"service-info-dialog",closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确认",cssClass:"btn-info",action:function(p){p.close()}}],onshown:function(){i.init()}})});jQuery("#dataFailNum").bind("click",function(){var o=d.handleUrlParam("/platform/overview/sysGlobal/service-info")+"?state=7";bi.dialog.show({title:"七日内数据表更新监控-失败总数",message:jQuery('<div id="serviceInfo" ></div>').load(o),cssClass:"service-info-dialog",closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确认",cssClass:"btn-info",action:function(p){p.close()}}],onshown:function(){i.init()}})});window.onresize=function(){$.each(b.modal.echartsObj,function(p,o){b.modal.echartsObj[p].resize&&b.modal.echartsObj[p].resize()})}}};return b.controller});