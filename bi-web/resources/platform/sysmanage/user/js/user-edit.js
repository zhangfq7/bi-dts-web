define(["sabace","upload","user/message"],function(x,p){var u;var o=0;var A=0;var E=null;var f=0;var e=0;var n=jQuery(".preview-container");var v=jQuery(".preview-container img");var t=n.width();var h=n.height();var r;var k;var z=0;var g=140;var s=140;var C="";var j=false;var m=false;var d="";var D="";function w(){if(!x.IsEmpty(userInfoBeanId)){jQuery(".avatar").attr("src",x.handleUrlParam("/platform/readUserImg")+"?userImgId="+userInfoBeanId+"&_t="+new Date().getTime());jQuery("#preview").attr("src",x.handleUrlParam("/platform/readUserImg")+"?userImgId="+userInfoBeanId+"&_t="+new Date().getTime())}else{jQuery(".avatar").attr("src",x.handleUrlParam("/platform/readUserImg")+"?userImgId=default&_t="+new Date().getTime());jQuery("#preview").attr("src",x.handleUrlParam("/platform/readUserImg")+"?userImgId=default&_t="+new Date().getTime())}n=jQuery(".preview-container");v=jQuery(".preview-container img");t=n.width();h=n.height();jQuery(".user-info-rgt").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true});var H=new Date().getFullYear();d="";for(var I=H;I>=H-100;I--){d+='<option value="'+I+'">'+I+"</option>"}jQuery("#select-year").html(d);d="";for(var J=1;J<=12;J++){d+='<option value="'+J+'">'+J+"</option>"}jQuery("#select-month").html(d);d="";for(var G=1;G<=31;G++){d+='<option value="'+G+'">'+G+"</option>"}jQuery("#select-day").html(d);var F=$("#depIdShow").val();if(F==undefined){F=""}if(!x.IsEmpty(birthday2)){var I=birthday2.split("-")[0];var J=parseInt(birthday2.split("-")[1]);var G=parseInt(birthday2.split("-")[2]);jQuery("#select-year").val(I);jQuery("#select-month").val(J);jQuery("#select-day").val(G);$("#add-dep").attr("truevalue",F);$("#add-dep").attr("value",$("#depName").val())}jQuery("#select-year").chosen({disable_search:true});jQuery("#select-day").chosen({disable_search:true});jQuery("#select-month").chosen({disable_search:true});jQuery("#select-year").on("change",b);jQuery("#select-month").on("change",b);if(!x.IsEmpty(sex2)){if(sex2=="1"){jQuery("#mail").removeClass("fa-square-o");jQuery("#mail").addClass("fa-check-square-o")}else{if(sex2=="0"){jQuery("#femail").removeClass("fa-square-o");jQuery("#femail").addClass("fa-check-square-o")}else{if(sex2=="9"){jQuery("#unknown").removeClass("fa-square-o");jQuery("#unknown").addClass("fa-check-square-o")}}}}jQuery(".checkBox").on("click",function(){j=jQuery(this).hasClass("fa-square-o");jQuery(".checkBox").removeClass("fa-check-square-o");jQuery(".checkBox").addClass("fa-square-o");if(j){jQuery(this).removeClass("fa-square-o");jQuery(this).addClass("fa-check-square-o")}});if(sex2==""){jQuery("#mail").eq(0).trigger("click");m=false}else{m=true}$("#add-dep").treeselect({height:200,searchAjaxParam:"depName",width:310,chkStyle:"radio",url:x.handleUrlParam("/platform/sysmanage/dept/company-dept"),onCheck:function(){$("#div"+this.id).fadeOut("fast")}});l();$(".chosen-select").chosen({disable_search:true});jQuery("#saveUserInfoBtn").on("click",c);jQuery("#cancelUserInfoBtn").on("click",function(){window.parent.location.reload()})}function b(){var G=jQuery("#select-year").val();var H=jQuery("#select-month").val();var I=y(G,H);d="";for(var F=1;F<=I;F++){d+='<option value="'+F+'">'+F+"</option>"}jQuery("#select-day-parent").html('<select id="select-day" class="birthday-select"></select>');jQuery("#select-day").html(d);jQuery("#select-day").chosen({disable_search:true})}function y(F,G){return new Date(F,G,0).getDate()}function l(){jQuery("#picker").show();u=WebUploader.create({swf:resPath+"/bace/js/webuploader/swf/Uploader.swf",server:x.handleUrlParam("/platform/sysmanage/user/upload-file")+"?userFlag=other",pick:"#picker",resize:false,auto:true,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"}});u.on("uploadSuccess",function(G,F){x.timeout(function(){jQuery("#uploadProgress").slideUp();jQuery("#picker").css("margin","0px");a(F)},500)});u.on("uploadProgress",function(G,F){jQuery("#uploadProgress").html(Math.round(F*100)+"%");if(Math.round(F*100)==100){jQuery("#uploadProgress").html(x.getMessage("user.label.uploadSucceed"))}});u.on("startUpload",function(){jQuery("#uploadProgress").slideDown();jQuery("#uploadProgress").html("0%");jQuery("#cropImageDiv").empty()})}function a(F){u.reset();i(F.width,F.height)}function q(H){if(parseInt(H.w)>0){tcx=(H.x/(o*z))*o;tcy=(H.y/(A*z))*A;tcw=((H.x2-H.x)/(o*z))*o;tch=((H.y2-H.y)/(A*z))*A;if((tcx+tcw)>o){tcw=o-tcx}if((tcy+tch)>A){tch=A-tcy}var G=t/H.w;var F=h/H.h;console.log("xsize="+t);console.log("ysize="+h);v.css({width:Math.round(G*f)+"px",height:Math.round(F*e)+"px",marginLeft:"-"+Math.round(G*H.x)+"px",marginTop:"-"+Math.round(F*H.y)+"px"})}}function B(){var J=E.getBounds();var H=100;var F=0;var K=0;if(J[0]>=H&&J[1]>=H){F=(J[0]-H)/2;K=(J[1]-H)/2}else{if(J[0]>J[1]){H=J[1];F=(J[0]-H)/2;K=0}else{if(J[0]<J[1]){H=J[0];F=0;K=(J[1]-H)/2}else{H=J[0];F=0;K=0}}}var G=F+H;var I=K+H;return[F,K,G,I]}function i(F,H){jQuery("#preview-tr").show();jQuery("#cropImageDiv").css("background","url("+resPath+"/resources/platform/sysmanage/user/img/bg.jpg)");o=F;A=H;jQuery("#cropImageDiv").empty();if(E!=null){E.destroy()}var I=x.handleUrlParam("/platform/readByteImg")+"?_t="+new Date().getTime()+"&userFlag=other";jQuery("#cropImageDiv").append('<img id="element_id" />');jQuery("#element_id").attr("src",I);jQuery("#preview").attr("src",I);if(F>g||H>s){jQuery("#cropImageDiv").css({padding:"0px",height:s+"px",width:g+"px"});if(F>g&&H<=s){z=g/F;jQuery("#element_id").width(F*z+"px");k=H*z;jQuery("#cropImageDiv").css("paddingTop",(s-k)/2+"px")}else{if(F<=g&&H>s){z=s/H;jQuery("#element_id").height(H*z+"px");r=F*z;jQuery("#cropImageDiv").css("paddingLeft",(g-r)/2+"px")}else{if(F>g&&H>s){var G=g/F;var J=s/H;if(G<=J){z=g/F;jQuery("#element_id").width(F*z+"px");k=H*z;jQuery("#cropImageDiv").css("paddingTop",(s-k)/2+"px")}else{z=s/H;jQuery("#element_id").height(H*z+"px");r=F*z;jQuery("#cropImageDiv").css("paddingLeft",(g-r)/2+"px")}}}}}else{z=1;jQuery("#cropImageDiv").css({paddingTop:(s-H)/2+"px",paddingLeft:(g-F)/2+"px",})}jQuery("#element_id").Jcrop({aspectRatio:t/h,onSelect:q,onChange:q,animationDelay:20,addClass:"jcrop-light"},function(){E=this;var K=E.getBounds();f=K[0];e=K[1];x.timeout(function(){E.animateTo(B())},300)})}function c(M){var H=jQuery(".user-info-rgt").validationEngine("validate");if(!H){return}var Q=$("#paneluserName").val().trim();if($("#add-dep").attr("truevalue")==undefined){bi.dialog.show({title:"提示框",message:"请选择部门！",cssClass:"register-dialog",nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:"确定",action:function(T){T.close()}}]})}var J=$("#add-dep").attr("truevalue").trim();var L=$(".fa-check-square-o").attr("sex2");var G=$("#add-job-id").val();var I=$("#panelmobile_num").val().trim();var N=$("#panelemail").val().trim();var O=jQuery("#select-year").val();var K=jQuery("#select-month").val();var P=jQuery("#select-day").val();if(K<10){K="0"+K}if(P<10){P="0"+P}var S=O+"-"+K+"-"+P;var F=jQuery("#sign").val();var R={userName:Q,birthday:S,depId:J,sex:L,jobIds:G,mobileNum:I,email:N,bardianSign:F};if(E!=null&&E.tellSelect().x!=E.tellSelect().x2){R.tcx=Math.floor(tcx);R.tcy=Math.floor(tcy);R.tcw=Math.floor(tcw);R.tch=Math.floor(tch);R.operType="1"}bi.dialog.confirm({title:x.getMessage("user.label.confirm"),message:x.getMessage("user.label.confirmPreserve"),callback:function(T){if(T){if(m){var V=$("#paneluserId").val().trim();R.userId=V;R.userImageId=V;U=x.handleUrlParam("/platform/sysmanage/userlist/user-list-edit")+"?userFlag=other"}else{var U=x.handleUrlParam("/platform/sysmanage/userlist/user-list-add")+"?userFlag=other"}x.ajax({data:R,url:U,success:function(X){if(X.count==0){bi.dialog.show({title:x.getMessage("user.label.tip"),message:x.getMessage("user.userlist.label.signature"),nl2br:false,closable:true,closeByBackdrop:false,closeByKeyboard:false});return}var W=X.flag;if(W=="success"){bi.dialog.show({title:x.getMessage("user.label.succeed"),message:x.getMessage("user.label.saveSuccesfully"),buttons:[{label:"确定",cssClass:"btn-info",action:function(Y){jQuery("#searchButton").trigger("click");Y.close();M.close()}}]})}else{if(W=="email"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:x.getMessage("提示"),message:x.getMessage("邮箱已存在"),buttons:[{label:"确定",cssClass:"btn-info",action:function(Y){Y.close()}}]})}else{if(W=="phone"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:x.getMessage("提示"),message:x.getMessage("手机号码已存在"),buttons:[{label:"确定",cssClass:"btn-info",action:function(Y){Y.close()}}]})}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:x.getMessage("user.label.error"),message:x.getMessage("user.label.saveError")})}}}},error:function(W){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:x.getMessage("user.label.error"),message:W.responseText||x.getMessage("user.label.saveError")})}})}}})}return{init:w,saveUserInfo:c}});