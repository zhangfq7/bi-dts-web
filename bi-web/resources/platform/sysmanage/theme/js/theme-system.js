define(["sabace","upload","theme/message"],function(w,x,o){var u;var n=0;var A=0;var C=null;var f=0;var e=0;var m=jQuery(".preview-container");var v=jQuery(".preview-container img");var t=m.width();var h=m.height();var q;var k;var z=0;var g=250;var s=50;var j=false;var d="";jQuery(function(){c();l();jQuery("#saveThemeBtn").on("click",a);jQuery("#recoverThemeBtn").on("click",r);jQuery(".div-left").validationEngine({validationEventTrigger:"input propertychange paste keyup ",promptPosition:"topRight",showOneMessage:true});jQuery(".theme-system-bg-border").bind("click",function(){var D=jQuery(this).find(">div").attr("id");jQuery(".theme-test").remove();jQuery(".panel:eq(0)").append('<link class="theme-test" rel="stylesheet" href="'+resPath+"/bace/ui/css/flat-ui-"+D+'.css" />')})});jQuery(".theme-system-bg-border").on("click",function(){var D=jQuery(this);jQuery(".theme-system-bg-border").removeClass("checked");D.addClass("checked");y(D)});function y(E){var D=E.find(">div").css("background-color");jQuery("#cropImageDiv,.preview-container").css({background:D,"box-shadow":"0px 0px 3px 3px "+D,})}function c(){w.ajax({url:w.handleUrlParam("/platform/sysmanage/theme/query-bg-color"),success:function(D){var E=jQuery("#"+D.bgColor).parent();E.toggleClass("checked");y(E)},error:function(D){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:w.getMessage("theme.label.error"),message:D.responseText||w.getMessage("theme.label.saveFail")})}})}function l(){jQuery("#picker").show();u=WebUploader.create({swf:resPath+"/bace/js/webuploader/swf/Uploader.swf",server:w.handleUrlParam("/platform/sysmanage/theme/upload-file"),pick:"#picker",resize:false,auto:true,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"}});u.on("uploadSuccess",function(E,D){w.timeout(function(){jQuery("#uploadProgress").slideUp();jQuery("#picker").css("margin","0px");b(D)},500)});u.on("uploadProgress",function(E,D){jQuery("#uploadProgress").html(Math.round(D*100)+"%");if(Math.round(D*100)==100){jQuery("#uploadProgress").html(w.getMessage("user.label.uploadSucceed"))}});u.on("startUpload",function(){jQuery("#uploadProgress").slideDown();jQuery("#uploadProgress").html("0%");jQuery("#cropImageDiv").empty()})}function b(D){u.reset();i(D.width,D.height)}function p(F){if(parseInt(F.w)>0){tcx=(F.x/(n*z))*n;tcy=(F.y/(A*z))*A;tcw=((F.x2-F.x)/(n*z))*n;tch=((F.y2-F.y)/(A*z))*A;if((tcx+tcw)>n){tcw=n-tcx}if((tcy+tch)>A){tch=A-tcy}var E=t/F.w;var D=h/F.h;v.css({width:Math.round(E*f)+"px",height:Math.round(D*e)+"px",marginLeft:"-"+Math.round(E*F.x)+"px",marginTop:"-"+Math.round(D*F.y)+"px",})}}function B(){var H=C.getBounds();var F=100;var D=0;var I=0;if(H[0]>=F&&H[1]>=F){D=(H[0]-F)/2;I=(H[1]-F)/2}else{if(H[0]>H[1]){F=H[1];D=(H[0]-F)/2;I=0}else{if(H[0]<H[1]){F=H[0];D=0;I=(H[1]-F)/2}else{F=H[0];D=0;I=0}}}var E=D+F;var G=I+F;return[D,I,E,G]}function i(D,F){jQuery("#preview-tr").show();n=D;A=F;jQuery("#cropImageDiv").empty();if(C!=null){C.destroy()}var G=w.handleUrlParam("/platform/readByteImg")+"?_t="+new Date().getTime()+"&companyFlag=yes";jQuery("#cropImageDiv").append('<img id="element_id" />');jQuery("#element_id").attr("src",G);jQuery("#preview").attr("src",G);if(D>g||F>s){jQuery("#cropImageDiv").css({padding:"0px",height:s+"px",width:g+"px"});if(D>g&&F<=s){z=g/D;jQuery("#element_id").width(D*z+"px");k=F*z;jQuery("#cropImageDiv").css("paddingTop",(s-k)/2+"px")}else{if(D<=g&&F>s){z=s/F;jQuery("#element_id").height(F*z+"px");q=D*z;jQuery("#cropImageDiv").css("paddingLeft",(g-q)/2+"px")}else{if(D>g&&F>s){var E=g/D;var H=s/F;if(E<=H){z=g/D;jQuery("#element_id").width(D*z+"px");k=F*z;jQuery("#cropImageDiv").css("paddingTop",(s-k)/2+"px")}else{z=s/F;jQuery("#element_id").height(F*z+"px");q=D*z;jQuery("#cropImageDiv").css("paddingLeft",(g-q)/2+"px")}}}}}else{z=1;jQuery("#cropImageDiv").css({paddingTop:(s-F)/2+"px",paddingLeft:(g-D)/2+"px",})}jQuery("#element_id").Jcrop({maxSize:[250,50],onSelect:p,onChange:p,animationDelay:20,bgColor:"transparent",addClass:"jcrop-normal"},function(){C=this;var I=C.getBounds();f=I[0];e=I[1];w.timeout(function(){C.animateTo(B())},300)})}function r(){bi.dialog.confirm({title:w.getMessage("theme.label.confirm"),message:w.getMessage("theme.label.recovery"),callback:function(D){if(D){w.ajax({loading:{title:w.getMessage("theme.label.tip"),text:w.getMessage("theme.label.pleaseWait2")},url:w.handleUrlParam("/platform/sysmanage/theme/recover-theme"),success:function(E){bi.dialog.show({title:w.getMessage("theme.label.succeed"),message:w.getMessage("theme.label.restoreSuccesfully"),closable:false,nl2br:false,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:w.getMessage("theme.button.OK"),cssClass:"btn-info",action:function(F){window.location.reload()}}]})},error:function(E){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:w.getMessage("theme.label.error"),message:E.responseText||w.getMessage("theme.label.saveError")})}})}}})}function a(){var D={};if(C!=null&&C.tellSelect().x!=C.tellSelect().x2){D.tcx=Math.floor(tcx);D.tcy=Math.floor(tcy);D.tcw=Math.floor(tcw);D.tch=Math.floor(tch);D.operType="1"}D.skin=jQuery(".theme-system-bg-border.checked>div").attr("id")==undefined?"blue":jQuery(".theme-system-bg-border.checked>div").attr("id");bi.dialog.confirm({title:w.getMessage("theme.label.confirm"),message:w.getMessage("theme.label.confirmSave"),callback:function(E){if(E){w.ajax({loading:{title:w.getMessage("theme.label.tip"),text:w.getMessage("theme.label.pleaseWait")},data:D,url:w.handleUrlParam("/platform/sysmanage/theme/save-theme"),success:function(F){if(F.flag=="succeed"){bi.dialog.show({title:w.getMessage("theme.label.succeed"),message:w.getMessage("theme.label.saveSuccesfully")});w.timeout(function(){document.location.href=w.handleUrlParam("/platform/sysmanage/theme/systheme")},3000)}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:w.getMessage("theme.label.error"),message:w.getMessage("theme.label.saveFail")})}},error:function(F){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:w.getMessage("theme.label.error"),message:F.responseText||w.getMessage("theme.label.saveError")})}})}}})}});