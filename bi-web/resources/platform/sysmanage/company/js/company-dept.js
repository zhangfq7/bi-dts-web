define(["sabace","message"],function(c,i){function g(){jQuery("#depTree").jqGrid({url:c.handleUrlParam("/platform/sysmanage/dept/dept-list"),styleUI:"Bootstrap",postData:"",datatype:"json",height:"auto",autowidth:true,treeGrid:true,ExpandColumn:"depName",treeGridModel:"adjacency",regional:"cn",mtype:"post",forceFit:true,loadComplete:function(){$(".tree-wrap").width(function(){return $(this).width()+14})},colModel:[{index:"depId",label:c.getMessage("company.dept.label.select"),formatter:function(j,k,m){var l='<input type="checkbox" id="selectDepId" value="'+m.depId+'" name="'+m.depName+'" depDegree="'+m.depDegree+'" allUserCount="'+m.allUserCount+'" parentId="'+m.parent+'" parentName="'+m.parentName+'"/>';l+='<div style="display:none">'+m.depDesc+"</div>";return l},cellattr:function(o,l,m,j,n){if(!m.depId){var k=jQuery(this).jqGrid("getGridParam","colModel");return"colspan="+k.length}},hlign:"center",align:"center",sortable:false,width:50,title:false},{name:"depId",key:true,hidden:true,sortable:false},{name:"depName",index:"depName",label:c.getMessage("company.dept.label.depName"),hlign:"center",sortable:false,width:300},{name:"userCount",index:"userCount",label:c.getMessage("company.dept.label.userCount"),hlign:"center",align:"right",sortable:false,width:90},{name:"allUserCount",index:"allUserCount",label:c.getMessage("company.dept.label.allUserCount"),hlign:"center",align:"right",sortable:false,width:90},{name:"depDesc",index:"depDesc",label:c.getMessage("company.dept.label.depDesc"),hlign:"center",sortable:false,width:240},{name:"adminId",index:"adminId",label:c.getMessage("company.dept.label.adminName"),hlign:"center",sortable:false,width:100},{name:"adminTime",index:"adminTime",label:c.getMessage("company.dept.label.adminTime"),hlign:"center",sortable:false,width:130}]});jQuery("#searchButton").on("click",function(){f()});jQuery("#addDepButton").on("click",function(){a()});jQuery("#modifyDepButton").on("click",function(){h()});jQuery("#delDepButton").on("click",function(){d()});$(window).resize(function(){$("#depTree").setGridWidth($("#depListPanel").width()-5)})}function f(){var j={};j.depName=$("#queryDepName").val();j.depDesc=$("#queryDepDesc").val();jQuery("#depTree").jqGrid("setGridParam",{postData:j}).trigger("reloadGrid")}function a(){var l=$("#selectDepId:checked");if(l.length!=1){bi.dialog.show({type:"type-warning",title:c.getMessage("company.label.tip"),message:c.getMessage("company.dept.mag.supper.noselect"),});return}var k=bi.dialog.show({title:c.getMessage("company.dept.label.deptAdd"),message:jQuery("#depInfoPanel").outerHTML(),nl2br:false,closable:true,cssClass:"open-dialog",closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:c.getMessage("company.button.cancel"),action:function(n){n.close()}},{label:c.getMessage("company.button.save"),cssClass:"btn-info",action:function(n){var o=n.getModalBody().find("#depInfoPanel").validationEngine("validate");if(!o){return false}bi.dialog.confirm({title:c.getMessage("company.label.confirm"),message:c.getMessage("company.dept.msg.saveConfirm"),callback:function(p){if(!p){return}e(k,"add")}})}}]});var j=jQuery(l[0]).val();var m=jQuery(l[0]).attr("name");k.getModalBody().find("#parentDepName").val(m);k.getModalBody().find("#parentDepId").val(j);k.getModalBody().find("#depInfoPanel").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true});setTimeout(function(){k.getModalBody().find("#depDesc").html("").focus().blur()},150)}function h(){var p=$("#selectDepId:checked");if(p.length!=1){bi.dialog.show({type:"type-warning",title:c.getMessage("company.label.tip"),message:c.getMessage("company.dept.msg.edit.noselect"),});return}var l=jQuery(p[0]).attr("depDegree");if(l==1){bi.dialog.show({type:"type-warning",title:c.getMessage("company.label.tip"),message:c.getMessage("company.dept.msg.editRoot"),});return}var j=bi.dialog.show({title:c.getMessage("company.dept.label.deptEdit"),message:jQuery("#depInfoPanel").outerHTML(),nl2br:false,closable:true,cssClass:"open-dialog",closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:c.getMessage("company.button.cancel"),action:function(r){r.close()}},{label:c.getMessage("company.button.save"),cssClass:"btn-info",action:function(r){var s=r.getModalBody().find("#depInfoPanel").validationEngine("validate");if(!s){return false}bi.dialog.confirm({title:c.getMessage("company.label.confirm"),message:c.getMessage("company.dept.msg.saveConfirm"),callback:function(t){if(!t){return}e(j,"modify")}})}}]});var m=jQuery(p[0]).val();var q=jQuery(p[0]).attr("name");var o=jQuery(p[0]).attr("parentId");var k=jQuery(p[0]).attr("parentName");var n=jQuery(p[0]).next().html();j.getModalBody().find("#parentDepId").val(o);j.getModalBody().find("#parentDepName").val(k);j.getModalBody().find("#depId").val(m);j.getModalBody().find("#depName").val(q);j.getModalBody().find("#depDesc").val(n);j.getModalBody().find("#depInfoPanel").validationEngine({autoHidePrompt:true,autoHideDelay:2000,binded:true,promptPosition:"bottomLeft",showOneMessage:true})}function d(){var o=$("#selectDepId:checked");if(o.length<1){bi.dialog.show({type:"type-warning",title:c.getMessage("company.label.tip"),message:c.getMessage("company.dept.msg.del.noselect"),});return}var l=[];for(var j=0;j<o.length;j++){l[j]=jQuery(o[j]).val();var n=jQuery(o[j]).attr("name");var k=jQuery(o[j]).attr("allUserCount");var m=jQuery(o[j]).attr("depDegree");if(parseInt(m)==1){bi.dialog.show({type:"type-warning",title:c.getMessage("company.label.tip"),message:c.getMessage("company.dept.msg.delRoot"),});return}if(parseInt(k)>0){bi.dialog.show({type:"type-warning",title:c.getMessage("company.label.tip"),message:c.getMessage("company.dept.msg.del.hasUser",n),});return}}bi.dialog.confirm({title:c.getMessage("company.label.confirm"),message:c.getMessage("company.dept.msg.delConfirm"),callback:function(p){if(!p){return}b(l)}})}function e(k,l){var j={};j.depId=k.getModalBody().find("#depId").val();j.depName=k.getModalBody().find("#depName").val().trim();j.parentDepId=k.getModalBody().find("#parentDepId").val();j.depDesc=k.getModalBody().find("#depDesc").val();j.type=l;c.ajax({url:c.handleUrlParam("/platform/sysmanage/dept/check-dept-name"),data:j,loading:{title:c.getMessage("company.label.tip"),text:c.getMessage("company.label.pleaseWait")},success:function(n){var m=n.flag;if(n.flag=="1"){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:c.getMessage("company.label.tip"),message:c.getMessage("company.dept.msg.checkDeptName"),buttons:[{label:c.getMessage("company.label.confirm"),cssClass:"btn-info",action:function(o){o.close()}}]})}if(n.flag=="0"){c.ajax({url:c.handleUrlParam("/platform/sysmanage/dept/save-dept"),data:j,success:function(o){if(o.saveFlag=="true"){bi.dialog.show({title:c.getMessage("company.label.succeed"),message:c.getMessage(o.retMsg),buttons:[{label:c.getMessage("company.label.confirm"),cssClass:"btn-info",action:function(p){f();p.close();k.close()}}]})}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:c.getMessage("company.label.error"),message:c.getMessage(o.retMsg)})}},error:function(o){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:c.getMessage("company.label.error"),message:c.getMessage("company.dept.msg.save.error")})}})}},error:function(m){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:c.getMessage("company.label.error"),message:m.responseText||c.getMessage("company.dept.msg.save.error")})}})}function b(k){var j={};j.depIdArray=k;c.ajax({url:c.handleUrlParam("/platform/sysmanage/dept/delete-dep-list"),data:j,loading:{title:c.getMessage("company.label.tip"),text:c.getMessage("company.label.pleaseWait")},success:function(l){if(l.delFlag=="true"){bi.dialog.show({title:c.getMessage("company.label.succeed"),message:c.getMessage(l.retMsg),onhide:function(){f()}})}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:c.getMessage("company.label.error"),message:c.getMessage(l.retMsg,l.depName)})}},error:function(l){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:c.getMessage("company.label.error"),message:l.responseText||c.getMessage("company.dept.msg.del.error")})}})}return{init:g}});