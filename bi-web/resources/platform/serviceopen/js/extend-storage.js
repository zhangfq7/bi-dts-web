define(["sabace","slider","order/message"],function(q,n,h){var e;var k;s();m();l();p();$(window).resize(function(){jQuery("#orderGrid").setGridWidth(jQuery("#order-list").width())});function m(){jQuery(".buttons").on("click",".buy",function(){if(jQuery(".order-div").hasClass("hide")){jQuery(".order-div").removeClass("hide");if(jQuery(".order-list-div").hasClass("hide")){}else{jQuery(".order-list-div").addClass("hide")}}else{jQuery(".order-div").addClass("hide")}});jQuery(".buttons").on("click",".calc",function(){if(jQuery(".order-list-div").hasClass("hide")){jQuery(".order-list-div").removeClass("hide");jQuery("#orderGrid").setGridWidth(jQuery("#order-list").width());if(jQuery(".order-div").hasClass("hide")){}else{jQuery(".order-div").addClass("hide")}}else{jQuery(".order-list-div").addClass("hide")}});jQuery("#storageValue").on("change",function(){var u=jQuery("#storageValue").val();if(!isNaN(u)){if(u>10){u=10}else{if(u<0){u=0}else{u=Math.floor(u/0.1)/10}}j(u,false)}else{jQuery("#storageValue").val(e);jQuery("#storageValue").attr("numVal",Math.floor(e*1024))}});jQuery(".btn-group button").bind("click",function(){jQuery(".btn-group button").removeClass("clickedButton theme-background").addClass("normalButton");jQuery(this).addClass("clickedButton theme-background").removeClass("normalButton");var u=jQuery(this).val();a(u)});jQuery(".btn-group").on("mouseover",".normalButton",function(){jQuery(".normalButton").removeClass("theme-background");jQuery(this).addClass("theme-background")}).on("mouseleave",".normalButton",function(){jQuery(this).removeClass("theme-background")});c();jQuery("#lastbutton").click();jQuery("#confirm").on("click",function(){o()});jQuery(".order-list").on("click",".orderEdit",function(){k=jQuery(this).attr("orderId");var v=jQuery(this).attr("orderEndDate");if(q.IsEmpty(v)){jQuery("#lastbutton").click()}else{v=v.substr(0,7)}var u=jQuery(this).attr("orderNum");u=Math.round(u/102.4);u=Number(u)/10;j(u,false);jQuery("#stoageSlider").slider("disable");jQuery("#storageValue").prop("disabled",true);jQuery(".btn-group button").each(function(w){var x=jQuery(this).html();if(x===v){jQuery(this).click()}});jQuery(".order-list-div").addClass("hide");jQuery(".order-div").removeClass("hide");jQuery(".buttons button").prop("disabled",true);jQuery("#back").removeClass("hide")});jQuery("#back").on("click",function(){jQuery(".order-div").addClass("hide");jQuery(".order-list-div").removeClass("hide");jQuery("#orderGrid").setGridWidth(jQuery("#order-list").width());jQuery("#back").addClass("hide");f()});jQuery(".order-list").on("click",".orderClose",function(){t(jQuery(this).attr("orderId"))});jQuery("#changeOrderDate").on("click",function(){jQuery("#queryOrderDate").focus()});jQuery("#queryOrderListBtn").on("click",function(){g()})}function s(){jQuery("#stoageSlider").slider({min:0,max:10,range:"min",step:0.1,slide:function(u,v){j(v.value,true)}}).slider("pips",{rest:"label",step:20,suffix:"GB",click:false}).slider("float",{handle:true,pips:true,suffix:"GB"});jQuery("#stoageSlider .ui-widget-header").addClass("theme-background");jQuery("#stoageSlider .ui-slider-handle").unbind("focusin").on("mouseover",function(){jQuery(this).addClass("theme-border-color")}).on("mouseleave",function(){jQuery(this).removeClass("theme-border-color")})}function b(w){var v=jQuery("#storageValue").attr("numVal");var u=Math.floor(v)*servicePrice;jQuery("#costPerMon").html(u)}function r(){var u=false;var v=jQuery("#storageValue").val();if(v>0){u=true}if(u){jQuery("#confirm").prop("disabled","")}else{jQuery("#confirm").prop("disabled",true)}}function a(x){if("--"==x){orderEnderDay=x;jQuery("#orderEnderDay").html(orderEnderDay);jQuery("#orderEnderDay").attr("endDate",x)}else{var w=new Date();w.setDate(1);w.setMonth(w.getMonth()+1+Number(x));cdt=new Date(w.getTime()-1000*60*60*24);var z=cdt.getFullYear();var v=(cdt.getMonth()+1)+"";var y=cdt.getDate()+"";if(v.length==1){v="0"+v}if(y.length==1){y="0"+y}orderEndDate=z+"-"+v+"-"+y;var u='<span class="font-orange dateNum">'+z+"</span>"+q.getMessage("order.label.year")+'<span class="font-orange dateNum">'+v+"</span>"+q.getMessage("order.label.month")+'<span class="font-orange dateNum">'+y+"</span>"+q.getMessage("order.label.day");jQuery("#orderEnderDay").html(u);jQuery("#orderEnderDay").attr("endDate",orderEndDate)}}function o(){var v=Number(jQuery("#storageValue").attr("numVal"));var x=jQuery("#orderEnderDay").attr("endDate");if(x=="--"){x=""}var w=Number(jQuery("#costPerMon").html());var u={orderId:k,serviceId:serviceId,orderNum:v,orderEndDate:x,sumConstIntegral:w};bi.dialog.confirm({title:q.getMessage("order.label.sure"),message:q.getMessage("order.label.sure.save"),callback:function(y){if(y){q.ajax({type:"post",cache:false,dataType:"json",url:q.handleUrlParam("/platform/serviceopen/save-order"),data:u,loading:{title:q.getMessage("order.label.save"),text:q.getMessage("order.label.saveing")},success:function(z){if("true"==z.saveFlag){if(q.IsEmpty(k)){totalNum=Number(totalNum)+Number(v);p()}bi.dialog.show({title:q.getMessage("order.label.save.succeed"),message:q.getMessage("order.storage.msg.succeed"),onhidden:function(){jQuery(".order-div").addClass("hide");jQuery(".order-list-div").removeClass("hide");jQuery("#orderGrid").setGridWidth(jQuery("#order-list").width());jQuery("#orderGrid").trigger("reloadGrid");f()}})}else{var A=z.integralNum;bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:q.getMessage("order.label.save.failed"),message:q.getMessage("order.msg.tooLarge",A)})}},error:function(z){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:q.getMessage("order.label.save.failed"),message:q.getMessage("order.storage.msg.failed")})}})}}})}function l(){jQuery("#queryOrderDate").dateRange({format:"YYYY-MM-DD",startValue:"",start:{maxDate:moment().format("YYYY-MM-DD"),},end:{maxDate:moment().format("YYYY-MM-DD"),},onhide:function(){var v=jQuery(this).dateRange("getDate")}});var u={serviceId:serviceId};jQuery("#orderGrid").jqGrid({url:q.handleUrlParam("/platform/serviceopen/order-list"),styleUI:"Bootstrap",autowidth:true,postData:u,height:"auto",mtype:"post",regional:"cn",datatype:"json",viewrecords:true,rownumbers:true,colModel:[{label:"订购编码",name:"orderId",index:"orderId",hlign:"center",hidden:true},{label:"订购数量",name:"orderNum",index:"orderNum",hlign:"center",hidden:true},{label:q.getMessage("order.label.serviceName"),name:"serviceShowName",index:"serviceShowName",hlign:"center",width:250,sortable:false},{label:q.getMessage("order.label.storageSize"),name:"orderCount",index:"orderCount",hlign:"center",width:180,sortable:false,formatter:function(v,w,x){if(v>1000){return(Math.round(v/102.4)/10)+"GB"}else{return v+"MB"}}},{label:q.getMessage("order.label.orderCost"),name:"sumConstIntegral",index:"sumConstIntegral",hlign:"center",width:180,sortable:false,formatter:function(v,w,x){return v+q.getMessage("order.label.costUnit")}},{label:q.getMessage("order.label.orderStartDate"),name:"orderStartDate",index:"orderStartDate",hlign:"center",width:200,sortable:false},{label:q.getMessage("order.label.orderEndDate"),name:"orderEndDate",index:"orderEndDate",hlign:"center",width:200,sortable:false},{label:q.getMessage("order.label.operation"),name:"dimId",index:"dimId",align:"center",hlign:"center",width:180,sortable:false,formatter:function(w,x,y){var v=y.orderId;return"<a href='javascript:void(0)' class='orderEdit' orderId='"+v+"' orderEndDate='"+y.orderEndDate+"' orderNum='"+y.orderNum+"'>"+q.getMessage("order.label.modify")+"</a>"}}],pager:"#orderGridPager",rowNum:5,rowList:[5],jsonReader:{records:"total",total:"totalPages"},afterInsertRow:function(w,v){}})}function c(){var v=new Date();v.setDate(1);var u=new Date();jQuery(".btn-group button").each(function(x){if(x==0){v.setMonth(v.getMonth())}else{if(x<9){v.setMonth(v.getMonth()+1)}else{if(x<11){v.setMonth(u.getMonth()+12)}else{return}}}var w=(v.getMonth()+1);if(w<10){w="0"+w}jQuery(this).html(v.getFullYear()+"-"+w)})}function j(v,u){if(!u){jQuery("#stoageSlider").slider("value",v)}jQuery("#storageValue").val(v);jQuery("#storageValue").attr("numVal",Math.floor(v*1024));e=v;b(v);r()}function f(){j(0,false);jQuery("#lastbutton").click();k="";if(jQuery(".buttons button").prop("disabled")){jQuery(".buttons button").prop("disabled","")}if(jQuery("#stoageSlider").slider("option","disabled")){jQuery("#stoageSlider").slider("enable")}if(jQuery("#storageValue").prop("disabled")){jQuery("#storageValue").prop("disabled","")}}function t(v){var u={orderId:v};bi.dialog.confirm({title:"确认",message:"您是否确定要关闭该服务？ 注意：服务关闭次月生效",callback:function(w){if(w){q.ajax({type:"post",cache:false,dataType:"json",url:q.handleUrlParam("/platform/serviceopen/close-order"),data:u,loading:{title:"关闭",text:"正在为您关闭该服务！"},success:function(x){if("true"==x.saveFlag){bi.dialog.show({title:"成功",message:"服务关闭成功，次月生效！",onhidden:function(){jQuery("#orderGrid").trigger("reloadGrid")}})}else{bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"失败",message:"服务关闭失败！"})}},error:function(x){bi.dialog.show({type:bi.dialog.TYPE_DANGER,title:"失败",message:"服务关闭失败！"})}})}}})}function p(){jQuery("#totalNum").empty();var u=d(totalNum);var v=u.substring(u.length-2,u.length);jQuery("#totalUnitStr").html(v);var y=parseFloat(u.substring(0,u.length-2));var w=Math.floor(y*100%100);jQuery("#totalNum").append(".").append('<span class="numSpan">'+Math.floor(w/10)%10+"</span>");jQuery("#totalNum").append('<span class="numSpan">'+w%10+"</span>");var z=Math.floor(y);for(i=z;i>0;i=parseInt(Number(i)/10)){var x='<span class="numSpan">'+Number(i)%10+"</span>";jQuery("#totalNum").prepend(x)}}function d(u){if(u===0){return"0 B"}var v=1024,x=["MB","GB","TB","PB","EB","ZB","YB"],w=Math.floor(Math.log(u)/Math.log(v));return(u/Math.pow(v,w)).toFixed(2)+""+x[w]}function g(){var u=jQuery("#queryOrderDate").dateRange("getDate");var v=jQuery("#queryOrderDate").val();postData={orderDateStart:u.startDate,orderDateEnd:u.endDate,serviceId:serviceId};if(v==""||v==null){postData.orderDateStart="";postData.orderDateEnd=""}jQuery("#orderGrid").jqGrid("setGridParam",{postData:postData}).trigger("reloadGrid")}});